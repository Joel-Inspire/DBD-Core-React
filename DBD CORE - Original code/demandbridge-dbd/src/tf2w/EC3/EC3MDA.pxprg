0010 REM "Statistical Data Inquiry <EC3MDA>
0020 SETESC 9300; SETERR 9000
0035 REM "5.5 - 05/09/07 - 10.299722 - crg - SSP# 196113
0037 REM "196113-Has a WebEC buyer that wants to see reports only.           
0040 REM "Copyright 2007 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 REM "This is modified for file IC9 specifically, but relies on info in the stat record also
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,EC_PARM$,EC${ALL},TABLE_HTML$,IC0$,PACK,OPTIONS$,SECTION$
0100 SETERR 9000
0105 Q0$="I/C",Q1$=IC0$
0110 X0$="EC3MDA",X1$="I/C Statistical Data Display",K9=0
0115 IF Q0$<>"" THEN X1$=Q0$+" "+X1$
0120 DIM Z0$(80,"-")
0135 C9=-1
0140 M0$="###,###,##0"
0155 DEF FNS$(Z9$)=Z9$(1,POS("  "=Z9$+"  ")-1)
0165 DEF FND$(Z9$)=Z9$(NUM(X3$(48,1))*2+1,2)+X3$(59,1)+Z9$(7-NUM(X3$(48,1))*2,2)+X3$(59,1)+STR((ASC(Z9$(1,1))-65)*10+1900+NUM(Z9$(2,1))-1570*POS("  "=Z9$(1,2)):"####")
0170 DEF FNR$(Z9$)=Z9$(POS(" "<>Z9$))
0200 REM "
0290 K9$=Q1$,K0=LEN(K9$)+5,K1=3
0300 REM "IOLISTS
0310 IOLIST A$(1,LEN(A$)),A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14]
0320 IOLIST B$
0321 IOLIST B$,B[0],B[1],B[2],B[3],B[4],B[5],B[6],B[7],B[8],B[9],B[10],B[11],B[12],B[13],B[14],B[15]
0330 IOLIST C$
0340 IOLIST D$
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="03O ZZPARM  "+"06O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 0521,9900
0530 GOSUB 8000
0700 REM "
0720 READ (Z[6],KEY="STAT"+Q0$)F9$,F0
0725 Q9$=FNS$(F9$(8,20))
0730 Z$="01O "+F9$(28,6)+"  02O "+F9$(35,6)+"  ",F1=NUM(F9$(41,3)),F2=NUM(F9$(44,2))
0735 IF Q0$="I/C" THEN Z$=Z$+"04O IC1...  "
0740 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 0741,9900
0840 FOR X=0 TO 9; F1$=F1$+F9$(49+X*17,5),F2$=F2$+F9$(54+X*17,12); NEXT X
0845 X9$="",X8$=""
0850 FOR X=0 TO 9
0855 IF F1$(X*5+1,1)<>" " THEN IF X<5 THEN X9$=X9$+", "+F1$(X*5+1,1)+"="+FNS$(F2$(X*12+1,12)) ELSE X8$=X8$+", "+F1$(X*5+1,1)+"="+FNS$(F2$(X*12+1,12))
0856 IF F1$(X*5+2,1)="Y" THEN F3$=F3$+F1$(X*5+1,1)
0857 F5$=F5$+F1$(X*5+1,1)
0860 NEXT X
0865 X9$=X9$(3),F5$=F5$(1,POS(" "=F5$+" ")-1)
0870 IF LEN(X8$)>2 THEN X8$=X8$(3),X9$=X9$+","
1000 REM "
1030 DIM B$(60),D$(50),AA[20]
1032 IF Q0$="I/C" THEN DIM B[15]
1040 DIM A$(40+K9),A[14]
1200 REM "
1201 FIND (Z[3],KEY=X3$(9,3)+"I/C",DOM=9900)ICPARM$
1205 IF LEN(Q1$)>1 THEN A$(1+K9,20)=Q1$,C0=0; GOTO 1220
1220 FIND (Z[2],KEY=A$(K9+1,20),DOM=9900)IOL=0321
1230 READ (Z[1],KEY=A$(K9+1,20),DOM=*NEXT) ! Position at first stat record in IC9
1240 READ (Z[1],END=1600)IOL=0310; IF IC0$(1,20)<>A$(1,20) THEN GOTO 1600 ELSE IF A$(25,5)<>ICPARM$(7,4)+OPTIONS$(1,1) THEN GOTO *SAME ! Get next stat record for item
1257 Q$=X3$(9,3)+"G/LYE"
1265 REM "Find current period Fiscal year, set to A$(25,4)
1270 FIND (Z[3],KEY=X3$(9,3)+"G/LYE"+A$(25,4),DOM=*NEXT)IOL=0330
1300 REM "Activity Type
1330 IF Q0$="I/C" THEN GOSUB 8150
1500 REM "
1505 Z9=-1
1510 A1$=A$(1,29)
1515 X9=POS(A$(29,1)=F1$,5),Q$=""; IF F9$(5,3)="G/L" THEN Q$="C"
1516 IF X9>0 THEN CALL "ZZMASK",F1$(X9+2,3)+Q$,M0$; F9=NUM(F1$(X9+2,3))
1517 IF A$(25,4)<>I9$ THEN GOSUB 7700
1518 PRECISION NUM(F1$(X9+3,1))
1520 FIND (Z[1],KEY=A1$,DOM=9900)IC9$
1525 Z9=0
1530 GOSUB 6600
1540 IF Q0$="I/C" THEN I1=0; GOSUB 8100
1541 GOSUB 6400
1550 GOTO 1240
1600 REM "Process numbers, in eaches; to get in sell u/m divide by PACK value
1610 FOR I=1 TO 12
1620 YTD+=AA[I] ! Year to date usage
1630 NEXT I
1635 CURR_PERIOD=NUM(MID(ICPARM$,11,2),ERR=*NEXT) ! Current period
1640 CURR=AA[CURR_PERIOD] ! Current period usage
1650 IF CURR_PERIOD>1 THEN MONTHAVG=(YTD-CURR)/(CURR_PERIOD-1) ELSE MONTHAVG=YTD ! YTD Monthly average usage
1700 REM "Process tags
1710 LINE_TAGS$="001<ic9_current_usage>002<ic9_ytd_usage>003<ic9_avg_mos_usage>004<ic9_current_usage_sell>005<ic9_ytd_usage_sell>006<ic9_avg_mos_usage_sell>"
1720 SECTION$=""; BUF$=TABLE_HTML$
1730 INDEX=POS("?tf?"=BUF$); IF INDEX=0 THEN GOTO HTML_DONE
1740 END_INDEX=POS("?"=BUF$(INDEX+4)),TAG$=BUF$(INDEX+4,END_INDEX-1),BUF1$=BUF$(1,INDEX-1),BUF2$=BUF$(INDEX+END_INDEX+4),LPOS=POS("<"+TAG$+">"=LINE_TAGS$); IF LPOS=0 THEN LINDEX=0 ELSE LINDEX=NUM(LINE_TAGS$(LPOS-3,3))
1750 GOSUB 1800; GOTO 1730
1760 HTML_DONE:
1770 SECTION$+=BUF$
1795 GOTO 9900
1799 REM "Get tag value & substitute
1800 ON LINDEX GOTO 1890,1801,1802,1803,1804,1805,1806,1890
1801 BUF$=BUF1$+FNQ$(CURR,M0$)+BUF2$; GOTO 1895; REM "ic9_current_usage
1802 BUF$=BUF1$+FNQ$(YTD,M0$)+BUF2$; GOTO 1895; REM "ic9_ytd_usage
1803 BUF$=BUF1$+FNQ$(MONTHAVG,M0$)+BUF2$; GOTO 1895; REM "ic9_avg_mos_usage
1804 BUF$=BUF1$+FNQ$(CURR/PACK,M0$)+BUF2$; GOTO 1895; REM "ic9_current_usage_sell
1805 BUF$=BUF1$+FNQ$(YTD/PACK,M0$)+BUF2$; GOTO 1895; REM "ic9_ytd_usage_sell
1806 BUF$=BUF1$+FNQ$(MONTHAVG/PACK,M0$)+BUF2$; GOTO 1895; REM "ic9_avg_mos_usage_sell
1890 BUF$=BUF1$+"?"+BUF2$; GOTO 2095; REM " ?
1895 RETURN 
6000 REM "BACKGROUND
6090 GOSUB 7700
6190 RETURN 
6200 REM "DISPLAY DATA
6220 IF Q0$="I/C" THEN GOSUB 8150
6230 GOSUB 7600
6390 RETURN 
6400 REM "WHOLE SCREEN
6410 GOSUB 6000
6430 GOSUB 6200
6445 RETURN 
6450 REM "DISPLAY KEYS
6490 RETURN 
6600 REM "ALT KEY DATA READS
6605 READ (Z[2],KEY=A$(1,20),DOM=6606)IOL=0321
6610 FIND (Z[3],KEY=X3$(9,3)+"G/LYE"+A$(25,4),DOM=6611)IOL=0330
6615 IF Q0$="I/C" THEN GOSUB 8150
6690 RETURN 
7600 REM "Display Year-to-Date
7620 IF C$="" THEN GOTO 7690 ELSE I1=A[0]
7625 I9=NUM(C$(13,2)); FOR I=I9 TO 1 STEP -1; IF A[I]=0 THEN I9=I-1; NEXT I ELSE EXITTO 7626
7635 IF C$="" THEN GOTO 7699
7642 FOR I=1 TO I9
7645 AA[I]+=A[I]
7660 NEXT I
7699 RETURN 
7700 REM "PRINT PERIOD ENDING DATES
7705 IF A$="" THEN GOTO 7745
7710 READ (Z[3],KEY=X3$(9,3)+"G/LYE"+A$(25,4),DOM=7745)IOL=0330
7785 IF C$>"" THEN I9$=C$(9,4)
7790 RETURN 
8000 REM "
8010 READ (Z[6],KEY=X3$(9,3)+"G/L",DOM=8090)F0$
8020 Q$=F0$(1,3); IF F0$(10,1)="N" THEN Q$=F0$(7,3)
8080 RETURN 
8090 EXITTO 9900
8100 REM "Handle special I/C stuff based on B$(124,4) and B(15)
8102 IF A$(29,1)<>"U" THEN RETURN 
8104 DIM P$(20)
8105 READ (Z[6],KEY="U/M"+B$(124,4),DOM=8106)P$,P0,P1
8110 IF P$(20,1)="Y" THEN I0=P1 ELSE I0=B[15]
8115 I9=NUM(C$(13,2))
8120 FOR I=0 TO I9
8125 IF I1=0 THEN A[I]=A[I]/I0 ELSE A[I]=A[I]*I0
8130 NEXT I
8145 RETURN 
8150 REM "If U type print unit of measure"
8165 READ (Z[6],KEY="U/M"+B$(124,4),DOM=8166)P$,P0,P1
8170 IF P$(20,1)="Y" THEN UM_VALUE$=B$(124,4) ELSE UM_VALUE$=FNS$(B$(124,4))+"/"+FNR$(STR(B[15]:"##,##0"))
8190 RETURN 
8200 REM " Print screen
8890 RETURN 
8940 DEF FNQ$(Z8,Z9$)=STR(Z8:Z9$)
9000 REM "Error processing
9002 J=ERR,K=TCB(5); SETERR 0000; ENDTRACE 
9010 LAST_WEBEC_ERR$="ERR: "+STR(J)+" AT: "+STR(K); LAST_WEBEC_ERR$=GBL("LAST_WEBEC_ERR",LAST_WEBEC_ERR$); REM "131928
9090 GOTO 9900
9900 REM "End
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9950 EXIT 
9999 END 
56002 REM "196113-Has a WebEC buyer that wants to see reports only.
