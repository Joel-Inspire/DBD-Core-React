0010 REM "Create email server request file <EC3EM2>
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 04/24/13 - 15.764444 - dmm - SSP# 262698
0037 REM "262698-Error during approval (0-EC3AP2-620), that worksheet can be 
0040 REM "Copyright 2013 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 REM "EMAIL_ACTION$
0051 REM "'AN' - Notification Approval Needed
0052 REM "'AR' - Notification Approval Rejected
0053 REM "'AA' - Notification Approval Accepted
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,EC_PARM$,EC${ALL},WORKSHEET$,EMAIL_ACTION$,OPTIONS$
0100 SETERR 9000
0110 X0$="EC3EM2",X1$="Create email server request file"
0120 EOL$=""; IF EC_PARM$(57,8)<>DIM(8) THEN EOL$=ATH(STP(EC_PARM$(57,8),1))
0121 DIM Z0$(80,"-")
0130 K0=20,K1=1
0135 C9=-1
0200 REM "
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=ESC+"BG"+Z0$+ESC+"EG"
0300 REM "IOLISTS
0310 IOLIST A$,ECA2$
0320 IOLIST B$
0400 GOSUB PARSE_OPTIONS
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0507 IF POS(EMAIL_ACTION$="ANAR",2)>0 THEN FILE$="EDN..." ELSE FILE$="ECD..." ! 166022
0510 Z$="01O EC9...  02O ECA...  03O "+FILE$+"  13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0545 GOSUB SET_READONLY ! SSP262698
0550 DIM EDN$(1580); READ (Z[3],KEY=WORKSHEET$,DOM=*NEXT)EDN$
0555 DIM ORG_BUYER$(1540); READ (Z[2],KEY=EDN$(11,15),DOM=*NEXT)ORG_BUYER$
0600 REM "get purchasing agent buyer record if needed
0610 IF NUL(APP_BUYER_ID$) THEN APP_BUYER_ID$=MID(ORG_BUYER$,869,15) ! SSP205923 - If approver buyer id not present in OPTIONS$, use approver from original buyer record.
0620 DIM ECAPA$(2048); FIND (Z(2),KEY=PAD(APP_BUYER_ID$,15),DOM=*NEXT)ECAPA$
0630 DIM ECA$(2048); FIND (Z(2),KEY=ORG_BUYER$(1,15),DOM=*NEXT)ECA$
0635 GOSUB CLEAR_READONLY ! SSP262698
1000 REM "BEGIN MAIN PROCESS
1010 XX=INT(POS(EMAIL_ACTION$="ANARAA",2)/2)
1020 ON XX GOTO 1021,1022,1023,5000
1021 TMPNAME$="TMPAN",TMPTYPE$="AN",BASIC$="EC3EM1",TPCODE$=EC_PARM$(1021,10),SOURCE$="approval_worksheet=Y",EMAILBUYER$=PAD(APP_BUYER_ID$,15),EMAILADDRESS$=ECAPA$(109,60); GOTO 1050; REM "AN - approval needed
1022 TMPNAME$="TMPAR",TMPTYPE$="AR",BASIC$="EC3EM1",TPCODE$=EC_PARM$(1041,10),SOURCE$="approval_worksheet=Y",EMAILBUYER$=ORG_BUYER$(1,15),EMAILADDRESS$=ORG_BUYER$(109,60); GOTO 1050; REM "AR - approval rejected
1023 TMPNAME$="TMPAA",TMPTYPE$="AA",BASIC$="EC3EM1",TPCODE$=EC_PARM$(1031,10),SOURCE$="approval_worksheet=Y",EMAILBUYER$=ORG_BUYER$(1,15),EMAILADDRESS$=ORG_BUYER$(109,60); GOTO 1050; REM "AA - approval accepted
1050 REM "get 3p info
1055 IF STP(EMAILADDRESS$,3)="" THEN GOTO 9900 ! SSP170269, if buyer has blank email address then don't generate email for approved/rejected
1060 DIM EC9$(200); FIND (Z(1),KEY=TPCODE$+"00002",DOM=5000)EC9$
1070 TEMPLATE$=STP(EC9$(16,30),3," "); CALL "EC3SVT",X3$,X4$,EC_PARM$,EC${ALL},TEMPLATE$ ! SSP173257, need webcode support for email body
1100 ! Set file suffix
1110 IF NOT(NUL(EC$[14](482,5))) THEN FILE_SUFFIX$=STP(EC$[14](482,5),3) ELSE XX$=STP(EC$[14](176,20),3," "),XX=POS("."=XX$); FILE_SUFFIX$=MID(XX$,XX)
1190 ! 
1500 REM "Create email request file 148750
1501 REM "Use port 1002
1505 CLOSE (1002)
1510 PRECISION 5; RANDOM$=STR(INT(RND*100000)); PRECISION 2; TMP_EMAIL_FILE$=%SERVER_DIR$+TMPNAME$+RANDOM$ ! SSP166022, was previously using FILE_SUFFIX$, this was being picked up by the server before we would write to it.
1511 OPEN (1002,ERR=1515)TMP_EMAIL_FILE$; CLOSE (1002); GOTO 1510; REM "if we can open the file then it is in use, try again
1515 REM "Create file, then open file and write to it
1520 SERIAL TMP_EMAIL_FILE$,ERR=1510
1521 OPEN LOCK (1002)TMP_EMAIL_FILE$; MESS$="Creating temp HTML e-mail file "+TMP_EMAIL_FILE$,MTYPE$="EMAIL"; GOSUB 7500
1530 IF EC_PARM$(1177,1)="Y" THEN SID$=EC$[1](1,7) ELSE SID$=EC$[1](1213,64) ! SSP212160 jdf
1532 WRITE RECORD (1002)"basic="+BASIC$
1533 WRITE RECORD (1002)"template="+TEMPLATE$
1534 WRITE RECORD (1002)"session_id="+SID$ ! SSP212160 jdf
1535 WRITE RECORD (1002)"worksheet="+WORKSHEET$
1536 WRITE RECORD (1002)SOURCE$
1538 WRITE RECORD (1002)"email_buyer="+EMAILBUYER$
1540 WRITE RECORD (1002)"email_address="+STP(EMAILADDRESS$,2)
1542 WRITE RECORD (1002)"remove_file=Y"
1543 WRITE RECORD (1002)"no_header=Y"
1544 WRITE RECORD (1002)"ordering_buyer="+ECA$(1,15)
1546 WRITE RECORD (1002)"ordering_buyer_name="+ECA$(16,35)
1548 WRITE RECORD (1002)"ordering_buyer_email="+STP(ECA$(109,60),2)
1550 WRITE RECORD (1002)"approval_type="+TMPTYPE$
1580 WRITE RECORD (1002)EOL$
1590 CLOSE (1002)
1595 ! 
1600 ! Create email file name, try the rename, if error, try again
1610 EMAIL_FILE$=%SERVER_DIR$+TMPNAME$+RANDOM$+FILE_SUFFIX$
1620 RENAME TMP_EMAIL_FILE$,EMAIL_FILE$,ERR=*NEXT; GOTO 1690
1630 PRECISION 5; RANDOM$=STR(INT(RND*100000)); PRECISION 2; GOTO 1610
1690 MESS$="Posting e-mail to send : "+EMAIL_ACTION$+"|"+EMAIL_FILE$+"|"+STP(EMAILADDRESS$,1),MTYPE$="EMAIL"; GOSUB 7500
1695 ! 
1700 IF MORE_EMAILS THEN RETURN 
5000 REM "EOJ
5005 IF MID(EC$[7],761,1)="Y" AND EMAIL_ACTION$<>"AN" THEN IF NOT(NUL(EDN$(677,60))) AND EDN$(677,60)<>ORG_BUYER$(109,60) THEN MORE_EMAILS=1,EMAILADDRESS$=EDN$(677,60); GOSUB 1500 ! WO253784, if cust parm set and worksheet email address prent and not same as buyer, send email if not AN which is for approver only
5010 IF EC$[7](608,1)<>"Y" OR EMAIL_ACTION$="AN" THEN GOTO 5090 ! WO186520, check customer parm, send email to all buyer addresses?, also if notification to approver then leave as usual.
5020 IF NOT(NUL(ORG_BUYER$(169,60))) THEN MORE_EMAILS=1,EMAILADDRESS$=ORG_BUYER$(169,60); GOSUB 1500
5025 IF NOT(NUL(ORG_BUYER$(340,60))) THEN MORE_EMAILS=1,EMAILADDRESS$=ORG_BUYER$(340,60); GOSUB 1500
5030 IF NOT(NUL(ORG_BUYER$(400,60))) THEN MORE_EMAILS=1,EMAILADDRESS$=ORG_BUYER$(400,60); GOSUB 1500
5090 GOTO 9900
6500 REM "Parse OPTIONS$ string
6505 PARSE_OPTIONS:
6510 IF NUL(OPTIONS$) THEN GOTO *RETURN
6520 B_O$=MID(OPTIONS$,MSK(OPTIONS$,"B{[^}]*}",ERR=*NEXT),MSL,ERR=*NEXT)
6530 IF B_O$<>"" THEN APP_BUYER_ID$=MID(B_O$,3,LEN(B_O$)-3)
6595 RETURN 
7000 LIST REM "convert email action to 3p id master
7003 DIM TP_ACTIONCD$(10),TP_ACTIONCD1$(200),TP_ACTIONCD2$(200)
7005 XX=INT(POS(EMAIL_ACTION$="AN",2)/2); ON XX GOTO 7045,7010,7045
7010 TP_ACTIONCD$=EC_PARM$(1021,10); GOTO 7030; REM "email notification of required approval "
7030 FIND (Z(28),KEY=TP_ACTIONCD$+"00001",DOM=*NEXT)TP_ACTIONCD_1$
7031 FIND (Z(28),KEY=TP_ACTIONCD$+"00002",DOM=*NEXT)TP_ACTIONCD_2$
7400 SET_READONLY:! SSP262698
7410 SET_PARAM 'XI'
7420 SET_READONLY_END:RETURN 
7430 CLEAR_READONLY:
7435 SET_PARAM -'XI'
7440 CLEAR_READONLY_END:RETURN 
7500 REM "Put MESS$ in log & display to screen if IMODE
7501 REM "MTYPE$ is type, clear it after, if '' then say info
7502 REM "valid are INFO,WARN,EXIT,EXCP,STAT,EMAIL
7504 IF XMODE THEN GOTO 7541
7505 IF MTYPE$="" THEN MTYPE$="INFO"
7510 OUT$=DTE(0:"%Y-%Mz-%Dz|%Hz:%mz:%sz")+"|"+MTYPE$+"|"+MESS$; PRECISION 2
7520 IF USE_START_LOG THEN GOTO *NEXT ELSE IF NO_LOG THEN GOTO 7540 ELSE PRINT (33003)OUT$; REM "151249, if start_log set, don't do anything We may use the start log until we have the server id
7540 IF DISPLAY_LOG THEN PRINT OUT$
7541 MTYPE$=""
7545 RETURN 
8195 RETURN 
8950 DEF FNS$(Z9$)=Z9$(1,POS("     "=Z9$+"     ")-1)
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
56002 REM "201193-Questions about security of Boars Head EC Promo site.       
56004 REM "205923-Would like quote on two tiered purchase approval.           
56006 REM "253784-Order Approval; Send approval type email to worksheet email 
56008 REM "262698-Error during approval (0-EC3AP2-620), that worksheet can be 
