0010 REM "Webec - Build email information from U1/U2 definition <EC3SEM>
0020 SETESC 9300; SETERR 9000
0035 REM "5.3 - 05/28/04 - 15.194444 - kmc - SSP# 172499
0040 REM "Copyright 2004 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 REM "ALL$ = y if all value to be included
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,EC_PARM$,EC${ALL},SORT_CODE$,WORKSHEET_REF$,EMAIL_TEXT$
0100 SETERR 9000
0110 X0$="EC3SEM",X1$="Webec - Build email inforamtion"
0120 DIM Z0$(80,"-")
0130 K0=20,K1=1
0135 C9=-1
0200 REM "
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=ESC+"BG"+Z0$+ESC+"EG"
0300 REM "IOLISTS
0310 IOLIST ECU$
0320 IOLIST ECV$
0330 IOLIST ECD$
0340 IOLIST ECE$,ECE[0],ECE[1]
0500 REM "FILES
0510 CLOSE (2001); OPEN (2001)"ECU"+X3$(9,3)
0520 CLOSE (2002); OPEN (2002)"ECV"+X3$(9,3)
0530 CLOSE (2003); OPEN (2003)"ECD"+X3$(9,3)
0540 CLOSE (2004); OPEN (2004)"ECE"+X3$(9,3)
0600 REM "read in sort definition
0610 DIM S$[50,1]; REM " index[x,1]=ECV record
0620 READ (2001,KEY=SORT_CODE$,DOM=9900)IOL=0310
0622 READ (2002,KEY=EC$[2](51,10)+ECU$(1,10),DOM=0623)
0625 SINDEX=1,ELEMENT_COUNT=0
0630 ECVKEY$=KEY(2002,END=0650); IF ECVKEY$(1,20)<>EC$[2](51,10)+ECU$(1,10) THEN GOTO 0650 ELSE READ (2002,KEY=ECVKEY$)IOL=0320
0640 S$[SINDEX,1]=ECV$,SINDEX=SINDEX+1,ELEMENT_COUNT=ELEMENT_COUNT+1; GOTO 0630
0650 IF ELEMENT_COUNT<>0 THEN GOTO 0700; REM "customer based definition found
0651 REM "seach for global definition
0653 READ (2002,KEY=DIM(10)+ECU$(1,10),DOM=0654)
0660 ECVKEY$=KEY(2002,END=0700); IF ECVKEY$(1,20)<>DIM(10)+ECU$(1,10) THEN GOTO 0700 ELSE READ (2002,KEY=ECVKEY$)IOL=0320
0670 S$[SINDEX,1]=ECV$,SINDEX=SINDEX+1,ELEMENT_COUNT=ELEMENT_COUNT+1; GOTO 0660
0700 IF ELEMENT_COUNT=0 THEN GOTO 9900
0800 EMAIL_TEXT$="",COUNT=1
0950 RAW_STLIST$="",RAW_DATAREF$=""
1000 REM "Mainline
1001 REM "get worksheet references (length=10 only get ECD    len=13 get ECD and ECE
1010 DIM ECD$(410),ECE$(125),ECE[1]; FIND (2003,KEY=WORKSHEET_REF$(1,10),DOM=1011)IOL=0330
1015 IF LEN(WORKSHEET_REF$)<13 THEN GOTO 1020
1017 FIND (2004,KEY=WORKSHEET_REF$,DOM=1018)IOL=0340
1100 REM "create entry
1110 GOSUB 7000
1200 EMAIL_TEXT$=ENTRY$
2900 GOTO 9900
7000 REM "build string based on definition
7002 ENTRY$="",ST_LENGTH=0
7010 FOR E=1 TO ELEMENT_COUNT
7012 TYPE$=S$[E,1](24,1),DPOSITION=NUM(S$[E,1](27,3)),LENGTH=NUM(S$[E,1](70,3)),TEXT$=S$[E,1](30,40),SOURCE_FILE$=S$[E,1](87,6); GOSUB 7100
7013 ST_LENGTH=ST_LENGTH+LENGTH
7015 ON POS(TYPE$="1T")-1 GOTO 7020,7040
7020 REM "data
7021 IF ECV$(73,1)="A" THEN GOTO 7050
7022 ENTRY$=ENTRY$+STP(MID(DATA$,DPOSITION,LENGTH),1); GOTO 7060 ! 172499
7040 REM "text
7042 ENTRY$=ENTRY$+MID(TEXT$,1,LENGTH); GOTO 7060 ! 172499
7050 REM "account type
7052 RESULT$=MID(DATA$,DPOSITION,LENGTH); CALL "ZZDISP",ERR=*NEXT,"AX",MID(DATA$,DPOSITION,LENGTH),STP(S$[E,1](78,9),2),X3$,RESULT$,"",0,0,X4$ ! 172499
7054 ENTRY$=ENTRY$+RESULT$; GOTO 7060
7080 NEXT E
7099 RETURN 
7100 REM "load DATA$ variable with appropriate file variable
7110 DP=POS(SOURCE_FILE$="ECD   ECE   ^E/C  ",6),DP=INT(DP/6)
7120 ON DP GOTO 7121,7122,7123
7121 DATA$=ECD$; GOTO 7140
7122 DATA$=ECE$; GOTO 7140
7123 DATA$=EC_PARM$; GOTO 7140
7145 RETURN 
8950 DEF FNS$(Z9$)=Z9$(1,POS("     "=Z9$+"     ")-1)
9000 REM "ERROR PROCESSING - Lines 9000-9090 ssp#172499
9002 J=ERR,K=TCB(5); SETERR 0000; ENDTRACE 
9010 LAST_WEBEC_ERR$="ERR: "+STR(J)+" AT: "+STR(K); LAST_WEBEC_ERR$=GBL("LAST_WEBEC_ERR",LAST_WEBEC_ERR$); REM "131928
9090 GOTO 9900
9900 REM "END PROGRAM
9910 FOR VV=2001 TO 2004; CLOSE (VV); NEXT VV
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
