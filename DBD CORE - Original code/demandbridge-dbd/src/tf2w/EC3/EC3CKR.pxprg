0010 REM "Check Server & restart <EC3CKR>
0020 SETESC 9300; SETERR 9000
0035 REM "4.5 - 11/01/00 - 15.93 - tma - SSP# 130975
0040 REM "Copyright 2000 Computer Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,Q0$,Q1$
0100 SETERR 9000
0110 X0$="EC3CKR",X1$="Check Server Status & restart"
0120 DIM Z0$(80,"-")
0130 K0=20,K1=1
0135 C9=-1
0200 REM "
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=ESC+"BG"+Z0$+ESC+"EG"
0300 REM "IOLISTS
0310 IOLIST A$
0320 IOLIST B$
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0610 READ (Z[13],KEY=X3$(9,3)+"E/C",DOM=9900)PARM$
0700 CLOSE (1); OPEN (1,ERR=9900)"D7"; DIR_PATH$=FID(1); CLOSE (1); DIR_PATH$=STP(DIR_PATH$(4,6)+DIR_PATH$(21),2)
0710 S$="ps -ef | grep D7 > "+DIR_PATH$+"/server_status.txt"
0720 INVOKE S$
0750 OPEN (1,OPT="TEXT")"server_status.txt"
0752 LINES$=""
0754 READ RECORD (1,END=0760)TXT$; LINES$=LINE$+TXT$; GOTO 0754
1000 REM "ck for server
1010 IF POS("D7:*.ec"=LINES$)=0 THEN GOTO 1200 ELSE GOTO 2000
1200 REM "server not found
1220 REM "clear existing ec files & Clear Active Log file
1230 S$="rm -i "+DIR_PATH$+"/*.ec*"; INVOKE S$
1240 OPEN (2)"ECB"+X3$(9,3)
1250 CALL "ZZINIT","02"
1280 S$="/etc/start.webec"; INVOKE S$
1290 WAIT 30
1300 REM " Recheck to see if it started
1400 CLOSE (1); OPEN (1,ERR=9900)"D7"; DIR_PATH$=FID(1); CLOSE (1); DIR_PATH$=STP(DIR_PATH$(4,6)+DIR_PATH$(21),2)
1410 S$="ps -ef | grep D7 > "+DIR_PATH$+"/server_status.txt"
1420 INVOKE S$
1450 OPEN (1,OPT="TEXT")"server_status.txt"
1460 LINES$=""
1470 READ RECORD (1,END=1480)TXT$; LINES$=LINE$+TXT$; GOTO 1470
1480 IF POS("D7:*.ec"=LINES$)=0 THEN GOTO 1500 ELSE GOTO 2000
1500 REM "Server will not restart
1520 MESS$="echo "+$22$+"Webec will not restart needs intervention, restart script cancelled"+$22$
1530 MESS$=MESS$+" |mail -s"+$22$+"WEBEC is down!"+$22$+" "+PARM$(168,30)
1580 INVOKE MESS$
1590 GOTO 9900
2000 REM " Server running wait then check again
2010 IF PARM$(436,4)="KILL" THEN GOTO 2200
2030 REST=NUM(PARM$(436,4))*60
2040 WAIT REST
2090 GOTO 0610
2200 REM " Script brought down by admin
2210 MESS$="echo "+$22$+"Webec Script brought down by administrator, restart script cancelled"+$22$
2220 MESS$=MESS$+" |mail -s"+$22$+"WEBEC script is no longer running"+$22$+" "+PARM$(168,30)
2280 INVOKE MESS$
2290 GOTO 9900
5000 REM "EOJ
5010 C=T; GOSUB 8150
5020 IF Q1$="" THEN CALL "ZZPROM",".4",X3$,Z,"Process complete!!","","",0
5040 GOTO 9900
8950 DEF FNS$(Z9$)=Z9$(1,POS("     "=Z9$+"     ")-1)
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9011 IF Q0$(1,2)="JS" THEN A1$=$FF$+X0$+"|Error|"+STR(Y5)+"|Line|"+STR(Y6)+"|"; GOTO 9900
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 REM "CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z[ALL],0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
