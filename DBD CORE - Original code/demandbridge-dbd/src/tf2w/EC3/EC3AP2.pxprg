0010 REM "order approval worksheet status update <EC3AP2>
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 04/24/13 - 15.761111 - dmm - SSP# 262698
0037 REM "262698-Error during approval (0-EC3AP2-620), that worksheet can be 
0040 REM "Copyright 2013 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 REM "ACTION$
0051 REM "'A' - Approval
0052 REM "'R' - Rejected
0053 REM "'C' - Quantity Changed
0054 REM "'N' - new approval record created
0055 REM "'V' - reviewed (will not override approval or rejection)
0060 REM "BUYERID$ = buyer id taking action
0062 REM "COMMENTS$ = approval order comments
0064 REM "OPTIONS$ = not used
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,EC_PARM$,EC${ALL},WORKSHEET$,ACTION$,BUYERID$,COMMENTS$,OPTIONS$
0100 SETERR 9000
0110 X0$="EC3AP2",X1$="order approval worksheet status update"
0120 EOL$=""; IF EC_PARM$(57,8)<>DIM(8) THEN EOL$=ATH(STP(EC_PARM$(57,8),1))
0121 DIM Z0$(80,"-")
0130 K0=20,K1=1
0135 C9=-1
0200 REM "
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=ESC+"BG"+Z0$+ESC+"EG"
0300 REM "IOLISTS
0310 IOLIST EDN$
0320 IOLIST EDO$
0330 IOLIST EDT$
0340 IOLIST EDU$
0350 IOLIST ECA$,ECA2$
0400 GOSUB PARSE_OPTIONS
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="04O EDU...  05O ECA...  13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0550 REM "only update existing records if authorized for approval
0560 IF EC$[2](867,1)<>"Y" AND POS(ACTION$="N")=0 THEN GOTO 5000
0600 REM "preprocessing variables
0610 CALL "EC3DAT",X3$,3,CURRTIME$,CURRDATE$,""
0620 GOSUB SET_READONLY; DIM ECA$(2000); FIND (Z(5),KEY=BUYERID$,DOM=*NEXT)IOL=0350 ! SSP262698, add set of READONLY
0621 GOSUB CLEAR_READONLY ! SSP262698
1000 REM "Update approval worksheet status
1001 MESS$="Updating Approval Order Log for "+WORKSHEET$+" Action: "+ACTION$; GOSUB 7500
1010 DIM EDU$(511); EDU$(1,10)=WORKSHEET$; FIND (Z(4),KEY=EDU$(1,10),DOM=*NEXT)IOL=0340
1013 IF NUL(APP_BUYER_ID$) THEN APP_BUYER_ID$=MID(ECA$,869,15) ! SSP205923 - If approver buyer id not present in OPTIONS$, use approver from original buyer record.
1015 IF ACTION$="N" THEN EDU$(11,6)=CURRDATE$,EDU$(17,4)=CURRTIME$,EDU$(21,15)=BUYERID$,EDU$(322,35)=ECA$(16,35),EDU$(393,15)=APP_BUYER_ID$,EDU$(408,10)=ECA$(51,10) ELSE EDU$(36,6)=CURRDATE$,EDU$(42,4)=CURRTIME$,EDU$(46,15)=BUYERID$,EDU$(357,35)=ECA$(16,35); REM "if new only update creation informaiton
1030 GOSUB 7000; IF DESC$<>"" THEN EDU$(62,20)=DESC$
1040 IF LEN(COMMENTS$)>240 THEN COMMENTS$=COMMENTS$(1,240) END_IF ; IF STP(COMMENTS$,3," ")<>"" THEN EDU$(82,240)=COMMENTS$
1050 IF ACTION$="R" THEN EDU$(61,1)="Y"; REM "order closed
1060 IF POS(EDU$(392,1)="AR")=0 THEN EDU$(392,1)=ACTION$; REM "only update action if not yet rejected or approved
1062 IF POS(EDU$(392,1)="AR")<>0 THEN EDU$(61,1)="Y"; REM "if accepted/rejected then close approval order
1064 IF EDU$(392,1)="E" THEN EDU$(61,1)="E" ELSE IF EDU$(392,1)="S" THEN EDU$(61,1)=""; REM "SSP#255476 - If last action is "E" then lock approval order to prevent access by other approvers; if last action is "S" then unlock approval order;
1090 WRITE (Z(4),KEY=EDU$(1,10))IOL=0340
5000 REM "EOJ
5040 GOTO 9900
6500 REM "Parse OPTIONS$ string
6505 PARSE_OPTIONS:
6510 IF NUL(OPTIONS$) THEN GOTO *RETURN
6520 B_O$=MID(OPTIONS$,MSK(OPTIONS$,"B{[^}]*}",ERR=*NEXT),MSL,ERR=*NEXT)
6530 IF B_O$<>"" THEN APP_BUYER_ID$=MID(B_O$,3,LEN(B_O$)-3)
6595 RETURN 
7000 REM "current status description
7001 DESC$=""
7002 IF POS(EDU$(392,1)="AR")<>0 THEN GOTO 7045; REM "if already accepted or rejected then no action
7010 ON POS(ACTION$="ARCNVES") GOTO 7040,7020,7021,7022,7023,7024,7025,7026
7020 DESC$="Approved"; GOTO 7030
7021 DESC$="Rejected"; GOTO 7030
7022 DESC$="Quantities Changed"; GOTO 7030
7023 DESC$="No Action Taken"; GOTO 7030
7024 DESC$="Reviewed"; GOTO 7030
7025 DESC$="Locked"; GOTO 7030 ! 255476
7026 DESC$="Saved"; GOTO 7030 ! 255476
7045 RETURN 
7400 SET_READONLY:! SSP262698
7410 SET_PARAM 'XI'
7420 SET_READONLY_END:RETURN 
7430 CLEAR_READONLY:
7435 SET_PARAM -'XI'
7440 CLEAR_READONLY_END:RETURN 
7500 REM "Log MESS$ ! 255476 - Updated to use standard EC logging logic
7501 REM "MTYPE$ is type, clear it after, if '' then say info
7505 IF MTYPE$="" THEN MTYPE$="INFO"
7520 MX=FN%_LOG_MESSAGE(MTYPE$,"SESSION_ID|"+EC$[1](1,7)+"|"+MESS$)
7541 MTYPE$=""
7545 RETURN 
7549 ! 
8195 RETURN 
8950 DEF FNS$(Z9$)=Z9$(1,POS("     "=Z9$+"     ")-1)
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
56002 REM "205923-Would like quote on two tiered purchase approval.           
56004 REM "207913-Purchase approvals: Super-approver must be able to approve all worksheets
56005 REM "255476-TVIINC workflow - Phase 1: Approver edit worksheets feature 
56006 REM "262698-Error during approval (0-EC3AP2-620), that worksheet can be 
