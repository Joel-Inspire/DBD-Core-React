0010 ! FMGIAj - Order History Inquiry (="FS6"+%C$)
0020 ! Generated by ProvideX® NOMADS II File Maintenance on Aug. 2, 2001 9:53
0030 ! ************************************************************************
0035 REM "5.7 - 06/16/09 - 14.913055 - jir - SSP# 230681
0037 REM "230681-Getting an error 046 in gui Order History look up by item.  
0040 REM "Copyright 2009 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0091 MSGBOX MSG("FMGIAL_MG1"),MSG("VERIFY"),"?,YESNO",%ANS$
0093 PNL_INVOKE: %MAX_SCREEN=1,%EXEC_CMD$="PROCESS "+QUO+"FMGIAI"+QUO+","+QUO+"../FMG/FM.EN"+QUO ! SSP 206686 230681
0094 _CUSTOMER$=%CUSTOMER$; GOSUB INIT; %FS1=_FS1,%ICO=_IC0,%FM1=_FM1,%FMP=_FMP,%FS9=_FS9,%P0$=P0$; IF %P0$(243,1)="Y" THEN PROCESS "QRY_IAL","../FMG/FM.EN",VAL$; IF VAL$<>"" THEN ORDER_LINE$=VAL$; GOSUB 28150; VAL$=""; GOSUB WRAPUP; GOTO 0093 ELSE GOSUB WRAPUP; GOTO 0096 ! SSP210101 jdf
0095 PROCESS "FMGIAJ","../ARG/AR.EN"
0096 %CUSTOMER$=_CUSTOMER$,%ANS$="",%MAX_SCREEN=0 ! SSP 206686
0097 EXIT 
0100 ! 100 - Initialization
0105 INIT:
0110 IF %CUSTOMER$<>"" THEN CUSTOMER$=%CUSTOMER$
0115 _FILE_NAME$="FS6"+%C$
0120 _FIL_NO=HFN; OPEN (_FIL_NO,IOL=*,ERR=OPEN_ERR)_FILE_NAME$
0125 _FILE_NAME$="ZZPARM"; _ZZPARM=HFN; OPEN (_ZZPARM,ERR=OPEN_ERR)_FILE_NAME$
0130 _FILE_NAME$="FS8"+%C$; _FS8=HFN; OPEN (_FS8,ERR=OPEN_ERR)_FILE_NAME$
0135 _FILE_NAME$="FM1"+%C$; _FM1=HFN; OPEN (_FM1,ERR=OPEN_ERR,IOL=*)_FILE_NAME$
0140 _FILE_NAME$="AR1"+%C$; _AR1=HFN; OPEN (_AR1,ERR=OPEN_ERR,IOL=*)_FILE_NAME$
0145 _FILE_NAME$="IC0"+%C$,_IC0=HFN; OPEN (_IC0,ERR=OPEN_ERR)_FILE_NAME$
0150 _FILE_NAME$="FMP"+%C$,_FMP=HFN; OPEN (_FMP,ERR=OPEN_ERR)_FILE_NAME$
0155 _FILE_NAME$="FS9"+%C$,_FS9=HFN; OPEN (_FS9,ERR=OPEN_ERR,IOL=*)_FILE_NAME$
0160 _FILE_NAME$="FS1"+%C$,_FS1=HFN; OPEN (_FS1,ERR=OPEN_ERR)_FILE_NAME$
0181 READ (_ZZPARM,KEY=%C$+"A/R",DOM=*NEXT)P0$; GOTO 0183
0182 CMD_STR$="END"; EXIT 
0185 MCHL=HFN; OPEN (MCHL)"*MEMORY*"
0186 ! CHL=HFN; OPEN (MCHL)"*memory*;KEYDEF=[1:1:36:""D""]"
0195 RETURN 
0200 OPEN_ERR: MSGBOX _MSG_FILOPNERR1$+QUO+_FILE_NAME$+QUO+SEP+_MSG_DIRECTORY$+LWD+SEP+_MSG_PREFIX$+PFX,MSG(ERR),"!"
0210 CMD_STR$="END"
0220 RETURN 
0500 ! 500 - Main panel post_display logic
0510 MAIN_POST_DISPLAY:
0512 IF %X3$(48,1)="1" THEN DATE_SET$="[Order Date]MDYL10.00"; END_IF ; IF %X3$(48,1)="2" THEN DATE_SET$="[Order Date]DMYL10.00"; END_IF ; IF %X3$(48,1)="3" THEN DATE_SET$="[Order Date]YMDL10.00" ! SSP222476 jdf
0513 IF STP(DATE_SET$)<>"" THEN DATE_STRING$=DETAILS.CTL'FMT$; NEW_DATE_STRING$=SUB(DATE_STRING$,DATE_STRING$(1,21),DATE_SET$,1) ! SSP222476 jdf
0514 IF STP(DATE_SET$)<>"" THEN DETAILS.CTL'FMT$=NEW_DATE_STRING$ ! SSP222476 jdf
0515 IF P0$(15,1)<>"Y" THEN CALL "*wingrp;Hide",BILLTO.GRP$
0535 ! GOSUB PROCESS_CUSTOMER
0540 RETURN 
0900 ! 900 - Wrapup
0905 WRAPUP:
0908 %MAX_SCREEN=0,%EXEC_CMD$="" ! SSP 206686 230681
0910 IF _FIL_NO<>0 THEN CLOSE (_FIL_NO); _FIL_NO=0
0915 IF _CUR_FN<>0 THEN CLOSE (_CUR_FN); _CUR_FN=0
0920 IF _ZZPARM<>0 THEN CLOSE (_ZZPARM); _ZZPARM=0
0925 IF _FS8<>0 THEN CLOSE (_FS8); _FS8=0
0930 IF _FM1<>0 THEN CLOSE (_FM1); _FM1=0
0935 IF _AR1<>0 THEN CLOSE (_AR1); _AR1=0
0940 IF _IC0<>0 THEN CLOSE (_IC0); _IC0=0
0945 IF _FMP<>0 THEN CLOSE (_FMP); _FMP=0
0950 IF _FS9<>0 THEN CLOSE (_FS9); _FS9=0
0955 IF _FS1<>0 THEN CLOSE (_FS1); _FS1=0
0990 RETURN 
1000 ! 1000 - Process customer
1005 PROCESS_CUSTOMER:
1010 REFRESH_FLG=1
1011 IF %CUSTOMER$<>"" THEN DISABLE CONTROL CUSTOMER.CTL
1012 %CUSTOMER$=CUSTOMER$; %ITEM_CODE$=ITEM_CODE$
1015 CALL "ZZWLKU;PARSE_CUST",CUSTOMER$,CUST_DIV$,CUST_CODE$; CUSTOMER$=CUST_DIV$+CUST_CODE$
1020 READ (_AR1,KEY=CUST_DIV$+CUST_CODE$,DOM=*NEXT); BILL_TO_CUST$=BILL_TO_CUST_DIV$+BILL_TO_CUST_CODE$
1023 REM MSGBOX MSG("FMGIAL_MG1"),MSG("VERIFY"),"?,YESNO",ANS$ ! SSP217149 jdf
1024 GOSUB LOAD_MEM_FILE
1025 ! GOSUB LOAD_DETAILS
1026 WAIT:OBTAIN *; EVENT=CTL
1027 IF EVENT=BUTTON_3.CTL THEN RETURN 
1028 IF EVENT=101 THEN GOSUB LOAD_ON_DEMAND
1030 IF EVENT=LB THEN GOSUB HIST_LINE_INFO
1035 IF EVENT=BT_EXP.CTL THEN GOTO EXPORT_LIST ! CALL "UTGEXP;EXPORT",DETAILS.CTL
1040 GOTO WAIT
1090 RETURN 
2000 ! 21000 - Read and load line details ON DEMAND
2500 EXPORT_LIST:
2520 IF NEEDED_TO=NRECS THEN GOTO 2550
2530 NEEDED_FROM=NEEDED_TO+1
2535 NEEDED_TO=NRECS
2540 GOSUB LOAD_FOR_NEXT
2550 CALL "UTGEXP;EXPORT",DETAILS.CTL
2560 ESCAPE 
7500 GET_ITEM_DESC:
7505 ON POS(HIST_TYPE$="BDFHJM") GOTO 7590,7550,7510,7515,7600,7570,7600
7510 C0$=CUST_DIV$+CUST_CODE$; GOTO 7520
7515 DIM C0$(10)
7520 FIND (_IC0,KEY=C0$+ITEM_CODE$,DOM=7555)IC0$
7525 ITEM_DESC$=IC0$(21,40)
7545 GOTO 7590
7550 REM "Custom item case
7560 FIND (_FM1,KEY=CUST_DIV$+CUST_CODE$+ITEM_CODE$,DOM=*NEXT); GOTO 7565
7561 ITEM_DESC$=DIM(40)
7569 GOTO 7590
7570 REM "Special stuff
7580 FIND (_FMP,KEY="X"+ITEM_CODE$,DOM=*NEXT)FMP$; ITEM_DESC$=FMP$(12,40); GOTO 7582
7581 ITEM_DESC$=DIM(40)
7590 RETURN 
7600 REM "Read in non stock info from FS9 and put into E0$
7620 FIND (_FS9,KEY=ORDER_DIV$+ORDER_NUM$+ITEM_CODE$+SEQ_NUM$,DOM=*NEXT); ITEM_DESC$=TF_DESC$; GOTO 7625
7621 ITEM_DESC$=DIM(40)
7640 GOTO 7590
7690 RETURN 
9999 END 
20010 LOAD_MEM_FILE:
20020 LIST_BOX LOAD DETAILS.CTL,""
20030 IF NUL(FS6_KEY$) THEN FS6_KEY$=CUSTOMER$ ! SSP 225600
20040 READ (_FIL_NO,KNO=7,KEY=FS6_KEY$,DOM=*NEXT) ! SSP217347 jdf     
20050 FS6_KEY$=KEY(_FIL_NO,KNO=7,END=ALL_MDONE)
20060 READ (_FIL_NO,KEY=FS6_KEY$,KNO=7,DOM=ALL_MDONE)
20070 IF FS6_KEY$(1,10)<>CUSTOMER$ THEN GOTO ALL_MDONE
20075 IF NUL(INV_DATE$) THEN GOTO 20050
20077 IF ANS$="YES" AND PRIC_EXT_INV_TO_DATE=0 THEN GOTO 20050
20080 WRITE (MCHL,KEY=FS6_KEY$)FS6_KEY$
20110 GOTO 20050
20120 ALL_MDONE:
20125 NRECS=NUM(FIN(MCHL,"NUMREC"))
20130 ! IF %X3$(48,1)="2" THEN DETAILS.CTL'SORT=-1
20135 LB=DETAILS.CTL
20140 DETAILS.CTL'ITEMNEEDEDCTL=101; DETAILS.CTL'ITEMCOUNT=NRECS
20150 SET_FOCUS DETAILS.CTL; WAIT 0
20180 RETURN 
20190 ! 
21000 ! 21000 - Read and load line details
21010 LOAD_DETAILS:
21012 ! RETURN 
21015 TOT_NUM_INV=50000,CUR_NUM_INV=0,BT_MORE.CTL'ENABLED=0,REFRESH_FLG=1 ! SSP 225600
21020 LIST_BOX LOAD DETAILS.CTL,""
21030 IF NUL(FS6_KEY$) THEN FS6_KEY$=CUSTOMER$ ! SSP 225600
21040 READ (_FIL_NO,KNO=7,KEY=FS6_KEY$,DOM=*NEXT) ! SSP217347 jdf     
21050 FS6_KEY$=KEY(_FIL_NO,END=ALL_DONE); IF CUR_NUM_INV>TOT_NUM_INV THEN BT_MORE.CTL'ENABLED=1,BT_MORE.CTL'VISIBLE=1; REFRESH_FLG=1; GOTO ALL_DONE ! SSP 225600
21060 READ (_FIL_NO,KEY=FS6_KEY$,DOM=ALL_DONE)
21070 IF FS6_KEY$(1,10)<>CUSTOMER$ THEN GOTO ALL_DONE
21075 IF NUL(INV_DATE$) THEN GOTO 21050
21077 IF ANS$="YES" AND PRIC_EXT_INV_TO_DATE=0 THEN GOTO 21050
21080 GOSUB GET_TYPE_DESC
21090 GOSUB GET_ITEM_DESC
21100 GOSUB LOAD_LISTBOX
21110 GOTO 21050
21120 ALL_DONE:IF CUR_NUM_INV<=TOT_NUM_INV THEN BT_MORE.CTL'ENABLED=0,BT_MORE.CTL'VISIBLE=0,REFRESH_FLG=1; END_IF ; IF %X3$(48,1)="2" THEN DETAILS.CTL'SORT=-1 END_IF ; RETURN ! SSP217347 jdf !SSP#222049, SSP 225600
21130 ! 
22010 LOAD_ON_DEMAND:
22015 NEEDED_TO=DETAILS.CTL'ITEMNEEDEDTO
22020 NEEDED_FROM=DETAILS.CTL'ITEMNEEDEDFROM
22022 LOAD_FOR_NEXT:
22025 IF NEEDED_FROM=0 OR NEEDED_TO=0 THEN RETURN 
22030 FOR I=NEEDED_FROM TO NEEDED_TO
22040 READ (MCHL,RNO=I,DOM=*NEXT)FS6_KEY$ ! SSP217347 jdf     
22050 READ (_FIL_NO,KEY=FS6_KEY$,KNO=7,DOM=NEXT_I)
22060 ! 
22070 ! 
22075 ! 
22080 GOSUB GET_TYPE_DESC
22090 GOSUB GET_ITEM_DESC
22100 GOSUB LOAD_LISTBOX
22110 NEXT_I:NEXT 
22120 RETURN 
25000 ! 25000 - Load items into listbox
25005 LOAD_LISTBOX:! COLUMN SEPARATOR IS SEP
25006 ! IF ANS$="YES" AND PRIC_EXT_INV_TO_DATE=0 THEN GOTO 21050
25007 IF %P0$(243,1)<>"Y" THEN BL$=""; READ (_FS1,KEY=ORDER_DIV$+ORDER_NUM$,DOM=*NEXT)FS1$; IF FS1$(63,1)="Y" AND (FS6_KEY$(1,10)=FS1$(6,10)) THEN BL$='SF'+'_CYAN'; CALL "*WINGRP;SHOW",INVO.GRP$ ELSE IF FS6_KEY$(1,10)=FS1$(6,10) THEN BL$='SF'+'_GREEN'; CALL "*WINGRP;SHOW",INVO3.GRP$ ! SSP210101 jdf    
25008 IF %P0$(243,1)="Y" THEN %BL$=""; READ (_FS1,KEY=ORDER_DIV$+ORDER_NUM$,DOM=*NEXT)FS1$; IF FS1$(63,1)="Y" AND (FS6_KEY$(1,10)=FS1$(6,10)) THEN %BL$="*** Invoicing in Progress ***" ELSE IF FS6_KEY$(1,10)=FS1$(6,10) THEN %BL$="*** Open Order ***" ! SSP210101 jdf    
25009 IF %P0$(243,1)="Y" THEN %BL$="",%COLOR_LN=7,%COLOR_LN$='BLACK'; READ (_FS1,KEY=ORDER_DIV$+ORDER_NUM$,DOM=*NEXT)FS1$; IF FS1$(63,1)="Y" AND (FS6_KEY$(1,10)=FS1$(6,10)) THEN %COLOR_LN=14,%COLOR_LN$='SF'+'CYAN',%BL$="*** Invoicing in Progress ***" ELSE IF FS6_KEY$(1,10)=FS1$(6,10) THEN %COLOR_LN=10,%COLOR_LN$='SF'+'GREEN',%BL$="*** Open Order ***" ! SSP210101 jdf    
25010 IF %P0$(243,1)="Y" THEN RETURN ! SSP210101 jdf
25011 CALL "ZZWDTE;DISPLAY",INV_DATE$
25012 QTY=FN%QTY_IN_UM(QTY_INV_TO_DATE,SELL_UM$,QTY_PER) ! IF QTY_PER<>0 AND QTY_INV_TO_DATE<>0 THEN QTY=QTY_INV_TO_DATE/QTY_PER ELSE QTY=QTY_INV_TO_DATE
25015 COLUMNS$=BL$+INV_DATE$+SEP+BL$+INV_NUM$+SEP+BL$+ITEM_CODE$+SEP+BL$+ITEM_DESC$+SEP+BL$+STR(QTY:"##,###,###-")+SEP+BL$+SELL_UM$+"/"+STR(QTY_PER:"##,##0")+SEP+BL$+STR(UNIT_PRICE:"###,###.00#")+SEP+BL$+STR(UNIT_COST:"###,###.00#")+SEP+BL$+PROD_CODE$+SEP+BL$+HIST_TYPE$+SEP+BL$+TYPE_DESC$+SEP+BL$+SEQ_NUM$+SEP+BL$+FN%ZZDISP$(ORDER_DIV$+ORDER_NUM$,"O/P") ! SSP217149 jdf
25020 ! ++CUR_NUM_INV; LIST_BOX LOAD DETAILS.CTL,0,COLUMNS$ ! SSP 225600
25030 DETAILS.CTL'ITEM=I
25050 DETAILS.CTL'ITEMTEXT$=COLUMNS$
25090 RETURN 
25095 ! 
26000 GET_TYPE_DESC:
26005 TYPE_DESC$=""
26010 ON POS(HIST_TYPE$="BDFHJMZ") GOTO 26090,26020,26025,26030,26035,26040,26045,26050
26020 TYPE_DESC$=MSG("CUSTOM_ORD"); GOTO GET_TYPE_DESC_END
26025 TYPE_DESC$=MSG("CUST_INV"); GOTO GET_TYPE_DESC_END
26030 TYPE_DESC$=MSG("STOCK_INV"); GOTO GET_TYPE_DESC_END
26035 TYPE_DESC$=MSG("NONSTOCK"); GOTO GET_TYPE_DESC_END
26040 TYPE_DESC$=MSG("SPEC_CHRGS"); GOTO GET_TYPE_DESC_END
26045 TYPE_DESC$=MSG("MESS_LNS"); GOTO GET_TYPE_DESC_END
26050 TYPE_DESC$=MSG("HID_INV"); GOTO GET_TYPE_DESC_END
26090 GET_TYPE_DESC_END:RETURN 
26095 ! 
28000 ! 
28010 HIST_LINE_INFO:
28020 LIST_BOX READ DETAILS.CTL,IDX
28030 LIST_BOX FIND DETAILS.CTL,IDX,LINE_INFO$
28035 XX=POS($1B53461B4236$=LINE_INFO$); IF XX<>0 THEN LINE_INFO$=LINE_INFO$(1,XX-1)+LINE_INFO$(XX+6); GOTO 28035
28037 XX=POS($1B53461B4232$=LINE_INFO$); IF XX<>0 THEN LINE_INFO$=LINE_INFO$(1,XX-1)+LINE_INFO$(XX+6); GOTO 28037
28040 ORD_DATE$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28050 ORD_NUM$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28060 ITEM_NUM$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28070 ITEM_DESC$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28080 ORD_QTY$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28090 PRICE$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28100 U_M$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28110 TF_COST$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28120 PROD_CODE$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28125 TF_TYPE$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28127 TYPE_DESC$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28130 SEQ_NUM$=LINE_INFO$(1,POS(SEP=LINE_INFO$)-1); LINE_INFO$=LINE_INFO$(POS(SEP=LINE_INFO$)+1)
28135 INV_NUMBER$=LINE_INFO$
28137 IF %OP_DIV_LEN=0 THEN INV_NUMBER$="00"+INV_NUMBER$ ! SSP217149 jdf
28140 ORDER_LINE$=CUSTOMER$+TF_TYPE$(1,1)+ITEM_NUM$+STP(INV_NUMBER$,3,"-")+SEQ_NUM$
28150 PROCESS "FMGIAI","../FMG/FM.EN",ORDER_LINE$
28160 ! GOTO WAIT
28190 RETURN 
30000 SEL_RECORD:
30010 ENTER HIST_TYPE$,ORDER_TYPE$,ITEM_CODE$,SELL_QTY,SELL_UM$,QTY_PER,INV_DATE$,PRIC_EXT_INV_TO_DATE,ORDER_DIV$,ORDER_NUM$
30015 IF NUL(INV_DATE$) THEN EXIT 123
30018 IF %ANS$="YES" AND PRIC_EXT_INV_TO_DATE=0 THEN EXIT 123
30020 GOSUB GET_TYPE_DESC; %TYPE_DESC$=TYPE_DESC$
30030 %MSG_1$=DIM(10); IF ORDER_TYPE$="B" THEN %MSG_1$="Bill as Ship"
30040 CALL "ZZWLKU;PARSE_CUST",%CUSTOMER$,CUST_DIV$,CUST_CODE$
30042 %IC0=FN%FFN("IC0"+%C$)
30050 _FS1=%FS1,_IC0=%IC0,_FM1=%FM1,_FMP=%FMP,_FS9=%FS9,FS6_KEY$=CUST_DIV$+CUST_CODE$; GOSUB GET_ITEM_DESC; %ITEM_DESC$=STP(ITEM_DESC$) ! SSP210101 jdf
30060 %QTY=FN%QTY_IN_UM(SELL_QTY,SELL_UM$,QTY_PER)
30065 %COLOR_LN$="",%MESS_COLOR$='B>'+'BLACK'+"*** Invoicing in Progress ***"+SEP+'B:'+'BLACK'+"*** Open Order ***"+SEP
30070 GOSUB LOAD_LISTBOX
30100 EXIT 
30210 %TT+=1; IF MOD(%TT,2)=0 THEN %COLOR_LN$='YELLOW' ELSE %COLOR_LN$='GREEN'
31000 SEL_REC:
31020 DD=HFN; OPEN (DD,IOL=*)"FS6500"
31030 LIST_BOX LOAD LB_LINE.CTL,""
31040 ESCAPE 
31050 READ (DD,END=0999)
31060 CC+=1; LIST_BOX LOAD LB_LINE.CTL,0,FN%ZZDISP$(CUST_DIV$+CUST_CODE$,"A/R")+SEP+"NAME "+STR(CC)+SEP+ITEM_CODE$+SEP+"DESC "+STR(CC)
31070 IF CC>=10 THEN EXIT 
31080 GOTO 31050
56000 ! "206118-00-TVIINC, Invoiced Order History by Date, doesn't say      
56001 ! "206686-Order history inquiry display screen has changed. Would like
56003 REM "211380-TopForm file feldnames which are SQL keywords break Oracle. 
56005 REM "217149-Order Number does not display correctly when the company is 
56006 REM "222049-Issue with invoiced order history                           
56007 REM "222476-Invoiced Order History by date (GUI) isn't sorting correctly
56008 REM "225600-Load fixed number of invoices, button to load next screenful
56009 ! "230681-Getting an error 046 in gui Order History look up by item.  
