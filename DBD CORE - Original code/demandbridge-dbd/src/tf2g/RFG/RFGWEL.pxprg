0010 REM "WMS Welcome Program <RFGWEL>"
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 06/18/21 - 14.469853 - jvv - SSP# 307360
0037 REM "307360-Allow for singe role login for WMS web page                 
0040 REM "Copyright 2021 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,EC_PARM$,EC${ALL},DATA${ALL},NUM_ENTRIES,OUTPUT
0100 SETERR 9000
0110 X0$="RFGWEL",X1$="WMS Welcome Program"
0120 EOL$=$0D0A$; REM EOL$=ATH(STP(EC_PARM$(57,8),1))
0127 HTML_TEXT$="Content-type: text/html"
0140 DIM MESS_INFO$[20]
0310 IOLIST RFK$
0500 REM "Open files
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01O RFK...  13O ZZPARM"
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0599 ! 
0600 REM "Find user
0610 FIND (Z[1],KEY=EC$[2](1,15),DOM=*NEXT)IOL=0310
0620 ! GOSUB CHECK_WMS_ROLES ;!SSP 307360
0699 ! 
1000 REM "Process DATA array
1010 FOR I=1 TO NUM_ENTRIES
1015 TAG$=DATA$[I,0],VALUE$=DATA$[I,1]
1020 T_IN=POS("."=TAG$); IF T_IN THEN TAG_PARM$=MID(TAG$,T_IN+1),TAG$=MID(TAG$,1,T_IN-1) ELSE TAG_PARM$=""
1025 SWITCH TAG$ ! 1185 end switch
1035 CASE "template"; TEMPLATE$=VALUE$; IF MULTIPLE_ROLES=1 THEN DATA$[I,1]=NEW_TEMPLATE$; %NEW_CALL_PROG=1; END_IF ; BREAK
1036 CASE "basic"; IF MULTIPLE_ROLES=1 THEN DATA$[I,1]=NEW_BASIC$; %NEW_CALL_PROG=1; END_IF ; BREAK
1180 DEFAULT ; VIA TAG$=VALUE$; BREAK ! Set to same name variable as TAG$
1185 END SWITCH ! 1050
1190 NEXT I
1195 DIM BYBINFO$[5]; BYBINFO$[1]=PGN,BYBINFO$[2]="227739.20090320",BYBINFO$[3]=TEMPLATE$,BYBOPTIONS$=""
1200 ! 
1500 REM "Fill out the template
1504 IF NOT(NUL(%BASIC2$)) OR %NEW_CALL_PROG THEN GOTO 2990 ! Skip outputting template if additional program to be done
1505 CLOSE (100); OPEN (100,OPT="TEXT",ERR=9000)TEMPLATE$
1510 READ (100,END=2950)LINE$; LINE$=FNBYB$(LINE$)
1515 CHKTAG=1
1520 WHILE CHKTAG ! 2800 wend
1522 P1=MSK(LINE$,"\?tf\?[^?]*\?"); IF P1=0 THEN CHKTAG=0; BREAK
1530 TAG$=LINE$(P1,MSL); LINE1$=LINE$(1,P1-1),LINE2$=MID(LINE$,P1+MSL)
1600 SWITCH TAG$ ! 2790 end switch
2785 DEFAULT ; LINE$=LINE1$+LINE2$ ! didn't match existing tag, so remove it
2790 END SWITCH ! 1600
2800 WEND ! 1520
2810 IF LINE$<>"" THEN PRINT (OUTPUT)LINE$
2900 GOTO 1510; REM next read
2990 GOTO 9900
5100 ADD_MSG_TO_LOG:! Add message to log file
5105 ! Add other info as needed here
5110 MOUT$="SESSION ID|"+EC$[1](1,7)+"|FILE|"+%WEBEC_FILE_NAME$+"|"
5135 MX=FN%_LOG_MESSAGE("MESG",MOUT$)
5145 RETURN 
5149 ! 
8000 CHECK_WMS_ROLES:
8010 WMS_ROLES$=STP(MID(RFK$,111,20),2),MULTIPLE_ROLES=LEN(WMS_ROLES$)
8020 IF MULTIPLE_ROLES<>1 THEN GOTO *RETURN
8040 SWITCH WMS_ROLES$
8045 CASE "R" ! Receiving
8047 NEW_BASIC$="RFGRH0",NEW_TEMPLATE$="rfgrh0.htm"; BREAK
8048 CASE "B" ! Bin change
8049 NEW_BASIC$="RFGBH0",NEW_TEMPLATE$="rfgbh0.htm"; BREAK
8050 CASE "A" ! Put Away
8052 NEW_BASIC$="RFGAH0",NEW_TEMPLATE$="rfgah0.htm"; BREAK
8055 CASE "P" ! Picking
8057 NEW_BASIC$="RFGPH0",NEW_TEMPLATE$="rfgph0.htm"; BREAK
8060 CASE "I" ! Inventory Counting
8062 NEW_BASIC$="RFGIH0",NEW_TEMPLATE$="rfgih0.htm"; BREAK
8070 DEFAULT 
8080 END SWITCH 
8095 RETURN 
8099 ! 
8800 DEF FNBYB$(LOCAL DATA$)
8801 ! Send DATA$ through EC3BYB
8820 CALL "EC3BYB",ERR=*NEXT,X3$,X4$,EC_PARM$,EC${ALL},DATA${ALL},NUM_ENTRIES,OUTPUT,DATA$,BYBINFO${ALL},BYBOPTIONS$,100 ! 227154
8840 RETURN DATA$
8845 END DEF
8849 ! *****************************************************
8920 DEF FNN(LOCAL DATA$)
8925 LINE$=LINE1$+DATA$+LINE2$
8930 RETURN 0
8940 END DEF
8949 ! 
9000 REM "ERROR PROCESSING
9002 J=ERR,K=TCB(5); SETERR 0000; ENDTRACE 
9010 LAST_WEBEC_ERR$="ERR: "+STR(J)+" AT: "+STR(K); LAST_WEBEC_ERR$=GBL("LAST_WEBEC_ERR",LAST_WEBEC_ERR$); REM "131928
9090 GOTO 9900
9900 REM "End
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9950 EXIT 
9999 END 
56002 REM "227739-WMS: EC program and template modifications to allow WMS user
