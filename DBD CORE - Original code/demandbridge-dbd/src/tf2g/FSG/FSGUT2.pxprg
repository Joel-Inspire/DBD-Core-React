0010 ! FSGUT2 - Delete Invalid Usage Records
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 09/13/10 - 11.183611 - tma - SSP# 240971
0037 REM "240971-FSGUT2-delete Invalid Useage Data - Does not appear to work 
0040 REM "Copyright 2010 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 PROCESS "FSGUT2","../FSG/FS.EN"
0060 EXIT 
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,Q0$,Q1$
0100 SETERR 9000
0101 INIT:
0110 X0$="FS2UT2",X1$="Delete Invalid Usage Data"
0120 DIM S$(40),A[31],C[15]
0130 K0=20,K1=1
0135 C9=-1
0200 REM "
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,-1,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=MNM('GS')+Z0$+MNM('GE')
0300 REM "IOLISTS
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14],A[15],A[16],A[17],A[18],A[19],A[20],A[21],A[22],A[23],A[24],A[25],A[26],A[27],A[28],A[29],A[30],A[31]
0330 IOLIST C$,C9$,C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8],C[9],C[10],C[11],C[12],C[13],C[14],C[15]
0399 IOLIST L$,L[0],L[1],L[2],L[3],L[4],L[5],L[6],L[7],L[8],L[9],L[10],L[11],L[12],L[13],L[14],L[15],L[16],L[17],L[18],L[19],L[20],L[21],L[22],L[23],L[24]
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01O FM1...  02O FMP... 03O FM4... 05O AR1...  06L FSW... 07O FM3...  08O FM0...  13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0585 RT_PARM$=""; CALL "RT2PRM",ERR=0586,X3$,X4$,RT_PARM$
0600 REM "
0610 GOSUB 6000
0620 NEXT_ID=CUSTOMER.CTL; EXIT 
0640 IF Q1$<>"*" THEN CALL "ZZPROM",".Y",X3$,Z,"Proceed?","","",0; ON Z GOTO 0641,9900
0700 REM "SELECTED CUSTOMER
0701 SEL_CUSTOMER: REFRESH_FLG=1
0705 Q0$="FM1"; READ (Z[13],KEY="STAT"+Q0$)F9$,F0
0710 Q9$=FNS$(F9$(8,20))
0720 ! PRINT @(12,10),"Enter the customer or leave blank for all:",
0730 DIM W0$(10); W0$(1,10)=CUSTOMER$ ! CALL "ZZENTR","AXU",A{ALL},W0$,X4$,X3$,58,10,1+K9,10,C0,"A/R","{1"+X$,"","AR2MAA00","AR1","",""
0740 IF W0$(1,10)=S$(1,10) THEN GOTO 0840 ELSE FIND (Z[5],KEY=W0$,DOM=0730)
0750 ! PRINT 'CF'
0840 FOR X=0 TO 9; F1$=F1$+F9$(49+X*17,5),F2$=F2$+F9$(54+X*17,12); NEXT X
0845 X9$="",X8$=""
0850 FOR X=0 TO 9
0855 IF F1$(X*5+1,1)<>" " THEN IF X<5 THEN X9$=X9$+", "+F1$(X*5+1,1)+"="+FNS$(F2$(X*12+1,12)) ELSE X8$=X8$+", "+F1$(X*5+1,1)+"="+FNS$(F2$(X*12+1,12))
0856 IF F1$(X*5+2,1)="Y" THEN F3$=F3$+F1$(X*5+1,1)
0857 F5$=F5$+F1$(X*5+1,1)
0860 NEXT X
0865 X9$=X9$(3),F5$=F5$(1,POS(" "=F5$+" ")-1)
0870 IF LEN(X8$)>2 THEN X8$=X8$(3),X9$=X9$+","
0920 IF W0$<>S$(1,10) THEN READ (Z[1],KEY=W0$,DOM=0921)
0921 RETURN ! NEXT_ID=BT_PROCEED.CTL; RETURN !SSP#240923
0925 PROCEED:
0990 ML_MESS.CTL'VALUE$="Processing Data...",ML_MESS1$="For usage at customer location:"
1000 REM "Look at ship-tos
1010 L0$="",L0=0,L1=0
1020 READ (Z[8],KEY="C"+W0$,DOM=1021)
1030 READ (Z[8],END=1200)Q$; IF W0$<>S$(1,10) THEN IF Q$(1,11)<>"C"+W0$(1,10) THEN GOTO 1200
1035 L0$=L0$+Q$(12,4),L0=L0+1
1036 IF Q$(223,1)=" " THEN L1$=L1$+Q$(12,4),L1=L1+1; IF POS(Q$(2,10)=L2$,10)=0 THEN L2$=L2$+Q$(2,10)
1040 GOTO 1030
1200 REM 
1210 ML_MESS1.CTL'VALUE$=STR(L0)+" locations found, "+STR(L1:"##0")+" with blank FMS method."
1220 IF L1=0 THEN NEXT_ID=CUSTOMER.CTL; EXIT ! THEN CALL "ZZPROM","4",X3$,0,"","","",0; GOTO 0010
1230 ! CALL "ZZPROM","Y",X3$,S3,"Proceed with removal of usage data?","","",0; IF S3=1 THEN GOTO 0010
1231 MSGBOX "Proceed with removal of usage data",MSG("CONFIRMING"),"?,YESNO",OPT$; IF OPT$="NO" THEN NEXT_ID=CUSTOMER.CTL; EXIT 
1400 REM "Process FM3 stat file for records
1410 READ (Z[7],KEY=W0$(1,10),DOM=1411)
1420 K$=KEY(Z[7],END=1600); READ (Z[7]); IF W0$(1,10)<>S$(1,10) THEN IF K$(1,10)<>W0$(1,10) THEN GOTO 1600
1425 IF POS(K$(1,10)=L2$,10)=0 THEN GOTO 1420
1430 READ (Z[8],KEY="C"+K$(1,10)+K$(21,4),DOM=1431)Q$; IF Q$(223,1)<>" " THEN GOTO 1420
1435 ML_MESS1.CTL'VALUE$=ML_MESS1$+" "+K$
1440 REMOVE (Z[7],KEY=K$); L2=L2+1; IF RT_PARM$<>"" THEN CUST$=K$(1,10); CALL "RT2WOC",ERR=1441,X3$,X4$,CUST$,"FM3...","D",K$
1490 GOTO 1420
5000 REM "EOJ
5020 IF Q1$<>"*" THEN MSGBOX "Process complete"+SEP+SEP+STR(L2)+" Records Deleted",MSG("CONFIRMING"),"!,TIM=5"
5030 CMD_STR$="E"; EXIT 
5040 GOTO 9900
6000 REM "BACKGROUND
6001 GOTO 6190
6005 PRINT (0,ERR=6016)'SB',
6020 PRINT @(0,4),"This utility will process the ship-to records for the specified FMS customer.   If the FMS method for a location is set to blank (meaning NO FMS tracking) then the program will delete all usage records at that location.   Afterwards, the   Rebuild Average Usage utility must be run."
6165 PRINT (0,ERR=6166)'SF',
6190 RETURN 
7300 REM "
7310 Q$="R"
7315 X$=A1$(LEN(A1$))
7316 X9=POS(X$=F1$,5)
7320 DIM A[24]; CALL "ZZPACK",X3$,Q$,F1$(X9+2,3),P9$,0,0,A{ALL},Z[7],X$,A1$(1,LEN(A1$)-1),F9$
7390 RETURN 
7700 REM "RECALC AVG USAGE
7705 PRINT @(25,21),'CE',"Recalculating Average from History...",
7710 U1=A[0]; CALL "FM2UBD",X3$,A1$,U0,P1$
7715 PRINT @(0,21),'CE',"Calculated average (Through period ",P1$(5,2),"/",P1$(1,4),"): ",U0:M0$
7720 Q$="Do you wish to update the current average with the calculated value?"; CALL "ZZPROM","Y",X3$,S3,Q$,"","",0
7725 ON S3 GOTO 7730,7780
7730 GOSUB 7740; GOTO 1800
7740 A[0]=U0,Z9=1; PRINT @(29,14),A[0]:M0$,
7745 EXTRACT (Z[3],KEY=A$(1,20))IOL=0330
7750 C[24]=C[24]-U1+U0
7755 WRITE (Z[3],KEY=A$(1,20))IOL=0330; IF RT_PARM$<>"" THEN CUST$=A$(1,10); CALL "RT2WOC",ERR=7756,X3$,X4$,CUST$,"FM4...","U",A$(1,20)
7760 U1=A[0]
7785 PRINT @(0,21),'CE',
7795 RETURN 
8910 DEF FNS$(Z9$)=Z9$(1,POS(S$=Z9$+S$)-1)
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9905 END_PRG:
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
56000 REM "240923-On the FSGUT2, Delete invalid usage data, you have to click 
56001 REM "240971-FSGUT2-delete Invalid Useage Data - Does not appear to work 
