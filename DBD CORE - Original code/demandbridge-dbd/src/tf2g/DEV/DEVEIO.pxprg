0020 ! "DEVEIO" : Embedded IO based debug utility pgm
0035 REM "5.7 - 03/29/21 - 11.472016 - crg - SSP# 307340
0037 REM "307340-DBD-157 - Embedded IO programming related fixes             
0040 REM "Copyright 2021 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0042 ! *** Open ***
0043 ON_OPEN: EVENT$="ON_OPEN",MSG_INDEX=41,LOG_INDEX=42
0044 EVENT_MISC_MSG$=" [LFO] "+STR(LFO)
0045 GOSUB PROCESS_EVENT
0046 EXIT 
0050 ! *** Close ***
0060 PRE_CLOSE: EVENT$="PRE_CLOSE",MSG_INDEX=43,LOG_INDEX=44
0065 GOSUB PROCESS_EVENT
0070 EXIT 
0080 ! *** Write ***
0090 PRE_WRITE: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0100 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0101 EVENT$="PRE_WRITE",MSG_INDEX=49,LOG_INDEX=50
0110 GOSUB PROCESS_EVENT
0120 EXIT 
0130 POST_WRITE: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0140 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0141 EVENT$="POST_WRITE",MSG_INDEX=51,LOG_INDEX=52
0150 GOSUB PROCESS_EVENT
0160 EXIT 
0170 ! *** Read ***
0180 PRE_READ: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0190 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0191 EVENT$="PRE_READ",MSG_INDEX=45,LOG_INDEX=46
0200 GOSUB PROCESS_EVENT
0210 EXIT 
0220 POST_READ: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0230 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0231 EVENT$="POST_READ",MSG_INDEX=47,LOG_INDEX=48
0240 GOSUB PROCESS_EVENT
0250 EXIT 
0260 ! *** Extract ***
0270 PRE_EXTRACT: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0280 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0281 EVENT$="PRE_EXTRACT",MSG_INDEX=53,LOG_INDEX=54
0290 GOSUB PROCESS_EVENT
0300 EXIT 
0310 POST_EXTRACT: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0320 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0321 EVENT$="POST_EXTRACT",MSG_INDEX=55,LOG_INDEX=56
0330 GOSUB PROCESS_EVENT
0340 EXIT 
0350 ! *** Remove ***
0360 PRE_REMOVE: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0370 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0371 EVENT$="PRE_REMOVE",MSG_INDEX=57,LOG_INDEX=58
0380 GOSUB PROCESS_EVENT
0390 EXIT 
0400 POST_REMOVE: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0410 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0411 EVENT$="POST_REMOVE",MSG_INDEX=59,LOG_INDEX=60
0420 GOSUB PROCESS_EVENT
0430 EXIT 
0440 ! *** Functions ***
0450 PRE_IND: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0460 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0470 EVENT$="PRE_IND",MSG_INDEX=61,LOG_INDEX=62
0480 GOSUB PROCESS_EVENT
0490 EXIT 
0500 PRE_KEY: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0510 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0520 EVENT$="PRE_KEY",MSG_INDEX=63,LOG_INDEX=64
0530 GOSUB PROCESS_EVENT
0540 EXIT 
0550 PRE_KEF: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0560 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0570 EVENT$="PRE_KEF",MSG_INDEX=65,LOG_INDEX=66
0580 GOSUB PROCESS_EVENT
0590 EXIT 
0600 PRE_KEL: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0610 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0620 EVENT$="PRE_KEL",MSG_INDEX=67,LOG_INDEX=68
0630 GOSUB PROCESS_EVENT
0640 EXIT 
0650 PRE_KEN: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0660 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0670 EVENT$="PRE_KEN",MSG_INDEX=69,LOG_INDEX=70
0680 GOSUB PROCESS_EVENT
0690 EXIT 
0700 PRE_KEC: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0710 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0720 EVENT$="PRE_KEC",MSG_INDEX=71,LOG_INDEX=72
0730 GOSUB PROCESS_EVENT
0740 EXIT 
0750 PRE_KEP: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0760 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0770 EVENT$="PRE_KEP",MSG_INDEX=73,LOG_INDEX=74
0780 GOSUB PROCESS_EVENT
0790 EXIT 
0800 PRE_RNO: LOCAL TF_VALUE$,ACCESS_MODE,KEY$,INDEX,ACCESS_OPT
0810 ENTER ACCESS_MODE,KEY$,INDEX,TF_VALUE$,ACCESS_OPT,ERR=*NEXT
0820 EVENT$="PRE_RNO",MSG_INDEX=75,LOG_INDEX=76
0830 GOSUB PROCESS_EVENT
0840 EXIT 
0850 ! 
2000 ! ACCESS_MODE: 0=NEXT / 1=KEY / 2=IND / 3=RNO
2010 ! KEY$       : Value of KEY or NULL
2020 ! INDEX      : Value of IND= or RN0=
2030 ! TF_VALUE$     : in PRE code -> value of KEY/IND/RNO (RD/WR/EXTR/REM)
2040 ! TF_VALUE$     : in POST code -> value of RECORD (RD/WR/EXTR)
2050 ! ACCESS_OPT : 1=DOM / 2=END / 4=NUL / 8=BSY / 16=FIND / 32=EXTRACT
2060 ! 
2070 ! RETURN data logic:
2080 ! PRE/POST_READ/EXTRACT + PRE_WRITE : The data record
2090 ! EXIT value: error returned to application program
2100 ! 
2110 REM "Construct message text
2120 FORMAT_MSG:
2130 MSG$=""+DTE(0:"%Y-%Mz-%Dz|%Hz:%mz:%sz")+" |"+DEVEIO_FILE_NAME$+"| EVENT : "+EVENT$+SEP
2140 MSG$+="KEY         : "+KEY$+SEP
2150 MSG$+="INDEX       : "+STR(INDEX)+SEP
2160 MSG$+="VALUE       : "+SUB(TF_VALUE$,SEP,"+$8A$+")+SEP
2170 MSG$+="ACCESS MODE : "+TBL(ACCESS_MODE,"NEXT","KEY","IND","RNO","UNKNOWN")+SEP
2180 MSG$+="ACCESS OPTS : "+TBL((POS(STR(ACCESS_OPT:"#0")=" 1 2 4 81632",2)+1)/2,"UNKNOWN","DOM","END","NUL","BSY","FIND","EXTRACT","UNKNOWN")+SEP
2185 IF NOT(NUL(EVENT_MISC_MSG$)) THEN MSG$+="EVENT MISC  : "+EVENT_MISC_MSG$+SEP; EVENT_MISC_MSG$=""
2190 MSG$+="STACK       : "+FN%GET_STACK$+SEP
2195 MSG$+="OPERATOR    : "+MID(%X3$,40,3)+SEP
2200 MSG$+=DIM(60,"*")
2210 RETURN 
2220 ! 
2230 REM "Display message in dialog
2240 DISPLAY_MSG:
2250 GOSUB FORMAT_MSG
2260 MSGBOX MSG$
2270 RETURN 
2280 ! 
2290 REM "Write message to EIO log
2300 LOG_MSG:
2310 EIO_LOGFILE$=%DATAPATH$+DLM+"log"+DLM+"EIODebug."+FID(0)+".log"
2320 IF NOT(%EIO_LOG) THEN {
2330 SERIAL EIO_LOGFILE$,ERR=*NEXT
2340 %EIO_LOG=GFN; OPEN LOCK (%EIO_LOG)EIO_LOGFILE$
2350  }
2360 GOSUB FORMAT_MSG
2370 PRINT (%EIO_LOG)MSG$
2380 RETURN 
2390 ! 
2400 PROGRAM_VERIFY:! Return a string to verify this is a program
2410 ENTER X$
2420 X$="Embedded I/O debug utility"
2430 EXIT 
2440 ! 
2450 PROCESS_EVENT:
2460 DEVEIO_FILE_NAME$=FIN(LFA,"FILENAME") ! Get last file accessed
2470 IF POS("DEVEAA"=FN%GET_STACK$)>0 THEN EXIT ! File access in DEVEAA to be ignored
2471 IF POS("UPDT"=FN%GET_STACK$)>0 THEN EXIT ! File access in "updt" pgms to be ignored
2480 FILE_PARAM_VAR$="%EIO_"+DEVEIO_FILE_NAME$+"$"
2490 ! Get file debug params, if not already available
2500 IF NUL(VIS(FILE_PARAM_VAR$)) THEN {
2510 EIO=HFN; OPEN (EIO)"EIO"+%C$
2520 READ (EIO,KEY=PAD(MID(DEVEIO_FILE_NAME$,1,3)+%C$,10),DOM=2540)PARAM$
2530 VIA FILE_PARAM_VAR$=PARAM$
2540 CLOSE (EIO)
2550  }
2560 ! File debug params found, now proceed with processing event
2570 PARAM$=VIS(FILE_PARAM_VAR$)
2580 IF MID(PARAM$,MSG_INDEX,1)="Y" THEN GOSUB DISPLAY_MSG
2590 IF MID(PARAM$,LOG_INDEX,1)="Y" THEN GOSUB LOG_MSG
2600 RETURN 
9999 END 
56001 REM "307340-DBD-157 - Embedded IO programming related fixes             
