0010 ! Search for Invalid Batch Files <UTGBAT>
0020 ! "5.1 - 08/14/03 - 9.716944 - jir
0030 ! "Copyright 2003 Computer Software Inc.; Norcross, Georgia
0035 REM "5.7 - 12/06/10 - 15.154722 - tma - SSP# 242279
0037 REM "242279-Remove Orphaned Batch files has incorrect wording for status
0040 REM "Copyright 2010 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 PROCESS "UTGBAT","../UTG/UT.EN"
0060 EXIT 
0080 INIT:! 100,10
0090 X0$="UT2BAT",X1$="Check for Orphan Batch Files",BADFILE$="This is a Bad File"
0100 _ZY9=HFN; OPEN (_ZY9)"ZY9"
0110 _ZZE=HFN; OPEN (_ZZE)"ZZE"
0120 _PATH=HFN; OPEN (_PATH)%DATAPATH$
0125 MSGBOX "Do you Wish to Remove all Batch Files with no ZY9 control record",MSG("WARNING"),"?,YESNO",OPT$
0130 PROCEED:
0135 PRINT 'CURSOR'(1),
0140 IF %X3$(77,1)="T" THEN K$=KEY(_PATH,END=0425); READ (_PATH); F$=K$(1,8); GOTO 0190
0150 READ RECORD (_PATH,END=0425)F$
0160 IF MID(F$,1,2)="PV" OR LEN(F$)=2 OR POS("."=F$) OR MID(F$,1,3)="ZZS" OR MID(F$,1,3)="ZZW" OR POS("_"=F$)<>0 THEN GOTO 0130
0170 F$=F$(1,POS($00000000$=F$+$00000000$)-1)
0180 CNH5=HFN; OPEN (CNH5,ERR=0130)F$; R0$=FN%FIN$(CNH5,"NUMREC"); R1$=FN%FIB$(CNH5); CLOSE (CNH5); GOTO 0205
0190 REM 
0200 F$=F$(1,POS("   "=F$+"   ")-1)
0210 IF LEN(F$)<>7 THEN GOTO 0130
0215 IF MID(R1$,19,1)="P" THEN GOTO 0130 ! SSP#242279
0220 IF POS("VIEWER"=UCS(F$))<>0 THEN GOTO 0130
0230 IF F$="TCONFIG" THEN GOTO 0130
0235 FIND (_ZZE,KEY=F$(1,3)+"   ",DOM=0130)F0$; IF MID(F0$,46,1)<>"1" THEN GOTO 0130 ! SSP#242279
0240 IDX+=1; LIST_BOX LOAD LB_LINE.CTL,IDX,F$
0260 IF F0$(46,1)<>"1" THEN LIST_BOX LOAD LB_LINE.CTL,IDX,F$+SEP+" No Batch File"; GOTO 0130
0270 ! THIS IS A BATCH FILE
0280 B=NUM(F$(4,4),ERR=0130)
0290 READ (_ZY9,KEY=F$(4,4)+" ",DOM=0295)F0$; GOTO 0410
0300 F0$=KEY(_ZY9,END=0330)
0310 IF F0$(1,4)<>F$(4,4) THEN GOTO 0330
0320 GOTO 0410
0330 ! THIS IS A BAD FILE
0340 CNH5=HFN; OPEN (CNH5)F$; R0$=FN%FIN$(CNH5,"NUMREC"); R0=NUM(R0$); CLOSE (CNH5); CLOSE (CNH5)
0350 LIST_BOX LOAD LB_LINE.CTL,IDX,*; LIST_BOX LOAD LB_LINE.CTL,IDX,F$+SEP+BADFILE$+SEP+STR(R0)
0360 LIST_BOX LOAD LB_LINE.CTL,IDX,*; LIST_BOX LOAD LB_LINE.CTL,IDX,F$+SEP+BADFILE$+SEP+STR(R0)
0370 ! MSGBOX "Do you Wish to Remove This Batch File : "+F$,MSG("WARNING"),"?,YESNOCANCEL",OPT$; IF OPT$="NO" THEN LIST_BOX LOAD LB_LINE.CTL,IDX,*; LIST_BOX LOAD LB_LINE.CTL,IDX,F$+SEP+BADFILE$+SEP+STR(R0)+SEP+"Not Erased"; GOTO 0420 ELSE IF OPT$="CANCEL" THEN CMD_STR$="E"; EXIT ! ssp#242279
0371 IF OPT$="NO" THEN LIST_BOX LOAD LB_LINE.CTL,IDX,*; LIST_BOX LOAD LB_LINE.CTL,IDX,F$+SEP+BADFILE$+SEP+STR(R0)+SEP+"Not Erased"; GOTO 0420 ELSE IF OPT$="CANCEL" THEN CMD_STR$="E"; EXIT ! ssp#242279
0380 LIST_BOX LOAD LB_LINE.CTL,IDX,*; LIST_BOX LOAD LB_LINE.CTL,IDX,F$+SEP+BADFILE$+SEP+STR(R0)+SEP+"Erased"
0390 ERASE F$
0400 GOTO 0130
0410 LIST_BOX LOAD LB_LINE.CTL,IDX,*; LIST_BOX LOAD LB_LINE.CTL,IDX,F$+SEP+"Has Control Record"+SEP+R0$
0420 GOTO 0130
0430 GOTO 9290
9000 ! 9000,10 ERROR PROCESSING
9010 Y5=ERR,Y6=TCB(5); IF Y5=68 OR Y5=69 THEN GOTO 9210
9020 SETERR 9030; Y8$=LST(PGM(Y6))
9030 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9050 ! 
9060 ON Y7 GOTO 9080,9130,9280,9090,9120
9070 ! 
9080 RETRY 
9090 SETERR 9110
9100 EXECUTE Y7$
9110 SETERR 9000; RETRY 
9120 SETERR 0000; RETRY 
9130 ! TRANSFER CONTROL
9140 ON Y8 GOTO 9290,0125,9335
9150 GOTO 0125
9160 GOTO 9280
9170 SETESC 9200
9180 SETERR 9200
9190 IF X3$(47,1)<>"1" THEN RETURN ELSE SETESC 0000; RETURN 
9200 SETERR 9000; SETESC 9170; RETURN 
9210 ! CTRL LOGIC
9220 SETERR 9000; GOSUB 6400
9230 ON C9 GOTO 0185,0415
9240 RETURN 
9250 ! FILES
9260 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1
9270 RETURN 
9280 ! EXIT PROGRAM
9290 ! END PROGRAM
9300 Y8=2,LB_LINE.CTL'SORT=-4
9310 CLOSE (_ZY9),(_ZZE),(_PATH),(_CNH5,ERR=*NEXT)
9315 PRINT 'CURSOR'(0),
9320 RETURN 
9330 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9340 SETERR 9350; Q1$=A1$; EXIT 
9350 SETESC 9200
9360 RUN "ZMENU"
9370 END 
9999 END 
10000 SEL_LINE:! 10000,10
10010 LIST_BOX READ LB_LINE.CTL,IDX
10020 LIST_BOX FIND LB_LINE.CTL,IDX,REC$
10030 IF POS("Not Erased"=REC$)=0 THEN RETURN ! ssp#242279
10040 F$=REC$(1,POS(SEP=REC$)-1)
10050 ! MSGBOX "Do you Wish to Remove This Batch File : "+F$,MSG("WARNING"),"?,YESNO",OPT$; IF OPT$="NO" THEN RETURN 
10051 IF OPT$="NO" THEN RETURN 
10060 XX=POS("No"=REC$,-1); REC$=REC$(1,XX-1)+REC$(XX+3)
10070 LIST_BOX LOAD LB_LINE.CTL,IDX,*
10080 LIST_BOX LOAD LB_LINE.CTL,IDX,REC$
10090 ERASE F$,ERR=*NEXT
10100 RETURN 
56002 REM "205460-Oracle - FIN(CHANNEL,"NUMREC") changed to use FN%FIN$()     
