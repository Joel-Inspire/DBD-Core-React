0010 REM "A/R Period End Processing <ARGUAA>
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 01/18/18 - 15.700833 - tma - SSP# 297528
0037 REM "297528-A/R Month end will attempt to right a restart record        
0040 REM "Copyright 2018 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 PROCESS "ARGUAA","../ARG/AR.EN"
0060 EXIT 
0090 INIT:
0100 SETERR 9000
0110 X0$="ARGUAA",X1$="A/R Period End Processing"
0120 DIM Z0$(80,"-")
0125 DIM G[4],D[4],Y[4],P[8],X0[4],X1[4],S$(10)
0200 REM "
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,-1,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0280 IOLIST P0$,P[0],P[1],P[2],P[3],P[4],P[5],P[6],P[7],P[8]
0290 IOLIST Y[0],Y[1],Y[2],Y[3],Y[4]
0295 DIM Z0$(80,X3$(235,1)); Z0$=MNM('GS')+Z0$+MNM('GE')
0300 REM "IOLISTS
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14],A[15]
0320 IOLIST B$,B[0],B[1],B[2],B[3],B[4],B[5],B[6],B[7],B[8],B[9],B[10],B[11],B[12],B[13],B[14],B[15],B[16],B[17],B[18],B[19],B[20],B[21]
0330 IOLIST C$,C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8],C[9],C[10],C[11],C[12],C[13]
0340 IOLIST D$,D[0],D[1],D[2],D[3]
0350 IOLIST E$,E[0],E[1],E[2],E[3],E[4],E[5],E[6],E[7]
0360 IOLIST F$
0370 IOLIST G$
0380 IOLIST H$,H[0],H[1],H[2],H[3],H[4],H[5],H[6],H[7],H[8],H[9],H[10],H[11],H[12],H[13],H[14],H[15],H[16]
0390 IOLIST I$,I[0],I[1],I[2],I[3],I[4],I[5],I[6],I[7],I[8],I[9]
0395 IOLIST AR7$(1),AR7[0],AR7[1] ! SSP#225247
0400 IOLIST J$,J[0],J[1],J[2],J[3],J[4],J[5],J[6],J[7],J[8],J[9]
0470 IOLIST G$,G[0],G[1],G[2],G[3],G[4]
0500 REM "FILES
0505 Z=NUM(X3$(60,3)),KEY_SZ=0; DIM Z[Z] ! SSP#244763
0510 Z$="01O AR1...  02O AR0...  03O AR6...  04ORAR7...  05O AR8...  06O AR9...  07O ARA...  08O ARK...  09O ARL...  10O ARM...  11O ARN...  12O ARO...  "
0515 Z$=Z$+"13O ZZPARM  15O ASU...  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 0521,9900
0550 FIND (Z[13],KEY=X3$(9,3)+"A/R",DOM=9800)IOL=0280
0555 FIND (Z[13],KEY=X3$(9,3)+"AR1",DOM=9800)P1$
0560 FIND (Z[13],KEY=X3$(9,3)+"G/L")G0$
0570 FIND (Z[13],KEY=X3$(9,3)+"G/LYE"+P0$(7,4))Y$
0572 IF P0$(118,1)<>"Y" THEN GOTO 0585
0575 Z$="14O ASO...  "
0580 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 0581,9900
0585 W9$=""; CALL "RT2PRM",ERR=0586,X3$,X4$,W9$
0590 IF P0$(125,1)<>"Y" THEN GOTO 0595; REM "WO121235, credit memo info !SSP#244763
0592 Z$="16O AT1...  "
0593 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 0594,9900
0595 SET_PARAM 'XI'; AR7_FID$=FN%FID$(Z[4]); KEY_SZ=ASC(AR7_FID$(11,1)),REC1=DEC(AR7_FID$(12,3)); IF KEY_SZ>0 THEN KEY_SZ=KEY_SZ-4; IF REC1>32767 THEN KEY_SZ=KEY_SZ-2 ! CALL "ZZINFO",Z[4],STATUS,X3$,REC_USED,TOT_REC,KEY_SZ,BYTE,DISC,TYPE,TOT_SEC,FILE_NM$ ! SSP#209664!SSP#231214
0596 SET_PARAM 'XI'=0
0598 ! SET_PARAM 'XI'; AR7_FID$=FN%FID$(Z[4]); KEY_SZ=ASC(AR7_FID$(11,1)); SET_PARAM 'XI'=0 ! SSP#231214
0600 REM "
0660 ! CALL "ZZPROM","P4",X3$,0,U6$,"","",0; U6=LEN(U6$)+2
0670 ! CALL "ZZPROM","P1",X3$,0,U7$,"","",0; U7=LEN(U7$)+2
0680 ! CALL "ZZPROM","P2",X3$,0,U8$,"","",0; U8=LEN(U8$)+2
0690 ! CALL "ZZPROM","P3",X3$,0,U9$,"","",0; U9=LEN(U9$)+2
0730 DIM A$(397),A[15]
0800 REM "CHECK FOR ROOM?
0805 ! CALL "ZZPROM","U1",X3$,0,"","","",0
0810 GOSUB 7800
0830 ! PRINT @(0,22),'CL',
0840 GOTO 0900
0880 REM "PROMPT OUT OF ROOM
0885 X$="There is not enough room to update this data. Press <Return>: "
0890 ! CALL "ZZPROM","U3",X3$,S3,"","","",0; GOTO 9900
0895 MSGBOX MSG("NER_DATA"),MSG("FYI"),"!"; CMD_STR$="END"; EXIT 
0900 REM "RESTART LOGIC
0905 CALL "ZZ2UPL",ERR=*NEXT,X3$,X4$,"ARGUAA","A",RET$; IF RET$<>"Y" THEN CMD_STR$="END"; RETURN ELSE WROTE_LOCK=1
0915 GOSUB 6000
0970 ! CALL "ZZPROM","9",X3$,S3,"","","",0; ON S3 GOTO 0971,9900
0980 CALL "ZZDAPP",X3$,"DALL"
0990 RETURN 
1000 REM "READ NEXT RECORD
1010 PROCESS_UPDATE:
1080 MSGBOX MSG("APGUAA_07"),MSG("FYI"),"!"
1090 ! CALL "ZZPROM","P0",X3$,0,"","","",12
1100 REM "
1110 D1$=Y$(15+NUM(P0$(11,2))*6,6)
1120 GOSUB 6700
1130 GOSUB 7000
1140 P2=4; REM LET P2=2
1150 REM "Only drop stats if last period, R0=1 says that is the case
1155 IF P0$(11,2)=Y$(13,2) THEN R0=1,P2=P2+2 ELSE GOTO 1180
1160 GOSUB 7300
1170 GOSUB 7400
1200 REM 
1210 GOSUB 2000
1215 IF R0=0 THEN GOTO 1240
1220 GOSUB 2800
1230 GOSUB 2900
1240 GOSUB 2200
1250 GOSUB 2600
1260 GOSUB 2700
1270 GOSUB 3000
1280 GOSUB 3100
1800 REM "Finish up period end by updating period
1810 IF P0$(11,2)>=Y$(13,2) THEN P0$(7,6)=STR(NUM(P0$(7,4))+1:"0000")+"01" ELSE P0$(11,2)=STR(NUM(P0$(11,2))+1:"00")
1820 WRITE (Z[13],KEY=X3$(9,3)+"A/R")IOL=0280
1950 GOSUB 5000
1980 CMD_STR$="END"
1990 RETURN 
2000 REM "Remove invoice history records as necessary
2002 PRINT 'DIALOGUE'(10,5,80,25,"")
2006 P0=X[Z[5],0],P1=0,P4=11,P5=16
2007 READ (Z[5],KEY="",DOM=2008)
2010 PRINT @(12,14),U9$," Invoice History...",@(12,18),U8$,
2015 DIM E$(124),E[7]
2020 K$=KEY(Z[5],END=2090)
2025 GOSUB 6800; PRINT @(12+U8,18),K$,
2030 READ (Z[5],END=2090)IOL=0350
2035 IF E$(118,6)>Y4$ THEN GOTO 2080 ! SSP#225247
2040 IF E$(118,6)<=Y4$ THEN REMOVE (Z[5],KEY=K$,DOM=2041); A0=E[0],F=Z[4]; GOSUB 5900 ! SSP#225247
2042 IF P0$(118,1)="Y" AND E$(118,6)<=Y4$ THEN REMOVE (Z[14],KEY=E$(106,6)+E$(11,8),DOM=2043)
2044 IF P0$(125,1)="Y" AND E$(118,6)<=Y4$ THEN REMOVE (Z[16],KEY=K$,DOM=2045); REM "WO121235, credit memo info
2045 IF W9$<>"" THEN CUST$=K$(1,10); CALL "RT2WOC",ERR=2046,X3$,X4$,CUST$,"AR8...","D",K$
2050 Z$="02C AR0...  02O ASG...  "; GOSUB 9750
2055 REMOVE (Z[2],KEY=K$(11,8)+K$(1,10),DOM=2056)
2060 Z$="02C ASG...  02O AR0...  "; GOSUB 9750
2070 REMOVE (Z[15],KEY=E$(1,10)+E$(53,8)+E$(11,8),DOM=2071); REM "WO111625
2080 GOTO 2015
2090 PRINT 'POP'
2095 RETURN 
2200 REM "Process Customers and invoices
2202 PRINT 'DIALOGUE'(10,5,80,25,"")
2205 P0=X[Z[1],0],P1=0,P4=11,P5=16
2210 READ (Z[1],KEY="",DOM=2211)
2215 PRINT @(12,14),U7$," Customers and Invoices...",@(12,18),U8$,@(12,20),U6$,
2220 K$=KEY(Z[1],END=2285); DIM A[15]
2222 IF MID(K$,1,10)=MID(S$,1,10) THEN REMOVE (Z[1],KEY=K$); GOTO 2220
2225 GOSUB 6800; PRINT @(12+U8,18),K$,
2230 READ (Z[1],KEY=K$,DOM=2220)IOL=0310
2240 GOSUB 2400
2250 GOSUB 2300
2275 WRITE (Z[1],KEY=K$)IOL=0310
2276 IF W9$<>"" THEN CUST$=K$; CALL "RT2WOC",ERR=2277,X3$,X4$,CUST$,"AR1...","U",K$
2280 GOTO 2220
2285 PRINT 'POP'
2290 RETURN 
2300 REM "Update summary statistics in AR0
2305 DIM B$(53),B[21]
2310 EXTRACT (Z[2],KEY=K$,DOM=2311)IOL=0320; GOTO 2320
2311 B$(1,10)=K$,X$=""; REM "3.0 Don't set up AR0 records for inactive customers
2313 FOR I=0 TO 6; IF A[I+6]<>0 THEN X$="Y"
2314 NEXT I
2315 IF X$="" THEN GOTO 2390
2320 FOR I=0 TO 6
2330 IF A[I+6]<>0 THEN IF B$(I*6+11,4)<D1$(1,4) THEN I0=I*2,B[I0]=B[I0]+1,B[I0+1]=B[I0+1]+A[I+6],B$(I*6+11,6)=D1$
2335 NEXT I
2380 WRITE (Z[2],KEY=K$)IOL=0320
2385 IF W9$<>"" THEN CUST$=K$; CALL "RT2WOC",ERR=2386,X3$,X4$,CUST$,"AR0...","U",K$
2390 RETURN 
2400 REM "Work on invoices for the customer"
2405 A$(391,6)=D1$,A[6]=0,A[7]=0,A[8]=0,A[9]=0,A[10]=0,A[11]=0,A[12]=0
2410 READ (Z[3],KEY=K$,DOM=2411)
2420 K0$=KEY(Z[3],END=2480)
2425 IF K0$(1,LEN(K$))<>K$ THEN GOTO 2480 ELSE DIM C$(139),C[14]
2430 PRINT @(12+U6,20),K0$(LEN(K$)),
2435 READ (Z[3],KEY=K0$,DOM=2420)IOL=0330
2450 IF C[3]=0 AND C$(133,6)<=P0$(7,6) AND MID(C$,160,7)<>"PENDING" THEN GOSUB 2500 ELSE GOSUB 7200
2475 GOTO 2420
2480 ! PRINT 'POP'
2485 IF A[6]>A[14] THEN A[14]=A[6],A$(385,6)=D1$
2490 RETURN 
2500 REM "Move invoice to history file
2510 DIM E$(184),E[7],AR7$(70),AR7(1) ! SSP#225247
2515 READ (Z[5],KEY=C$(1,18),DOM=*NEXT)IOL=0350 ! SSP#225247
2520 E$(1,52)=C$(1,52),E$(53,8)=C$(66,8),E$(61,20)=C$(74,20),E$(81,9)=C$(108,9),E$(90,16)=C$(36,15),E$(106,6)=C$(127,6),E$(112,6)=C$(102,6),E$(118,6)=P0$(7,6)
2522 IF C$(11,7)<>"ONACCNT" THEN E$(124,8)=C$(160,8)
2525 E[0]=C[1],E[1]=E[1]+C[9],E[2]=E[2]+C[7],E[3]=E[3]+C[8],E[4]=E[4]+C[2],E[5]=E[5]+C[10],E[6]=E[6]+C[11] ! SSP#225247
2530 WRITE (Z[5],KEY=E$(1,18))IOL=0350
2531 IF W9$<>"" THEN CUST$=E$(1,10); CALL "RT2WOC",ERR=2532,X3$,X4$,CUST$,"AR8...","U",E$(1,18)
2533 IF KEY_SZ<>0 THEN GOSUB 3300 ! SSP#225247
2534 REM "Remove G/L transactions - 3.0 Don't bother if accrual only, so file may be downsized without regard to existing links
2535 IF G0$(40,1)<>"A" THEN F=Z[12],A0=C[0]; GOSUB 5900
2539 REM "Remove from open invoices
2540 REMOVE (Z[3],KEY=C$(1,18),DOM=2541)
2541 IF W9$<>"" THEN CUST$=C$(1,10); CALL "RT2WOC",ERR=2542,X3$,X4$,CUST$,"AR6...","D",C$(1,18)
2544 REM "Remove from pending file
2545 REMOVE (Z[8],KEY=C$(1,18),DOM=2546); IF C$(168,1)="Y" THEN CALL "AR2DUT",X3$,X4$,3,"",X0{ALL},C$,X1{ALL},0,0,"",0
2549 REM "Remove from alternate sort
2550 REMOVE (Z[11],KEY=C$(1,10)+"A"+C$(20,6)+C$(11,8),DOM=2551)
2551 REMOVE (Z[11],KEY=C$(1,10)+"B"+C$(20,6)+C$(11,8),DOM=2552)
2590 RETURN 
2600 REM "Drop detail from sales tax file
2601 RETURN 
2605 P0=X[Z[9],0],P1=0,P4=11,P5=16
2610 READ (Z[9],KEY="",DOM=2611)
2615 PRINT @(12,14),U9$," Sales tax paid...",@(12,18),U8$,
2620 K$=KEY(Z[9],END=2690)
2625 GOSUB 6800; PRINT @(12+U8,18),K$,
2640 IF K$(1,6)<=Y4$ THEN REMOVE (Z[9],KEY=K$,DOM=2641) ELSE READ (Z[9])
2680 GOTO 2620
2690 PRINT @(12,14),'CE',
2695 RETURN 
2700 REM "Drop detail from commission file
2701 RETURN 
2705 P0=X[Z[10],0],P1=0,P4=11,P5=16
2710 READ (Z[10],KEY="",DOM=2711)
2715 PRINT @(12,14),U9$," Commission paid...",@(12,18),U8$,
2720 K$=KEY(Z[10],END=2790)
2725 GOSUB 6800; PRINT @(12+U8,18),K$,
2740 IF K$(1,6)<=Y4$ THEN REMOVE (Z[10],KEY=K$,DOM=2741) ELSE READ (Z[10])
2780 GOTO 2720
2790 PRINT @(12,14),'CE',
2795 RETURN 
2800 REM "Drop Customer stats
2802 PRINT 'DIALOGUE'(10,5,80,25,"")
2805 P0=X[Z[6],0],P1=0,P4=11,P5=16
2810 READ (Z[6],KEY="",DOM=2811)
2815 PRINT @(12,14),U9$," Customer statistics...",@(12,18),U8$,
2820 K$=KEY(Z[6],END=2890)
2825 GOSUB 6800; PRINT @(12+U8,18),K$,
2840 R1=POS(K$(15,1)=R0$,5)
2850 IF R1=0 THEN READ (Z[6]); GOTO 2870
2860 IF K$(11,4)<R0$(R1+1,4) THEN REMOVE (Z[6],KEY=K$,DOM=2871); IF W9$<>"" THEN CUST$=K$(1,10); CALL "RT2WOC",ERR=2861,X3$,X4$,CUST$,"AR9...","D",K$ END_IF ELSE READ (Z[6])
2880 GOTO 2820
2890 PRINT 'POP'
2895 RETURN 
2900 REM "Drop Salesperson stats
2902 PRINT 'DIALOGUE'(10,5,80,25,"")
2905 P0=X[Z[7],0],P1=0,P4=11,P5=16
2910 READ (Z[7],KEY="",DOM=2911)
2915 PRINT @(12,14),U9$," Salesperson statistics...",@(12,18),U8$,
2920 K$=KEY(Z[7],END=2990)
2925 GOSUB 6800; PRINT @(12+U8,18),K$,
2940 R1=POS(K$(9,1)=R1$,5)
2950 IF R1=0 THEN READ (Z[7]); GOTO 2970
2960 IF K$(5,4)<R1$(R1+1,4) THEN REMOVE (Z[7],KEY=K$,DOM=2971) ELSE READ (Z[7])
2980 GOTO 2920
2990 PRINT 'POP'
2995 RETURN 
3000 REM "Delete inactive customers
3005 P0=X[Z[1],0],P1=0,P4=11,P5=19
3010 PRINT @(0,14),'CL',@(12),U$," Deleting inactive customers..."
3020 READ (Z[1],KEY="",DOM=3021)
3030 K$=KEY(Z[1],END=3090); READ (Z[1])IOL=0310
3035 GOSUB 6800
3040 IF A$(219,1)<>"I" THEN GOTO 3030
3050 Q1$=A$(1,10),Q0$="A/R",Q2$="",Q3$="P"
3060 CALL "AR2UAB",ERR=3061,X3$,X4$,Q0$,Q1$,Q2$,Q3$
3065 READ (Z[1],KEY=K$,DOM=3066)
3070 GOTO 3030
3090 RETURN 
3100 REM "Delete salesman
3110 Z$="02CRAR0...  "
3120 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 3121,9900
3130 Z$="02ORAR3...  "
3140 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 3141,9900
3150 P0=X[Z[2],0],P1=0,P4=11,P5=19
3160 PRINT @(0,14),'CL',@(12),U$," Deleting inactive salesmen..."
3170 READ (Z[2],KEY="",DOM=3171)
3180 K$=KEY(Z[2],END=3290); READ (Z[2])B$
3190 GOSUB 6800
3200 IF B$(203,1)<>"I" THEN GOTO 3180
3210 Q1$=B$(1,4),Q0$="A/R",Q2$="",Q3$="P"
3220 CALL "AR2UAC",ERR=3221,X3$,X4$,Q0$,Q1$,Q2$,Q3$
3225 READ (Z[2],KEY=K$,DOM=3226)
3230 GOTO 3180
3290 RETURN 
3300 REM "AR7 as direct file needs to be marked as a history record!SSP#225247
3305 DIM AR7$(70),AR7(1) ! SSP#225247
3310 READ (Z[4],KEY=E$(1,18),DOM=*NEXT) ! SSP#225247
3320 AR7_KEY$=KEY(Z(4),END=3390); READ (Z[4],KEY=AR7_KEY$)IOL=0395 ! SSP#225247
3330 IF AR7$(1,18)<>E$(1,18) THEN GOTO 3390 ! SSP#225247
3340 AR7$(49,1)="H" ! SSP#225247
3350 WRITE (Z[4],KEY=AR7_KEY$)IOL=0395 ! SSP#225247
3360 GOTO 3320 ! SSP#225247
3390 RETURN ! SSP#225247
5000 REM "END OF UPDATE
5020 _AR7=HFN; OPEN (_AR7)"AR7"+%C$
5025 SET_PARAM 'XI'; AR7_FID$=FN%FID$(_AR7); KEY_SZ=ASC(AR7_FID$(11,1)),R1=DEC(AR7_FID$(12,3)); IF KEY_SZ>0 THEN KEY_SZ=KEY_SZ-4; IF R1>32767 THEN KEY_SZ=KEY_SZ-2 ! SSP#209664!SSP#231214
5026 SET_PARAM 'XI'=0
5030 IF KEY_SZ<>0 THEN CALL "UT2HIS",ERR=*NEXT,X3$,X4$,"","*","AR" ! SSP#225538 !SSP#230159
5031 CLOSE (_AR7)
5040 PRINT @(0,3),'CE',; CALL "AR2UT4",X3$,X4$,"","*" ! SSP#235378 moved line
5100 REM "
5200 REM "CLEAR FILES
5240 PRINT 'CF'
5290 CALL "ZZ2UPL",ERR=*NEXT,X3$,X4$,"ARGUAA","D",RET$
5400 REM 
5450 RETURN 
5900 REM "REMOVE LINES
5910 DIM DET[1]; CALL "AR2XAB",X3$,X4$,F,E$,A0,"",DET{ALL},FLAG$,SEQ$,"D"
5911 GOTO 5990
5920 EXTRACT (F,IND=0,ERR=5960)IOL=0290
5930 A1=Y[1],Y[1]=A0,Y[0]=Y[0]-1
5935 READ (F,IND=A0)A; IF A>0 THEN Y[0]=Y[0]-1,A0=A; IF POS(BIN(A,3)=Y5$,3)=0 THEN Y5$=Y5$+BIN(A,3); GOTO 5935
5940 WRITE (F,IND=A0)A1
5950 Y[4]=-1; WRITE (F,IND=0)IOL=0290
5955 GOTO 5990
5960 IF ERR=0 THEN RETRY ELSE GOTO 9000
5990 RETURN 
6000 REM "BACKGROUND
6005 ! PRINT (0,ERR=6016)'SB',
6020 ! PRINT @(12,4),"This program will perform the period end processing",@(12,5),"for Accounts Receivable for period ",P0$(11,2)," FYE ",P0$(7,4),"."
6025 ! PRINT @(12,7),"This function selectively purges history data based",@(12,8),"on the parameters for this company.  You should verify",@(12,9),"that all reports which may require this data have been",@(12,10),"printed prior to period end processing."
6030 RPT_FISYR$=P0$(7,4); RPT_PER$=P0$(11,2)
6165 ! PRINT (0,ERR=6066)'SF',
6180 REFRESH_FLG=1
6190 RETURN 
6200 REM "DISPLAY DATA
6225 GOSUB 6450
6390 RETURN 
6400 REM "WHOLE SCREEN
6405 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,X5$,X0,X1,0
6410 GOSUB 6000
6430 IF C9>0 THEN GOSUB 6200 ELSE GOSUB 6450
6440 IF ABS(C0)>4 THEN C0=ABS(C0)-5
6445 RETURN 
6490 RETURN 
6600 REM "RESTART LOGIG
6610 ! WRITE (Z[1],IND=I1)V0$,K0$,K1$,K0,K1 SSP#297528 this is AR1 should not write a restart record to AR1
6690 RETURN 
6700 REM "Set Y4$ = FY AP to remove invoice history, based on params
6710 Y1=NUM(P0$(11,2)),Y2=NUM(P0$(41,2)),Y2$=P0$(7,4)
6720 IF Y1-Y2>0 THEN Y4$=Y2$+STR(Y1-Y2:"00"); GOTO 6790
6725 Y2=Y2-Y1,Y2$=STR(NUM(Y2$)-1:"0000")
6730 FIND (Z[13],KEY=X3$(9,3)+"G/LYE"+Y2$,DOM=6731)Y3$; Y1=NUM(Y3$(13,2)); GOTO 6720
6739 REM "Next lower year not found, set purge date to remove all lower ones
6740 Y4$=Y2$+"13"
6790 RETURN 
6800 REM "% complete & phase printing
6801 REM "P4= xpos on scrn,P5= ypos on scrn,P0=total # of recs,P1=counter(inc. in here),P2=total # of phases,P3=current phase(init to 0, incr. when P1 is = 0)
6810 IF P1=0 THEN PRINT @(P4,P5),"     complete",; IF P2>1 THEN P3=P3+1; PRINT ", phase",P3," of",P2," phases"
6820 P1=P1+1; IF P0<>0 THEN PRINT @(P4,P5),P1*100/P0:"###%",
6840 RETURN 
7000 REM "Set up constants for ageing
7005 D2$=D1$
7010 IF P0$(47,1)="Y" THEN GOTO 7090
7020 REM "age by months"
7030 A0$=D2$(1,4),A2=NUM(A0$(3)),A5=4
7040 FOR I=1 TO 4
7050 A1$=A0$(1,2),A3=A2-I; IF A3<1 THEN A3=A3+12; IF A1$(2,1)<>"0" THEN A1$(2,1)=CHR(ASC(A1$(2,1))-1) ELSE A1$=CHR(ASC(A1$(1,1))-1)+"9"
7060 A0$=A0$+A1$+STR(A3:"00")
7070 NEXT I
7080 RETURN 
7090 REM "Set aging if aging is days"
7100 A0$="",A5=6,A1$="      "
7110 FOR I=0 TO 4
7120 CALL "ZZDATE",X3$,"",D2$,A1$,-P[I],0,0,0,0,0,0,"","",""
7130 A0$=A0$+A1$
7140 NEXT I
7150 RETURN 
7200 REM "Age invoice and set A2= total to update and add invoice total to A2 bucket"
7204 REM "Setup to age
7205 IF C$(19,1)="C" THEN A2=8; GOTO 7270
7210 IF P0$(46,1)="Y" THEN D3$=C$(54,6) ELSE D3$=C$(20,6)
7220 FOR I=0 TO 4
7230 IF D3$(1,A5)>A0$(I*A5+1,A5) THEN A2=I+7; EXITTO 7270
7240 NEXT I
7250 REM "if still here then maximum age
7260 A2=12
7270 A[A2]=A[A2]+C[3],A[6]=A[6]+C[3]
7280 RETURN 
7300 REM "Set R0$ to balance types and last year to keep to remove for AR9
7301 REM "e.g. S1985P1984 etc
7305 R0$=""
7310 FOR I=0 TO 9
7320 IF P0$(21+I,1)=" " THEN GOTO 7350
7330 R0$=R0$+P0$(21+I,1)+STR(NUM(P0$(7,4))+1-NUM(P0$(31+I,1)):"0000")
7350 NEXT I
7390 RETURN 
7400 REM "Set R1$ to balance types and last year to keep to remove for ARA
7401 REM "e.g. S1985P1984 etc
7405 R1$=""
7410 FOR I=0 TO 9
7420 IF P1$(9+I,1)=" " THEN GOTO 7450
7430 R1$=R1$+P1$(9+I,1)+STR(NUM(P0$(7,4))+1-NUM(P1$(19+I,1)):"0000")
7450 NEXT I
7490 RETURN 
7500 REM "CUSTOM PROGRAMMING ROUTINES
7800 REM "Load file info
7810 DIM X[Z,1],X$(0)
7815 FOR X=1 TO Z
7820 CALL "ZZINFO",X,0,X3$,A,B,0,0,0,0,0,""; X[X,0]=A,X[X,1]=B
7825 NEXT X
7840 RETURN 
8000 REM "Compute oldest invoice period/year to purge
8010 P0$=F0$(7,6),P0=NUM(F0$(42,2)),P1=NUM(P0$(5,2)),Y=NUM(Y0$(13,2))
8020 P=P1-P0
8025 IF P<1 THEN P0$(1,4)=STR(NUM(P0$(1,4))-1:"0000"),P=P+Y; GOTO 8025
8030 P0$(5,2)=STR(P:"00")
8040 RETURN 
9000 REM "ERROR PROCESSING
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9050 ON Y7 GOTO 9060,9100,9190,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9190 GOSUB 6600; GOTO 9900
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9750 REM 
9760 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0
9770 RETURN 
9810 CALL "ZZPROM","4",X3$,A,"The A/R parameters have not been set for this company. Press |Return","","",0; GOTO 9900
9900 REM "END PROGRAM
9902 WRAPUP:
9904 IF WROTE_LOCK THEN CALL "ZZ2UPL",ERR=*NEXT,X3$,X4$,"ARGUAA","D",RET$
9905 CALL "ZZDAPP",X3$,"AALL"
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9920 SETERR 9940
9930 Q1$=A1$; EXIT 
9940 SETESC 9350
9950 EXIT 
9999 END 
56000 REM "225538-Cash Receipts Journals not attached to invoice history in   
56001 REM "297528-A/R Month end will attempt to right a restart record        
