0010 ! ECGSTS - WebEC Server Monitor
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 04/19/18 - 14.367777 - jvv - SSP# 297583
0037 REM "297583-Graphical version of EC Monitor needs improvements.         
0040 REM "Copyright 2018 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 PROCESS "ECGMJV","../ECG/EC.EN"
0070 EXIT 
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,Q0$,Q1$
0100 INIT:
0110 X0$="ECGSTS",X1$="eCommerce Server Monitor" ! ssp#242161
0120 DIM Z0$(80,"-"),CC[4],LL[4],WW[4],HH[4]
0130 K0=20,K1=1,M0$="#,###,##0",FIRST_LINE=5,SPACING=5,MAX_SERVERS=4
0135 C9=-1,CC(1)=4.7,LL(1)=2.6,CC(2)=46.7,LL(2)=1.6,CC(3)=1.7,LL(3)=15,CC(4)=46.7,LL(4)=15
0200 ! "
0240 CALL "ZZCOMP","","",X2$,X3$,X4$,M9$,X0,X1,0; IF X1>0 THEN GOTO 9920
0242 IF X3$="" THEN CLOSE (14); OPEN (14)"ZZPARM"; READ (14,KEY="TFEEC3STS  ",DOM=0243)X3$,*,X4$ ! "If X3$ not set then read env
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0290 SET_PARAM 'LU' ! We do so much with text files, don't lock them
0295 DIM Z0$(80,X3$(235,1)); Z0$=MNM('GS')+Z0$+MNM('GE')
0300 ! "IOLISTS
0310 IOLIST ECY$
0320 IOLIST ECZ$,ECZ[0],ECZ[1],ECZ[2],ECZ[3],ECZ[4],ECZ[5],ECZ[6],ECZ[7],ECZ[8],ECZ[9],ECZ[10],ECZ[11],ECZ[12],ECZ[13],ECZ[14],ECZ[15],ECZ[16],ECZ[17],ECZ[18]
0500 ! "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01O ECY...  02O ECZ...  13O ZZPARM  14OSZZPARM "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0550 CLOSE (120); OPEN (120,ERR=0551)"EC3STS.LOG"; GOTO 0555
0551 IF ERR<>12 THEN OPEN (120,OPT="TEXT")"EC3STS.LOG"; GOTO 0555 ELSE SERIAL "EC3STS.LOG",0,0; GOTO 0550
0555 MESS$="STARTED"; GOSUB 7600
0560 ! "See if we are the on to monitor
0564 MON_KEY$="EC3STSMN"
0565 FIND (Z[14],KEY=MON_KEY$,DOM=0566,ERR=0568)MONITOR$; ML_MONITOR$="I am the Monitor",REFRESH_FLG=1; GOTO 0570 ! ssp#242161
0566 MONITOR=1,MONITOR$=MON_KEY$+FID(0); WRITE (Z[14],KEY=MON_KEY$)MONITOR$; GOTO 0570 ! "If record not found, set it up and we know we are the monitor
0568 ! "if here, err occurred, probably err 0, so we won't be the monitor
0569 DIM MONITOR$(10); MONITOR=0; REFRESH_FLG=1,ML_MONITOR$="I am NOT the Monitor"; GOTO 0575
0570 ! "If here, we can be the monitor
0572 MONITOR=1; EXTRACT (Z[14],KEY=MON_KEY$,ERR=0568)MONITOR$ ! "If we get error here, then someone got the record or we had readprm on
0575 ! "Done with setting monitor stuff here, so display
0576 IF MONITOR THEN X1$=X1$+" - Monitor ON" ELSE X1$=X1$+" - Monitor OFF"
0578 DISP_MESSAGE$=X1$,REFRESH_FLG=1
0610 GOSUB 6000
1000 ! "Get list of configured servers and load into SERVER$[]
1005 DIM ECY$(512),ECZ$(128),ECZ[18]
1010 DIM SERVER$[100],LAST_TIME[100,1]
1100 ! "Read ECY for servers
1101 SET_FOCUS 0; GOSUB UPDATE_STATUS ! PRINT 'MESSAGE'('_RED'+'WHITE'+"refresh Screen",0); CALL "$CTL-10;AGENT_MSG","Refresh Screen",0; PRINT 'MESSAGE'('F8'+'BLACK'+"",0)!SSP#216436; 268710
1102 IF %SERVER_ID$<>"" THEN S_INDEX=1; READ (Z(1),KEY=%SERVER_ID$)IOL=0310; SERVER$[1]=ECY$; GOTO 1150
1105 S_INDEX=0; READ (Z[1],KEY="",DOM=1106)
1110 DIM ECY$(512); READ (Z[1],END=1150)IOL=0310
1115 S_INDEX=S_INDEX+1; SERVER$[S_INDEX]=ECY$
1145 GOTO 1110
1148 ! "if no servers configured, then give message
1150 SERVER_CONF$=STR(S_INDEX)+" Servers Configured"; RETURN 
1152 SERVER:
1155 IF S_INDEX=0 THEN MSGBOX "There are no WebEC Servers configured on your system!","Warning","!"; GOTO 9900 ELSE S_TOTAL=S_INDEX
1158 ! CALL "ZZTIME",X3$,1,0;! "Update date/time on screen
1175 FIRST_ONE=1; GOSUB 2000 ! "display list
1176 GOSUB 4000 ! "Check for servers running
1178 IF SUB_CALL THEN SUB_CALL=0; RETURN 
1179 IF DISPLAY_ONLY THEN DISPLAY_ONLY=0; GOTO 1200
1200 ! "Prompt for next action
1201 NEXT_ID=ML_OPTIONS.CTL; RETURN 
1210 CALL "ZZPROM","X0EC3STS",X3$,Z,"","","",0
1215 ON Z GOTO 1220,1230,1240,1250,1260,1270,1280,1210
1220 ! "Stop a Server
1225 GOSUB 3000; DISPLAY_ONLY=1; GOTO 1100
1230 ! "Run a Server
1235 GOSUB 3100; DISPLAY_ONLY=1; GOTO 1100
1240 ! "Exit
1245 GOTO 9900
1250 ! "Redisplay status
1255 GOTO 1100
1260 ! "Parameters
1265 CALL "EC3MSA",X3$,X4$,"",""
1267 GOSUB 6400
1268 DISPLAY_ONLY=1; GOTO 1100
1270 ! "View Log
1275 CALL "EC3STL",X3$,X4$,"",""
1277 GOSUB 6400; DISPLAY_ONLY=1; GOTO 1100
1280 ! "Restart a Server
1285 GOSUB 3200; DISPLAY_ONLY=1; GOTO 1100
1995 GOTO 9900
2000 ! "Display page of servers, starting at FIRST_ONE
2006 CURRENT=FIRST_ONE,CURR_LINE=FIRST_LINE,SERVERS_ON_PAGE=0
2010 IF SERVERS_ON_PAGE>=MAX_SERVERS THEN GOTO 2100
2011 GOSUB ASSING_PANEL
2015 DIM ECZ$(128),ECZ[18]; FIND (Z[2],KEY=SERVER$[CURRENT](1,15),DOM=2016)IOL=0320; GOTO 2018
2016 ECZ$(16,10)="STAT N/A"; PRECISION 14; ECZ[0]=FN%GET_DATETIME("",0); PRECISION 2 ! "If not on file, then create default info
2075 GOSUB ASSIGN_VAR_PANEL
2080 IF CURRENT<S_TOTAL THEN SERVERS_ON_PAGE=SERVERS_ON_PAGE+1,CURRENT=CURRENT+1,CURR_LINE=CURR_LINE+SPACING; GOTO 2010
2095 RETURN 
2100 ! "Page full logic - arrived from 2010
2111 RETURN 
2112 PRINT @(0,20),"Press I to interrupt display or <RET> to continue",; READ RECORD (0,SIZ=1,TIM=5,ERR=2115)IN$; IF POS(IN$="Ii")<>0 OR CTL=4 THEN GOTO 1200
2115 FIRST_ONE=CURRENT; GOTO 2000
3000 STOP_SERVER_LOGIC:
3004 IF AUTOKILL THEN MESS$=S$+"|AUTOKILL"; GOSUB 7600; GOTO 3020
3008 DIM S[1]
3010 ! C9=0; CALL "ZZENTR","SUZX",S{ALL},S$,X4$,X3$,16,21,1,15,C0,"",X$,"","EC3STS02","ECY","",""; IF ABS(C0)>4 THEN GOSUB 6400; ON C0 GOTO 3010,3011
3011 X$=""
3012 ! IF ABS(C0)>1 THEN GOTO 3090
3015 FIND (Z[1],KEY=S$,DOM=3005)IOL=0310
3020 FIND (Z[2],KEY=S$,DOM=3021)IOL=0320; GOTO 3030
3021 ! "Server status record not found
3022 IF AUTOKILL THEN GOTO 3090 ELSE SP$="Server "+STP(S$,2)+" status record not found, cannot stop this server!"; MSGBOX SP$,"!Error","!"
3025 IF ECZ$(16,10)<>"ENDED     " THEN GOTO 3030 ELSE IF AUTOKILL THEN GOTO 3026 ELSE SP$="Server status record indicates server stopped. Try KILL command?"; MSGBOX SP$,"!Error","YesNo",SEL$; IF SEL$="NO" THEN GOTO 3090
3026 COMMAND$="{WEBEC_KILL_SERVER}"; GOSUB 7550 ! "Kill Command
3027 REMOVE (Z[2],KEY=S$,DOM=3028)
3028 COMMAND$="{WEBEC_CLEAR_STOP}"; GOSUB 7550 ! "remove end.servid file
3029 GOTO 3090
3030 ! "If here, stop server using END.server name  file
3034 IF AUTOKILL THEN GOTO 3035
3035 COMMAND$="{WEBEC_STOP_SERVER}"; GOSUB 7550 ! "End command
3045 WAIT 2 ! "Give the server a chance to stop
3050 ECZ$(16,10)="ENDED"; FIND (Z[2],KEY=S$,DOM=3051)IOL=0320
3055 IF ECZ$(16,10)="ENDED     " THEN GOTO 3060 ! "Server stopped ok
3056 ! "Server didn't stop yet, wait a few seconds before panic
3057 WAIT 3; FIND (Z[2],KEY=S$,DOM=3058)IOL=0320
3058 IF ECZ$(16,10)="ENDED     " THEN GOTO 3060 ELSE IF AUTOKILL THEN GOTO 3026 ELSE SP$="Could not stop "+STP(S$,2)+", try KILL command?"; MSGBOX SP$,"!Error","YesNo",SEL$; IF SEL$="NO" THEN GOTO 3090 ELSE GOTO 3026
3060 COMMAND$="{WEBEC_CLEAR_STOP}"; GOSUB 7550 ! "Clear End file
3061 IF AUTOKILL THEN GOTO 3062 ELSE SUB_CALL=1; GOSUB 1100; SP$="Server "+STP(S$,2)+" stopped successfully."; MSGBOX SP$,MSG("CONFIRMING"),"!,TIM=4"
3093 IF AUTOKILL THEN GOTO 3094 ELSE DISPLAY_ONLY=1; GOTO 1100
3095 RETURN 
3100 RUN_A_SERVER:
3104 IF AUTOSTART THEN MESS$=S$+"|AUTOSTART"; GOSUB 7600; GOTO 3117
3106 DIM S[1]
3110 ! C9=1; CALL "ZZENTR","SUZX",S{ALL},S$,X4$,X3$,15,21,1,15,C0,"",X$,"","EC3STS04","ECY","",""; IF ABS(C0)>4 THEN GOSUB 6400; ON C0 GOTO 3110,3111
3111 X$=""
3112 ! iF ABS(C0)>1 THEN GOTO 3190
3115 FIND (Z[1],KEY=S$,DOM=3105)IOL=0310
3117 COMMAND$="{WEBEC_CLEAR_STOP}"; GOSUB 7550 ! "Make sure END file is gone
3120 FIND (Z[2],KEY=S$,DOM=3125)IOL=0320
3121 ! "Server already running
3122 IF ECZ$(16,10)="ENDED     " THEN GOTO 3125
3123 IF AUTOSTART THEN GOTO 3124 ELSE SP$="Server status indicates that "+STP(S$,2)+" is running. Try emergency stop?"; MSGBOX SP$,"!Error","YesNo",SEL$; IF SEL$="NO" THEN GOTO 3190
3124 COMMAND$="{WEBEC_KILL_SERVER}"; GOSUB 7550 ! "Kill command
3125 ! "Start server
3126 IF AUTOSTART THEN GOTO 3127
3130 COMMAND$="{WEBEC_RUN_SERVER}"; GOSUB 7550 ! "Run Command
3140 WAIT 2 ! "Give the server a chance to get started
3145 FIND (Z[2],KEY=S$,DOM=3146)IOL=0320; GOTO 3150
3146 WAIT 3 ! "wait a little more before panicing
3147 FIND (Z[2],KEY=S$,DOM=3148)IOL=0320; GOTO 3150
3148 IF AUTOSTART THEN MESS$=S$+"|FAILED"; GOSUB 7600; GOTO 3195 ELSE SP$="Looks like server didn't start!"; MSGBOX SP$,MSG("WARNING"),"!,TIM=8"; PRINT @(20,28),DIM(80)
3149 GOTO 3190
3150 ! "looks like it started
3151 IF AUTOSTART THEN MESS$=S$+"|STARTED"; GOSUB 7600; GOTO 3195
3155 SUB_CALL=1; GOSUB 1100
3160 SP$="Server "+STP(S$,2)+" started."; MSGBOX SP$,"!Message"; PRINT @(20,28),DIM(80),
3190 IF AUTOSTART THEN GOTO 3191 ELSE DISPLAY_ONLYL=1; GOTO 1100
3195 RETURN 
3200 ! "Restart a Server
3206 DIM S$(15),S[1]; X$="<F4> to skip, or enter server name to restart"
3210 C9=0; CALL "ZZENTR","SUZX",S{ALL},S$,X4$,X3$,16,21,1,15,C0,"",X$,"","EC3STS02","ECY","",""; IF ABS(C0)>4 THEN GOSUB 6400; ON C0 GOTO 3010,3011
3211 X$=""
3212 IF ABS(C0)>1 THEN GOTO 3290
3215 FIND (Z[1],KEY=S$,DOM=3205)IOL=0310
3220 FIND (Z[2],KEY=S$,DOM=3221)IOL=0320; GOTO 3230
3222 SP$="Server "+STP(S$,2)+" status record not found, cannot restart this server!"; MSGBOX SP$,"!Warning","!"; GOTO 3290
3230 ! "If here, restart server using RESTART.server name file
3235 COMMAND$="{WEBEC_RESTART_SERVER}"; GOSUB 7550 ! "Restart
3295 RETURN 
4000 ! "Check monitored servers to see if they are running
4005 IF MONITOR THEN GOTO 4006 ELSE RETURN ! "If set not to monitor, then don't
4010 FOR RINDEX=1 TO S_TOTAL
4015 IF NUM(SERVER$[RINDEX](376,5),ERR=4080)=0 THEN GOTO 4080 ! "If 0 then don't monitor
4020 DIM ECZ$(128),ECZ[18]; FIND (Z[2],KEY=SERVER$[RINDEX](1,15),DOM=4050)IOL=0320 ! "Find stats, if no record then assume restart needed
4025 IF ECZ$(16,10)="ENDED     " THEN GOTO 4050
4030 IF LAST_TIME[RINDEX,0]=0 THEN PRECISION 14; LAST_TIME[RINDEX,0]=ECZ[0],LAST_TIME[RINDEX,1]=FN%GET_DATETIME("",0); PRECISION 2; GOTO 4035 ! "If not set yet, set & continue
4031 ! "get diff w last time and compare to # secs allowed
4032 PRECISION 14; IF LAST_TIME[RINDEX,0]<>ECZ[0] THEN LAST_TIME[RINDEX,0]=ECZ[0],LAST_TIME[RINDEX,1]=FN%GET_DATETIME("",0); PRECISION 2; GOTO 4035
4033 PRECISION 14; SECONDS=(FN%GET_DATETIME("",0)-LAST_TIME[RINDEX,1])*86400; PRECISION 2
4034 IF SECONDS>NUM(SERVER$[RINDEX](376,5)) THEN GOTO 4050 ELSE PRECISION 14; LAST_TIME[RINDEX]=ECZ[0]; PRECISION 2
4035 ! "Pickup processing here
4045 GOTO 4080
4050 ! "Restart process
4053 GOSUB 7650
4054 ECY$=SERVER$[RINDEX],S$=SERVER$[RINDEX](1,15) ! "As if we read the data
4055 FIND (Z[2],KEY=SERVER$[RINDEX](1,15),DOM=4061)IOL=0320 ! "IF no status record then skip stop attempt, we don't have the info
4060 AUTOKILL=1; GOSUB 3000; AUTOKILL=0 ! "kill server for sure
4062 ! "Remove last file processed if it exists it may have been stuck on it
4064 ERASE STP(SERVER$[RINDEX](56,60),3," ")+DLM+STP(ECZ$(26,20),1),ERR=4065; GOTO 4064
4068 REMOVE (Z[2],KEY=SERVER$[RINDEX](1,15),DOM=4069) ! "Remove status record we don't need it any more
4069 ! "Now attempt to start the file
4075 AUTOSTART=1; GOSUB 3100; AUTOSTART=0
4080 NEXT RINDEX
4095 RETURN 
6000 ! "BACKGROUND
6190 RETURN 
6400 ! "WHOLE SCREEN
6405 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,X5$,X0,X1,0
6410 GOSUB 6000
6420 SUB_CALL=1; GOSUB 1100
6440 IF ABS(C0)>4 THEN C0=ABS(C0)-5
6445 RETURN 
7500 ! "Run COMMAND$ and capture output in TF_OUTPUT$
7515 %ML_CMD.CTL=ML_CMD.CTL; PRINT @(20,28),; CALL "ZZ2CMD",X3$,X4$,COMMAND$,ARG$,"NR",RETURN_CODE,RETURN$; PRINT @(20,28),DIM(80),
7545 RETURN 
7550 ! "Setup Args to run command 1=server name, 2=environment code, 3=Process id, 4=End file name, 5=restartfile name, 6=email message, 7=email subject, 8=email address, 9=arguments
7555 ARG$=""
7560 ARG$=ARG$+STP(S$,3)+SEP ! "{SERVER}
7562 IF ECY$(433,8)=DIM(8) THEN ENV$="EC3SRV" ELSE ENV$=ECY$(433,8) END_IF ; ARG$=ARG$+ENV$+SEP ! "{ENV}
7566 ARG$=ARG$+STR(ECZ[2])+SEP ! "{PID}
7568 ARG$=ARG$+STP(ECY$(56,60),2)+DLM+"END."+STP(S$,3)+SEP; REM {ENDFILE}
7570 ARG$=ARG$+STP(ECY$(56,60),2)+DLM+"RESTART."+STP(S$,3)+SEP; REM {RESTARTFILE}
7572 ARG$=ARG$+EMESS$+SEP; EMESS$="" ! Set & then clear email message
7574 ARG$=ARG$+SUBJECT$+SEP; SUBJECT$="" ! Set & then clear subject
7576 ARG$=ARG$+STP(ECY$(442,40),1)+SEP ! Email address
7578 ARG$=ARG$+STP(ECY$(116,60),1)+SEP ! Arguments
7590 ! "Now execute COMMAND
7593 GOSUB 7500
7595 RETURN 
7600 ! "Write message to LOG
7610 OUT$=DTE(0:"%Y-%Mz-%Dz|%Hz:%mz:%sz")+"|"+MESS$
7620 ! "Position to current end of file incase multiple EC3STS's running
7622 TMP$=FN%XFD$(120,0); IF DEC(TMP$(38,4))>0 THEN READ (120,IND=DEC(TMP$(38,4))-1,ERR=7623)
7625 WRITE (120)OUT$
7645 RETURN 
7650 ! "Notify of failure
7654 ! "Log failure
7655 MESS$=SERVER$[RINDEX](1,15)+"|INACTIVE"; GOSUB 7600
7660 ! "Email notify
7662 IF STP(SERVER$[RINDEX](442,40),1)="" OR X3$(77,1)<>"U" THEN GOTO 7670 ! "If no email address or not a unix system then skip it
7664 EMESS$="WebEC Server "+STP(SERVER$[RINDEX](1,15),1)+" appears inactive. A restart is being attempted."; PRECISION 14; EMESS$=EMESS$+" ["+DTE(0:"%Y-%Mz-%Dz|%Hz:%mz:%sz")+"]"; PRECISION 2; SUBJECT$="WebEC Server "+STP(SERVER$[RINDEX](1,15),1)+" appears inactive"
7665 COMMAND$="{WEBEC_FAIL_NOTIFY}"; GOSUB 7550
7670 ! "After email notify
7695 RETURN 
8000 UPDATE_STATUS:
8010 CALL "UPDSV0;UPDATE_STATUS",ERR=*NEXT,"ECMONITOR","EC MONITOR","","EC Server Status Monitor","ECGSTS",STR(TCB(89))
8045 RETURN 
8049 ! 
8950 DEF FNS$(Z9$)=Z9$(1,POS("     "=Z9$+"     ")-1)
9000 ! "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 ! " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 ! "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 3005,3105
9900 ! "END PROGRAM
9905 SET_PARAM -'LU' ! Clear text file lock
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 EXIT 
9999 END 
10000 CHECK_OPTIONS:
10001 ML_CMD.CTL'VALUE$=""
10002 IF CTL=BUTTON_5.CTL THEN REPLACEMENT_SCRN$="ECGMJV"; RETURN 
10010 CALL "*WINGRP;ENABLE",CH.GRP$; SET_FOCUS BUTTON_5.CTL; OBTAIN (0,SIZ=1,TIM=10,ERR=*NEXT)'ME',*,'MN'; CALL "*WINGRP;DISABLE",CH.GRP$; _AA=CTL; GOTO 10030
10012 REFRESH_FLG=1
10020 GOSUB SERVER_MONITOR; GOSUB ASSIGN_VALUE; GOTO 10001 ! SET_FOCUS ML_OPTIONS.CTL; NEXT_ID=ML_OPTIONS.CTL; EXIT 
10030 IF CTL=10032 THEN PROCESS "ECGMSA","../ECG/EC.EN"
10040 IF CTL=BUTTON_1.CTL THEN GOSUB STOP_SERVER; EXIT 
10050 IF CTL=BUTTON_2.CTL THEN GOSUB RUN_SERVER; EXIT 
10060 IF CTL=BUTTON_3.CTL THEN GOSUB VIEW_LOG; EXIT 
10070 IF CTL=BUTTON_4.CTL THEN PROCESS "ECGMSA","../ECG/EC.EN"
10080 IF CTL=BT_SERVER1.CTL THEN OPTION_SER=1; GOSUB OPTIONS_SERVER
10090 IF CTL=BT_SERVER2.CTL THEN OPTION_SER=2; GOSUB OPTIONS_SERVER
10100 IF CTL=BT_SERVER3.CTL THEN OPTION_SER=3; GOSUB OPTIONS_SERVER
10110 IF CTL=BT_SERVER4.CTL THEN OPTION_SER=4; GOSUB OPTIONS_SERVER
10120 IF CTL=BUTTON_5.CTL THEN REPLACEMENT_SCRN$="ECGMJV"; RETURN 
10130 IF CTL=BUTTON_6.CTL THEN GOSUB KILL_MONITOR
10140 IF CTL=BUTTON_7.CTL THEN GOSUB RESTART_MONITOR
10999 GOSUB SERVER_MONITOR; GOTO CHECK_OPTIONS
15000 VIEW_LOG:
15005 IF %SERVER_ID$<>"" THEN DB_SERVERS$=%SERVER_ID$; PROCESS "ECGSTS.3","../ECG/EC.EN",DB_SERVERS$; GOTO *RETURN
15010 PROCESS "ECGSTS.3","../ECG/EC.EN"
15020 RETURN 
20000 ASSING_PANEL:
20005 SV=CURRENT,SERVER_CONF$=STR(S_INDEX)+" Servers Configured"
20010 SERVER1$=STP(SERVER$[CURRENT](1,15))+" "+STP(SERVER$[CURRENT](16,40))
20012 EXECUTE "button remove bt_server"+STR(CURRENT)+".ctl;button bt_server"+STR(CURRENT)+".ctl,@("+STR(CC(SV))+","+STR(LL(SV))+",51.5,1.50)="+""""+SERVER1$+""""
20015 SERVER_NO$="SERVER"+STR(CURRENT)+".GRP$"; EXECUTE "call ""*wingrp;SHOW"","+SERVER_NO$+";CALL ""*wingrp;UNLOCK"","+"server_no$"
20016 REFRESH_FLG=1
20030 REFRESH_FLG=1
20040 RETURN 
21000 READ_SERVER_ID:
21001 ML_LOG$=""; LIST_BOX LOAD ML_LOG.CTL,""
21002 ECY=HFN; OPEN (ECY)"ECY"+%C$
21010 DIM ECY$(512); READ (ECY,KEY=PAD(ML_SERVER_ID$,15," "),DOM=*NEXT)IOL=0310; GOTO 21050
21020 MSGBOX "Server ID: "+ML_SERVER_ID$+" No On File","!Error","!"
21030 NEXT_ID=ML_SERVER_ID.CTL; GOTO 21100
21050 ML_SERVER_DESC$=ECY$(16,40),ML_SERVER_DESC.CTL'VALUE$=ML_SERVER_DESC$,REFRESH_FLG=1
21055 XXX=HFN; OPEN (XXX)FID(0); XXX$=FIN(XXX); CLOSE (XXX); XXX=DEC(XXX$(10,1))
21060 CLOSE (ECY); RUN "ECGSTL"
21100 CLOSE (ECY)
21110 RETURN 
22000 INIT_ECGMON:
22010 ! 
22020 _ECY=HFN; OPEN (_ECY)"ECY"+%C$
22030 _ECZ=HFN; OPEN (_ECZ)"ECZ"+%C$
22031 IDX=NUM(FN%FIN$(_ECY,"NUMREC")); IDX=0 ! PRINT 'SIZE'(95,IDX+6); IDX=0 ! SSP 205460
22032 NXT_READ: SS=LB_SERVER.CTL'SORT; READ (_ECY,KEY="",DOM=*NEXT)
22033 SET_FOCUS 0 ! PRINT 'MESSAGE'('_RED'+'WHITE'+"refresh Screen",0); CALL "$CTL-10;AGENT_MSG","Refresh Screen",0; PRINT 'MESSAGE'('F8'+'BLACK'+"",0)!SSP#216436
22035 LIST_BOX LOAD LB_SERVER.CTL,""
22036 IDX=0,NEXT_SCR=0,%SERVER_ID$=""
22040 DIM ECY$(512); READ (_ECY,END=END_INIT)ECY$
22050 DIM ECZ$(128),ECZ(18); READ (_ECZ,KEY=ECY$(1,15),DOM=*NEXT)IOL=0320
22060 IDX+=1; LIST_BOX LOAD LB_SERVER.CTL,IDX,ECY$(1,15)+SEP+ECY$(16,40)+SEP+ECZ$(16,10)+SEP+FN%PRINT_DATETIME$(ECZ[1],"%Mz/%Dz %Hz:%mz:%sz")+SEP+STR(ECZ[2])+SEP+STR(ECZ[6])+SEP+STR(ECZ(10))+SEP+STR(ECZ(5))+SEP+STR(ECZ(9))+SEP+FN%PRINT_DATETIME$(ECZ(0),"%Mz/%Dz %Hz:%mz:%sz")+SEP+STR(ECZ(8):"#,###,##0")+SEP+STR(ECZ(7):"#,###,##0")+SEP+STR(ECZ(4):"#,###,##0")+SEP+STR(ECZ(3):"#,###,##0")
22070 GOTO 22040
22100 END_INIT:
22102 LB_SERVER.CTL'SORT=SS
22105 PRINT 'MESSAGE'(MSG("PRESS_D"),0),
22106 GOSUB UPDATE_STATUS ! 268710
22110 OBTAIN (0,SIZ=1,TIM=15,ERR=NXT_READ)'ME',*,'MN'
22120 _CTRL=CTL
22125 IF CTL<0 AND CTL>-1000 THEN CALL "*control"; GOTO 22110
22130 IF CTL=BT_EXIT.CTL OR CTL=4 THEN CMD_STR$="END"; GOTO CLOSE_FILES
22140 LIST_BOX READ LB_SERVER.CTL,IDX,ERR=22110
22150 LIST_BOX FIND LB_SERVER.CTL,IDX,VAL$
22160 %SERVER_ID$=VAL$(1,15)
22170 NEXT_SCR=1
22950 CLOSE_FILES:
22960 CLOSE (_ECY),(_ECZ)
22970 RETURN 
23000 RESIZE_SCRN:
23005 IF UID="jvv" THEN RETURN 
23010 LB_SERVER.CTL'LINES=IDX+2.5,BT_EXIT.CTL'LINE=LB_SERVER.CTL'LINES+1.5,ML_DESC.CTL'LINE=IDX+4
23020 ! PRINT 'SIZE'(95,IDX+6),
23040 _OBJ_W=95,_OBJ_H=IDX+6; PERFORM "*winproc;center_wdw"
23050 PRINT 'MOVE'(_OBJ_C,_OBJ_L),
23060 RETURN 
23100 ECGMON: PROCESS "ECGMJV","../ECG/EC.EN"; EXIT 
30000 ASSIGN_VAR_PANEL:
30010 EXECUTE "ML_STATUS_SERVER"+STR(CURRENT)+"$="+""""+ECZ$(16,10)+""""
30015 PRECISION 14
30020 EXECUTE "ML_STATUS_TIME_SERVER"+STR(CURRENT)+"$="+""""+FN%PRINT_DATETIME$(ECZ[0],"%Mz/%Dz %Hz:%mz:%sz")+""""
30040 IF ECZ[1]<>0 THEN PRECISION 14; EXECUTE "ML_START_SERVER"+STR(CURRENT)+"$="+""""+FN%PRINT_DATETIME$(ECZ[1],"%Mz/%Dz %Hz:%mz:%sz")+""""
30045 PRECISION 2
30050 EXECUTE "ML_PROCESS_SERVER"+STR(CURRENT)+"$="+""""+STR(ECZ[2])+""""
30060 EXECUTE "ML_ERRORS_SERVER"+STR(CURRENT)+"$="+""""+STP(STR(ECZ[8]:M0$),2)+""""
30070 EXECUTE "ML_LOGINS_SERVER"+STR(CURRENT)+"$="+""""+STP(STR(ECZ[6]:M0$),2)+""""
30080 EXECUTE "ML_INVALID_SERVER"+STR(CURRENT)+"$="+""""+STP(STR(ECZ[7]:M0$),2)+""""
30090 EXECUTE "ML_ACTIVE_SERVER"+STR(CURRENT)+"$="+""""+STP(STR(ECZ[10]:M0$),2)+""""
30092 EXECUTE "ML_ORDERS_SERVER"+STR(CURRENT)+"$="+""""+STP(STR(ECZ[4]:M0$),2)+""""
30094 EXECUTE "ML_ORDERS_LINE_SERVER"+STR(CURRENT)+"$="+""""+STP(STR(ECZ[5]:M0$),2)+""""
30096 EXECUTE "ML_FILEDONE_SERVER"+STR(CURRENT)+"$="+""""+STP(STR(ECZ[3]:M0$),2)+""""
30098 EXECUTE "ML_FILETODO_SERVER"+STR(CURRENT)+"$="+""""+STP(STR(ECZ[9]:M0$),2)+""""
30100 REFRESH_FLG=1
30110 RETURN 
30900 RUN_SERVER: RUN_SERVER=1
31000 STOP_SERVER:
31002 GOSUB LOAD_DB_SERVERS
31010 IF RUN_SERVER=0 THEN PROCESS "ECGSTS.1","../ECG/EC.EN",DB_SERVERS$ ELSE PROCESS "ECGSTS.2","../ECG/EC.EN",DB_SERVERS$
31020 NEXT_ID=ML_SERVER_ID.CTL,%FT_DESC$="Stop Server:",REFRESH_FLG=1
31022 INDI_STOP_SERVER:
31025 IF DB_SERVERS$<>"" THEN S$=PAD(DB_SERVERS$,15," ") ELSE GOTO 31030
31026 IF RUN_SERVER=0 THEN GOSUB STOP_SERVER_LOGIC ELSE GOSUB RUN_A_SERVER; NEXT_ID=ML_OPTIONS.CTL ! SSP 208113
31030 RUN_SERVER=0
31040 RETURN 
31500 LOAD_DB_SERVERS:
31505 DB_SERVERS$=""
31510 FOR AA=1 TO S_TOTAL
31520 DB_SERVERS$=DB_SERVERS$+SERVER$[AA](1,15)+"/"
31530 NEXT AA
31540 DROP_BOX LOAD DB_SERVERS.CTL,DB_SERVERS$
31550 REFRESH_FLG=1
31560 RETURN 
32000 SERVER_MONITOR:
32010 FOR XX=1 TO 4
32020 EXECUTE "CALL"+""""+"*WINGRP;HIDE"+""""+",SERVER"+STR(XX)+".GRP$"
32030 CALL "*WINGRP;LOCK",SERVER1.GRP$
32040 NEXT XX
32050 GOSUB 1100
32060 GOSUB SERVER
32070 RETURN 
33000 OPTIONS_SERVER:
33001 IF STP(SERVER$)="" THEN SERVER$=%SERVER_ID$
33002 IF %SERVER_ID$<>"" THEN OPTION_SER=1
33005 DB_SERVERS$=SERVER$[OPTION_SER](1,15),OPT$="",%ML_CMD.CTL=ML_CMD.CTL
33010 PROCESS "ECGSTS.4","../ECG/EC.EN",DB_SERVERS$,OPT$
33020 SWITCH OPT$
33030 CASE "1"
33040 RUN_SERVER=0; GOTO INDI_STOP_SERVER
33050 CASE "2"
33060 RUN_SERVER=1; GOTO INDI_STOP_SERVER
33070 CASE "3"
33080 PROCESS "ECGSTS.3","../ECG/EC.EN",DB_SERVERS$
33090 DEFAULT 
33100 RETURN 
33110 END SWITCH 
34000 KILL_MONITOR:
34010 FIND (Z(14),KEY="STOPSTS   ",DOM=*NEXT)*,STOP$
34020 WRITE (Z(14),KEY="STOPSTS   ")"STOPSTS   ","YES"
34030 GOSUB 1100
34040 GOSUB SERVER
34050 RETURN 
34500 RESTART_MONITOR:
34510 COMMAND$="{EC_MONITOR}"
34520 ARG$="EC_MONITOR"
34530 GOSUB 7500
34535 FIND (Z(14),KEY="STOPSTS   ",DOM=*NEXT)
34540 RETURN 
35000 ASSIGN_VALUE:
35010 EXECUTE "ml_status_server"+STR(CURRENT)+".ctl'value$=ML_STATUS_SERVER"+STR(CURRENT)+"$"
35020 EXECUTE "ml_status_time_server"+STR(CURRENT)+".ctl'value$=ML_STATUS_TIME_SERVER"+STR(CURRENT)+"$"
35040 EXECUTE "ml_start_server"+STR(CURRENT)+".ctl'value$=ML_START_SERVER"+STR(CURRENT)+"$"
35050 EXECUTE "ml_process_server"+STR(CURRENT)+".ctl'value$=ML_PROCESS_SERVER"+STR(CURRENT)+"$"
35060 EXECUTE "ml_errors_server"+STR(CURRENT)+".ctl'value$=ML_ERRORS_SERVER"+STR(CURRENT)+"$"
35070 EXECUTE "ml_logins_server"+STR(CURRENT)+".ctl'value$=ML_LOGINS_SERVER"+STR(CURRENT)+"$"
35080 EXECUTE "ml_invalid_server"+STR(CURRENT)+".ctl'value$=ML_INVALID_SERVER"+STR(CURRENT)+"$"
35090 EXECUTE "ml_active_server"+STR(CURRENT)+".ctl'value$=ML_ACTIVE_SERVER"+STR(CURRENT)+"$"
35092 EXECUTE "ml_orders_server"+STR(CURRENT)+".ctl'value$=ML_ORDERS_SERVER"+STR(CURRENT)+"$"
35094 EXECUTE "ml_orders_line_server"+STR(CURRENT)+".ctl'value$=ML_ORDERS_LINE_SERVER"+STR(CURRENT)+"$"
35096 EXECUTE "ml_filedone_server"+STR(CURRENT)+".ctl'value$=ML_FILEDONE_SERVER"+STR(CURRENT)+"$"
35098 EXECUTE "ml_filetodo_server"+STR(CURRENT)+".ctl'value$=ML_FILETODO_SERVER"+STR(CURRENT)+"$"
35100 RETURN 
56080 XX$=OBJ(0),XX=DEC(XX$(21,2)),YY=DEC(XX$(23,2)),XXX=DEC(XX$(25,2)),XX=(XXX/2)+XX
56100 ! "205761-Server monitor buttons must always be selected twice        
56102 REM "211380-TopForm file feldnames which are SQL keywords break Oracle. 
56103 REM "216436-Is it possible to turn off the blue "Refresh Screen"?       
56104 ! "208113-Server Monitor on their test server appears to lock up      
56105 REM "242161-display issue and wording on screen for ECGSTS              
56106 REM "268710-Server status reporting framework - new file for servers to 
