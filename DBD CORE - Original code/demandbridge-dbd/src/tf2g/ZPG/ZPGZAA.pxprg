0010 ! ZPGZAA - List Profile Setup
0035 REM "5.7 - 11/03/10 - 9.296944 - tma - SSP# 242054
0037 REM "242054-When you create a profile in Contact Managment.  Display    
0040 REM "Copyright 2010 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 IF TCB(13)=1 THEN BEGIN 
0060 _XI=PRM('XI'); SET_PARAM 'XI'
0070 PROCESS "ZPGZAA","../ZPG/ZP.EN"
0080 SET_PARAM 'XI'=_XI
0090 GOTO 9800
0100 INIT:! ^100,5 - Initialization routine
0200 ! ^100,5 - Constants & Functions
0205 K0=9,K1=0
0210 C9=-1,V9=-2
0215 M0$="###,###,###.00-",M1$="####0"
0220 V8$="000809101899"
0225 ! CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2
0226 CALL "ZZWDTE;TF_TODAY",%TODAY$
0230 IF X1>0 THEN CMD_STR$="E"; EXIT 
0237 CALL "ZZ2FNC;GETUSERNAME",USERNAME$
0238 K9$=HSH(USERNAME$)+"PROFILE",K9=LEN(K9$)
0240 DIM V7$(10)
0245 V7$(1,1)="1",V7$(5,1)="1",V7$(6,1)="1"
0250 DIM E[1],A[1]
0255 ! 
0300 ! ^300,5 - Iolists & Templates
0305 IOLIST A1$:[LEN(9,SEP=SEP)],A2$:[LEN(4,SEP=SEP)],A3$:[LEN(6,SEP=SEP)],A4$:[LEN(16,SEP=SEP)],A5$:[LEN(5,SEP=SEP)],A6$:[LEN(3,SEP=SEP)],A7$:[LEN(3,SEP=SEP)],A8$:[LEN(1,SEP=SEP)],A9_1$:[LEN(3,SEP=SEP)],A9_2$:[LEN(3,SEP=SEP)],A9_3$:[LEN(3,SEP=SEP)],A9_4$:[LEN(3,SEP=SEP)],A9_5$:[LEN(3,SEP=SEP)],A9_6$:[LEN(3,SEP=SEP)],A9_7$:[LEN(3,SEP=SEP)],A9_8$:[LEN(3,SEP=SEP)],A9_9$:[LEN(3,SEP=SEP)],A9_10$:[LEN(3,SEP=SEP)],A9_11$:[LEN(3,SEP=SEP)],A9_12$:[LEN(3,SEP=SEP)],A10_1$:[LEN(3,SEP=SEP)],A10_2$:[LEN(3,SEP=SEP)],A10_3$:[LEN(3,SEP=SEP)],A10_4$:[LEN(3,SEP=SEP)],A10_5$:[LEN(3,SEP=SEP)],A10_6$:[LEN(3,SEP=SEP)],A10_7$:[LEN(3,SEP=SEP)],A10_8$:[LEN(3,SEP=SEP)],A10_9$:[LEN(3,SEP=SEP)],A10_10$:[LEN(3,SEP=SEP)],A10_11$:[LEN(3,SEP=SEP)],A10_12$:[LEN(3,SEP=SEP)],A11$:[LEN(1,SEP=SEP)],A12$:[LEN(40,SEP=SEP)],A13$:[LEN(4,SEP=SEP)],A14$:[LEN(5,SEP=SEP)],A15$:[LEN(5,SEP=SEP)],A16$:[LEN(6,SEP=SEP)],A17$:[LEN(6,SEP=SEP)],A18$:[LEN(6,SEP=SEP)],A19$:[LEN(6,SEP=SEP)],A20$:[LEN(1,SEP=SEP)],A21$:[LEN(2,SEP=SEP)],A22$:[LEN(2,SEP=SEP)],A23$:[LEN(1,SEP=SEP)]
0310 DIM A$:IOL=0305
0315 IOLIST A0$,A$,A[0],A[1]
0320 IOLIST E$,E[0],E[1]
0325 GLOBAL_IOL:IOLIST %LIST_TYPE_DESC$,%SIC_DESC$,%SOURCE_OF_LEAD$,%CONT_CAT_DESC$,%SALES_NAME,%SEL_COD_DESC$,%SET_DESC_ES$,%SET_DESC_ET$
0330 ! 
0500 ! 500,5 - Open files
0503 GOSUB SETUP_MESSAGES
0505 _FILE_NAME$="FMP"+%C$; _FMP=HFN; OPEN (_FMP,ERR=OPEN_ERR)_FILE_NAME$
0510 _FILE_NAME$="ZP4"+%C$; _ZP4=HFN; OPEN (_ZP4,ERR=OPEN_ERR)_FILE_NAME$ ! TM Contact master
0515 _FILE_NAME$="ZZPARM"; ZZPARM=HFN; OPEN (ZZPARM,ERR=OPEN_ERR)_FILE_NAME$
0520 _FILE_NAME$="ZZPARM"; ZZPARM_13=HFN; OPEN (ZZPARM_13,ERR=OPEN_ERR)_FILE_NAME$ ! Originally opened on two channels
0530 _ZPC=HFN; OPEN (_ZPC,ERR=*NEXT)"ZPC"+%C$+USERNAME$; GOTO 0600 ! TM Profile Sort
0540 IF ERR=12 THEN {
0545 SORT "ZPC"+%C$+USERNAME$,35,0
0550 RETRY 
0555  } ELSE {
0560 MSGBOX "Unable to open or create sort file ZPC"+%C$+" due to an error "+STR(ERR)+". Cannot process this routine.","Attention","info"
0565 CMD_STR$="E"; EXIT 
0570  }
0575 ! 
0600 ! ^100,5 - Get parameters
0605 Y8=1; CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,X5$,X0,X1,X2
0610 DIM S9$(255); FIND (ZZPARM,KEY="osec"+%X3_OP_ID$,DOM=*NEXT)S9$
0615 RETURN 
0620 ! 
0670 OPEN_ERR: MSGBOX _MSG_FILOPNERR1$+QUO+_FILE_NAME$+QUO+SEP+_MSG_DIRECTORY$+LWD+SEP+_MSG_PREFIX$+PFX,MSG(ERR),"!"
0675 CMD_STR$="END"
0680 RETURN 
0685 ! 
1000 POST_DISPLAY:! ^1000,5 - Get record and display if applicable
1005 F1$=KEY(_ZPC,END=*NEXT); IF F1$<>"" THEN GOSUB CLEAR_PROFILE
1010 A$(1,LEN(A1$))=A1$
1015 IF A1$="" THEN A$(1,LEN(K9$))=K9$
1020 A1$=A$(1,9)
1025 READ (ZZPARM,ERR=*NEXT,KEY=%C$+A1$,DOM=1100)IOL=0315; GOTO 1035
1030 IF ERR<>0 THEN CMD_STR$="E"; EXIT 
1035 ! If ZPC is empty (F1$="") then we should not have zzparm record,
1040 ! remove it and proceed as it it was not there
1045 IF F1$="" THEN GOSUB REMOVE_PARM_REC; GOTO 1075
1050 IF POS(" "<>S9$(8,24))>0 AND POS(A$(10,4)=S9$(8,24),4)=0 THEN {
1055 MSGBOX MSG("ACCESS_DEN")+" "+MSG("NOT_AUTH")+" "+A$(10,4),MSG("ATTENTION"),"!"; GOTO DELETE_REC
1060  }
1065 IF F1$<>"" THEN CALL "*wingrp;disable",SEQUENCE.GRP$
1070 A0=A[0]
1075 REFRESH_FLG=1
1080 EXIT 
1085  }
1090 ! 
1100 CLEAR_MSG$="N"
2000 DELETE_REC:! ^1000,5
2005 REMOVE (ZZPARM,KEY=%C$+A1$,DOM=*NEXT)
2010 READ DATA FROM "" TO IOL=0315
2015 READ DATA FROM "" TO IOL=GLOBAL_IOL
2020 ANSWER$="YES"; GOSUB 7115
2025 REFRESH_FLG=1
2030 NEXT_ID=A.A12.CTL,REFRESH_FLG=1
2035 IF CLEAR_MSG$<>"N" THEN MSGBOX MSG("LIST_CLEAR"),MSG("FYI"),"!"
2040 EXIT 
2045 ! 
6700 WRITE_REC:! 6700,5
6705 IF STP(A.A2$,2)="" THEN {
6710 MSGBOX "List to process is missing.","Attention","!"
6715 NEXT_ID=A.A2.CTL,REFRESH_FLG=1
6720 EXIT 
6725  }
6730 A0$=A$(121,40),A[0]=A0
6735 WRITE (ZZPARM,KEY=X3$(9,3)+A1$)IOL=0315
6740 IF A.A23$="Y" THEN A.A11$=LCS(A.A11$) ! List by salesperson
6745 V$=A$(10,4)+DIM(67)+A$(14)
6750 S0$=""; FIND (_FMP,KEY="eT"+A$(200,2),DOM=*NEXT)S0$ ! Category set
6755 S1$=""; FIND (_FMP,KEY="eS"+A$(202,2),DOM=*NEXT)S1$ ! State set
6760 CALL "*progbar;init","Updating profile",40
6765 T_R=0 ! ssp#242054 T_R=NUM(FN%FIN$(_ZP4,"numrec"))
6770 ! IF T_R<1 THEN T_R=1!SSP#242054
6775 P_R=INT(T_R/20); IF P_R<1 THEN P_R=1
6780 COUNTER=0
6785 ! 
6800 ! ^100,5 - Do the update
6805 SELECT IOL=0320 FROM _ZP4 BEGIN V$(1,4) END V$(1,4)+$FF$
6809 T_R=T_R+1 ! SSP#242054
6810 ! COUNTER++
6815 IF MOD(COUNTER,P_R)=0 THEN {
6820 CALL "*progbar;update_percent",ERR=ABORT_UPDATE,"",COUNTER/T_R*100
6825  }
6830 CALL "ZP2SZA",X3$,E$,E{ALL},V$,A{ALL},S0$,S1$,X9
6835 IF X9>0 THEN {
6840 COUNTER++
6845 DIM K5$(35); K5$(1,5)=A$(10,4)+A$(120,1),K5$(30,6)=E$(5,6)
6850 IF POS(A$(120,1)="zZ")>0 THEN {
6855 K5$(10,9)=E$(129,9)
6860 ! If specialty, then add uppercased lookup as part of the key
6865 IF Q1$="Y" THEN K5$(15,15)=CVS(E$(419,15),32)
6870  }
6875 IF POS(A$(120,1)="lL")>0 THEN {
6880 K5$(10,20)=E$(419,20)
6885  }
6890 IF A$(120,1)>="a" AND A$(120,1)<="z" THEN {
6895 K5$(6,4)=E$(359,4)
6900  }
6905 WRITE (_ZPC,KEY=K5$); F1$=K5$
6910  }
6915 NEXT RECORD 
7000 ! ^100,5 - Update complete
7005 CALL "*progbar;update_percent","",100
7010 CALL "*progbar;wrap_up"
7015 NEXT_ID=QUIT.CTL,REFRESH_FLG=1
7016 MSGBOX "Profile update complete"+SEP+"Found "+STR(COUNTER)+" Records out of "+STR(T_R),MSG("FYI"),"info"
7020 RETURN 
7025 ! 
7100 CLEAR_PROFILE:! ^100,5
7105 IF F1$<>"" THEN {
7110 MSGBOX "Clear existing list profile?","Confirm","?,YESNO",ANSWER$
7115 IF ANSWER$="YES" THEN {
7120 FILE_ZPC$=FIB(_ZPC),FILE_ZPC$=FILE_ZPC$(25,60)
7125 CLOSE (_ZPC)
7130 REFILE FILE_ZPC$,ERR=*NEXT
7135 OPEN (_ZPC)FILE_ZPC$
7140 GOSUB REMOVE_PARM_REC
7145 CALL "*wingrp;enable",SEQUENCE.GRP$; F1$="" ! SSP#242043
7150  } }
7155 RETURN 
7160 ! 
7200 REMOVE_PARM_REC:! ^100,5
7205 REMOVE (ZZPARM,KEY=%C$+A1$,DOM=*NEXT)
7210 RETURN 
7215 ! 
9100 SETUP_MESSAGES:
9110 _MSG_FILOPNERR1$=MSG("FILOPNERR1")
9120 _MSG_DIRECTORY$=MSG("DIRECTORY")
9130 _MSG_PREFIX$=MSG("PREFIX")
9190 SETUP_MESSAGES_END:RETURN 
9195 ! 
9700 WRAPUP:! 9700,5 - Close files and clean up
9705 READ DATA FROM "" TO IOL=GLOBAL_IOL
9710 IF _FMP THEN CLOSE (_FMP)
9715 IF _ZP4 THEN CLOSE (_ZP4)
9720 IF _ZPC THEN CLOSE (_ZPC)
9725 IF ZZPARM THEN CLOSE (ZZPARM)
9730 IF ZZPARM_13 THEN CLOSE (ZZPARM_13)
9735 EXIT 
9740 ! IF S3=5 THEN CALL "ZZ2PRP",MODULE_CODE$,RESULT$,TF_DATE$; IF RESULT$="Y" THEN RUN "CT2UDA" ELSE CALL "ZZPROM",".4",X3$,S3,"This option requires the Contact Management Gateway Module","","",0; GOTO 9753
9800 ! ^100,5 - Return to previous
9805 ! if tcb(13)=1 then rUN "ZMENU"
9998 ! 9998,1 - End
9999 END 
10009 ! 
10019 CHECK_SEQUENCE:
10029 RETURN 
10045 ! 
10050 LIST_TYPE_ENTRY:
10055 IF POS(" "<>S9$(8,24))>0 AND POS(A.A2$=S9$(8,24),4)=0 THEN {
10060 MSGBOX MSG("ACCESS_DEN")+" "+MSG("NOT_AUTH")+" "+MSG("LIST_T_C")+" "+A.A2$,MSG("ATTN"),"!"
10065 A.A2$="",NEXT_ID=A.A2.CTL,REFRESH_FLG=1
10070  }
10090 LIST_TYPE_ENTRY_END:RETURN 
10095 ! 
10100 ABORT_UPDATE:
10110 CALL "*progbar;wrap_up"
10120 GOTO DELETE_REC
10145 ! 
10150 CHECK_ERR:
10160 IF ERR<>0 THEN EXIT ERR
10170 MSGBOX MSG("REC_BUSY"),MSG("CONFIRM"),"?,YESNO",ANSWER$
10180 IF ANSWER$="NO" THEN EXIT ELSE RETRY 
10190 ! 
56000 ! "190159-Contact Managment.  List profile.  When he creates a new    
56001 ! "       profile, does not appear to clear the old one
56002 REM "205460-Oracle - FIN(CHANNEL,"NUMREC") changed to use FN%FIN$()     
56004 REM "211380-TopForm file feldnames which are SQL keywords break Oracle. 
56005 REM "242043-ZPGZAA - If you answer option to clear list profile, radial 
56006 REM "242054-When you create a profile in Contact Managment.  Display     is incorrect for number of records
