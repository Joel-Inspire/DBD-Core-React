0010 ! UPDDT3 - File DT3 Maintenance
0035 REM "5.6 - 01/07/08 - 13.823055 - mhe - SSP# 203099
0037 REM "203099-Enhancements to Output Director.  Provide ability for       
0040 REM "Copyright 2008 DemandBridge, Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 ! FILENO - CHANNEL OF OPEN FILE
0051 ! KEYNO  - KEY NUMBER
0052 ! SEG1-SEG5$ : KEY SEGMENTS . CAN BE NULL
0053 ! A$ - RECORD A$
0054 ! FOUND - IF RECORD FOUND, THEN 1 ELSE 0
0055 ! BUSY - IF RECORD BUSY THEN 1 ELSE 0
0056 ! OK - IF RECORD ADDED OK=1 ELSE 0
0310 IOLIST A$,A[0],A[1],A[2],A[3]
0500 INIT:
0505 DIM Z[255]; OPENED=0
0507 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,X5$,X0,X1,0
0510 IF FILENO=-99 THEN Z$="01S DT3...  "; CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; FILENO=Z[1],OPENED=1 ELSE IF POS("DT3"=PTH(FILENO))=0 THEN Z$="01S DT3...  "; CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; FILENO=Z[1],OPENED=1
0590 RETURN 
0598 ! 
0599 ! 
0600 WRAPUP:
0610 IF OPENED THEN CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
0690 RETURN 
0698 ! 
0699 ! 
1000 READBYKEY:
1010 ENTER FILENO,KEYNO,SEG1$,SEG2$,SEG3$,SEG4$,SEG5$,A$,A{ALL},FOUND
1015 FOUND=0
1020 GOSUB INIT
1025 CALL "UPDDT3;CLEAR_FIELDS",A$,A{ALL}
1049 XP=PRM('XI'); SET_PARAM 'XI'
1050 READ (FILENO,KNO=KEYNO,KEY=SEG1$+SEG2$+SEG3$+SEG4$+SEG5$,DOM=*NEXT)IOL=0310; FOUND=1
1051 SET_PARAM 'XI'=XP
1080 GOSUB WRAPUP
1090 EXIT 
1098 ! 
1099 ! 
1100 READNEXT:
1110 ENTER FILENO,A$,A{ALL},FOUND
1115 FOUND=0
1120 GOSUB INIT
1125 CALL "UPDDT3;CLEAR_FIELDS",A$,A{ALL}
1149 XP=PRM('XI'); SET_PARAM 'XI'
1150 READ (FILENO,END=*NEXT)IOL=0310; FOUND=1
1151 SET_PARAM 'XI'=XP
1180 GOSUB WRAPUP
1190 EXIT 
1198 ! 
1199 ! 
1200 READPREV:
1210 ENTER FILENO,A$,A{ALL},FOUND
1215 FOUND=0
1220 GOSUB INIT
1225 CALL "UPDDT3;CLEAR_FIELDS",A$,A{ALL}
1249 XP=PRM('XI'); SET_PARAM 'XI'
1250 PKEY$=KEP(FILENO,ERR=*NEXT); READ (FILENO,KEY=PKEY$)IOL=0310; FOUND=1
1251 SET_PARAM 'XI'=XP
1280 GOSUB WRAPUP
1290 EXIT 
1298 ! 
1299 ! 
1300 READFIRST:
1310 ENTER FILENO,A$,A{ALL},FOUND
1315 FOUND=0
1320 GOSUB INIT
1325 CALL "UPDDT3;CLEAR_FIELDS",A$,A{ALL}
1349 XP=PRM('XI'); SET_PARAM 'XI'
1350 PKEY$=KEF(FILENO,KNO=0,ERR=*NEXT); READ (FILENO,KEY=PKEY$)IOL=0310; FOUND=1
1351 SET_PARAM 'XI'=XP
1380 GOSUB WRAPUP
1390 EXIT 
1398 ! 
1399 ! 
1400 READLAST:
1410 ENTER FILENO,A$,A{ALL},FOUND
1415 FOUND=0
1420 GOSUB INIT
1425 CALL "UPDDT3;CLEAR_FIELDS",A$,A{ALL}
1449 XP=PRM('XI'); SET_PARAM 'XI'
1450 PKEY$=KEL(FILENO,ERR=*NEXT); READ (FILENO,KEY=PKEY$)IOL=0310; FOUND=1
1451 SET_PARAM 'XI'=XP
1480 GOSUB WRAPUP
1490 EXIT 
1498 ! 
1499 ! 
1500 EXTRACTBYKEY:
1510 ENTER FILENO,KEYNO,SEG1$,SEG2$,SEG3$,SEG4$,SEG5$,A$,A{ALL},FOUND,BUSY
1515 FOUND=0,BUSY=0
1525 CALL "UPDDT3;CLEAR_FIELDS",A$,A{ALL}
1549 XP=PRM('XI'); SET_PARAM 'XI'
1550 IF POS("DT3"=PTH(FILENO))=0 THEN BUSY=1 ELSE READ (FILENO,KNO=KEYNO,KEY=SEG1$+SEG2$+SEG3$+SEG4$+SEG5$,DOM=*NEXT)IOL=0310; FOUND=1,BUSY=1,PRIMEKEY$=KEC(FILENO,KNO=0); EXTRACT (FILENO,KEY=PRIMEKEY$,KNO=0,ERR=*NEXT); BUSY=0
1551 SET_PARAM 'XI'=XP
1590 EXIT 
1598 ! 
1599 ! 
1600 INSERT:
1610 ENTER FILENO,A$,A{ALL},OK
1615 OK=0,PRIMEKEY$=A$(1,35)
1620 GOSUB INIT
1650 WRITE (FILENO,KEY=PRIMEKEY$,ERR=*NEXT)IOL=0310; OK=1
1680 GOSUB WRAPUP
1690 EXIT 
1698 ! 
1699 ! 
1700 DELETE:
1710 ENTER FILENO,A$,A{ALL},FOUND,BUSY
1715 FOUND=0,BUSY=1,PRIMEKEY$=A$(1,35)
1720 GOSUB INIT
1750 REMOVE (FILENO,KEY=PRIMEKEY$,DOM=DELETE_END,ERR=*NEXT); BUSY=0
1785 DELETE_END:
1787 GOSUB WRAPUP
1790 EXIT 
1798 ! 
1799 ! 
1800 CLEAR_FIELDS:
1810 ENTER A$,A{ALL}
1820 DIM A$(1016),A[3]
1890 EXIT 
1898 ! 
1899 ! 
1900 UPDATE:
1910 ENTER FILENO,A$,A{ALL},BUSY
1915 BUSY=1,PRIMEKEY$=A$(1,35)
1920 GOSUB INIT
1950 WRITE (FILENO,KEY=PRIMEKEY$,ERR=*NEXT)IOL=0310; BUSY=0
1980 GOSUB WRAPUP
1990 EXIT 
1998 ! 
1999 ! 
2000 CLEAR_LOCK:
2010 ENTER FILENO
2020 GOSUB INIT
2050 READ (FILENO,KNO=0,KEY="",ERR=*NEXT)
2080 GOSUB WRAPUP
2090 EXIT 
2098 ! 
2099 ! 
2500 VALIDATE:
2510 ENTER A$,A{ALL},MSG$
2520 A$=PAD(A$,1016),MSG$=""
2990 EXIT 
2998 ! 
2999 ! 
9999 END 
10000 TOD_CUST_INV_UPD_NOT:
10010 ENTER DT3,MEM_FL,DT0,FM0,ZZPARM,IC0,ICF,T$,T{ALL},X3$,TOD_OUTPUT_TYPE$,ADJ_REF$
10011 TOD_OUTPUT_TYPE$=PAD("CUST_INV_UPD_NOT",20)
10012 IF TCB(29)<7100000 THEN GOTO 10390 ! version 7.1
10015 WHS$=T$(21,4),CUST$=T$(1,10); IF CUST$=DIM(10) THEN GOTO 10390
10020 TOD_CHECK$=DIM(2)+PAD(CUST$,20)+PAD(WHS$,10)+DIM(5) ! [SSP-203099]
10022 OBJDT3=NEW("DTGDT3") ! [SSP-203099]
10024 TOD_OK=OBJDT3'CHECK(TOD_CHECK$) ! [SSP-203099]
10026 DROP OBJECT OBJDT3 ! [SSP-203099]
10030 ! CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CUST$,WHS$,DIM(5),TOD_OK; IF NOT(TOD_OK) THEN CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CUST$,DIM(10),DIM(5),TOD_OK
10040 IF TOD_OK THEN {! 
10045 MEM_KEY$=CUST$+WHS$,TOD_TRANS$="",TOD_SEQ=0; READ (MEM_FL,KEY=MEM_KEY$,DOM=*NEXT)MEM_K$,TOD_TRANS$,TOD_SEQ
10050 IF TOD_TRANS$="" THEN CALL "UPDDT0;GET_NEXT_TRANS_NUM",ZZPARM,X3$,TOD_TRANS$
10055 TOD_SEQ=TOD_SEQ+1
10060 CALL "UPDDT3;CLEAR_FIELDS",DT3$,DT3{ALL}
10070 DT3$(1,20)=TOD_OUTPUT_TYPE$,DT3$(21,10)=TOD_TRANS$
10080 DT3$(31,5)=STR(TOD_SEQ:"00000")
10085 DT3$(85,15)=PAD(ADJ_REF$,15)
10090 DT3$(36,24)=T$(1,24),DT3$(66,6)=T$(31,6)
10235 WHSE$=PAD(WHS$,4)
10240 CALL "UPDFM0;READBYKEY",FM0,0,"D",DIM(10),WHSE$,SEG4$,SEG5$,FM0$,FM0{ALL},FOUNDFM0
10250 DT3$(109,10)=MID(FM0$,568,10)
10255 CALL "UPDIC0;READBYKEY",IC0,0,DT3$(36,20),SEG2$,SEG3$,SEG4$,SEG5$,IC0$,IC0{ALL},FOUNDIC0; IF FOUNDIC0 THEN DT3$(120,4)=IC0$(124,4)
10330 DT3[0]=T[0],DT3[1]=T[1]
10335 IF DT3[0]>0 THEN DT3$(119,1)="I" ELSE DT3$(119,1)="D"
10350 CALL "UPDDT3;UPDATE",DT3,DT3$,DT3{ALL},BUSYDT3
10355 WRITE (MEM_FL,KEY=MEM_KEY$)MEM_KEY$,TOD_TRANS$,TOD_SEQ
10360  } ! 20020
10390 EXIT 
10398 ! 
10399 ! 
10500 TOD_CUST_INV_UPD_NOT_PI:
10510 ENTER DT3,MEM_FL,DT0,FM0,ZZPARM,T$,T{ALL},X3$,TOD_OUTPUT_TYPE$
10520 TOD_OUTPUT_TYPE$=PAD("CUST_INV_UPD_NOT",20)
10530 IF TCB(29)<7100000 THEN GOTO 10790 ! version 7.1
10540 WHS$=T$(21,4),CUST$=T$(1,10); IF CUST$=DIM(10) THEN GOTO 10790
10542 TOD_CHECK$=DIM(2)+PAD(CUST$,20)+PAD(WHS$,10)+DIM(5) ! [SSP-203099]
10544 OBJDT3=NEW("DTGDT3") ! [SSP-203099]
10546 TOD_OK=OBJDT3'CHECK(TOD_CHECK$) ! [SSP-203099]
10548 DROP OBJECT OBJDT3 ! [SSP-203099]
10550 ! CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CUST$,WHS$,DIM(5),TOD_OK; IF NOT(TOD_OK) THEN CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CUST$,DIM(10),DIM(5),TOD_OK
10560 IF TOD_OK THEN {! 
10570 MEM_KEY$=CUST$+WHS$,TOD_TRANS$="",TOD_SEQ=0; READ (MEM_FL,KEY=MEM_KEY$,DOM=*NEXT)MEM_K$,TOD_TRANS$,TOD_SEQ
10580 IF TOD_TRANS$="" THEN CALL "UPDDT0;GET_NEXT_TRANS_NUM",ZZPARM,X3$,TOD_TRANS$
10590 TOD_SEQ=TOD_SEQ+1
10600 CALL "UPDDT3;CLEAR_FIELDS",DT3$,DT3{ALL}
10610 DT3$(1,20)=TOD_OUTPUT_TYPE$,DT3$(21,10)=TOD_TRANS$
10620 DT3$(31,5)=STR(TOD_SEQ:"00000")
10630 DT3$(85,2)="PI"
10640 DT3$(36,24)=T$(1,24),DT3$(66,6)=T$(25,6)
10650 WHSE$=PAD(WHS$,4)
10660 CALL "UPDFM0;READBYKEY",FM0,0,"D",DIM(10),WHSE$,SEG4$,SEG5$,FM0$,FM0{ALL},FOUNDFM0
10670 DT3$(109,10)=MID(FM0$,568,10)
10680 DT3$(120,4)=T$(121,4)
10690 DT3[1]=T[1]
10695 DT3[0]=T[2]-T[0]
10700 IF DT3[0]>0 THEN DT3$(119,1)="I" ELSE DT3$(119,1)="D"
10710 IF DT3[0]<>0 THEN CALL "UPDDT3;UPDATE",DT3,DT3$,DT3{ALL},BUSYDT3
10720 IF DT3[0]<>0 THEN WRITE (MEM_FL,KEY=MEM_KEY$)MEM_KEY$,TOD_TRANS$,TOD_SEQ
10730  } ! 20020
10790 EXIT 
10798 ! 
10799 ! 
11000 TOD_CUST_INV_UPD_NOT_LOT:
11010 ENTER DT3,MEM_FL,DT0,FM0,ZZPARM,IC0,ICF,T$,T{ALL},X3$,TOD_OUTPUT_TYPE$,ADJ_REF$
11020 TOD_OUTPUT_TYPE$=PAD("CUST_INV_UPD_NOT",20)
11030 IF TCB(29)<7100000 THEN GOTO 11290 ! version 7.1
11040 WHS$=T$(21,4),CUST$=T$(1,10); IF CUST$=DIM(10) THEN GOTO 11290
11042 TOD_CHECK$=DIM(2)+PAD(CUST$,20)+PAD(WHS$,10)+DIM(5) ! [SSP-203099]
11044 OBJDT3=NEW("DTGDT3") ! [SSP-203099]
11046 TOD_OK=OBJDT3'CHECK(TOD_CHECK$) ! [SSP-203099]
11048 DROP OBJECT OBJDT3 ! [SSP-203099]
11050 ! CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CUST$,WHS$,DIM(5),TOD_OK; IF NOT(TOD_OK) THEN CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CUST$,DIM(10),DIM(5),TOD_OK
11060 IF TOD_OK THEN {! 
11070 MEM_KEY$=CUST$+WHS$,TOD_TRANS$="",TOD_SEQ=0; READ (MEM_FL,KEY=MEM_KEY$,DOM=*NEXT)MEM_K$,TOD_TRANS$,TOD_SEQ
11080 IF TOD_TRANS$="" THEN CALL "UPDDT0;GET_NEXT_TRANS_NUM",ZZPARM,X3$,TOD_TRANS$
11090 TOD_SEQ=TOD_SEQ+1
11100 CALL "UPDDT3;CLEAR_FIELDS",DT3$,DT3{ALL}
11110 DT3$(1,20)=TOD_OUTPUT_TYPE$,DT3$(21,10)=TOD_TRANS$
11120 DT3$(31,5)=STR(TOD_SEQ:"00000")
11125 DT3$(36,24)=T$(1,24),DT3$(66,6)=T$(25,6)
11130 DT3$(85,15)=PAD(ADJ_REF$,15)
11146 DT3$(60,6)=DIM(6) ! not used
11150 WHSE$=PAD(WHS$,4)
11160 CALL "UPDFM0;READBYKEY",FM0,0,"D",DIM(10),WHSE$,SEG4$,SEG5$,FM0$,FM0{ALL},FOUNDFM0
11170 DT3$(109,10)=MID(FM0$,568,10)
11180 DT3$(120,4)=T$(121,4)
11185 CALL "UPDICF;READBYKEY",ICF,0,T$(1,32),SEG2$,SEG3$,SEG4$,SEG5$,ICF$,ICF{ALL},FOUNDICF
11190 DT3[0]=T[4],DT3[1]=T[0]
11195 IF FOUNDICF THEN DT3[0]=T[4]-ICF[4] ! existing lot qty change
11200 IF DT3[0]>0 THEN DT3$(119,1)="I" ELSE DT3$(119,1)="D"
11210 CALL "UPDDT3;UPDATE",DT3,DT3$,DT3{ALL},BUSYDT3
11220 WRITE (MEM_FL,KEY=MEM_KEY$)MEM_KEY$,TOD_TRANS$,TOD_SEQ
11230  } ! 20020
11290 EXIT 
11298 ! 
11299 ! 
56000 REM "198612-TopForm Output director                                     
56002 REM "198997-Export XML inventory adjustments, physical inventory        
56004 REM "203099-Enhancements to Output Director.  Provide ability for       
