0010 ! UPDDT2 - File DT2 Maintenance
0035 REM "5.7 - 10/23/18 - 9.273888 - dmm - SSP# 302939
0037 REM "302939-Create new CUST_PO_RECPT_NOT report similar to CSR version. 
0040 REM "Copyright 2018 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 ! FILENO - CHANNEL OF OPEN FILE
0051 ! KEYNO  - KEY NUMBER
0052 ! SEG1-SEG5$ : KEY SEGMENTS . CAN BE NULL
0053 ! A$ - RECORD A$
0054 ! FOUND - IF RECORD FOUND, THEN 1 ELSE 0
0055 ! BUSY - IF RECORD BUSY THEN 1 ELSE 0
0056 ! OK - IF RECORD ADDED OK=1 ELSE 0
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4]
0500 INIT:
0505 DIM Z[255]; OPENED=0
0507 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,X5$,X0,X1,0
0510 IF FILENO=-99 THEN Z$="01S DT2...  "; CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; FILENO=Z[1],OPENED=1 ELSE IF POS("DT2"=PTH(FILENO))=0 THEN Z$="01S DT2...  "; CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; FILENO=Z[1],OPENED=1
0590 RETURN 
0598 ! 
0599 ! 
0600 WRAPUP:
0610 IF OPENED THEN CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
0690 RETURN 
0698 ! 
0699 ! 
1000 READBYKEY:
1010 ENTER FILENO,KEYNO,SEG1$,SEG2$,SEG3$,SEG4$,SEG5$,A$,A{ALL},FOUND
1015 FOUND=0
1020 GOSUB INIT
1025 CALL "UPDDT2;CLEAR_FIELDS",A$,A{ALL}
1049 XP=PRM('XI'); SET_PARAM 'XI'
1050 READ (FILENO,KNO=KEYNO,KEY=SEG1$+SEG2$+SEG3$+SEG4$+SEG5$,DOM=*NEXT)IOL=0310; FOUND=1
1051 SET_PARAM 'XI'=XP
1080 GOSUB WRAPUP
1090 EXIT 
1098 ! 
1099 ! 
1100 READNEXT:
1110 ENTER FILENO,A$,A{ALL},FOUND
1115 FOUND=0
1120 GOSUB INIT
1125 CALL "UPDDT2;CLEAR_FIELDS",A$,A{ALL}
1149 XP=PRM('XI'); SET_PARAM 'XI'
1150 READ (FILENO,END=*NEXT)IOL=0310; FOUND=1
1151 SET_PARAM 'XI'=XP
1180 GOSUB WRAPUP
1190 EXIT 
1198 ! 
1199 ! 
1200 READPREV:
1210 ENTER FILENO,A$,A{ALL},FOUND
1215 FOUND=0
1220 GOSUB INIT
1225 CALL "UPDDT2;CLEAR_FIELDS",A$,A{ALL}
1249 XP=PRM('XI'); SET_PARAM 'XI'
1250 PKEY$=KEP(FILENO,ERR=*NEXT); READ (FILENO,KEY=PKEY$)IOL=0310; FOUND=1
1251 SET_PARAM 'XI'=XP
1280 GOSUB WRAPUP
1290 EXIT 
1298 ! 
1299 ! 
1300 READFIRST:
1310 ENTER FILENO,A$,A{ALL},FOUND
1315 FOUND=0
1320 GOSUB INIT
1325 CALL "UPDDT2;CLEAR_FIELDS",A$,A{ALL}
1349 XP=PRM('XI'); SET_PARAM 'XI'
1350 PKEY$=KEF(FILENO,KNO=0,ERR=*NEXT); READ (FILENO,KEY=PKEY$)IOL=0310; FOUND=1
1351 SET_PARAM 'XI'=XP
1380 GOSUB WRAPUP
1390 EXIT 
1398 ! 
1399 ! 
1400 READLAST:
1410 ENTER FILENO,A$,A{ALL},FOUND
1415 FOUND=0
1420 GOSUB INIT
1425 CALL "UPDDT2;CLEAR_FIELDS",A$,A{ALL}
1449 XP=PRM('XI'); SET_PARAM 'XI'
1450 PKEY$=KEL(FILENO,ERR=*NEXT); READ (FILENO,KEY=PKEY$)IOL=0310; FOUND=1
1451 SET_PARAM 'XI'=XP
1480 GOSUB WRAPUP
1490 EXIT 
1498 ! 
1499 ! 
1500 EXTRACTBYKEY:
1510 ENTER FILENO,KEYNO,SEG1$,SEG2$,SEG3$,SEG4$,SEG5$,A$,A{ALL},FOUND,BUSY
1515 FOUND=0,BUSY=0
1525 CALL "UPDDT2;CLEAR_FIELDS",A$,A{ALL}
1549 XP=PRM('XI'); SET_PARAM 'XI'
1550 IF POS("DT2"=PTH(FILENO))=0 THEN BUSY=1 ELSE READ (FILENO,KNO=KEYNO,KEY=SEG1$+SEG2$+SEG3$+SEG4$+SEG5$,DOM=*NEXT)IOL=0310; FOUND=1,BUSY=1,PRIMEKEY$=KEC(FILENO,KNO=0); EXTRACT (FILENO,KEY=PRIMEKEY$,KNO=0,ERR=*NEXT); BUSY=0
1551 SET_PARAM 'XI'=XP
1590 EXIT 
1598 ! 
1599 ! 
1600 INSERT:
1610 ENTER FILENO,A$,A{ALL},OK
1615 OK=0,PRIMEKEY$=A$(1,35)
1620 GOSUB INIT
1650 WRITE (FILENO,KEY=PRIMEKEY$,ERR=*NEXT)IOL=0310; OK=1
1680 GOSUB WRAPUP
1690 EXIT 
1698 ! 
1699 ! 
1700 DELETE:
1710 ENTER FILENO,A$,A{ALL},FOUND,BUSY
1715 FOUND=0,BUSY=1,PRIMEKEY$=A$(1,35)
1720 GOSUB INIT
1750 REMOVE (FILENO,KEY=PRIMEKEY$,DOM=DELETE_END,ERR=*NEXT); BUSY=0
1785 DELETE_END:
1787 GOSUB WRAPUP
1790 EXIT 
1798 ! 
1799 ! 
1800 CLEAR_FIELDS:
1810 ENTER A$,A{ALL}
1820 DIM A$(1961),A[4]
1890 EXIT 
1898 ! 
1899 ! 
1900 UPDATE:
1910 ENTER FILENO,A$,A{ALL},BUSY
1915 BUSY=1,PRIMEKEY$=A$(1,35)
1920 GOSUB INIT
1950 WRITE (FILENO,KEY=PRIMEKEY$,ERR=*NEXT)IOL=0310; BUSY=0
1980 GOSUB WRAPUP
1990 EXIT 
1998 ! 
1999 ! 
2000 CLEAR_LOCK:
2010 ENTER FILENO
2020 GOSUB INIT
2050 READ (FILENO,KNO=0,KEY="",ERR=*NEXT)
2080 GOSUB WRAPUP
2090 EXIT 
2098 ! 
2099 ! 
2500 VALIDATE:
2510 ENTER A$,A{ALL},MSG$
2520 A$=PAD(A$,1961),MSG$=""
2990 EXIT 
2998 ! 
2999 ! 
9999 END 
10000 TOD_CUST_PO_RECPT:
10010 ENTER DT2,MEM_FL,DT0,FM0,PO2_B,ZZPARM,A$,E$,F$,G$,X3$,A{ALL},TOD_OUTPUT_TYPE$,F{ALL},AR1$ ! WO302939
10011 TOD_OUTPUT_TYPE$=PAD("CUST_PO_RECPT_NOT",20)
10012 IF TCB(29)<7100000 THEN GOTO 10390 ! version 7.1
10015 IF A[0]=0 THEN GOTO 10390 ! SSP205010
10020 WHS$=G$(12,4),CUST$=F$(91,10); IF CUST$=DIM(10) THEN GOTO 10390 ! SSP205010
10022 OOP=NEW("DTGDT2") ! SSP 214041
10025 CHECK$=PAD(DIVISION$,2)+PAD(CUST$,20)+PAD(WHS$,10)+DIM(5) ! SSP 214041
10028 TOD_OK=OOP'CHECK(CHECK$) ! SSP 214041
10030 ! CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CUST$,WHS$,DIM(5),TOD_OK; IF NOT(TOD_OK) THEN CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CUST$,DIM(10),DIM(5),TOD_OK
10040 IF TOD_OK THEN {! 
10045 MEM_KEY$=A$(1,9)+CUST$+WHS$,TOD_TRANS$="",TOD_SEQ=0; READ (MEM_FL,KEY=MEM_KEY$,DOM=*NEXT)MEM_K$,TOD_TRANS$,TOD_SEQ
10050 IF TOD_TRANS$="" THEN CALL "UPDDT0;GET_NEXT_TRANS_NUM",ZZPARM,X3$,TOD_TRANS$
10055 TOD_SEQ=TOD_SEQ+1
10060 CALL "UPDDT2;CLEAR_FIELDS",DT2$,DT2{ALL}
10070 DT2$(1,20)=TOD_OUTPUT_TYPE$,DT2$(21,10)=TOD_TRANS$
10080 DT2$(31,5)=STR(TOD_SEQ:"00000")
10090 DT2$(36,9)=A$(1,9) ! ponum
10100 DT2$(45,10)=E$(7,10) ! vend
10110 DT2$(55,10)=CUST$
10120 DT2$(65,8)=E$(306,8) ! ord
10130 DT2$(75,4)=E$(343,4) ! sls rep
10140 DT2$(79,4)=E$(347,4) ! cust serv rep
10150 DT2$(74,1)="N"; IF MID(E$,361,1)="Y" THEN DT2$(74,1)="Y"
10160 DT2$(83,4)=WHS$
10170 DT2$(87,1)=F$(6,1) ! line compl
10180 DT2$(88,3)=F$(7,3) ! po line
10190 DT2$(92,3)=F$(11,3) ! ord line
10195 DT2$(162,15)=E$(328,15) ! customer po
10200 DT2$(95,3)=F$(25,3) ! prod code
10210 DT2$(98,10)=F$(101,10) ! item code
10220 DT2$(108,40)=F$(28,40) ! desc
10230 DT2$(148,4)=F$(77,4) ! um
10235 DT2$(177,11)=FN%ZZDISP$(F$(82,9),"P/O") ! WO200524, formatted po num
10240 CALL "UPDFM0;READBYKEY",FM0,0,"D",DIM(10),G$(12,4),SEG4$,SEG5$,FM0$,FM0{ALL},FOUNDFM0; IF FOUNDFM0 THEN DT2$(152,10)=MID(FM0$,568,10)
10245 CALL "UPDEDW;READBYKEY",0,0,F$(82,8),F$(7,3),SEG3$,SEG4$,SEG5$,EDW$,EDW{ALL},FOUNDEDW; IF FOUNDEDW THEN DT2$(288,3)=EDW$(35,3) ! WO255981, attempt to find EDW record for PO line, for external line number
10250 DT2$(291,35)=AR1$(11,35) ! WO302939
10260 CALL "UPDPO2;READBYKEY",PO2_B,0,E$(297,9),SEG2$,SEG3$,SEG4$,SEG5$,PO2$,PO2{ALL},FOUNDPO2
10270 RECV_ALL=1
10280 CALL "UPDPO2;READNEXT",PO2_B,PO2$,PO2{ALL},FOUNDPO2; IF FOUNDPO2 THEN IF PO2$(82,9)<>E$(297,9) THEN FOUNDPO2=0
10290 WHILE FOUNDPO2
10300 IF PO2$(6,1)<>"Y" AND PO2[7]+PO2[6]<PO2[1] THEN RECV_ALL=0,FOUNDPO2=0 ELSE CALL "UPDPO2;READNEXT",PO2_B,PO2$,PO2{ALL},FOUNDPO2; IF FOUNDPO2 THEN IF PO2$(82,9)<>E$(297,9) THEN FOUNDPO2=0
10310 WEND 
10320 IF RECV_ALL THEN DT2$(73,1)="Y" ELSE DT2$(73,1)="N"
10322 XP=POS(QUO=DT2$); IF XP<>0 THEN DT2$(XP,1)=" "; GOTO *SAME ! ssp204213 problem with report writer
10323 XP=POS("'"=DT2$); IF XP<>0 THEN DT2$(XP,1)=" "; GOTO *SAME ! ssp204213 problem with report writer
10330 DT2[0]=A[1]
10340 DT2[1]=A[0]
10345 DT2[2]=F[2]; IF DT2[2]=0 THEN DT2[2]=1 ! UM_AMT FROM PO2
10350 CALL "UPDDT2;UPDATE",DT2,DT2$,DT2{ALL},BUSYDT2
10355 WRITE (MEM_FL,KEY=MEM_KEY$)MEM_KEY$,TOD_TRANS$,TOD_SEQ,TOD_OUTPUT_TYPE$
10360  } ! 20020
10370 DROP OBJECT OOP ! SSP 214041
10390 EXIT 
10398 ! 
10399 ! 
15000 TOD_CSR_PO_RECPT:
15010 ENTER DT2,MEM_FL,DT0,FM0,PO2_B,ZZPARM,A$,E$,F$,G$,X3$,A{ALL},TOD_OUTPUT_TYPE$,F{ALL},AR1$ ! WO302939
15011 TOD_OUTPUT_TYPE$=PAD("CSR_PO_RECPT_NOT",20)
15012 IF TCB(29)<7100000 THEN GOTO 15490 ! version 7.1
15032 IF A[0]=0 THEN GOTO 15490 ! SSP205010
15040 WHS$=G$(12,4),CSR$=E$(347,4); IF CSR$=DIM(4) THEN GOTO 15490
15042 OOP=NEW("DTGDT2C") ! SSP 214041
15045 CHECK$=PAD(DIVISION$,2)+PAD(CSR$,20)+PAD(WHS$,10)+DIM(5) ! SSP 214041
15048 TOD_OK=OOP'CHECK(CHECK$) ! 214041
15050 ! CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CSR$,WHS$,DIM(5),TOD_OK; IF NOT(TOD_OK) THEN CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CSR$,DIM(10),DIM(5),TOD_OK
15060 IF TOD_OK THEN {! 
15070 MEM_KEY$=A$(1,9)+CSR$+WHS$,TOD_TRANS$="",TOD_SEQ=0; READ (MEM_FL,KEY=MEM_KEY$,DOM=*NEXT)MEM_K$,TOD_TRANS$,TOD_SEQ
15080 IF TOD_TRANS$="" THEN CALL "UPDDT0;GET_NEXT_TRANS_NUM",ZZPARM,X3$,TOD_TRANS$
15090 TOD_SEQ=TOD_SEQ+1
15100 CALL "UPDDT2;CLEAR_FIELDS",DT2$,DT2{ALL}
15110 DT2$(1,20)=TOD_OUTPUT_TYPE$,DT2$(21,10)=TOD_TRANS$
15120 DT2$(31,5)=STR(TOD_SEQ:"00000")
15130 DT2$(36,9)=A$(1,9) ! ponum
15140 DT2$(45,10)=E$(7,10) ! vend
15150 DT2$(55,10)=F$(91,10) ! SSP#218283
15160 DT2$(65,8)=E$(306,8) ! ord
15170 DT2$(75,4)=E$(343,4) ! sls rep
15180 DT2$(79,4)=E$(347,4) ! cust serv rep
15190 DT2$(74,1)="N"; IF MID(E$,361,1)="Y" THEN DT2$(74,1)="Y"
15200 DT2$(83,4)=WHS$
15210 DT2$(87,1)=F$(6,1) ! line compl
15220 DT2$(88,3)=F$(7,3) ! po line
15230 DT2$(92,3)=F$(11,3) ! ord line
15240 DT2$(162,15)=E$(328,15) ! customer po
15250 DT2$(95,3)=F$(25,3) ! prod code
15260 DT2$(98,10)=F$(101,10) ! item code
15270 DT2$(108,40)=F$(28,40) ! desc
15280 DT2$(148,4)=F$(77,4) ! um
15285 DT2$(177,11)=FN%ZZDISP$(F$(82,9),"P/O") ! WO200524, formatted po num
15290 CALL "UPDFM0;READBYKEY",FM0,0,"D",DIM(10),G$(12,4),SEG4$,SEG5$,FM0$,FM0{ALL},FOUNDFM0; IF FOUNDFM0 THEN DT2$(152,10)=MID(FM0$,568,10)
15295 DT2$(291,35)=AR1$(11,35) ! WO302939
15300 CALL "UPDPO2;READBYKEY",PO2_B,0,E$(297,9),SEG2$,SEG3$,SEG4$,SEG5$,PO2$,PO2{ALL},FOUNDPO2
15310 RECV_ALL=1
15320 CALL "UPDPO2;READNEXT",PO2_B,PO2$,PO2{ALL},FOUNDPO2; IF FOUNDPO2 THEN IF PO2$(82,9)<>E$(297,9) THEN FOUNDPO2=0
15330 WHILE FOUNDPO2
15340 IF PO2$(6,1)<>"Y" AND PO2[7]+PO2[6]<PO2[1] THEN RECV_ALL=0,FOUNDPO2=0 ELSE CALL "UPDPO2;READNEXT",PO2_B,PO2$,PO2{ALL},FOUNDPO2; IF FOUNDPO2 THEN IF PO2$(82,9)<>E$(297,9) THEN FOUNDPO2=0
15350 WEND 
15360 IF RECV_ALL THEN DT2$(73,1)="Y" ELSE DT2$(73,1)="N"
15362 XP=POS(QUO=DT2$); IF XP<>0 THEN DT2$(XP,1)=" "; GOTO *SAME ! ssp204213 problem with report writer
15363 XP=POS("'"=DT2$); IF XP<>0 THEN DT2$(XP,1)=" "; GOTO *SAME ! ssp204213 problem with report writer
15370 DT2[0]=A[1]
15380 DT2[1]=A[0]
15390 DT2[2]=F[2]; IF DT2[2]=0 THEN DT2[2]=1 ! UM_AMT FROM PO2
15400 CALL "UPDDT2;UPDATE",DT2,DT2$,DT2{ALL},BUSYDT2
15410 WRITE (MEM_FL,KEY=MEM_KEY$)MEM_KEY$,TOD_TRANS$,TOD_SEQ,TOD_OUTPUT_TYPE$
15420  } ! 20020
15450 DROP OBJECT OOP ! SSP 214041
15490 EXIT 
20000 TOD_KIT_PO_RECPT:! SSP 208675
20010 ENTER DT2,MEM_FL,DT0,ZZPARM,X3$,DT2$,DT2{ALL},TOD_OUTPUT_TYPE$
20011 TOD_OUTPUT_TYPE$=PAD("KIT_PO_RECPT_NOT",20)
20014 IF TCB(29)<7100000 THEN GOTO 20490 ! version 7.1
20040 WHS$=DT2$(83,4),CSR$=DT2$(79,4); IF CSR$=DIM(4) THEN GOTO 20490
20042 OOP=NEW("DTGDT2B")
20045 CHECK$=PAD(DIVISION$,2)+PAD(CSR$,20)+PAD(WHS$,10)+DIM(5)
20048 TOD_OK=OOP'CHECK(CHECK$)
20050 ! CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CSR$,WHS$,DIM(5),TOD_OK; IF NOT(TOD_OK) THEN CALL "UPDDT0;CHECK",DT0,TOD_OUTPUT_TYPE$,DIM(2),CSR$,DIM(10),DIM(5),TOD_OK
20060 IF TOD_OK THEN {! 
20070 MEM_KEY$=DT2$(36,9)+CSR$+WHS$,TOD_TRANS$="",TOD_SEQ=0; READ (MEM_FL,KEY=MEM_KEY$,DOM=*NEXT)MEM_K$,TOD_TRANS$,TOD_SEQ
20080 IF TOD_TRANS$="" THEN CALL "UPDDT0;GET_NEXT_TRANS_NUM",ZZPARM,X3$,TOD_TRANS$
20090 TOD_SEQ=TOD_SEQ+1
20100 ! CALL "UPDDT2;CLEAR_FIELDS",DT2$,DT2{ALL}
20110 DT2$(1,20)=TOD_OUTPUT_TYPE$,DT2$(21,10)=TOD_TRANS$
20120 DT2$(31,5)=STR(TOD_SEQ:"00000")
20185 DT2$(177,11)=FN%ZZDISP$(DT2$(36,9),"P/O") ! WO200524, formatted po num
20200 XP=POS(QUO=DT2$); IF XP<>0 THEN DT2$(XP,1)=" "; GOTO *SAME ! ssp204213 problem with report writer
20210 XP=POS("'"=DT2$); IF XP<>0 THEN DT2$(XP,1)=" "; GOTO *SAME ! ssp204213 problem with report writer
20400 CALL "UPDDT2;UPDATE",DT2,DT2$,DT2{ALL},BUSYDT2
20410 WRITE (MEM_FL,KEY=MEM_KEY$)MEM_KEY$,TOD_TRANS$,TOD_SEQ,TOD_OUTPUT_TYPE$
20420  } ! 20020
20450 DROP OBJECT OOP
20490 EXIT 
56000 REM "198612-TopForm Output director                                     
56002 REM "200524-Ability to send an email to originator of PO that product   
56004 REM "205010-PO Receipt XML                                              
56006 REM "255981-Pier1; Capture their line num from 810, store it in EDW,    
56008 REM "302939-Create new CUST_PO_RECPT_NOT report similar to CSR version. 
