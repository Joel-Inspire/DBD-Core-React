0010 REM "Sample Rebate Update Report <GB2RSA>
0035 REM "4.4 - 01/07/00 - 16.78 - kmc - SSP# 120526
0040 REM "Copyright 1999 Computer Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 CLEAR ; SETERR 9000
0095 PRECISION 14; T2=TIM; PRECISION 2
0105 SETERR 9000; SETESC 9300
0110 X0$="GB2RSA",X1$="Sample Rebate Update Report"
0120 DIM A$(10),A[3],B$(600),C$(53),P[7]
0140 Z0$="##,###,###.00-",Z1$="###.00-"
0160 DEF FNP$(Z9$)="("+Z9$(1,3)+") "+Z9$(4,3)+"-"+Z9$(7,4)+" Ext: "+Z9$(11,4)
0165 DEF FND$(Z9$)=Z9$(NUM(X3$(48,1))*2+1,2)+X3$(59,1)+Z9$(7-NUM(X3$(48,1))*2,2)+X3$(59,1)+STR((ASC(Z9$(1,1))-65)*10+1900+NUM(Z9$(2,1))-1570*POS("  "=Z9$(1,2)):"####")
0170 DEF FNT$(Z9$)=STR(NUM(Z9$(1,2))-12*POS("13"<=Z9$(1,2),2)+12*POS("00"=Z9$(1,2)):"00")+":"+STR(NUM(Z9$(3,2))*.6:"00")+" "+CHR(65+15*POS("12"<=Z9$(1,2),2))+"M"
0210 T=1,T0=0,T1=5
0220 W3=79
0225 W=999
0230 DIM T1$(W3,"-"),T2$(W3,"="),T3$(W3,"*"),Y5$(W3),Y6$(W3)
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,"",-1,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0300 REM "I/O lists
0305 REM "IOLIST FOR GB0 - Sample Rebate file
0310 IOLIST A$,A[0],A[1],A[2],A[3]
0315 REM "IOLIST FOR AR1 - Customer Masterfile
0320 IOLIST B$
0330 IOLIST FMP$,FMP[0],FMP[1],FMP[2],FMP[3]
0340 IOLIST AR9$,AR9[0],AR9[1],AR9[2],AR9[3],AR9[4],AR9[5],AR9[6],AR9[7],AR9[8],AR9[9],AR9[10],AR9[11],AR9[12],AR9[13],AR9[14]
0420 IOLIST X3$,X4$,V1$,V3$,V2$,V0$,V0[0],V0[1]
0500 REM "Files
0505 DIM Z[NUM(X3$(60,3))]; GOSUB 7400
0510 Y$="01O GB0...  02O AR1...  03O FMP...  04O AR9... 13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Y$,Z{ALL},Z0,Z1
0560 READ (Z[13],KEY=X3$(9,3)+"A/R")P$,P[0],P[1],P[2],P[3],P[4],P[5],P[6],P[7]
0700 REM "Open Printer
0720 REM 
0800 REM "Alternate Sort Info & total dim"
0805 DIM U0$(4)
0810 ON V0 GOTO 0820,0820,0830,0840
0820 DIM U[1]; U=10,U0=1,U[0]=0,U[1]=10,T0=1,V1=10,V2=0,U0$="    ",T5$="AA/R            ",U5$="Customer"; GOTO 0850
0830 DIM U[3]; U=23,U0=3,U[0]=0,U[1]=3,U[2]=10,U[3]=10,T0=0,U0$="    ",T5$="                "; GOTO 0850
0850 DIM T[T0,5]
0860 V5=V1+1,V6=V5+V2,V7=V6+V3
0870 W0$="Minimum Total Sales to Qualify: "+STP(STR(V0[0]:Z0$),2)
0872 W1$="Rebate Applied: "+STP(STR(V0[1]:Z1$),2)
0880 IF V0$(73,1)<>"Y" THEN GOSUB 7500; REM "If not skip calculation, then do calculation stuff
0890 IF V0$(74,1)="Y" THEN GOTO 5000; REM "If set to skip report then skip here
0895 CALL "ZZPRIN",X0$,X3$,Y0$,V3$,Z{ALL},W8$,W9$,W0,W9,W2,W3,W4; ON W4 GOTO 0896,9920
0900 REM " Position read"
0905 REM "set key file to read from"
0910 U1=Z[1]
0920 GOTO 0960
0934 REM "create default 'all' range key
0935 REM DIM V2$(U*2),V4$(U,"~"); LET U3=1
0940 FOR U9=1 TO U0; U3=U3+U[U9-1]+U[U9-1]
0950 V2$(U3+U[U9],U[U9])=V4$(1,U[U9])
0955 NEXT U9
0964 REM "Get starting key from range key
0965 DIM V4$(U); U3=1,U4=1
0970 FOR U9=1 TO U0; U3=U3+U[U9-1]+U[U9-1],U4=U4+U[U9-1]
0975 V4$(U4,U[U9])=V2$(U3,U[U9])
0980 NEXT U9
0985 V4$(U,1)=CHR(ASC(V4$(U,1))-1)
0990 READ (U1,KEY=V4$,DOM=0991)
1000 REM "Read next record
1005 U$=KEY(U1,END=5000)
1008 REM "check key against range info"
1009 U3=1,U2=1
1010 FOR U9=1 TO U0; U2=U2+U[U9-1],U3=U3+U[U9-1]+U[U9-1]
1020 IF U$(U2,U[U9])>=V2$(U3,U[U9]) THEN GOTO 1030 ELSE EXTRACT (U1,KEY=U$(1,U2-1)+V2$(U3,U[U9]),DOM=1021)
1025 EXITTO 1000
1030 IF U$(U2,U[U9])<=V2$(U3+U[U9],U[U9]) THEN GOTO 1040 ELSE READ (U1,KEY=U$(1,U2-1)+$FF$,DOM=1032)
1035 EXITTO 1000
1040 NEXT U9
1100 REM "Get record"
1110 U9$=U$,A$=U9$
1150 READ (Z[1],KEY=U$,DOM=1000)IOL=0310
1190 IF V0$(79,1)="Y" AND A[3]=0 THEN GOTO 1000
1300 REM "Read other data
1400 REM "Subtotals"
1415 GOSUB 3100
1420 ON T GOTO 1470,1430
1430 GOSUB 6200
1490 T=0
1500 REM "Print Data
1510 IF W+1>W0 THEN GOSUB 6000
1520 Y5$(12)=STR(A[0]:Z0$),Y5$(27)=STR(A[1]:Z0$),Y5$(42)=STR(A[2]:Z0$),Y5$(57)=STR(A[1]-A[2]:Z0$),Y5$(72)=STR(A[3]:Z1$)
1590 GOSUB 7300
1600 REM 
1900 REM "Accumulate Totals"
1910 T[T0,1]=T[T0,1]+A[0],T[T0,2]=T[T0,2]+A[1],T[T0,3]=T[T0,3]+A[2],T[T0,4]=T[T0,4]+A[1]-A[2],T[T0,5]=T[T0,5]+A[3]
1990 T[T0,0]=T[T0,0]+1
1995 GOTO 1000
3000 REM "Subtotaling Routines"
3050 REM "Add to T$ for total title, T & T5 should be set
3055 T7$=T5$(T*4-3,4)
3060 IF T7$(1,1)=" " THEN RETURN 
3070 IF T7$(1,1)<>"S" THEN CALL "ZZDISP",T7$(1,1)+"X",T6$,T7$(2,3),X3$,T6$,"",0,0,X4$
3080 IF T$="" THEN T$=T6$ ELSE T$=T$+" "+T6$
3090 RETURN 
3100 REM "High order break"
3110 IF V1=0 THEN RETURN ELSE IF U1$=U9$(1,V1) THEN GOSUB 3200; RETURN 
3120 GOSUB 3220
3130 IF U1$="" THEN GOTO 3160
3150 T=1,T$=U5$,T6$=U1$; GOSUB 3050; GOSUB 7000
3160 U1$=U9$(1,V1)
3180 RETURN 
3200 REM "Second highest order break"
3210 IF V2=0 THEN RETURN ELSE IF U2$=U9$(V5,V2) THEN GOSUB 3300; RETURN 
3220 GOSUB 3320
3230 IF U2$="" THEN GOTO 3260
3250 T=2,T$=U6$,T6$=U2$; GOSUB 3050; GOSUB 7000
3255 IF U0$(2,1)="Y" THEN GOSUB 6000
3260 U2$=U9$(V5,V2)
3280 RETURN 
3380 RETURN 
3480 RETURN 
5000 REM "End of Print
5020 IF W8=0 THEN GOTO 5290
5030 T0$="END"
5040 IF V1>0 THEN GOSUB 3120
5050 T=0,T$="Report"; GOSUB 7000
5200 REM "
5290 GOTO 9900
6000 REM "Page header
6035 IF T0$="END" THEN W0$=""
6040 CALL "ZZHEAD",X0$,X1$,X2$,X3$,W0$,W1$,W2$,W9$,W3,W,W9,W8,W0,W5,W2,W8$,W5$; IF T0$="END" THEN GOTO 6060 ELSE ON W5 GOTO 6041,9910
6045 ON W5 GOTO 6046,9900
6060 GOSUB 6100
6070 GOSUB 7300
6090 RETURN 
6100 REM "
6115 Y5$(16)="Current",Y5$(33)=V0$(75,4),Y5$(46)="Excluded",Y5$(61)="Elgible"
6120 GOSUB 7300
6125 Y5$(1)="Customer",Y5$(16)="Balance",Y5$(33)="Sales",Y5$(48)="Sales",Y5$(63)="Sales",Y5$(72)="Rebate"
6130 GOSUB 7300
6199 RETURN 
6200 REM "Break #1 header
6210 IF W+2>W0 THEN GOSUB 6000
6225 CALL "ZZDISP","AX",A$(1,10),"A/R",X3$,X$,"",0,0,X4$; Y5$(1)=X$
6230 DIM B$(100)
6235 FIND (Z[2],KEY=A$(1,10),DOM=6240)IOL=0320
6250 Y5$(3+LEN(X$))=B$(11,35)
6255 GOSUB 7300
6299 RETURN 
6300 REM "Break #2 header
6399 RETURN 
7000 REM "Totals logic
7001 IF T=T0 THEN IF T[T0,0]<2 THEN GOSUB 7300; GOTO 7100
7002 IF W+3>W0 THEN GOSUB 6000
7010 Y5$(1)=T3$(1,T0+1-T)+" "
7015 REM "IF T$<>"" THEN LET Y5$(T0+2-T)=T$+" TOTAL ("+STR(T[T,0]:"0")+"):"
7020 Y5$(12)=T1$(1,LEN(Z0$)),Y5$(27)=T1$(1,LEN(Z0$)),Y5$(42)=T1$(1,LEN(Z0$)),Y5$(57)=T1$(1,LEN(Z0$)),Y5$(72)=T1$(1,LEN(Z1$)); GOSUB 7300
7025 Y5$(12)=STR(T[T,1]:Z0$),Y5$(27)=STR(T[T,2]:Z0$),Y5$(42)=STR(T[T,3]:Z0$),Y5$(57)=STR(T[T,4]:Z0$),Y5$(72)=STR(T[T,5]:Z1$)
7030 GOSUB 7300
7064 IF T$="END" THEN Y5$(37)=T2$(1,15); GOSUB 7300
7065 IF T$="END" THEN Y5$(12)=T2$(1,LEN(Z0$)),Y5$(27)=T2$(1,LEN(Z0$)),Y5$(42)=T2$(1,LEN(Z0$)),Y5$(57)=T2$(1,LEN(Z0$)),Y5$(72)=T2$(1,LEN(Z1$)); GOSUB 7300
7090 IF T0$="END" THEN IF T=0 THEN GOSUB 7200; GOTO 7190
7100 REM "Accumulate sub totals
7110 IF T=0 THEN GOTO 7190
7120 FOR X=0 TO T1
7130 T[T-1,X]=T[T-1,X]+T[T,X],T[T,X]=0
7140 NEXT X
7190 RETURN 
7200 REM "Elapsed time routine"
7205 GOSUB 7300; Y5$(1)="Number of items printed: "+STR(T[0,0]); GOSUB 7300
7210 PRECISION 14; T2=TIM-T2
7220 IF INT(T2)>0 THEN T4$=STR(INT(T2))+" Hours " ELSE T4$=""
7230 T3=INT(FPT(T2)*3600)
7240 T3=T3/60
7250 T4$=T4$+STR(T3:"##.##")+" Minutes"
7260 Y5$(1)="Elapsed time: "+T4$; GOSUB 7300
7280 PRECISION 2
7290 RETURN 
7300 REM "Output line Y5$ to output device
7310 IF POS("V"=W8$)>0 THEN CALL "ZZVIEW",X3$,0,0,W3,W9,W,W9$,Y5$; GOTO 7390
7320 W=W+1; IF POS(" "<>Y5$)=0 THEN PRINT (W9)"" ELSE PRINT (W9)Y5$; Y5$(1)=""
7330 REM 
7390 IF W>=W0 THEN GOSUB 6000
7395 RETURN 
7400 REM "Read report selection parameters"
7410 Z$="12O ZZP     "
7420 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 7421,9900
7430 Y3$=X3$(1,6),Y4$=X3$(178,7); DIM V0[1]
7450 READ (Z[12],KEY=X3$(1,8),DOM=7451)IOL=0420
7480 X3$(178,7)=Y4$,V0=NUM(V0$(71,1)),W3$=V0$(19,POS("   "=V0$(19,40)+"   ")-1)
7485 FOR U1=1 TO LEN(V1$); IF V1$(U1,1)=" " THEN V1$(U1,1)="."; NEXT U1 ELSE NEXT U1
7490 RETURN 
7500 REM "If all range, then init file, else clear for customer range
7501 REM "Then calculate new numbers
7505 IF V2$(1,20)=DIM(10)+DIM(10,$7E$) THEN CALL "ZZINIT",STR(Z[1]:"00"); GOTO 7545
7506 PRINT @(20,19),"Clearing customer range",
7507 READ (Z[1],KEY=V2$(1,9)+CHR(ASC(V2$(10,1))-1),DOM=7508)
7510 K1$=KEY(Z[1],END=7540); IF K1$(1,10)>V2$(11,10) THEN GOTO 7540
7515 CALL "ZZDISP","A",K1$(1,10),"A/R",X3$,"","",25,20,X4$
7520 REMOVE (Z[1],KEY=K1$,DOM=7521)
7535 GOTO 7510
7540 PRINT @(0,19),'CE',
7545 GOSUB 8100
7550 READ (Z[4],KEY=V2$(1,9)+CHR(ASC(V2$(10,1))-1),DOM=7551)
7560 DIM AR9[14]; READ (Z[4],END=7590)IOL=0340; XC=XC+1; IF MOD(XC,XT0)=1 THEN GOSUB 8150 END_IF ; IF AR9$(1,10)>V2$(11,10) THEN GOTO 7590 ELSE IF AR9$(11,4)<>V0$(75,4) OR POS(AR9$(15,1)="SE")=0 THEN GOTO 7560; REM "Do range, and only do this fiscal year, only interested in Sales or Excluded sales
7565 DIM FMP$(243),FMP[3]; FIND (Z[3],KEY="D"+AR9$(1,10),DOM=7566)IOL=0330
7570 DIM A$(10),A[3]; A$(1)=AR9$(1,10); REM "Customer number
7571 REM "If S type add to sales, if E add to excluded, then recalc & write out
7572 EXTRACT (Z[1],KEY=A$(1,10),DOM=7573)IOL=0310
7573 A[0]=FMP[2]; REM "Current balance
7575 AMT=0; FOR II=1 TO 13; AMT=AMT+AR9[II]; NEXT II
7578 IF AR9$(15,1)="S" THEN A[1]=A[1]+AMT ELSE A[2]=A[2]+AMT
7580 A[3]=0; IF A[1]-A[2]>V0[0] THEN A[3]=(A[1]-A[2])*V0[1]/100
7582 WRITE (Z[1],KEY=A$(1,10))IOL=0310
7585 GOTO 7560
7590 PRINT @(0,17),'CE'
7595 RETURN 
7600 REM "Update Processing
7605 PRINT @(0,15),'CE',; CALL "ZZINFO",Z[1],XT9,X3$,XT,XT0,XK,XB,XD,XS0,XS1,XF$
7610 IF XT=0 THEN GOTO 7695; REM "No records to process
7615 CALL "ZZPROM",".Y",X3$,Z,"Update sample rebate amounts to customers?","","",0; ON Z GOTO 7616,7695
7616 CALL "ZZPROM",".Y",X3$,Z,"Proceed with update?","","",0; ON Z GOTO 7617,7695
7617 XT1=0,XC=0,XT0=INT(XT*.02); IF XT0<=1 THEN XT0=2; PRINT @(15,17),"Updating rebates - there are "+STR(XT)+" records to update",
7625 READ (Z[1],KEY=V2$(1,9)+CHR(ASC(V2$(10,1))-1),DOM=7626)
7630 DIM A$(10),A[3]; READ (Z[1],END=7645)IOL=0310; IF A$(1,10)>V2$(11,10) THEN GOTO 7645
7633 XC=XC+1; IF MOD(XC,XT0)=1 THEN GOSUB 8150
7635 DIM FMP$(243),FMP[3]; FMP$(1)="D"+A$(1,10); EXTRACT (Z[3],KEY="D"+A$(1,10),DOM=7636)IOL=0330
7637 FMP[2]=A[3]; WRITE (Z[3],KEY=FMP$(1,11))IOL=0330
7640 GOTO 7630
7645 XC=XT; GOSUB 8150
7695 RETURN 
8100 REM "GOSUB here, once, at the beginning, after the background is set and before the Proceed? question. Set T to total # to do (by calling ZZINFO) and T0 to the reporting interval (report every T0 number of records) this is typically 2% of total; This also prints a message (@8115),so adjust accordingly
8110 CALL "ZZINFO",Z[4],XT9,X3$,XT,XT0,XK,XB,XD,XS0,XS1,XF$
8115 PRINT @(10,17),"Calculating rebates - there are "+STR(XT)+" records to process"
8130 XT1=0,XC=0,XT0=INT(XT*.02); IF XT0<=1 THEN XT0=2
8135 GOSUB 8150
8145 RETURN 
8150 REM "Call this each time to update the bar graph. Display horiz. bar graph given total #, T and current #, C, and time counter T1 (T1 is init'ed here and used here, just don't use it somewhere else)
8155 CALL "ZZBARG",X3$,"HG",19,10,50,XT1,XT,XC
8195 RETURN 
9000 REM "ERROR PROCESSING
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 1000
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9900 REM "End program
9905 IF POS("V"=W8$)>0 THEN GOSUB 6000
9910 IF V0$(74,1)<>"Y" THEN CALL "ZZERPT",X3$,X4$,X0$,Y3$,Y4$,W9,W2,W5,W,W0,W8,T3,V3$
9915 GOSUB 7600; REM "Update processing
9920 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 IF Y4$<>"" THEN RUN Y4$,ERR=9931
9940 RUN "ZMENU"
9999 END 
