0010 REM "Sample Rebate Processing <GB2SRA>
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 11/15/11 - 18.019722 - jvv - SSP# 249775
0037 REM "249775-Changes to sales tax parameters and tax calculations to     
0040 REM "Copyright 2011 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 REM "Command C=calculate SR & Post to Sample Rebate balance, return in REBATE
0051 REM "D=Deleting Sample rebate, add amount back to Sample Rebate balance
0052 REM "M=manual adjustment of rebate, amount to adjust passed in in REBATE. positive= use more balance, neg=use less rebate balance. PASS BACK REBATE=-1 if enough rebate available, REBATE= most you could get, calling program to adjust line
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,COMMAND$,ARB$,ARB{ALL},REBATE
0100 SETERR 9000
0110 X0$="GB2SRA",X1$="Sample Rebate Processing"
0250 REBATE_IN=REBATE,REBATE=0
0255 DIM FMP$(48),FMP[3],Y[4],ART$(144),ART[48],IC0$(187),IC0[40] ! SSP 249775
0290 IOLIST Y[0],Y[1],Y[2],Y[3],Y[4]
0300 REM "IOLISTS
0310 IOLIST FMP$,FMP[0],FMP[1],FMP[2],FMP[3]
0320 IOLIST LINK,ART$,ART[0],ART[1],ART[2],ART[3],ART[4],ART[5],ART[6],ART[7],ART[8],ART[9],ART[10],ART[11],ART[12],ART[13],ART[14],ART[15],ART[16],ART[17],ART[18],ART[19],ART[20],ART[21],ART[22],ART[23],ART[24],ART[25],ART[26],ART[27],ART[28],ART[29],ART[30],ART[31],ART[32],ART[33],ART[34],ART[35],ART[36],ART[37],ART[38],ART[39],ART[40],ART[41],ART[42],ART[43],ART[44],ART[45],ART[46],ART[47],ART[48] ! SSP 249775
0330 IOLIST IC0$,IC0[0],IC0[1],IC0[2],IC0[3],IC0[4],IC0[5],IC0[6],IC0[7],IC0[8],IC0[9],IC0[10],IC0[11],IC0[12],IC0[13],IC0[14],IC0[15],IC0[16],IC0[17],IC0[18],IC0[19],IC0[20],IC0[21],IC0[22],IC0[23],IC0[24],IC0[25],IC0[26],IC0[27],IC0[28],IC0[29],IC0[30],IC0[31],IC0[32],IC0[33],IC0[34],IC0[35],IC0[36],IC0[37],IC0[38],IC0[39],IC0[40]
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01O FMP... 02O ART... 03O IC0... 13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0530 F=Z[2]
0580 FIND (Z[13],KEY=X3$(9,3)+"G/B",DOM=9900)GB$
0585 IF STP(GB$(93,10),3," ")="" THEN GOTO 9900; REM "if no sample rebate item then leave
0590 FIND (Z[1],KEY="D"+ARB$(15,10),DOM=9900)IOL=0310; REM "If not found, no rebate to do
0600 REM "
0610 ON POS(COMMAND$="CDM") GOTO 9900,1000,2000,2100,9900
1000 REM "C, Calculate SR & post it
1010 REM "FMP read on line 590
1015 IF FMP[2]=0 THEN REBATE=0; GOTO 1995; REM "No rebate left to use, just exit
1020 SR_LINE=0; SR_LINE=NUM(ARB$(410,5),ERR=1021)
1100 REM "Add lines, skipping Freight (F) type lines, and the sample rebate line (if it exists)
1105 NEXT_LINE=ARB[20],LINE_TOTAL=0,FIRST_PROD_CODE$="",LAST_LINE=0
1110 IF NEXT_LINE<=0 THEN GOTO 1140
1120 READ (Z[2],IND=NEXT_LINE)IOL=0320
1125 IF ART$(1,1)="F" OR ART$(2,1)="Y" OR NEXT_LINE=SR_LINE THEN GOTO 1126 ELSE LINE_TOTAL=LINE_TOTAL+ART[4]; IF FIRST_PROD_CODE$="" THEN FIRST_PROD_CODE$=ART$(3,3); REM "Skip line if Freight tyhep, costed freight line, or is the existing sample rebate line.
1133 LAST_LINE=NEXT_LINE,NEXT_LINE=LINK
1135 GOTO 1110
1150 REM "Check sample rebate balance, choose lower value & update FMP record
1155 IF LINE_TOTAL=0 OR LAST_LINE=0 THEN GOTO 1995
1160 EXTRACT (Z[1],KEY="D"+ARB$(15,10),DOM=1995)IOL=0310
1165 IF FMP[2]<LINE_TOTAL THEN REBATE=FMP[2],FMP[2]=0 ELSE REBATE=LINE_TOTAL,FMP[2]=FMP[2]-LINE_TOTAL
1180 GOSUB 3000
1190 WRITE (Z[1],KEY="D"+ARB$(15,10))IOL=0310
1995 GOTO 9900
2000 REM "D, Delete amount by adding back to sample rebate balance
2001 REM "This routine doesnot actually delete the line, but puts the amount back into the Rebate Balance
2005 SR_LINE=0,SR_LINE=NUM(ARB$(410,5),ERR=2006)
2007 ARB$(410,5)="    0"
2010 IF SR_LINE=0 THEN GOTO 2095 ELSE EXTRACT (Z[2],IND=SR_LINE)IOL=0320
2015 REBATE=ART[4]; ART[2]=0,ART[3]=0,ART[4]=0,ART[5]=0; WRITE (Z[2],IND=SR_LINE)IOL=0320; REM "Get rebate amount, then clear all buckets to 0 & write out
2050 EXTRACT (Z[1],KEY="D"+ARB$(15,10),DOM=2095)IOL=0310
2055 FMP[2]=FMP[2]+(-REBATE)
2060 WRITE (Z[1],KEY="D"+ARB$(15,10))IOL=0310
2095 GOTO 9900
2100 REM "M, manual adjustment of rebate
2105 EXTRACT (Z[1],KEY="D"+ARB$(15,10),DOM=2195)IOL=0310
2110 IF REBATE_IN<=0 OR REBATE_IN<=FMP[2] THEN REBATE=-1,FMP[2]=FMP[2]+(-REBATE_IN) ELSE REBATE=FMP[2],FMP[2]=0
2190 WRITE (Z[1],KEY="D"+ARB$(15,10))IOL=0310
2195 GOTO 9900
3000 REM "Create ART line from sample rebate item code
3005 DIM ART$(289),ART[20]
3010 GOSUB 3100; REM "Get ITEM$ - sample rebate charge item code
3012 ART$(1,1)="I",ART$(3,3)=IC0$(61,3),ART$(6,1)="Y"; REM "Type, prod code, print on invoice
3014 ART$(7,40)=IC0$(21,40),ART$(50,4)="EACH",ART[6]=1; REM "Desc, U/M, qty per U/M
3016 ART$(54,1)="Y",ART$(55,20)=DIM(10)+ITEM$,ART$(84,5)=ARB$(128,5); REM "Taxable, item code, commission code from invoice header
3018 ART$(125,10)=ARB$(67,10); REM "Sales tax code from header
3020 ART[0]=1,ART[1]=1,ART[2]=-REBATE,ART[3]=-REBATE; REM "qty ordered, qty shipped, unit price, unit cost
3022 ART[4]=-REBATE,ART[5]=-REBATE,ART[10]=-REBATE; REM "Extended price, extended cost, sell price at billing
3050 REM "Write out line
3055 GOSUB 5200; REM "Get a9
3060 LINK=0; WRITE (Z[2],IND=A9)IOL=0320
3065 EXTRACT (Z[2],IND=LAST_LINE)IOL=0320
3070 LINK=A9; WRITE (Z[2],IND=LAST_LINE)IOL=0320
3075 ARB$(410,5)=STR(A9); REM "Set sample rebate link in ARB$
3095 RETURN 
3100 REM "Get ITEM$ from G/B$ and substitute department from first line if needed
3101 REM "FIRST_PROD_CODE$ set in 1100's
3110 ITEM$=GB$(93,10); P=POS("#"=ITEM$); IF P<>0 THEN IF FIRST_PROD_CODE$(2,1)="0" AND FIRST_PROD_CODE$(1,1)<>"0" THEN ITEM$(P,1)=FIRST_PROD_CODE$(1,1) ELSE ITEM$(P,1)=FIRST_PROD_CODE$(2,1)
3115 DIM IC0$(187),IC0[40]; FIND (Z[3],KEY=DIM(10)+ITEM$,DOM=3116)IOL=0330
3145 RETURN 
4900 REM "END OF LINES
4910 Y[4]=-1; WRITE (F,IND=0)IOL=0290
4920 CALL "ZZEXPF",X3$,X4$,"X"+STR(F),"",G9; IF G9>0 THEN GOTO 9900
4925 EXTRACT (F,IND=0)IOL=0290
4930 Z=NUM(FIN(F,"MAXREC")); Y[3]=Z-1
4935 Y[4]=-2; WRITE (F,IND=0)IOL=0290
4940 GOTO 5230
5200 REM "GET NEXT INDEX TO FILE IN A9
5210 EXTRACT (F,IND=0,ERR=5295)IOL=0290
5215 IF Y[4]=-2 THEN READ (F); WAIT 0; GOTO 5210
5220 Y[4]=-2; WRITE (F,IND=0)IOL=0290
5230 IF Y[1]<1 THEN A9=Y[2],Y[2]=Y[2]+1; GOTO 5260
5255 A9=Y[1]; READ (F,IND=A9)Y[1]
5260 IF Y[0]<Y[3] AND Y[2]<=Y[3] THEN Y[0]=Y[0]+1,Y[4]=-1 ELSE Y[2]=Y[2]-1; GOTO 4900
5280 WRITE (F,IND=0)IOL=0290
5290 RETURN 
5295 IF ERR<>0 THEN GOTO 9000 ELSE RETRY 
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
56000 REM "249775-Changes to sales tax parameters and tax calculations to     
