0010 REM "Find the TOSS price on new item <OS2OBC>
0035 REM "5.7 - 09/14/10 - 10.824166 - tma - SSP# 240678
0037 REM "240678-OPT:  If using List order in Price Plan Priority, Pricing   
0040 REM "Copyright 2010 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 SETERR 9000
0095 ENTER X3$,X4$,A$,I{ALL},B$,FROM$,PRICE,TYPE_PRICE$,COST,QUANTITY
0101 REM "TYPE_PRICE$="B" USE BEST PRICE - CHECK ALL PRICE PLANS EXCEPT MATRIX
0102 REM "TYPE_PRICE$="P" USE CUSTOMER'S BEST INCLUDING FLYERS
0103 REM " TYPE_PRICE$="C" USE LOWEST PRICE IN CUSTOMER'S PRICE PLANS NO FLYERS
0104 REM " TYPE_PRICE$="V" USE LOWEST PRICE IN ENTIRE SYSTEM INCLUDING MATRIX AND FLYERS SSP 220569
0171 FID_0$=FID(0); IF %IN_WEBEC$="Y" THEN FID_0$(1,1)="G"
0300 IOLIST OS1$
0310 IOLIST IC0$,IC0[0],IC0[1],IC0[2],IC0[3],IC0[4],IC0[5],IC0[6],IC0[7],IC0[8],IC0[9],IC0[10],IC0[11],IC0[12],IC0[13],IC0[14],IC0[15],IC0[16],IC0[17],IC0[18],IC0[19],IC0[20],IC0[21],IC0[22],IC0[23],IC0[24],IC0[25],IC0[26],IC0[27],IC0[28],IC0[29],IC0[30],IC0[31],IC0[32],IC0[33],IC0[34],IC0[35],IC0[36],IC0[37],IC0[38],IC0[39],IC0[40]
0330 IOLIST OS6$
0340 IOLIST OS0$
0350 IOLIST AR1$
0500 REM "FILES
0501 DIM IC0[40]
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="03O OS1...  05O OS6...  06O OS0...  10O AR1...  13O ZZPARM  15O IC0...  25O OS7...  26O OS5...  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0750 READ (Z[13],KEY=X3$(9,3)+"OSP")OSP$
0751 HOLD_OSP$=OSP$
1000 REM " READ CUSTOMER'S PRICING PRIORITIES
1005 DIM CUST$(10); IF POS(FROM$="FM2OB5FM2OB0",6)<>0 THEN CUST$=B$(6,10) ELSE CUST$=B$(1,10)
1010 DIM OS6$(183); READ (Z[5],KEY=CUST$,DOM=1011)IOL=0330; REM SSP 210735
1012 IF NUL(TYPE_PRICE$) THEN TYPE_PRICE$=MID(OS6$,11,1)
1014 IF NUL(TYPE_PRICE$) THEN TYPE_PRICE$=MID(OSP$,219,1)
1015 IF POS(" "<>OS6$)=0 AND TYPE_PRICE$="C" THEN TYPE_PRICE$="L"
1016 READ (Z[6],KEY=A$(1,10),DOM=9900)OS0$
1020 REM "IF QUANTITY<>0 THEN GOTO 1200                           
1050 IF TYPE_PRICE$="B" THEN GOTO 3000
1051 IF TYPE_PRICE$="V" THEN GOTO 3000; REM SSP 220569
1060 IF TYPE_PRICE$="C" THEN GOTO 5000
1070 IF TYPE_PRICE$="P" THEN GOTO 3000
1080 IF TYPE_PRICE$="L" THEN GOTO 1200
1090 IF TYPE_PRICE$="O" THEN GOTO 6000
1100 REM " GET THE PRICE
1105 FOR I=0 TO 24; REM SSP 210735
1110 READ (Z[3],KEY=A$(1,10)+OS6$(22+I*6,6),DOM=1111)IOL=0300; IF B$(16,6)<OS1$(25,6) OR B$(16,6)>OS1$(31,6) THEN GOTO 1120 ELSE GOTO 1150
1120 NEXT I
1130 GOTO 1200
1150 REM "GOT THE RECORD
1160 REM "A[4]=NUM(OS1$(47,10))
1170 I[0]=NUM(OS1$(47,10))
1190 REM "IF QUANTITY<>0 THEN GOTO 1200
1200 REM " GET THE COST
1202 COST=0
1203 READ (Z[26],KEY=PLAN$,DOM=*NEXT)COST_PLAN$
1204 IF PLAN$="" OR MID(COST_PLAN$,53,6)=DIM(6) THEN OSP$(448,1)="Y" ELSE OSP$(448,1)=HOLD_OSP$(448,1)
1210 READ (Z[6],KEY=A$(1,10),DOM=9900)OS0$
1215 LIST_PRICE=NUM(OS0$(204,10))
1220 IF MID(OS6$,12,1)="Y" THEN GOTO 1222
1221 IF I[0]=0 THEN I[0]=NUM(OS0$(204,10)); REM " IF NOT PRICE IN 0S1, USE BASE FROM OS0
1222 IF OSP$(448,1)<>"Y" THEN READ (Z[25],KEY=A$(1,10)+COST_PLAN$(53,6),DOM=1223)OS7$; OS5$=COST_PLAN$; GOTO 1242
1225 READ (Z[25],KEY=A$(1,10),DOM=*NEXT)
1226 REM "IF PLAN$="" AND LEN(OS1$)<>0 THEN I[17]=NUM(OS1$(57,10))
1230 OS7_KEY$=KEY(Z[25],END=1499)
1232 IF OS7_KEY$(1,10)<>A$(1,10) THEN GOTO 1499
1233 READ (Z[25],KEY=OS7_KEY$)OS7$
1234 IF B$(16,6)<OS7$(77,6) OR B$(16,6)>OS7$(83,6) THEN GOTO 1230
1235 READ (Z[26],KEY=OS7$(11,6),DOM=1245)OS5$
1242 COST$=OS7$(27,10)
1243 IF OS5$(52,1)="1" THEN COST$=OS7$(27,10) ELSE IF OS5$(52,1)="2" THEN COST$=OS7$(47,10) ELSE IF OS5$(52,1)="3" THEN COST$=OS7$(67,10)
1245 IF MID(OS5$,60,1)="Y" THEN IF QUANTITY>=NUM(OS7$(17,10)) THEN COST$=OS7$(27,10)
1246 IF MID(OS5$,60,1)="Y" THEN IF QUANTITY>=NUM(OS7$(37,10)) THEN COST$=OS7$(47,10)
1247 IF MID(OS5$,60,1)="Y" THEN IF QUANTITY>=NUM(OS7$(57,10)) THEN COST$=OS7$(67,10)
1248 REM "IF OS5$(60,1)="Y" THEN COST=NUM(COST$); GOTO 1499
1250 IF COST=0 THEN COST=NUM(COST$)
1255 IF NUM(COST$)<COST THEN COST=NUM(COST$)
1258 IF OSP$(448,1)="Y" THEN GOTO 1266 ELSE GOTO 1265
1259 REM "IF OS5$(52,6)=DIM(6) THEN GOTO 1266 ELSE GOTO 1265
1260 IF MID(COST_PLAN$,53,6)<>OS5$(53,6) OR MID(COST_PLAN$,53,6)=DIM(6) THEN GOTO 1266
1263 IF COST_PLAN$(52,1)="1" THEN COST$=OS7$(27,10) ELSE IF COST_PLAN$(52,1)="2" THEN COST$=OS7$(47,10) ELSE IF COST_PLAN$(52,1)="3" THEN COST$=OS7$(67,10) END_IF 
1264 IF NUM(COST$)<COST THEN COST=NUM(COST$)
1265 GOTO 1499
1266 REM "IF NUM(COST$)>NUM(OS7$(67,10)) AND NUM(OS7$(67,10))<>0 THEN COST$=OS7$(67,10) ELSE IF NUM(COST$)>NUM(OS7$(47,10)) AND NUM(OS7$(47,10))<>0 THEN COST$=OS7$(47,10) ELSE IF NUM(COST$)>NUM(OS7$(27,10)) AND NUM(OS7$(27,10))<>0 THEN COST$=OS7$(27,10)
1267 IF NUM(COST$)<COST THEN COST=NUM(COST$)
1268 GOTO 1230
1499 IF COST<>0 THEN I[17]=COST
1500 GOTO 9900
3000 REM " BEST OF ALL PRICES WITH FLYERS
3002 I[0]=0
3010 READ (Z[3],KEY=A$(1,10),DOM=3011)
3020 K$=KEY(Z[3],END=3100); IF K$(1,10)<>A$(1,10) THEN GOTO 3100
3025 READ (Z[3],KEY=K$)IOL=0300
3030 IF B$(16,6)<OS1$(25,6) OR B$(16,6)>OS1$(31,6) THEN GOTO 3020 ELSE IF (NUM(OS1$(47,10))=0 AND OS6$(12,1)<>"Y") THEN GOTO 3020 ! SSP229947 - if price is zero but customer is set to allow zero pricing, then use it
3032 IF TYPE_PRICE$="P" AND OS1$(18,1)<>"F" AND POS(OS1$(11,6)=OS6$(22,72))=0 THEN GOTO 3020; REM " NOT A FLYER AND NOT IN THE CUSTOMER LIST         
3034 IF OS1$(18,1)="M" AND TYPE_PRICE$="B" THEN GOTO 3020; REM " NOT MATRIX PRICES
3035 IF I[0]=0 THEN I[0]=NUM(OS1$(47,10)),I[17]=NUM(OS1$(57,10)),PLAN$=OS1$(11,6)
3036 REM "PLAN$=OS1$(11,6)
3040 IF NUM(OS1$(47,10))<I[0] THEN I[0]=NUM(OS1$(47,10)),I[17]=NUM(OS1$(57,10))
3041 IF NUM(OS1$(47,10))<I[0] THEN I[17]=NUM(OS1$(57,10))
3045 IF NUM(OS1$(47,10))<=I[0] THEN PLAN$=OS1$(11,6)
3050 GOTO 3020
3110 GOTO 1200
4990 GOTO 9900
5000 REM " CUSTOMER'S BEST
5002 I[0]=0; I[17]=0
5105 FOR I=0 TO 24; REM SSP 210735
5110 READ (Z[3],KEY=A$(1,10)+OS6$(22+I*6,6),DOM=5180)IOL=0300; IF B$(16,6)<OS1$(25,6) OR B$(16,6)>OS1$(31,6) THEN GOTO 5180 ELSE IF (NUM(OS1$(47,10))=0 AND OS6$(12,1)<>"Y") THEN GOTO 5180 ELSE IF OS1$(18,1)="F" THEN GOTO 5180 ! SSP229947 - if price is zero but customer is set to allow zero pricing, then use it
5150 REM "GOT THE RECORD
5155 REM "IF I[0]=0 THEN PLAN$=OS1$(11,6)
5160 IF I[0]=0 THEN I[0]=NUM(OS1$(47,10)),I[17]=NUM(OS1$(57,10)),PLAN$=OS1$(11,6)
5170 IF NUM(OS1$(47,10))<I[0] THEN I[0]=NUM(OS1$(47,10)),I[17]=NUM(OS1$(57,10)),PLAN$=OS1$(11,6)
5175 REM "IF NUM(OS1$(47,10))<I[0] THEN PLAN$=OS1$(11,6)
5180 NEXT I
5200 REM " GET THE COST
5225 REM "I[17]=NUM(OS1$(57,10))
5226 GOTO 1200
5999 GOTO 9900
6000 REM " GET FIRST PRICE IN LIST
6002 I[0]=0; I[17]=0
6010 FOR I=0 TO 24; REM SSP 226618
6020 READ (Z[3],KEY=A$(1,10)+OS6$(22+I*6,6),DOM=6030)IOL=0300; IF B$(16,6)<OS1$(25,6) OR B$(16,6)>OS1$(31,6) THEN GOTO *NEXT ELSE EXITTO 6060 ! SSP 226618!SSP#240678
6030 NEXT I ! SSP 226618
6050 TYPE_PRICE$=DIM(1); GOTO 1014 ! SSP 226618
6110 IF B$(16,6)<OS1$(25,6) OR B$(16,6)>OS1$(31,6) THEN TYPE_PRICE$=DIM(1); GOTO 1014
6112 REM "IF OS6$(12,1)="N" AND I[0]=0 THEN I[0]=NUM(OS1$(47,10))
6113 I[17]=NUM(OS1$(57,10)),PLAN$=OS1$(11,6)
6114 I[0]=NUM(OS1$(47,10))
6115 GOTO 1200
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 RETURN 
9900 IF (MID(OS6$,12,1)="N" AND I[0]=0) OR (MID(OS6$,12,1)="Y" AND TYPE_PRICE$="L") THEN I[0]=NUM(MID(OS0$,204,10)); REM " IF NOT PRICE IN 0S1, USE BASE FROM OS0 ! 226534
9901 IF POS(FROM$="EC3OE0FMGODB")<>0 AND COST<>0 THEN GOTO 9905
9902 IF POS(FROM$="EC3WS1OS2TAAEC3PC4",6)<>0 THEN COST=I[17],PRICE=I[0]; GOTO 9910
9904 COST=I[17]
9905 EXTRACT (Z[15],KEY=DIM(10)+A$,DOM=9910)IOL=0310
9906 IC0[17]=COST; PRICE=I[0]; IC0[18]=COST; REM " IC0[20]=IC0[17]
9907 WRITE (Z[15],KEY=DIM(10)+A$)IOL=0310
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9920 FROM$=PLAN$
9940 EXIT 
9999 END 
56000 REM "177423-Convert TOPS for GUI-9900'S USES HARDCODED PGM NAME..NEEDED TO CHANGE IT TO USE THE GUI PGM NAME TOO
56001 REM "210735-Tops Update Price Plan Priorities (OSGUTL) was not changed 
56002 REM "220569-Request for change to TOPS pricing to make maintenance of  
56003 REM "226534-Modify EC3WS1 and OS2OBC to handle invalid items or absent  
56004 REM "229947-Tops pricing issue on ZERO price plan.
56005 REM "240678-OPT:  If using List order in Price Plan Priority, Pricing   
