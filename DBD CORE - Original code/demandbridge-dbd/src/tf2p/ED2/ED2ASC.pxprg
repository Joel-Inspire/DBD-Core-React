0010 REM "<ED2ASC> Invoices to ASCII file
0020 SETESC 9300; SETERR 9000
0035 REM "5.2 - 01/27/04 - 11.368611 - tma - SSP# 168322
0040 REM "Copyright 2004 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,QT$,INV$,INV{ALL}
0100 SETERR 9000
0110 X0$="ED2ASC",X1$="Invoice to ASCII file"
0120 DIM Z0$(80,"-")
0130 K0=20,K1=1,C=1
0135 C9=-1
0140 DIM A[20],C[8],Z1$(15," "),I[20]
0145 DTT$=DAY,DTT$=DTT$(7,2)+DTT$(1,2)+DTT$(4,2),TMP$=DTT$(3,2)+DTT$(5,2)+DTT$(1,2)
0165 DEF FND$(Z9$)=Z9$(NUM(X3$(48,1))*2+1,2)+X3$(59,1)+Z9$(7-NUM(X3$(48,1))*2,2)+X3$(59,1)+STR((ASC(Z9$(1,1))-65)*10+1900+NUM(Z9$(2,1))-1570*POS("  "=Z9$(1,2)):"####")
0240 REM "CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2; IF X1>0 THEN GOTO 09920
0290 TEMP$=X3$(9,3)+"E/M"
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14],A[15],A[16],A[17],A[18],A[19],A[20]
0330 IOLIST C$,C1$,C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8]
0370 IOLIST G$
0390 IOLIST I$,I[0],I[1],I[2],I[3],I[4],I[5],I[6],I[7],I[8],I[9],I[10],I[11],I[12],I[13],I[14],I[15],I[16],I[17],I[18],I[19],I[20]
0410 IOLIST Q$
0420 IOLIST K$
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="06O EM1...  07O AR1...  08O EM2... 09O ARB...  10O ART...  11O IC0...  13O ZZPARM  15O EM9...  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0560 REM "CALL "ZZPRIN",X0$,X3$,Y0$,V3$,Z[ALL],W0$,W1$,W0,W9,W2,W3,W4; ON W4 GOTO 00561,09920
0580 DEVICE=32408
0585 REM "CLOSE (DEVICE) ; OPEN (DEVICE) "P7"
0600 READ (Z[13],KEY=X3$(9,3)+"A/R")P3$
0700 READ (Z[13],KEY=X3$(9,3)+"E/M",DOM=9900)P4$
1000 REM "Main Process
1010 REM "READ (Z[9],KEY=INV$,DOM=00911) IOL=00310; REM "INITIAL READ FROM ORDERS FILE (ARB)
1030 GOSUB 1800; REM "CHK EDI PARAMETERS
1035 GOSUB 2000
1040 GOSUB 1900; REM "Get Customers information
1050 REM "GOSUB 02000; REM "SET UP CHANNEL FOR PRINTING
1070 GOSUB 2200; REM "Write line items out to EDI file
1090 REM "GOSUB 03000; REM "ARCHIVE FILE TO EDITMP IN CASE OF PROBLEMS
1600 GOTO 9900
1800 REM "CHK FOR EDI CUSTOMER
1810 READ (Z[6],KEY=QT$,DOM=1811,ERR=1811)
1820 JL$=KEY(Z[6],END=9910)
1825 IF JL$(1,10)<>QT$ THEN GOTO 9910
1830 READ (Z[6],KEY=JL$,DOM=9910,ERR=9910)EDI$
1840 Q$=EDI$
1890 RETURN 
1900 REM "Get Customer info
1920 CUST_CODE$=QT$
1925 READ (Z[8],KEY=CUST_CODE$,DOM=1926)
1930 CUST_CODE$=KEY(Z[8],END=1931); GOTO 1940
1935 EXITTO 9900
1940 REC_ID$=CUST_CODE$(11,15)
1950 READ (Z[7],KEY=CUST_CODE$(1,10),DOM=1951)IOL=0370
1995 RETURN 
2000 REM "Set the channel up for printing
2005 REM "PRINTER_CFG$="512,1,3,,"; REM "LINE WIDTH 131, DON'T LOCK OTHERS OUT, BUILD IN /TMP THEN SEND, NO TIMEOUT
2010 FILE_NAME$=STR(NUM(DTT$):"000000")+".out"
2015 PRINTER_CFG$=STP(Q$(75,45),1)+FILE_NAME$; REM "PRINTER_CFG$=PRINTER_CFG$+"cat >> "+STP(Q$(75,45),1)+FILE_NAME$; REM "S1$ WAS ON END OF THIS STATEMENT
2020 DEV_CHANNEL=DEVICE,DEVICE_NAME$=P4$(212,2); REM "fid(DEVICE)
2025 REM "Determine correct channel to close
2030 CLOSE (DEV_CHANNEL); OPEN (DEV_CHANNEL,OPT=PRINTER_CFG$)DEVICE_NAME$
2095 RETURN 
2200 REM "Wite line items out to EDI file
2220 REM "READ (Z[9],KEY=P3$(7,6)+A$(7,8),END=02290) IOL=00390
2230 INVOICE_DATE$=FND$(INV$(86,6)),DUE_DATE$=FND$(INV$(116,6))
2240 JL$=G$(56,7)
2250 JL$=CVS(JL$(POS("#"=JL$)+1),16)
2260 PRINT (DEV_CHANNEL)INV$(7,8)+$2C$+INVOICE_DATE$+$2C$+JL$+$2C$+INV$(15,10)+$2C$+DUE_DATE$+$2C$+STR(INV[9]:"-######.00")+$0D0A$,
2290 RETURN 
3000 REM "Write file to the editmp DIRectory
3010 REM "SYSTEM S1$
3090 RETURN 
5001 XFD$=FN%XFD$(Z[2],0),TOT_REC=DEC(XFD$(38,4))
5003 CLOSE (Z[2])
5004 IF TOT_REC=0 THEN ERASE TEXT$; GOTO 5012
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9901 ESCAPE 
9905 CLOSE (DEV_CHANNEL,ERR=9910)
9906 REM "S1$="sort "+STP(Q$(75,45),1)+FILE_NAME$+" |uniq > "+STP(Q$(75,45),1)+TMP$+".out 2> /dev/null"
9907 REM "S2$="cp "+STP(Q$(75,45),1)+TMP$+".out"+" /usr/lib/pvx/editmp/ 2> /dev/null"; X=SYS(S1$); X=SYS(S2$)
9908 S2$="cp "+STP(Q$(75,45),1)+TMP$+".out"+" "+HWD+DLM+"editmp"+DLM; INVOKE S2$
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9920 CLOSE (DEVICE,ERR=9921)
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
