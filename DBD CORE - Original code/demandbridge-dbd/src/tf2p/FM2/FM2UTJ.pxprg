0010 REM "Attempt to plug FMZ Lot data from ICF, ICI <FM2UTJ>
0035 REM "5.4 - 03/03/06 - 15.754722 - kmc - SSP# 190474
0037 REM "190474-Additional Services - Enhance TF to provide for tax codes   
0040 REM "Copyright 2006 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0100 BEGIN 
0110 DIM S$(20)
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6]
0320 IOLIST B$,B[0],B[1],B[2],B[3],B[4],B[5],B[6]
0330 IOLIST C$,C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8],C[9],C[10],C[11],C[12],C[13],C[14],C[15],C[16],C[17]
0340 IOLIST D0$,D1$,D2$,D3$
0405 C0$="047"
0410 OPEN (1)"ICF"+C0$
0420 OPEN (2)"ICI"+C0$
0430 OPEN (3)"FMZ"+C0$
0450 OPEN (5)"FMZ047X"; CALL "ZZINIT","05"
0600 REM "SORT FILE
0610 Q$="TMP"+FID(0)
0615 ERASE Q$,ERR=0616; GOTO 0615
0620 DIRECT Q$,20,10000,128,0,0
0630 OPEN (4)Q$
0800 REM "ONE CUSTOMER CODE
0820 C9$="0000330000"
0990 I8=12+6+6
0995 READ (1,KEY=C9$,DOM=0996)
0996 READ (2,KEY=C9$,DOM=0997)
0997 READ (3,KEY=C9$,DOM=0998)
0999 PRINT 'LF',"NOW PROCESSING LOT DETAIL FILE..."
1000 REM "READ NEXT ICF RECORD
1005 DIM A[6],B[6],C[17]
1020 K$=KEY(1,END=1400); I9=IND(1),I9$=STR(I9:"000000"); READ (1)IOL=0310
1025 IF C9$>"" THEN IF A$(1,10)<>C9$ THEN GOTO 1400
1030 PRINT @(0),A$(1,32),
1100 REM 
1200 REM "CHECK FOR JOB NUMBER
1220 D0$=A$(1,20),D1$="",D2$=""
1240 FIND (4,KEY=D0$,DOM=1241)IOL=0340
1260 Q$=A$(56,12); IF POS(Q$=D1$,I8)=0 THEN D1$=D1$+Q$+I9$+A$(25,6); WRITE (4,KEY=D0$)IOL=0340
1290 GOTO 1000
1400 REM "PROCESS ICI FILE
1410 PRINT 'LF',"PROCESSING LOT HISTORY FILE..."
1420 K$=KEY(2,END=1600); I9=IND(2),I9$=STR(I9:"000000"); READ (2)IOL=0320
1422 IF C9$>"" THEN IF B$(1,10)<>C9$ THEN GOTO 1600
1425 PRINT @(0),B$(1,32),
1430 Q$=B$(56,12)
1440 D0$=B$(1,20),D1$="",D2$=""
1450 FIND (4,KEY=D0$,DOM=1451)IOL=0340
1452 D3$=D3$+I9$
1455 IF POS(Q$=D1$,I8)=0 THEN IF POS(Q$=D2$,I8)=0 THEN D2$=D2$+Q$+I9$+B$(25,6); WRITE (4,KEY=D0$)IOL=0340
1480 GOTO 1420
1600 REM 
2000 REM "PROCESS FMZ
2005 PRINT 'LF',"PROCESSING FMZ..."
2020 K$=KEY(3,END=3000); READ (3)IOL=0330
2025 IF C9$>"" THEN IF C$(1,10)<>C9$ THEN GOTO 3000
2030 PRINT @(0),K$,
2040 Q$=C$(1,10)+C$(16,10); IF D0$<>Q$ THEN READ (4,KEY=Q$,DOM=2800)IOL=0340
2050 Q$=C$(246,12)
2054 REM "SKIP IF VALID JOB NUMBER
2055 IF Q$<>S$(1,12) THEN IF POS(Q$=D1$+D2$,I8)>0 THEN PRINT @(40),"VALID DATA!",; GOTO 2800
2100 REM "ONLY ONE LOT
2110 IF LEN(D1$+D2$)>I8 THEN GOTO 2200
2120 IF Q$=S$(1,12) THEN C$(246,12)=D1$+D2$; PRINT @(40),'CL',"SINGLE LOT ITEM!",; GOTO 2800
2125 ESCAPE 
2180 GOTO 2800
2200 REM "MORE THAN ONE LOT
2202 PRINT @(40),'CL',"MULTIPLE LOTS!",
2205 IF R0$<>D0$ THEN GOSUB 4000
2230 A1=C[1],J0$=""
2240 FOR X=0 TO R1
2245 IF R[X]=0 THEN GOTO 2260 ELSE IF R[X]>=A1 THEN R[X]=R[X]-A1; J0$=D9$(X*I8+1,I8); EXITTO 2265
2250 REM ESCAPE ; REM "HAVE TO SPLIT A LOT!
2260 NEXT X
2261 J0$=D9$(1,I8)
2262 REM "ESCAPE
2263 GOTO 2800
2280 C$(246,12)=J0$(7,12)
2285 GOTO 2800
2800 REM "WRITE FILE (5=3)
2820 WRITE (5,KEY=K$)IOL=0330
2890 GOTO 2020
3001 ESCAPE 
4000 REM "BUILD ARRAY OF JOBS BY DATE
4005 D9$=D1$+D2$
4020 X$=""; FOR X=1 TO LEN(D9$) STEP I8
4025 P=POS(D9$(X+18,6)<X$,I8)
4030 IF P=0 THEN X$=X$+D9$(X+18,6)+D9$(X,18) ELSE X$=X$(1,P-1)+D9$(X+18,6)+D9$(X,18)+X$(P)
4035 NEXT X
4040 D9$=X$
4050 D8$=""; FOR X=1 TO LEN(D9$) STEP I8; D8$=D8$+D9$(1,6); NEXT X
4100 REM "COLLECT QUANTITIES FOR EACH LOT
4120 DIM R[LEN(D9$)/I8]; R0=0
4125 FOR X=1 TO LEN(D9$) STEP I8
4130 Q$=D9$(X+6,12); P=POS(Q$=D1$,I8); IF P>0 THEN F0=1 ELSE F0=2
4135 I0=NUM(D9$(X+18,6))
4140 READ (F0,IND=I0)IOL=0310
4150 P=POS(Q$=D9$(7),I8); IF P=0 THEN ESCAPE ELSE P=INT(P/I8)
4155 A0=A[4]; IF A[3]<>0 THEN A0=A[3]*A[4]; IF A[2]<>0 THEN A0=A[2]*A[3]*A[4]
4160 R[P]=R[P]+A0,R0=R0+A0
4180 NEXT X
4190 R0$=D0$,R1=LEN(D9$)/I8-1
4195 RETURN 
9999 END 
56000 ! Changes since 03/01/2006
56005 REM "190474-Additional Services - Enhance TF to provide for tax codes   
