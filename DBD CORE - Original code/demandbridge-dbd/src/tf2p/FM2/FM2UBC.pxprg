0010 REM "F/M Calculate Average Usage for Item <FM2UBC>
0020 SETESC 9300; SETERR 9000
0035 REM "3.1.1
0040 REM "Copyright 1986 Computer Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0260 DEF FND$(Z9$)=STR((ASC(Z9$(1,1))-65)*10+1900+NUM(Z9$(2,1))-1570*POS("  "=Z9$(1,2)):"####")
1010 X0$="FM2UBC"
1020 ENTER X3$,F9$,F0,F0$,F1,F1$,D1$,D0$,U0$,U8,U9,M0$,M9,U1,U3
1030 M0=M9,U9=0; IF M0$="W" THEN M0=1
1110 REM M0$ = METHOD: A)VERAGE, W)EIGHTED, M0=NUMBER OF PERIODS
1111 REM "D0$ is reference date (last count)
1200 REM "FIND FIRST CUSTOMER DATE RECORD
1210 Q0=LEN(F0$); READ (F0,KEY=F0$,DOM=1211)
1215 READ (F0,END=1300)Q$
1220 IF Q$(1,LEN(F0$))<>F0$ THEN GOTO 1300 ELSE P1$=Q$
1224 REM "GET LAST PERIOD ENDING DATE IN Q$
1225 P0=NUM(P1$(Q0+5,2)),Q$=P1$(Q0+7+P0*6,6)
1245 REM "IF LESS THAN REFERENCE DATE...
1250 IF Q$<D0$ THEN GOTO 1215
1280 GOTO 1400
1300 REM "DATE RECORD NOT THERE
1310 IF P1$>"" THEN GOSUB 7000; GOTO 1225
1350 REM "THERE ARE NO DATE RECORDS FOR THIS CUST
1360 EXIT 11
1400 REM 
1410 IF P0=13 THEN D9=28 ELSE IF P0=12 THEN D9=30 ELSE D9=365/P0
1420 D$=D0$
1470 U0=U9
2000 REM "GET CORRECT STAT RECORD FOR BASE DATE D$
2020 IF P1$(Q0+7+P0*6,6)<D$ THEN GOSUB 4000
2030 IF F2$="" THEN GOSUB 4100
2100 REM "DETERMINE PERIOD P2 FROM DATE D$
2120 P=POS(D$<=P1$(24),6),P2$=P1$(23+P,6)
2125 P2=INT(P/6)+1
2150 REM "CURRENT PERIOD USAGE
2160 CALL "YDYSBT",X3$,D$,P2$,P3; P3=D9-P3
2180 U1=INT(K[P2]),U2=M0-1,U3=P3
2200 REM "M9 PRIOR PERIODS OF USAGE (STRAIGHT AVERAGE ONLY)
2202 IF M0$="W" THEN U9=U1; GOTO 2420
2205 IF U2<=0 THEN GOTO 2400 ELSE U2=U2-1
2210 P2=P2-1; IF P2=0 THEN GOTO 2280
2215 D$=P1$(24+(P2-1)*6,6)
2219 REM "USAGE START DATE: MIGHT NEED TO FINE TUNE THIS CALCULATION!
2220 IF D$<D1$ THEN U2=0; GOTO 2400
2230 U1=U1+K[P2],U3=U3+D9; GOTO 2200
2270 REM "PRIOR YEAR
2280 P$=STR(NUM(P$)-1:"0000")
2282 P1$(LEN(F0$)+1,4)=P$
2285 READ (F0,KEY=F0$+P$,DOM=2286)P1$
2290 GOSUB 4100
2295 P2=P0; GOTO 2211
2400 REM "DONE WITH USAGE
2410 U9=U1*D9/U3; IF POS("F"=F9$(18,8))=0 THEN U9=INT(U9)
2420 IF M0$="W" THEN IF U8<>0 THEN U9=(U8*(M9-1)+U9)/M9
2440 GOTO 9900
4000 REM "FLUSH CURRECT STAT RECORD
4020 CALL "ZZPACK",X3$,"W",F8$,"",0,0,K{ALL},F1,U0$,F2$,F9$
4090 F2$=""
4095 RETURN 
4100 REM "GET STAT RECORD  FOR PERIOD P$
4105 P=POS(U0$=F9$(49),17),F8$=F9$(50+P,3),P$=P1$(12,4),F2$=F1$+P$
4130 DIM K[24]
4140 CALL "ZZPACK",X3$,"R",F8$+"","",0,0,K{ALL},F1,U0$,F2$,F9$
4195 RETURN 
7000 REM "GET NEXT YEAR PERIOD END RECORD
7010 Q$=P1$(NUM(P1$(Q0+5,2))*6+18,6),Y=NUM(P1$(Q0+1,4))+1
7015 P1$(Q0+7)=Q$,P1$(Q0+1,4)=STR(Y:"0000")
7020 CALL "FM2UBZ",X3$,"",P1$,Q0
7040 WRITE (F0,KEY=P1$(1,Q0+4))P1$
7090 RETURN 
9000 REM "ERROR PROCESSING
9010 Y5=ERR,Y6=TCB(5)
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,1
9045 REM 
9050 ON Y7 GOTO 9060,9100,9190,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9190 GOSUB 6600; GOTO 9900
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9700 REM "FILES
9740 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 0521,9900
9790 RETURN 
9900 REM "END PROGRAM
9910 PRINT @(0,14),'CL',
9940 EXIT 
9999 END 
