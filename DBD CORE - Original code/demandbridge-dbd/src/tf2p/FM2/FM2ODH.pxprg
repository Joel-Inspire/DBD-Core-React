0010 REM "Add or delete order effects from system<FM2ODH>
0011 REM "Promotion Logic added for company 030
0020 REM "SETESC 09300; SETERR 09000
0035 REM "5.7 - 07/30/19 - 14.403888 - jvv - SSP# 307192
0037 REM "307192-Office Products legacy code causes error in FM2ODH          
0040 REM "Copyright 2019 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 REM REQUISTIONS SHOULD NOT AFFECT FSA - BOOKING FILE
0087 REM "C0=command, 1=add, -1=maint. delete, -2=header delete stuff, -3=both deletes, -4=Put out FSA prior record only, 99=Rebuild mode (FM2UT9)
0088 REM "A$=sales order data
0090 CLEAR ; SETERR 0100; ENTER X3$,C0,A$,A{ALL},OPT$,ERR=*NEXT ! SSP 307192
0095 IF OPT$="OS" THEN BOOK$="N"; REM SSP 307192   
0100 SETERR 9000
0110 X0$="FM2ODH"
0150 IF X4$="" THEN X4$=%X4$ ! SSP258502
0170 FID_0$=FID(0); IF %IN_WEBEC$="Y" OR %IN_BOFILL=1 OR %IN_GUI$="Y" THEN FID_0$(1,1)="G"; REM SSP 187122, SSP 180159
0340 IOLIST D$,D[0],D[1],D[2],D[3],D[4],D[5],D[6],D[7],D[8]
0341 IOLIST J$,J[0],J[1],J[2],J[3],J[4],J[5],J[6],J[7],J[8]
0350 IOLIST E$,E[0],E[1],E[2],E[3],E[4],E[5],E[6],E[7],E[8],E[9],E[10],E[11],E[12],E[13],E[14],E[15],E[16],E[17]
0360 IOLIST F$,F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8],F[9],F[10],F[11],F[12],F[13],F[14],F[15]
0362 IOLIST F0$,F0[0],F0[1],F0[2],F0[3],F0[4],F0[5],F0[6],F0[7],F0[8],F0[9],F0[10],F0[11],F0[12],F0[13],F0[14],F0[15]
0370 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13]
0390 IOLIST M$,M[0],M[1],M[2],M[3],M[4]
0410 IOLIST AA$,AA[0],AA[1],AA[2],AA[3],AA[4],AA[5],AA[6],AA[7],AA[8],AA[9],AA[10],AA[11],AA[12],AA[13],AA[14],AA[15]
0420 IOLIST FV5$,FV5[0],FV5[1],FV5[2],FV5[2] ! SSP 276772
0450 REM "Initialize logging
0455 IF %LOG_LEVEL=%LOG_DEBUG THEN {
0460 LOG_OPTIONS$="A"; CALL "ZZ2LOG;OPEN_LOG",ERR=*NEXT,X3$,X4$,FN%GET_BASENAME$(PGN)+"."+FID(0)+".log",LOG_OPTIONS$,LOG_CHANNEL ! 245262
0470 CALL "ZZ2LOG;LOG_MSG",ERR=*NEXT,X3$,X4$,LOG_CHANNEL,MID(A$,118,8)+"|"+FN%GET_STACK$,%LOG_DEBUG ! 245262
0471 CALL "ZZ2LOG;LOG_MSG",ERR=*NEXT,X3$,X4$,LOG_CHANNEL,MID(A$,118,8)+"|C0 : "+STR(C0)+"|"+A$,%LOG_DEBUG
0495  }
0499 ! 
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01O FS4...  02O PO6...  03O PO3...  04O FSA...  05O FS2...  06O AR4...  07O FS1...  08O FSO...  09O FSV...  10O FM0...  11O OE2...  12O AR1...  13O ZZPARM  17O SH8...  18O SH9...  19O EDD...  41O FV5...  " ! SSP 276772
0515 IF X3$(9,3)="498" THEN Z$=Z$+"14O OE4...  15O OE0...  16O AR2...  "; REM "SSP110762
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0550 DIM EC_PARMS$(1275); FIND (Z[13],KEY=X3$(9,3)+"E/C",DOM=*NEXT)EC_PARMS$(1) ! SSP263687
0555 FIND (Z[13],KEY=X3$(9,3)+"A/R")AR_PARMS$
0556 FIND (Z[13],KEY=X3$(9,3)+"AR1")AR1_PARMS$; REM "W/O 109017
0560 FIND (Z[13],KEY=X3$(9,3)+"F/M")P0$
0561 MFF_PARM=0; IF MID(P0$,337,1)="Y" THEN MFF_PARM=1 ! SSP 276772
0562 PO_ACK$="N"; IF P0$(323,1)="Y" THEN PO_ACK$="Y" ! SSP 233493
0565 SHIP_INTERFACE$=""; FIND (Z[13],KEY=X3$(9,3)+"S/H",DOM=0566)SHIP_INTERFACE$
0566 GB$=""; FIND (Z[13],KEY=X3$(9,3)+"G/B",DOM=0567)GB$
0568 REM "F9$="Y" means no booking for this order.  F9$="P" means this is a release and only book the portion that is not cusotmer specific (since it was previously booked when the bill as shipped P/O was entered)
0569 IF BOOK$="N" THEN F9$="Y"; GOTO 0590; REM SSP Don't book on United downloaded invoices SSP 194096
0570 F9$="N"; IF P0$(226,1)<>"Y" THEN GOTO 0575
0572 IF A$(54,1)="S" OR (A$(54,1)="B" AND P0$(228,1)<>"Y") THEN F9$="Y"; GOTO 0575; REM " Otherwise not a B-type order or Bookable type
0573 IF P0$(228,1)="Y" AND A$(54,1)=" " THEN F9$="P"; REM "Only case left is Bookable B-type and F9$ will still be N
0575 IF P0$(194,1)<>"Y" AND A$(47,1)="R" THEN F9$="Y"; REM "BFS wants to book reqs
0590 IF C0<>-4 THEN GOTO 0700
0600 REM "Handle -4 Also change in FM2ODM 1600's
0602 IF F9$="Y" THEN GOTO 0620
0605 DIM J$(50),J[8]
0610 WRITE (Z[4],KEY=FID(0)+A$(118,8))IOL=0341
0620 GOTO 9900
0700 REM "Adjust Promotion Statistics?
0710 IF POS(X3$(9,3)="030500",3)=0 THEN GOTO 0750
0720 IF A$(49,2)="  " OR C0=-2 THEN GOTO 0750
0740 CALL "FM2OA3",X3$,C0,A$,A{ALL}
0750 IF A$(52,1)="Y" AND (POS(" "<>A$(23,5)+A$(3,3))>0 OR A$(183,1)="Y") THEN CALL "FM2OA6",X3$,C0,A$
0760 IF C0<>99 THEN IF LEN(A$)<200 THEN A$=A$+" "; GOTO 0760 ELSE IF A$(169,3)="   " THEN A$(169,12)=X3$(40,3)+X3$(40,3)+X3$(21,6) ELSE A$(172,9)=X3$(40,3)+X3$(21,6); REM "CHG LAST OPERATOR ONLY IF NOT A REBUILD
0800 CALL "ZZ2PRP","EC",RESULT$,DATE$; IF RESULT$="Y" AND EC_PARMS$(1183,1)<>"Y" THEN CALL "EC3SOR",X3$,X4$,C0,A$,A{ALL},"FS1","","",""; REM "SSP127059, SSP263687, check Bypass parm, may not need ECW file built
0810 CALL "ZZ2PRP","WC",RESULT$,DATE$; IF RESULT$="Y" THEN CALL "EW3SOR",ERR=*NEXT,X3$,X4$,C0,A$,A{ALL},"FS1","","",""; REM "SSP127059;REM"SSP#205580
0900 ON C0 GOTO 1000,2000
1000 REM "Delete out
1007 DIM B[29]; CALL "FM2ODZ",X3$,C0,"ALL",B{ALL},A$
1008 IF A$(184,1)="O" THEN IF C0=-2 THEN CALL "UPDFT6;DELETE",-99,A$(118,8),A{ALL},0,0; REM "Only delete repeat notepad if a$(184,1)="O"when deleting an order; !ssp#210352
1009 IF C0<>99 THEN IF A$(184,1)="Y" OR P0$(274,1)="A" AND A$(48,1)<>"Y" AND A$(386,1)<>"Y" THEN IF %IN_WEBEC$<>"Y" AND %IN_GUI$<>"Y" THEN PRINT @(26,22),"Removing repeat order records", END_IF ; CALL "FM2ODE",X3$,C0,A$,A{ALL},X4$; IF %IN_WEBEC$<>"Y" AND %IN_GUI$<>"Y" THEN PRINT @(0,22),'CL',; REM "WO100041, SSP 180159, SSP 224057, SSP294679, check new FS1 flag PO Receiving Updated
1010 REMOVE (Z[1],KEY=A$(6,10)+A$(118,8),DOM=1011)
1015 REMOVE (Z[8],KEY=A$(6,10)+A$(28,15)+A$(118,8),DOM=1016)
1020 X$="S"+A$(118,8); GOSUB 7900
1025 X$="W"+A$(118,8); GOSUB 7900
1030 GOSUB 7100
1040 IF C0>=-1 THEN GOTO 1090
1045 GOSUB 8400; REM "Remove SH8 records
1050 GOSUB 7000; REMOVE (Z[3],KEY=A$(118,8)+"     ",DOM=1051)
1055 GOSUB REMOVE_EDD ! SSP294523
1060 REMOVE (Z[9],KEY=A$(118,8),DOM=1061)
1065 IF A$(54,1)="B" THEN CALL "FM2ICA",X3$,X4$,"FM2ODH",C0,A$,A{ALL},""; REM "WO111482, Inventory Costing Feature
1070 REM "Mod for ssp105161 1070-1075
1072 DIM M$(64),M[4]; FIND (Z[11],KEY=A$(118,8),DOM=1073)IOL=0390; CALL "OE2AUA",X3$,M$,M{ALL},"D",MSG$
1080 IF C0=-2 THEN IF GB$<>"" THEN ORDER$=A$,LOC$=ORDER$(199,2); CALL "GB2OTS",X3$,X4$,ORDER$,"N","",LOC$,"D"; REM " Delete record from order tracking
1085 IF C0=-2 THEN IF GB$<>"" THEN ORDER$=A$(118,8); CALL "BM2DEL",X3$,X4$,ORDER$
1087 IF C0=-2 THEN CALL "FM2DEL;WRITE_FV2",X3$,X4$,A$,A{ALL},FM2DEL_OTHER$ ! WO252273
1090 GOTO 9900
2000 REM "Add in
2002 GOSUB 4300 ! IF POS(X3$(9,3)="118500",3)>0 OR POS(" "<>AR1_PARMS$(70,5))<>0 THEN GOSUB 4300; REM "Check Product Class / Salesperson - W/O 105787, OR check DIRect ship line change to commission code, if in AR1 parms - W/O 109017!ssp#292399!ssp#292399 open for all
2003 GOSUB 7100
2005 GOSUB 2100; REM "105161
2006 IF C0=1 AND P0$(280,1)="Y" AND A$(54,1)="B" AND A$(240,1)="Y" THEN CALL "FM2ICA",X3$,X4$,"FM2ODH",C0,A$,A{ALL},""; REM "WO111482, Inventory Costing Feature
2007 IF C0<>99 AND A$(172,3)=DIM(3) THEN A$(172,9)=X3$(40,3)+X3$(21,6)
2008 IF X3$(77,1)="U" THEN GFS1$=FN%FIB$(Z[7]),%GFS1=GFN; OPEN (%GFS1)GFS1$(4,6); WRITE (Z[7],KEY=A$(118,8))IOL=0370; EXTRACT (%GFS1,KEY=A$(118,8))IOL=0370 ! [205703]-change FIB() to FNFIB()  REM SSP156588; lock order hdr
2009 DIM B[29]; CALL "FM2ODZ",X3$,C0,"ALL",B{ALL},A$
2010 IF X3$(77,1)="U" THEN CLOSE (%GFS1)
2011 WRITE (Z[1],KEY=A$(6,10)+A$(118,8)); WRITE (Z[8],KEY=A$(6,10)+A$(28,15)+A$(118,8))
2014 IF C0=99 OR A$(314,1)="Y" THEN GOTO 2040; REM SSP# 189962 - If suspended order, do not allow (re)prints
2015 IF C0=1 AND A$(61,1)<>" " AND A$(126,1)="Y" THEN IF %IN_GUI$="Y" THEN MSGBOX MSG("FMGODH_07"),MSG("MB_ATTN"),"?,YESNO",_ANS$; IF _ANS$="YES" THEN A$(126,1)=" " END_IF ; ELSE CALL "ZZPROM","Y",X3$,S3,"Reprint Sales Order/Thank you letter? ","","",0; IF S3=0 THEN A$(126,1)=" "; REM "SSP 180159
2017 IF X3$(146,6)="FM2BKS" THEN GOTO 2025; REM "SSP181341...DON'T MAKE THANK YOU LETTER IF COMING FROM ENHANCED BO FILL REPORT
2020 IF A$(194,1)<>"Y" AND A$(61,1)<>" " AND A$(126,1)<>"Y" THEN WRITE (Z[2],KEY="S"+A$(118,8)) ELSE X$="S"+A$(118,8); GOSUB 7900
2025 IF C0=1 AND A$(43,1)="Y" AND A$(45,1)="Y" THEN IF %IN_GUI$="Y" THEN CALL "FMGODH.1",MSG("FMGODH_08"),S3,"N"; IF S3=0 THEN A$(45,1)=" " END_IF ; ELSE CALL "ZZPROM",".RP",X3$,S3,"Reprint Work Order? ","","",0; IF S3=0 THEN A$(45,1)=" "; REM "SSP 180159
2030 IF A$(194,1)<>"Y" AND A$(43,1)="Y" AND A$(45,1)<>"Y" THEN WRITE (Z[2],KEY="W"+A$(118,8)) ELSE X$="W"+A$(118,8); GOSUB 7900
2032 IF C0=1 AND A$(51,1)="Y" THEN IF %IN_GUI$="Y" THEN CALL "FMGODH.1",MSG("FMGODH_09"),S3,"N"; IF S3=0 THEN A$(51,1)="A" END_IF ; ELSE CALL "ZZPROM",".RP",X3$,S3,"Reprint Customer Order Acknowledgement?","","",0; IF S3=0 THEN A$(51,1)="A"; REM "SSP 180159
2034 IF A$(194,1)<>"Y" AND A$(51,1)="A" AND A$(62,1)="Y" THEN WRITE (Z[2],KEY="A"+A$(118,8)) ELSE X$="A"+A$(118,8); GOSUB 7900
2054 IF POS("F"=A$(232,5))>0 THEN OPTIONS$=OPTIONS$+"F"
2055 IF C0=1 AND A$(194,1)<>"Y" AND SHIP_INTERFACE$<>"" THEN CALL "SH2EXP",ERR=*NEXT,X3$,X4$,A$(118,8),OPTIONS$,RET$ ! SSP239749 jdf
2090 GOSUB 7300; REM "Write out order header with updated buckets and flags
2095 GOTO 9900; REM "Finished with order
2100 REM "Check Order Status ... ssp105161
2101 REM "Delete logic around 01075
2103 IF GB$="" OR X3$(9,3)<>"498" THEN GOTO 2145
2104 IF A$(194,1)<>" " THEN GOTO 2145; REM "If already on hold, don't check again
2105 EXC$="  "; READ (Z[14],KEY="",DOM=2106)
2110 KEY_14$=KEY(Z[14],END=2140); READ (Z[14])
2115 DIM AB$(128),AB[2]; READ (Z[15],KEY=KEY_14$(3,2),DOM=2135)AB$,AB[0],AB[1],AB[2]
2125 ON INT((POS(AB$(1,2)="CLGPPDTEINOL")+1)/2) GOSUB 2146,4000,4200,4100,4150,4250,4050,2146; IF STP(EXC$,3," ")="" THEN GOTO 2126 ELSE GOSUB 2150; GOTO 2140
2135 GOTO 2110
2140 REM "Exception Processing finished
2145 RETURN 
2146 RETURN ; REM "Dummy subroutine for not found case
2150 REM "Check exception situations
2153 A$(194,1)="Y"; REM "Set on hold flag to yes
2155 DIM AD$(128),AD[4]; FIND (Z[11],KEY=A$(6,10),DOM=2170)AD$,AD[0],AD[1],AD[2],AD[3],AD[4]
2160 IF AD$(37,2)="C " THEN CALL "OE2AUA",AD$,AD{ALL},"D",MSG$; GOTO 2195
2170 DIM E$(229),E[17]; FIND (Z[5],KEY=A$(118,8)+"001",DOM=2171)IOL=0350
2175 AD$(1)=A$(118,8)+A$(16,6)+A$(6,10)+A$(169,3)+A$(172,3)+A$(175,6)+"H "+STR(TIM*100:"0000")+" "+A$(89,4)+DIM(10)+X3$(21,6)+EXC$,AD[0]=E[0]
2190 CALL "OE2AUA",X3$,AD$,AD{ALL},"A",MSG$
2195 RETURN 
3990 GOTO 9900
4000 REM "Check over credit limit
4010 DIM AA$(600),AA[15]; FIND (Z[12],KEY=A$(6,10),DOM=4045)IOL=0410
4020 IF AA$(361,1)="X" OR AA[6]+A[6]<=AA[5] THEN GOTO 4045
4030 EXC$="CL"
4045 RETURN 
4050 REM "Order Total Limit Exceeded
4095 RETURN 
4100 REM "Past Due Balance
4110 DIM AA$(600),AA[15]; FIND (Z[12],KEY=A$(6,10),DOM=4145)IOL=0410
4115 REM "Calucluate PASTDUE based on A/R params indicating which buckets are past due
4120 PASTDUE=0,PD_BUCKET=NUM(AR_PARMS$(99,1),ERR=4135)
4135 IF AA$(361,1)="X" OR AA[9]+AA[10]+AA[11]+AA[12]<AB[0] THEN GOTO 4145
4140 EXC$="PD"
4145 RETURN 
4150 REM "Cash Only
4155 FIND (Z[12],KEY=A$(6,10),DOM=4195)IOL=0410
4160 FIND (Z[16],KEY=AA$(359,2),DOM=4195)AC$
4165 IF AC$(33,1)<>" " THEN GOTO 4195
4170 EXC$="TE"
4195 RETURN 
4200 REM "Low Gross Profit
4209 REM "D[] values already sett
4210 O_VALUE=D[5]+D1[0],O_COST=D[6]+D1[1]
4220 IF O_COST=0 THEN LGP0=100 ELSE LGP0=(O_VALUE-O_COST)/O_COST
4225 IF LGP0*100>=AB[0] THEN GOTO 4245
4235 EXC$="GP"
4245 RETURN 
4250 REM "Incomplete
4265 IF A$(194,1)<>"Y" THEN GOTO 4295
4275 EXC$="IN"
4295 RETURN 
4300 REM "Check Product Class and Salesperson - W/O 105787
4310 CALL "FM2ODK",X3$,X4$,A$
4390 RETURN 
7000 REM "Remove FSA records
7002 IF F9$="Y" THEN RETURN 
7004 DIM J$(50),J[8]
7005 READ (Z[4],KEY=FID(0)+A$(118,8),DOM=7006)IOL=0341; GOTO 7010
7006 GOSUB 7100
7007 READ (Z[4],KEY=FID(0)+A$(118,8),DOM=7040)IOL=0341
7010 R0$="*"; GOTO 7274
7040 RETURN 
7100 REM "Create FSA record
7105 DIM D$(50),D[8],D1[1]
7110 GOSUB 7150
7115 D$(1,2)=A$(118,2),D$(3,6)=A$(16,6),D$(9,8)=A$(118,8),D$(18,10)=A$(6,10),D$(28,4)=A$(93,4),D$(32,16)=A$(102,16),D[0]=A[1],D[1]=A[2],D[2]=A[3],D[3]=A[4],D[4]=A[5],D$(49,1)=A$(54,1)
7116 IF F9$="Y" THEN RETURN 
7120 IF C0>=0 THEN GOSUB 7250 ELSE WRITE (Z[4],KEY=FID(0)+A$(118,8),DOM=7121)IOL=0340
7140 RETURN 
7150 REM "Calculate order amount,cost & est comm
7152 DIM F0$(33),F0[15]; READ (Z[6],KEY=A$(97,5),DOM=7153)IOL=0362; REM "Get order header's comm code and save for we may need it
7154 Q0=0,Q1=0,Q$="",A[10]=0
7155 READ (Z[5],KEY=A$(118,8),DOM=7156)
7160 K$=KEY(Z[5],END=7197); IF K$(1,8)<>A$(118,8) THEN GOTO 7197 ! SSP 225300
7165 DIM E$(140),E[17]
7170 READ (Z[5],KEY=K$)IOL=0350
7171 IF P0$(261,1)="Y" THEN A[10]=A[10]+E[17]; REM "Freight Returned from Lots, SSP94420
7172 IF F9$="P" THEN IF E$(155,1)="C" AND E$(9,1)=" " AND E$(161,10)<>P0$(229,10) THEN D1[0]=D1[0]+E[6],D1[1]=D1[1]+E[3]; GOTO 7160
7173 IF P0$(266,1)="Y" AND POS(E$(9,1)=P0$(267,5))>0 THEN GOTO 7160; REM "ADD LINE FOR SSP#098664 CWJ 6/3/98
7174 DIM F$(33),F[15]; GOSUB CHECK_COMM ! SSP 225300
7175 FOR SLP=ST_P TO END_P ! SSP 225300
7176 DCOM$=DET_COM$(SLP*5-4,5); IF STP(DCOM$,2)="" THEN CONTINUE ! SSP 225300 CAN HAVE BLANK COMMISSION CODES SSP 234456
7177 FIND (Z[6],KEY=DCOM$,DOM=7178)IOL=0360 ! SSP 225300
7178 GOSUB 8000; REM "Sets E3 to cost including adjustments based on whse cost adjustments !SSP 225300
7179 DIM EXTRA[10] ! SSP 225300
7180 IF F$(32,1)<>"L" THEN Q0=Q0+E[6],Q1=Q1+E3,Q$="*",Q=0 ELSE CALL "AR2COM","TX"+DIM(132)+A$(93,4),F$,F{ALL},Q,E[6],E3,"",A{ALL},E{ALL},EXTRA{ALL}
7185 D[7]=D[7]+Q ! SSP 234456
7187 ! OTO 7160 ! 
7193 IF F0$(32,1)="I" THEN GOSUB 8050
7194 NEXT SLP ! SSP 225300
7195 D[5]=D[5]+E[6],D[6]=D[6]+E[3] ! SSP 234456
7196 GOTO 7160 ! SSP 225300 SSP 234456
7197 IF C0<>99 THEN IF P0$(192,1)="Y" THEN GOSUB 8200 ! SSP 225300 !SSP#270990
7198 IF Q$="*" THEN GOSUB 7200
7199 RETURN ! SSO 225300
7200 REM "Fiqure total commission if required
7205 DIM F$(32),F[15]
7210 FIND (Z[6],KEY=A$(97,5),DOM=7211)IOL=0360
7214 IF P0$(192,1)="Y" THEN Q1=Q1-D[8]; REM "ADD IN GP ADJUSTMENTS
7215 CALL "AR2COM","",F$,F{ALL},Q,Q0,Q1
7220 D[7]=D[7]+Q
7240 RETURN 
7250 REM "Determine whether to write out
7252 IF C0=99 THEN RETURN 
7255 DIM J$(50),J[8]
7256 REM "Look for prior values
7260 READ (Z[4],KEY=FID(0)+A$(118,8),DOM=7280)IOL=0341
7262 REMOVE (Z[4],KEY=FID(0)+A$(118,8))
7265 IF D$(1,16)<>J$(1,16) OR D$(18)<>J$(18) THEN GOTO 7275
7267 FOR I=1 TO 8
7268 IF J[I]<>D[I] THEN EXITTO 7275
7269 NEXT I
7270 REM "No diffs, don't write out
7272 GOTO 7290
7274 REM "Write out neg of prior record if prior record not blank(indicating new order)
7275 IF POS(" "<>J$)=0 THEN GOTO 7280
7276 FOR I=5 TO 8; J[I]=-J[I]; NEXT I
7277 WRITE (Z[4],KEY=J$(1,17),DOM=7278)IOL=0341; GOTO 7280
7278 J$(17,1)=CHR(ASC(J$(17,1))+1); GOTO 7277
7280 IF R0$="*" THEN R0$=""; GOTO 7015
7281 REM "Write out new totals
7284 WRITE (Z[4],KEY=D$(1,17),DOM=7285)IOL=0340; GOTO 7288
7287 D$(17,1)=CHR(ASC(D$(17,1))+1); GOTO 7284
7290 RETURN 
7300 REM "Set order amount and cost in header
7301 REM "Assumes D(5) and D(6) set for FSA record - D1() sale and cost for lines skipped because items were previously booked on a bill as shipped p/o.
7310 A[6]=D[5]+D1[0],A[7]=D[6]+D1[1]
7315 IF C0<>99 THEN IF A$(184,1)="Y" OR P0$(274,1)="A" AND A$(48,1)<>"Y" AND A$(386,1)<>"Y" THEN IF %IN_WEBEC$<>"Y" AND %IN_GUI$<>"Y" THEN PRINT @(26,22),"Copying repeat order records", END_IF ; CALL "FM2ODE",X3$,1,A$,A{ALL},X4$; IF %IN_WEBEC$<>"Y" AND %IN_GUI$<>"Y" THEN PRINT @(0,22),'CL',; REM "If this is a repeat order then call routine to copy records; REM "SSP 180159, SSP 224057, SSP294679, check new FS1 field PO Receiving Updated
7318 IF C0<>99 THEN IF A$(184,1)="O" THEN IF %IN_WEBEC$<>"Y" AND %IN_GUI$<>"Y" THEN PRINT @(26,22),"Copying repeat Notepad records", END_IF ; CALL "UPDFT6;ADD_REPEAT_NOTES",A$(118,8); IF %IN_WEBEC$<>"Y" AND %IN_GUI$<>"Y" THEN PRINT @(0,22),'CL',; REM "Only save notepad if a$(184,1)="O" SSP#210352, SSP 224057
7330 IF GB$<>"" AND C0<>99 THEN ORDER$=A$,LOC$=ORDER$(199,2); CALL "GB2OTS",X3$,X4$,ORDER$,"N","",LOC$,""; REM "106447 add to order tracking if not on hold
7335 IF P0$(280,1)="Y" AND A$(54,1)="B" AND A$(240,1)="Y" THEN CALL "FM2ICA",X3$,X4$,"FM2ODH",C0,A$,A{ALL},""; REM "SSP111482, Inventory costing, set order cost
7337 GOSUB SET_READONLY; READ RECORD (Z(7),KEY=A$(118,8),DOM=*NEXT)FS1$; IF FS1$(128,1)="Y" AND A$(128,1)<>"S" THEN A$(1,1)=FS1$(1,1),A$(128,1)=FS1$(128,1); REM "SSP#200855,188722,215059!218545. SSP261716, error 0 reported, will save off then set READONLY, restore on next line in case of DOM
7338 GOSUB CLEAR_READONLY ! SSP261716, restore REAONLY prm setting
7340 A$(232,5)=DIM(5); WRITE (Z[7],KEY=A$(118,8))IOL=0370
7345 RETURN 
7900 REM "Remove PO6 Records
7910 REMOVE (Z[2],KEY=X$,DOM=7911)
7920 REMOVE (Z[2],KEY=X$+"P",DOM=7921)
7921 IF C0<>-2 THEN GOTO 7940; REM SSP 196538
7925 READ (Z[2],KEY="VOS2C0   "+A$(118,8),DOM=7926); REM SSP 196538
7926 TOPS$=KEY(Z[2],END=7930); IF MID(TOPS$,10,8)<>MID(A$,118,8) THEN GOTO 7930; REM SSP 196538
7927 REMOVE (Z[2],KEY=TOPS$); REM SSP 196538
7928 GOTO 7925; REM SSP 196538
7940 RETURN 
8000 REM "Calculate Adjusted Gross Profit on the line
8005 Q=F[0],D8=0,E3=E[3]
8007 IF P0$(171,1)="Y" AND E$(155,1)="C" AND E$(161,10)<>P0$(172,10) THEN GOSUB 8150
8010 IF POS(MID(F$,33,1)="1234567890")=0 OR MID(E$,155,1)="M" THEN GOTO 8030
8011 REM "Do house charges
8015 IF POS(E$(155,1)="IC")>0 AND E$(9,1)=" " THEN F1$="0000"; IF E[12]<>0 THEN F1=E[0]/E[12]+SGN(FPT(E[0]/E[12])); F1$=STR(F1:"0000"); REM "used by house charge within AR2COM - Blank means not comingout of whse
8020 CALL "AR2COM","HC"+F1$,F$,F0{ALL},Q,E[6],E3; D8=D8+Q
8030 IF MID(F$,33,1)="F" THEN D8=D8-Q
8035 IF POS(MID(F$,33,1)=" C")>0 THEN D8=D8-E3*Q/100
8040 D[8]=D[8]+D8
8043 IF P0$(192,1)="Y" THEN GOSUB 8300
8045 RETURN 
8050 REM "Pre Compute est.load on Invoice Total type Commis
8055 IF POS(F0$(33,1)="123456789")>0 THEN GOTO 8095 ELSE D8=0
8060 D8=(-A[7])*F0[0]/100
8065 IF LEN(H$)>32 THEN IF H$(33,1)="S" THEN D8=0 ELSE IF H$(33,1)="F" THEN D8=-F[0]
8090 D[8]=D[8]+D8
8095 RETURN 
8150 REM "Exculde whse from setting GP adjustment to cost
8165 DIM X$(15); X$(1,1)="D",X$(12,4)=E$(10,4)
8170 READ (Z[10],KEY=X$,DOM=8190)X$
8175 IF X$(235,1)<>"Y" THEN D8=D8+E3,E3=0
8195 RETURN 
8200 REM "Process req type charges to get proper adj gross profit
8205 CALL "AR2SHC",X3$,X4$,"O",A$,R,R$,R{ALL}
8210 IF R=0 THEN GOTO 8295; REM "R IS NUMBER TO DO IF 0 LEAVE
8212 REM "For each Req charge in R$, build a pseudo-line, and load buckets from R(all) array , and call commission routine. Add GP adju bucket (bucket (8), (9 of 11)) DIRectly to D(8)
8220 FOR I=1 TO R
8225 DIM E$(200),E[20],R0[10]
8230 R0$=R$((I-1)*100+1,100)
8235 FOR I0=0 TO 10
8236 R0[I0]=R[(I-1)*11+I0]
8237 NEXT I0
8240 E$(155,1)="S",E[3]=R0[5],E[6]=R0[4]
8245 IF POS(" "<>R0$(70,5))>0 THEN E$(128,5)=R0$(70,5) ELSE R0$(70,5)=A$(97,5)
8247 DIM F$(32),F[15]; FIND (Z[6],KEY=E$(128,5),DOM=8248)IOL=0360
8250 GOSUB 8000
8255 IF F$(32,1)<>"L" THEN Q0=Q0+E[6],Q1=Q1+E3,Q$="*",Q=0 ELSE CALL "AR2COM","",F$,F{ALL},Q,E[6],E3
8257 D[5]=D[5]+E[6],E[6]=D[6]+E[3],D[7]=D[7]+Q
8270 D[8]=D[8]+R0[8]; REM "Add calculated gp adjustment
8275 NEXT I
8295 RETURN 
8300 REM "FINDERS FEE
8305 IF MFF_PARM THEN GOSUB READ_MFEE; RETURN ! SSP 276772
8310 ON POS(E$(135,1)="SCPF") GOTO 8345,8320,8330,8340,8342
8320 D[8]=D[8]-E[6]*E[11]*.01; GOTO 8345
8330 D[8]=D[8]-E[3]*E[11]*.01; GOTO 8345
8340 D[8]=D[8]-(E[6]-E[3])*.01; GOTO 8345
8342 D[8]=D[8]-E[11]; GOTO 8345
8345 RETURN 
8400 REM "Remove SH8 records - WO124784
8405 CALL "UPDSH9;DELETE_ORDER_ENTRIES",Z[18],A$(118,8) ! ssp 194599
8410 READ (Z[17],KEY=A$(118,8),DOM=8411)
8415 SH8_KEY$=KEY(Z[17],END=8445)
8420 IF SH8_KEY$(1,8)<>A$(118,8) THEN GOTO 8445
8425 REMOVE (Z[17],KEY=SH8_KEY$,DOM=8415)
8430 GOTO 8415
8445 RETURN 
8500 SET_READONLY:! SSP261716, save XI parm and set READONLY
8510 SAVE_XI=PRM('XI'); SET_PARAM 'XI'
8525 SET_READONLY_END:RETURN 
8530 CLEAR_READONLY:! SSP261716, restore previous XI setting
8535 SET_PARAM 'XI'=SAVE_XI
8545 CLEAR_READONLY_END:RETURN 
8600 REMOVE_EDD:! SSP294523
8610 READ (Z[19],KEY=A$(118,8),DOM=*NEXT)
8615 EDD_KEY$=KEY(Z[19],END=8645)
8620 IF EDD_KEY$(1,8)<>A$(118,8) THEN RETURN 
8625 REMOVE (Z[19],KEY=EDD_KEY$,DOM=8615)
8630 GOTO 8615
8645 RETURN 
8649 ! 
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9915 IF %LOG_LEVEL=%LOG_DEBUG THEN CALL "ZZ2LOG;CLOSE_LOG",ERR=*NEXT,X3$,X4$,LOG_CHANNEL ! 245262
9920 IF PO_ACK$<>"Y" THEN GOTO 9930 ELSE IF C0=1 OR C0=-2 OR C0=-3 THEN GOTO 9925 ELSE GOTO 9930 ! SSP 233493   
9925 IF C0=1 THEN ACK_TYPE$="U" ELSE ACK_TYPE$="C" ! ssp 233493
9928 CALL "FM2ODW;PO_ACK_UPDATE",X3$,X4$,ACK_TYPE$,C0,A$(118,8) ! ssp 233493
9930 SETERR 9940; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
10000 CHECK_COMM:! Set comm string to AXS if %MSLC set else use default
10010 IF NOT(%MSLC) THEN DIM DET_COM$(25); ST_P=1,END_P=1,DET_COM$(1,5)=E$(128,5); RETURN ! SSP 225300
10030 CKEY$="O"+A$(118,8)+A$(6,10)+E$(6,3) ! SSP 225300
10040 CALL "ARGSCM ; GET_INVOICE_COMM",CKEY$,DET_COM$ ! SSP 225300
10045 IF LEN(DET_COM$)<25 THEN DET_COM$=DET_COM$+DIM(25),DET_COM$=DET_COM$(1,25) ! SSP 225300
10050 ST_P=1,END_P=5 ! SSP 225300
10060 RETURN ! SSP 225300
12000 READ_MFEE:! SSP 276772
12005 IKY$=E$(147,8)+E$(6,3)
12008 DIM FV5[4],FV5$(125)
12010 READ (Z[41],KEY=IKY$,DOM=*NEXT)
12015 READ_NEXT_FV5:
12020 FF_KEY$=KEY(Z[41],END=END_MFEE); READ (Z[41],KEY=FF_KEY$)IOL=0420
12030 IF FF_KEY$(1,LEN(IKY$))<>IKY$ THEN GOTO END_MFEE
12040 FTYPE$=FV5$(15,1),FVEND$=FV5$(16,10),FRATE=FV5[0]
12060 ON POS(FTYPE$="SCGFA") GOTO READ_NEXT_FV5,12070,12080,12090,12100,12090; REM " SSP# 132459
12070 D[8]=D[8]-E[6]*E[11]*.01; GOTO READ_NEXT_FV5
12080 D[8]=D[8]-E[3]*E[11]*.01; GOTO READ_NEXT_FV5
12090 D[8]=D[8]-(E[6]-E[3])*.01; GOTO READ_NEXT_FV5
12100 D[8]=D[8]-E[11]; GOTO READ_NEXT_FV5
12200 GOTO READ_NEXT_FV5
12280 END_MFEE:
12290 RETURN 
12299 ! 
56000 REM "187122-Ehanced Back Order Fill report option I/C RM RQ created       
56001 REM " SSP 194096 When you pull in the United Invoices, it was updating the Order Booking file a second time
56002 REM " SSP 196538 When you delete a Tops Order, remove the PO6 Record
56005 REM "194599-Issue with the addresses on VP business cards. Pulling      
56006 REM "205580-OPO1 in order entry                                         
56008 REM "205703-Oracle - FID and FIB calls, replace with FN%FID$ and FN%FIB$
56009 REM "210352-Notepad disappears in order history
56010 REM "218545-Issue with suspended packing lists showing a value of "N"   
56011 REM "180159-Consolidate FM2ODH and FMGODH, FM2ODZ and FMGODZ into one   
56012 REM "224057-What does this error message on the email confirmation page 
56014 REM "233493-Retrieve/process DSSI PO files, create/send DSSI PO Acks.   
56016 REM "245262-DSSI PO Acknowledments; some are going to DSSI with no line 
56018 REM "252273-New Deleted Order and Deleted PO file. Modify delete routine
56020 REM "258502-SH9 CUST_CODE_FORMATTED, almost always unformatted customer.
56022 REM "261716-Error 0-FM2ODH-7337 with DB/e order 30-J0HDBY.              
56024 REM "263687-Error generating DB/e orders. (016-EC3SOR-6720) **ECW full**
56025 REM "270990-Running FM2UT9.  Do not feel this Auto Req charge should be 
56026 REM "276772-Multiple Finder's Fees per Customer/Item/Order Line.        
56027 REM "282968-Repeat orders are removed and not put back
56028 REM "292399-DB: 291503 Commission by product code by salesperson.       
56030 REM "294523-CC Vault work-discovered EDD not deleted with order delete
56032 REM "307192-Office Products legacy code causes error in FM2ODH          
