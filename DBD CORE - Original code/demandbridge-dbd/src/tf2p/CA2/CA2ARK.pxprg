0010 REM "Convert Sales tax/Commission Pending <CA2ARK>
0020 SETESC 9300; SETERR 9000
0035 REM "5.2 - 08/20/03 - 11.276666 - dmm - SSP# 163697
0040 REM "Copyright 2003 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0080 BEGIN 
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,Q0$,Q1$
0100 SETERR 9000
0110 X0$="CA2ARK",X1$="Convert to TopForm A/R Pending Tax & Comm File"
0120 DIM Z0$(80,"-"),Z1$(20,"0"),Z2$(20)
0130 K0=20,K1=1
0135 C9=-1
0200 REM "
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=ESC+"BG"+Z0$+ESC+"EG"
0300 REM "IOLISTS
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14],A[15]
0330 IOLIST C$,C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8],C[9],C[10],C[11],C[12],C[13],C[14]
0340 IOLIST D$,D[0],D[1],D[2],D[3],D[4],D[5],D[6],D[7],D[8],D[9],D[10],D[11],D[12],D[13],D[14],D[15]
0350 IOLIST E$,E[0],E[1],E[2],E[3]
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="02O ARK...  03O AR6...  04O AR1...  05O AR7...  06O AR2...  07O ARKERR  11O CA0... 12O MAPDAT  13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0530 READ (Z[13],KEY=X3$(9,3)+"A/R")P0$
0535 READ (Z[11],KEY="ARK ")CA0$
0600 REM "
0605 READER$="CA2R"+STP(CA0$(25,2),1)
0610 GOSUB 6000
0615 CALL READER$,X3$,X4$,CA0$,CA1${ALL},"O","",MEM${ALL},R$,RET_CODE
0640 CALL "ZZPROM",".Y",X3$,Z,"Proceed?","","",0; ON Z GOTO 0641,9900
0700 CALL "ZZINIT",STR(Z[2]:"00")+STR(Z[7]:"00")
0710 X$="AR4 "
0720 FOR I=1 TO LEN(X$) STEP 4
0730 CALL "ZZPROM",".Y",X3$,Z,"Clear Mapping for "+X$(I,3)+"?","","",0; ON Z GOTO 0731,0790
0740 READ (Z[12],KEY=X$(I,4),DOM=0741)
0750 READ (Z[12],END=0790)R2$
0760 IF X$(I,4)<>R2$(1,4) THEN GOTO 0790
0770 REMOVE (Z[12],KEY=R2$(1,24))
0780 GOTO 0750
0790 NEXT I
0910 DIM D[15],E[3]
0920 H0$=$0A$,I9=980000
0940 READ (Z[12],KEY="*PARAMETERS")P9$
0950 ADDR "CA2CVT"
0955 REM "Fiscal Year/Accounting Period
0960 F9$="1993",F8$="10"
0970 GOSUB 8150
1000 REM "Read Data file
1010 DIM R$(1000); CALL READER$,X3$,X4$,CA0$,CA1${ALL},"R","",MEM${ALL},R$,RET_CODE; IF RET_CODE=2 THEN GOTO 5000
1180 GOSUB 2000
1900 GOTO 1000
2000 REM "Initialize TopForm Record
2020 DIM A$(65),A[15],S$(50)
2025 C1=C1+1
2050 REM "A/R Customer Code
2060 Q$=FNS$(R$(1,17)); DIM X$(100); X$(1)="AR1 "+Q$
2065 X=NUM(P0$(14,1)),A$(1,10)=Z1$,A$(3,X)=Q$(3),A$(3,X)=STR(NUM(Q$(3),ERR=2066):Z1$(1,X))
2070 FIND (Z[12],DOM=2071,KEY=X$(1,24))X$; A$(1,10)=X$(25,10); GOTO 2090
2080 A$(1)="**Customer number missing from map**",I8$=STR(NUM(I8$)+1:"0000"); WRITE (Z[7],KEY=Q$+I8$)R$; GOTO 4990
2090 FIND (Z[4],KEY=A$(1,10),DOM=2091)IOL=0340; GOTO 2095
2091 PRINT @(0,15),"missing: ",R$(1,17),; INPUT *; PRINT @(0,15),'CL',; GOTO 4990
2100 REM "Invoice Number
2110 A$(11,8)=STR(NUM(R$(18,10),ERR=2111):"0000000 ")
2115 DIM C$(181),C[14]; READ (Z[3],KEY=A$(1,18),DOM=2116)IOL=0330; GOTO 2125
2120 I8$=STR(NUM(I8$)+1:"0000"); WRITE (Z[7],KEY=A$(11,8)+I8$)"***MISSING INV**"+R$; GOTO 4990
2830 REM "Salesperson Code #1
2840 Q$=R$(48,4); IF FNS$(Q$)="" THEN Q$=C$(74,4) ELSE I1=46,I2=4; GOSUB 7700
2870 REM "Salesperson Code #2
2880 Q$=R$(52,4); IF FNS$(Q$)="" THEN Q$=C$(78,4) ELSE I1=50,I2=4; GOSUB 7700
2910 REM "Salesperson Code #3
2920 Q$=R$(56,4); IF FNS$(Q$)="" THEN Q$=C$(82,4) ELSE I1=54,I2=4; GOSUB 7700
2950 REM "Salesperson Code #4
2960 Q$=R$(60,4); IF FNS$(Q$)="" THEN Q$=C$(86,4) ELSE I1=58,I2=4; GOSUB 7700
2990 REM "Salesperson Code #5
3000 Q$=R$(64,4); IF FNS$(Q$)="" THEN Q$=C$(90,4) ELSE I1=62,I2=4; GOSUB 7700
3060 REM "Audit Control Number
3070 A$(40,6)="CONV00"
3300 REM "Sales Tax Code
3320 Q$=R$(28,10); IF FNS$(Q$)="" THEN A$(25,10)=C$(117,10); GOTO 3350
3330 DIM X$(100); X$(1)="AR5 "+Q$,I1=25,I2=10; GOSUB 7500
3350 REM "Commission Code
3360 Q$=R$(38,10),X$(1)="AR4 "+Q$,I1=35,I2=5; GOSUB 7500
3650 REM "Invoice commission Pending
3655 Q$=R$(68,15); GOSUB 7650; A[4]=X
3656 IF X3$(9,3)="529" THEN A[4]=X*.55
3670 REM "State Taxable Amount
3675 Q$=R$(83,15); GOSUB 7650; A[5]=X
3690 REM "State Tax Billed
3695 Q$=R$(98,15); GOSUB 7650; A[6]=X
3700 REM "County Taxable Amount
3705 Q$=R$(113,15); GOSUB 7650; A[7]=X
3710 REM "County Tax Billed
3715 Q$=R$(128,15); GOSUB 7650; A[8]=X
3720 REM "Local Taxable Amount
3725 Q$=R$(143,15); GOSUB 7650; A[9]=X
3730 REM "Local Tax Billed
3735 Q$=R$(158,15); GOSUB 7650; A[10]=X
3750 REM "Salesperson 1 Comm %
3755 Q$=R$(173,10); GOSUB 7650; A[11]=X
3760 REM "Salesperson 2 Comm %
3765 Q$=R$(183,10); GOSUB 7650; A[12]=X
3770 REM "Salesperson 3 Comm %
3775 Q$=R$(193,10); GOSUB 7650; A[13]=X
3780 REM "Salesperson 4 Comm %
3785 Q$=R$(203,10); GOSUB 7650; A[14]=X
3790 REM "Salesperson 5 Comm %
3795 Q$=R$(213,10); GOSUB 7650; A[15]=X
3800 REM "Gross Profit
3805 Q$=R$(223,15); GOSUB 7650; A[3]=X
4000 REM "Pickup some data from AR6 record
4010 REM "Invoice date
4015 A$(19,6)=C$(20,6)
4020 REM "Invoice Total
4025 A[0]=C[2]
4030 REM "Invoice net amount
4035 A[1]=C[9]
4040 REM "Invoice freight
4045 A[2]=C[8]
4100 REM "Update some information in AR6
4110 REM "Gross Profit
4115 C[10]=A[3]
4120 REM "Total Commission Amount
4125 C[11]=A[4]
4190 WRITE (Z[3],KEY=C$(1,18))IOL=0330
4600 REM "Check out sps commission
4615 IF POS(" "<>A$(46,20))=0 THEN A$(46,20)=C$(74,20); REM "If salespersons blank, default from invoice
4624 REM "Set 1st to 100% if only one and all are 0
4625 IF A[11]=0 AND A[12]=0 AND A[13]=0 AND A[14]=0 AND A[15]=0 AND POS(" "<>A$(50,16))=0 THEN A[11]=100
4900 REM "Write file(s)
4910 WRITE (Z[2],KEY=A$(1,18),DOM=4911)IOL=0310; C2=C2+1; GOTO 4920
4911 REM "Already on file, just add to appropiate buckets
4912 DIM TMP[15]; FOR I=0 TO 15; TMP[I]=A[I]; NEXT I
4914 EXTRACT (Z[2],KEY=A$(1,18),DOM=4910)IOL=0310
4915 FOR I=4 TO 10; A[I]=A[I]+TMP[I]; NEXT I
4917 WRITE (Z[2],KEY=A$(1,18))IOL=0310
4990 RETURN 
5000 REM "EOJ
5005 IF C1<>C2 THEN CALL "ZZPROM",".4",X3$,Z,"Only "+STR(C2)+" out of "+STR(C1)+" records were loaded!","","",0
5010 GOSUB 5200
5020 CALL "ZZPROM",".4",X3$,Z,"Process complete!!","","",0
5040 GOTO 9900
5200 REM "COMPLETE CYCLE
5210 REM CALL "AR2UT4",X3$,"","","*"
5290 RETURN 
6000 REM "BACKGROUND
6005 PRINT (0,ERR=6016)'SB',
6020 PRINT @(0,4),"This program converts the A/R Pending file to TopForm's ARK, Sales tax and Commission Pending File.",
6165 PRINT (0,ERR=6166)'SF',
6190 RETURN 
7500 REM "Generalized Mapping
7510 X=0
7520 FIND (Z[12],KEY=X$(1,24),DOM=7521)X$,X; A$(I1,I2)=X$(25,I2); GOTO 7590
7560 X$(25)=Q$; WRITE (Z[12],KEY=X$(1,24))X$; GOTO 7520
7590 RETURN 
7600 REM "Generalized Date conversion
7610 IF FNS$(Q$)="" THEN X$=""; GOTO 7640
7620 CALL "CA2CVT",X3$,X4$,P9$(1,2),Q$,0,X$,0,"",0
7640 RETURN 
7650 REM "Generalized Numeric conversion
7660 IF FNS$(Q$)="" THEN X$="",X=0; GOTO 7690
7670 CALL "CA2CVT",X3$,X4$,P9$(5,2),Q$,0,X$,X,"",0
7690 RETURN 
7700 REM "Salesperson's Map
7705 IF FNS$(Q$)="" THEN RETURN 
7710 DIM X$(100); X$(1)="AR3 "+Q$
7720 GOTO 7500
7750 REM "Convert Phone Number
7760 IF FNS$(Q$)="" THEN X$=""; GOTO 7790
7770 CALL "CA2CVT",X3$,X4$,P9$(3,2),Q$,0,X$,0,"",0
7790 RETURN 
8000 REM "Update Finance Charge for this invoice
8010 DIM A[14]; A$(11,7)="9000001",A$(19,1)="F",A[3]=F9,A[2]=F9,A[3]=F9,A[6]=F9
8020 WRITE (Z[2],KEY=A$(1,18),DOM=8021)IOL=0310; GOTO 8040
8030 A$(11,7)=STR(NUM(A$(11,7))+1:"0000000"); GOTO 8020
8040 RETURN 
8200 REM 'FIX DATE IN PLACE IN R$ BASED ON J
8201 RETURN 
8205 IF POS(" "<>R$(J,10))=0 THEN GOTO 8245
8210 J1$="",J2$="",J$=R$(J,10); IF POS("/"=J$)=0 THEN IF J$(1,3)=" 19" THEN J$=J$(4),J$=J$(3)+J$(1,2); GOTO 8220 ELSE IF J$(1,2)="19" THEN J$=J$(3),J$=J$(3)+J$(1,2); GOTO 8220
8211 J1$=J$(1,POS("/"=J$)-1),J$=J$(POS("/"=J$)+1)
8213 IF LEN(J1$)<2 THEN J1$="0"+J1$
8215 J2$=J$(1,POS("/"=J$)-1),J$=J$(POS("/"=J$)+1)
8217 IF LEN(J2$)<2 THEN J2$="0"+J2$
8220 R$(J,10)=J1$+J2$+J$
8245 RETURN 
8920 DEF FNS$(Z9$)=Z9$(1,POS(Z2$=Z9$+Z2$)-1)
8930 DEF FNQ$(Z9$,Z9)=STR(NUM(Z9$):Z1$(1,Z9))
8940 DEF FNE$(Z9)=CHR(ASC("A")+INT(Z9/10))+STR(MOD(Z9,10))
8950 DEF FNS(Z9$)=POS(" "<>Z9$)
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9920 DROP "CA2CVT",ERR=9921
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
