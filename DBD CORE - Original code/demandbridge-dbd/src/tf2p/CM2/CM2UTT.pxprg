0010 REM "Convert True R/L TB Basic Files to ProOffice Text Format"
0035 REM "5.2 - 05/08/03 - 12.016388 - dmm - SSP# 159455
0040 REM "Copyright 2003 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 CLEAR ; SETERR 0095; ENTER X3$
0095 SETERR 9000
0100 DEF FNYMD$(Z9$)=STR(ASC(Z9$(1,1))+125)+Z9$(2,1)+Z9$(3,2)+Z9$(5,2)
0120 DIR$=HWD+DLM+"comm"+DLM+"prooffice"+DLM,WORK_DIR$=HWD+DLM+"comm"+DLM+"work"+DLM,PROC_DIR$=HWD+DLM+"comm"+DLM+"processed"+DLM,OUT_DIR$=HWD+DLM+"comm"+DLM+"outbox"+DLM
0200 PNT_SLS$="AM  BAB BL  DI  DP  FD  FG  GC  HR  HS  JR  KLJ LFB LG  LJ  PN  RR  RW  SC  SF  SLJ SRF SR  PB  BM  MU  MO  RS  RJ  CG  SH  "
0210 PFG_SLS$="Q6AMQ6BBQ6BLQ6DIQ6DPQ6FDQ6FGQ6GCQ6HRQ6HSQ6JRQ6KJQ6LBQ6LGQ6LJQ6PNQ6RRQ6RWQ6SCQ6SFQ6SJQ6SFQ6SRQ6PBQ6BMQ6MUQ6MOQ6RSQ6RJQ6CGQ6SH"
0220 PNT_TRM$="0001020304050607080911121314151623242526272829303132"
0230 PFG_TRM$="0215029930353005012599993099303030309999303099991099"
0500 ! Open files
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="02O ZZPARM  03O AR1...  04O AR2...  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; IF Z0=1 THEN GOTO 9900
0900 PRINT @(10,15),"Convert TopForm True R/L Files for ProOffice"
1000 SELECT F$ FROM DIR$ WHERE MID(F$,1,3)="CM1"
1002 USEDAR1$="",USEDAR3$=""
1007 OWNER$=F$(4,3)
1010 PRINT @(10,20),"Processing File: ",F$
1020 CLOSE (100); OPEN (100)DIR$+F$; FTYP$=FID(100); CLOSE (100)
1040 IF FTYP$(10,1)=$0B$ THEN GOSUB 2000 ELSE GOSUB 3000
1050 NEXT RECORD 
1060 GOTO 9900
2000 REM "Process Text File"
2001 ESCAPE ! Should never be here!
2009 ERASE DIR$+"work/"+F$+".txt",ERR=2010
2010 SERIAL DIR$+"work/"+F$+".txt",4,0
2020 FTXT=UNT; OPEN (FTXT,OPT="TEXT")DIR$+"inbox/"+F$
2030 FWRK=UNT; OPEN (FWRK,OPT="TEXT")DIR$+"work/"+F$+".txt"
2100 READ (FTXT,END=2190)REC$
2110 IF REC$(1,3)="CM3" OR REC$(1,3)="ART" THEN REC$=REC$(1,16)+"   "+REC$(17)
2120 IF REC$(1,3)="SPC" THEN REC$=REC$(1,29)+"     "+REC$(30)
2130 WRITE (FWRK)REC$
2140 GOTO 2100
2190 CLOSE (FTXT); CLOSE (FWRK)
2192 CMD$="mv -f "+DIR$+"work/"+F$+".txt"+" "+DIR$+"prooffice/"+F$+".txt"; INVOKE CMD$
2193 ESCAPE 
2194 CMD$="mv -f "+DIR$+"inbox/"+F$+" "+DIR$+"processed/"+F$; INVOKE CMD$
2195 ESCAPE 
2199 RETURN 
3000 REM "Process TBasic File"
3005 WORK_F$=F$+".txt"; IF OWNER$="509" THEN WORK_F$=WORK_F$(1,3)+"434"+WORK_F$(7)
3009 ERASE WORK_DIR$+WORK_F$,ERR=3010
3010 SERIAL WORK_DIR$+WORK_F$
3020 FTB=UNT; OPEN (FTB)DIR$+F$
3030 FWRK=UNT; OPEN LOCK (FWRK,OPT="TEXT")WORK_DIR$+WORK_F$
3112 GOSUB 3300; REM "AR1 Records"
3114 GOSUB 3400; REM "AR3 Records"
3116 GOSUB 3200; REM "APD Records"
3118 GOSUB 3500; REM "CM3 Records"
3190 CLOSE (FTB); CLOSE (FWRK)
3192 RENAME WORK_DIR$+WORK_F$,OUT_DIR$+WORK_F$,ERR=*NEXT; GOTO 3194
3193 ESCAPE 
3194 RENAME DIR$+F$,PROC_DIR$+F$,ERR=*NEXT; GOTO 3196
3195 ESCAPE 
3199 RETURN 
3200 REM "APD Records"
3205 DIM APDW$(106),APD[13]
3207 READ (FTB,KEY="APD",DOM=3208)
3210 K1$=KEY(FTB,END=3299)
3212 IF K1$(1,3)<>"APD" THEN GOTO 3299
3213 IF POS("AUDIT"=K1$)>0 THEN READ (FTB); GOTO 3210; REM "Skip Audit Records"
3215 READ (FTB)INFO1$,INFO2$,*,*,APD$,APD{ALL}
3225 IF F$(4,3)="270" THEN GOSUB 30000
3230 APDW$(1,3)="APD"
3232 APDW$(4,4)=APD$(1,4)
3234 APDW$(8,2)=APD$(5,2)
3236 APDW$(10,10)=APD$(7,10)
3238 APDW$(20,20)=APD$(17,10)
3240 APDW$(40,8)=FNYMD$(APD$(27,6))
3242 APDW$(48,8)=FNYMD$(APD$(35,6))
3244 APDW$(56,8)=APD$(62,8)
3246 APDW$(64,3)=APD$(104,3); IF OWNER$="509" THEN APDW$(64,3)="434"
3248 APDW$(67,10)=STR(APD[9]:"-000000.00")
3250 APDW$(77,10)=STR(APD[2]:"-000000.00")
3252 APDW$(87,10)=STR(APD[3]:"-000000.00")
3254 APDW$(97,10)=STR(APD[1]:"-000000.00")
3260 PRINT (FWRK)APDW$
3270 GOTO 3210
3299 RETURN 
3300 REM "AR1 Records"
3305 DIM AR1W$(232),AR1[15]
3307 READ (FTB,KEY="AR1",DOM=*NEXT)
3310 K1$=KEY(FTB,END=3399)
3312 IF K1$(1,3)<>"AR1" THEN GOTO 3399
3313 IF POS("AUDIT"=K1$)>0 THEN READ (FTB); GOTO 3310; REM "Skip Audit Records"
3320 READ (FTB)INFO1$,INFO2$,*,*,AR1$,AR1{ALL}
3322 IF F$(4,3)="270" THEN GOSUB 31000
3325 IF POS(AR1$(1,10)=USEDAR1$,10)=0 THEN USEDAR1$=USEDAR1$+AR1$(1,10) ELSE GOTO 3310; REM "Skip AR1 if already included in file"
3327 READ (Z[2],KEY="CMP"+OWNER$); FAR2=Z[4]; FAR1=Z[3]
3328 READ (FAR2,KEY=AR1$(359,2))WAR2$
3330 AR1W$(1,3)="AR1"
3332 AR1W$(4,10)=AR1$(1,10)
3334 AR1W$(14,35)=AR1$(11,35)
3336 AR1W$(49,30)=AR1$(56,30)
3338 AR1W$(79,30)=AR1$(86,30)
3340 AR1W$(109,16)=AR1$(116,16)
3342 AR1W$(125,2)=AR1$(132,2)
3344 AR1W$(127,9)=AR1$(134,9)
3346 AR1W$(136,10)=AR1$(205,10)
3348 AR1W$(146,10)=AR1$(143,10)
3350 AR1W$(156,20)=AR1$(165,20)
3352 AR1W$(176,8)=FNYMD$(AR1$(229,6))
3354 AR1W$(184,10)=AR1$(235,10)
3356 AR1W$(194,6)=""; REM "Sales Tax %"
3358 AR1W$(200,1)=AR1$(245,1)
3360 AR1W$(201,4)=AR1$(278,4)
3362 AR1W$(205,15)=STP(UCS(STP(WAR2$(3,15),1)),0); REM "TERMS CODE DESC"
3364 AR1W$(220,3)=AR1$(431,3); IF OWNER$="509" THEN AR1W$(220,3)="434"
3366 AR1W$(223,10)=STR(AR1[5]:"-000000.00")
3370 PRINT (FWRK)AR1W$
3380 ! WRITE (FAR1,KEY=AR1$(1,10))AR1$,AR1{ALL}
3390 GOTO 3310
3399 RETURN 
3400 REM "AR3 Records"
3405 DIM AR3W$(129)
3407 READ (FTB,KEY="AR3",DOM=3408)
3410 K1$=KEY(FTB,END=3499)
3412 IF K1$(1,3)<>"AR3" THEN GOTO 3499
3413 IF POS("AUDIT"=K1$)>0 THEN READ (FTB); GOTO 3410; REM "Skip Audit Records"
3420 READ (FTB)INFO1$,INFO2$,*,*,AR3$
3425 IF F$(4,3)="270" THEN GOSUB 33000
3427 IF POS(AR3$(1,4)=USEDAR3$,4)=0 THEN USEDAR3$=USEDAR3$+AR3$(1,4) ELSE GOTO 3410; REM "Skip AR3 if already included in file"
3430 AR3W$(1,3)="AR3"
3432 AR3W$(4,4)=AR3$(1,4)
3434 AR3W$(8,35)=AR3$(5,35)
3436 AR3W$(43,30)=AR3$(40,30)
3438 AR3W$(73,30)=AR3$(70,30)
3440 AR3W$(103,16)=AR3$(100,16)
3442 AR3W$(119,2)=AR3$(116,2)
3444 AR3W$(121,9)=AR3$(118,9)
3450 PRINT (FWRK)AR3W$
3460 GOTO 3410
3499 RETURN 
3500 REM "CM3 Records"
3505 DIM CM3W$(407),CM3[20]
3507 READ (FTB,KEY="CM3",DOM=3508)
3510 K1$=KEY(FTB,END=3699)
3512 IF K1$(1,3)<>"CM3" THEN GOTO 3699
3513 IF POS("AUDIT"=K1$)>0 THEN READ (FTB); GOTO 3510; REM "Skip Audit Records"
3515 READ (FTB)INFO1$,INFO2$,*,*,CM3$,CM3{ALL}
3520 IF F$(4,3)="270" THEN GOSUB 32000
3521 IF CM3[1]=0 AND CM3[2]=0 AND CM3[4]=0 AND CM3[6]=0 AND CM3[8]=0 AND CM3[9]=0 THEN GOTO 3510; REM "Skip if Invoice Amounts are zero"
3522 IF LEN(CM3$)<495 THEN CM3$=CM3$+" "; GOTO 3522
3524 READ (Z[2],KEY="CMP"+OWNER$); FAR1=Z[3],FAR2=Z[4]
3525 DIM AR1W$(232),AR1W[15]
3526 DIM WAR1$(600),ARW1[15]; READ (FAR1,KEY=CM3$(15,10),DOM=3527)WAR1$,AR1W{ALL}
3527 IF CM3$(65,2)="  " THEN CM3$(65,2)="30"; REM "Set Default"
3528 READ (FAR2,KEY=CM3$(65,2),DOM=3529)WAR2$
3530 CM3W$(1,3)="CM3"
3532 CM3W$(4,4)=CM3$(1,4)
3534 CM3W$(8,2)=CM3$(5,2)
3536 CM3W$(10,10)=CM3$(7,7)
3538 CM3W$(20,10)=CM3$(15,10)
3540 CM3W$(30,35)=WAR1$(11,35)
3542 CM3W$(65,87)=WAR1$(56,87)
3544 CM3W$(152,35)=CM3$(290,35)
3546 CM3W$(187,30)=CM3$(191,30)
3548 CM3W$(217,30)=CM3$(221,30)
3550 CM3W$(247,16)=CM3$(251,16)
3552 CM3W$(263,2)=CM3$(267,2)
3554 CM3W$(265,9)=CM3$(269,9)
3556 CM3W$(274,8)=CM3$(92,8)
3558 CM3W$(282,20)=CM3$(100,15)
3560 CM3W$(302,8)=FNYMD$(CM3$(86,6))
3562 CM3W$(310,8)=FNYMD$(CM3$(116,6))
3564 CM3W$(318,8)=FNYMD$(CM3$(180,6))
3566 CM3W$(326,15)=STP(UCS(STP(WAR2$(3,15),1)),0); REM TERMS CODE DESC
3568 CM3W$(341,4)=CM3$(133,4)
3570 CM3W$(345,3)=OWNER$; IF OWNER$="509" THEN CM3W$(345,3)="434"
3572 CM3W$(348,10)=STR(CM3[9]-CM3[8]-CM3[6]-CM3[4]-CM3[2]:"-000000.00")
3574 CM3W$(358,10)=STR(CM3[2]:"-000000.00")
3576 CM3W$(368,10)=STR(CM3[4]:"-000000.00")
3578 CM3W$(378,10)=STR(CM3[6]:"-000000.00")
3580 CM3W$(388,10)=STR(CM3[8]:"-000000.00")
3582 CM3W$(398,10)=STR(CM3[9]:"-000000.00")
3590 PRINT (FWRK)CM3W$
3600 IF POS(WAR1$(1,10)=USEDAR1$,10)>0 THEN GOTO 3510
3610 USEDAR1$=USEDAR1$+WAR1$(1,10)
3615 IF WAR1$(359,2)="  " THEN WAR1$(359,2)="30"; REM "Set Default"
3620 READ (FAR2,KEY=WAR1$(359,2))WAR2$
3630 AR1W$(1,3)="AR1"
3632 AR1W$(4,10)=WAR1$(1,10)
3634 AR1W$(14,35)=WAR1$(11,35)
3636 AR1W$(49,30)=WAR1$(56,30)
3638 AR1W$(79,30)=WAR1$(86,30)
3640 AR1W$(109,16)=WAR1$(116,16)
3642 AR1W$(125,2)=WAR1$(132,2)
3644 AR1W$(127,9)=WAR1$(134,9)
3646 AR1W$(136,10)=WAR1$(205,10)
3648 AR1W$(146,10)=WAR1$(143,10)
3650 AR1W$(156,20)=WAR1$(165,20)
3652 AR1W$(176,8)=FNYMD$(WAR1$(229,6))
3654 AR1W$(184,10)=WAR1$(235,10)
3656 AR1W$(194,6)=""; REM "Sales Tax %"
3658 AR1W$(200,1)=WAR1$(245,1)
3660 AR1W$(201,4)=WAR1$(278,4)
3662 AR1W$(205,15)=STP(UCS(STP(WAR2$(3,15),1)),0); REM TERMS CODE DESC
3664 AR1W$(220,3)=WAR1$(431,3); IF OWNER$="509" THEN AR1W$(220,3)="434"
3666 AR1W$(223,10)=STR(AR1W[5]:"-000000.00")
3670 PRINT (FWRK)AR1W$
3680 GOTO 3510
3699 RETURN 
9000 REM "ERROR PROCESSING
9005 ! IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9900 ! End Program
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 EXIT 
9999 END 
30000 REM "PRINTNET APD
30020 APD$(104,4)="2701"
30030 APD$(62,2)="Q6"
30040 APD[9]=APD[1]-APD[2]-APD[3]
30999 RETURN 
31000 REM "PRINTNET AR1
31020 AR1$(1,2)="Q6"
31030 AR1$(431,3)="270"
31040 IF AR1$(359,2)<>"  " THEN Z=POS(AR1$(359,2)=PNT_TRM$,2); IF Z=0 THEN GOTO 31050 ELSE AR1$(359,2)=PFG_TRM$(Z,2)
31050 IF AR1$(278,4)<>"    " THEN Z=POS(AR1$(278,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 31060 ELSE AR1$(278,4)=PFG_SLS$(Z,4)
31060 IF AR1$(282,4)<>"    " THEN Z=POS(AR1$(282,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 31070 ELSE AR1$(282,4)=PFG_SLS$(Z,4)
31070 IF AR1$(286,4)<>"    " THEN Z=POS(AR1$(286,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 31080 ELSE AR1$(286,4)=PFG_SLS$(Z,4)
31080 IF AR1$(290,4)<>"    " THEN Z=POS(AR1$(290,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 31090 ELSE AR1$(290,4)=PFG_SLS$(Z,4)
31090 IF AR1$(294,4)<>"    " THEN Z=POS(AR1$(294,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 31100 ELSE AR1$(294,4)=PFG_SLS$(Z,4)
31999 RETURN 
32000 REM "PRINTNET CM3
32020 CM3$(15,2)="Q6",CM3$(92,2)="Q6",CM3$(338,4)="2701"
32040 IF CM3$(65,2)<>"  " THEN Z=POS(CM3$(65,2)=PNT_TRM$,2); IF Z=0 THEN GOTO 32050 ELSE CM3$(65,2)=PFG_TRM$(Z,2)
32050 IF CM3$(133,4)<>"    " THEN Z=POS(CM3$(133,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 32060 ELSE CM3$(133,4)=PFG_SLS$(Z,4)
32060 IF CM3$(137,4)<>"    " THEN Z=POS(CM3$(137,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 32070 ELSE CM3$(137,4)=PFG_SLS$(Z,4)
32070 IF CM3$(141,4)<>"    " THEN Z=POS(CM3$(141,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 32080 ELSE CM3$(141,4)=PFG_SLS$(Z,4)
32080 IF CM3$(145,4)<>"    " THEN Z=POS(CM3$(145,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 32090 ELSE CM3$(145,4)=PFG_SLS$(Z,4)
32090 IF CM3$(149,4)<>"    " THEN Z=POS(CM3$(149,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 32100 ELSE CM3$(149,4)=PFG_SLS$(Z,4)
32999 RETURN 
33000 REM "PRINTNET AR3
33020 Z=POS(AR3$(1,4)=PNT_SLS$,4); IF Z=0 THEN GOTO 33050 ELSE AR3$(1,4)=PFG_SLS$(Z,4); GOTO 33100
33050 AR3$(1,4)="Q6"+AR3$(1,2)
33999 RETURN 
