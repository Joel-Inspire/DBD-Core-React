0010 REM "Credit Card Processing Plus - message lines <AR2EAT>
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 02/28/18 - 18.510555 - crg - SSP# 298991
0037 REM "298991-Program exception trying to run credit card processing      
0038 REM "Mod 5/25/93 for req charges cost codes in art(113,9)
0040 REM "Copyright 2018 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0085 SETERR 0090; ENTER X3$,X4$,Q0$,Q1$
0090 L$="Y"
0100 SETERR 9000
0110 X0$="AR2EPT",X1$="A/R Invoice Message Lines",K9$="",K9=0
0120 DIM H$(33),H[1],Y[4],A[30]
0130 DIM SPACE$(40," ")
0140 Z6$="##,###,###.00-"
0230 X2=-1
0235 IF L$="Y" THEN GOTO 0241
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2; IF X1>0 THEN GOTO 9920
0290 IOLIST Y[0],Y[1],Y[2],Y[3],Y[4]
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14],A[15],A[16],A[17],A[18],A[19],A[20],A[21],A[22],A[23],A[24],A[25],A[26],A[27],A[28],A[29],A[30]
0320 IOLIST B$,B[0],B[1],B[2],B[3],B[4],B[5],B[6],B[7],B[8],B[9],B[10],B[11],B[12],B[13],B[14],B[15],B[16],B[17],B[18],B[19],B[20],B[21]
0330 IOLIST C$,C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8],C[9]
0331 IOLIST C$,C[0],STR(C[1]),C[2],C[3],C[4],C[5],STR(C[6]),C[7],C[8],C[9]
0340 IOLIST H$,H[0],H[1],H[2],H[3],H[4],H[5],H[6],H[7],H[8],H[9],H[10],H[11],H[12],H[13],H[14],H[15]
0341 IOLIST D$
0350 IOLIST A9,E$,E[0],E[1],STR(E[2]),STR(E[3]),E[4],E[5],E[6],E[7],E[8],E[9],E[10],E[11],E[12],E[13],E[14],E[15],E[16],E[17],E[18],E[19],E[20]
0351 IOLIST A9,E$,E[0],E[1],E[2],E[3],E[4],E[5],E[6],E[7],E[8],E[9],E[10],E[11],E[12],E[13],E[14],E[15],E[16],E[17],E[18],E[19],E[20]
0360 IOLIST F$
0365 IOLIST F$,F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8],F[9],F[10]
0370 IOLIST S$(1),S[0],S[1],S[2],S[3]
0380 IOLIST ICF$,ICF[0],ICF[1],ICF[2],ICF[3],ICF[4],ICF[5],ICF[6],ICF[7],ICF[8]
0390 IOLIST O$,O0
0400 IOLIST J$
0401 IOLIST J$,J[0],J[1],J[2],J[3],J[4],J[5],J[6],J[7],J[8],J[9],J[10],J[11],J[12],J[13],J[14],J[15],J[16],J[17],J[18],J[19],J[20]
0410 IOLIST I$,I[0],I[1],I[2],I[3],I[4],I[5],I[6],I[7],I[8],I[9],I[10],I[11],I[12],I[13],I[14],I[15],I[16],I[17],I[18],I[19],I[20]
0420 IOLIST SM7$,SM7[0],SM7[1],SM7[2],SM7[3],SM7[4],SM7[5],SM7[6],SM7[7],SM7[8],SM7[9],SM7[10],SM7[11],SM7[12]
0500 REM "FILES
0501 IF L$<>"Y" THEN PRINT @(25,22),"Invoice message lines when credit card terms code",
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01O ARB...  05O ART...  08O EDD... 09O FS1...  13O ZZPARM  "
0511 IF %ACTION$="C" THEN Z$="01O GRB...  05O GRT...  08O EDD... 09O FS1...  13O ZZPARM  "
0515 DIM P9[5]; CLOSE (14); OPEN (14)"ZZPARM"; FIND (14,KEY=X3$(9,3)+"F/M")P9$,*,*,P9[0],P9[1],P9[2],P9[3]; CLOSE (14); IF P9$(22,1)="Y" THEN Z$=Z$+"10O FW0...  " ELSE Z$=Z$+"10O FM1...  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0530 F=Z[5],Y9=2
0550 DIM M6[1]; CALL "IC2PRE",X3$,Z[13],"",M6{ALL},"",0,"",0
0560 FIND (Z[13],KEY=X3$(9,3)+"F/M")P0$
0570 FIND (Z[13],KEY=X3$(9,3)+"AR1")P8$
0575 FIND (Z[13],KEY=X3$(9,3)+"A/R")ARS$
0580 GB$=""; FIND (Z[13],KEY=X3$(9,3)+"G/B",DOM=0581)GB$
0589 DIM CIG$(15); FIND (Z[13],KEY=X3$(9,3)+"SMP",DOM=0590)CIG$; REM " SSP# 145492
0590 DIM E$(289),E[20]
0900 ! 
0910 DIM A[30]; EXTRACT (Z[1],KEY=Q1$,DOM=9900)IOL=0310
0920 IF A[20]>0 THEN GOSUB 8800
0960 DIM O$(168); FIND (Z[9],KEY=A$(92,8),DOM=0961)IOL=0390
1000 REM "
1104 GOSUB 7100; REM " CREDIT CARD MESSAGES
1108 GOSUB 3000
1110 IF A[20]<=0 THEN {
1111 A[20]=A0
1120 WRITE (Z[1],KEY=Q1$)IOL=0310
1125 EXTRACT (Z[1],KEY=Q1$,DOM=1126)
1130  }
1190 GOTO 9700
1500 REM "CHECK FOR AUTO REQ CHARGES
1595 RETURN 
1800 REM "Default line
2095 RETURN 
2100 REM "Write out prev line
2110 GOSUB 5200
2115 GOSUB 3000
2120 A=A9,A9=0
2140 RETURN 
2500 REM 
2590 RETURN 
2600 REM 
2985 RETURN 
3000 REM "Write out line to index A, A9 is assumed to point to next line
3005 IF A<=0 THEN GOTO 3090
3010 WRITE (F,IND=A)IOL=0350
3090 RETURN 
3100 REM 
4540 RETURN 
4900 REM "END OF LINES
4910 Y[4]=-1; WRITE (F,IND=0)IOL=0290
4920 CALL "ZZEXPF",X3$,X4$,"X"+STR(F),"",G9; IF G9>0 THEN GOTO 5230
4925 EXTRACT (F,IND=0)IOL=0290
4930 Z=NUM(FIN(F,"MAXREC")); Y[3]=Z-1
4935 Y[4]=-2; WRITE (F,IND=0)IOL=0290
4980 GOTO 5230
5000 REM 
5040 RETURN 
5200 REM "GET NEXT INDEX TO FILE IN A9
5210 EXTRACT (F,IND=0,ERR=5295)IOL=0290
5215 IF Y[4]=-2 THEN READ (F); WAIT 0; GOTO 5210
5220 Y[4]=-2; WRITE (F,IND=0)IOL=0290
5230 IF Y[1]<1 THEN A9=Y[2],Y[2]=Y[2]+1; GOTO 5260
5255 A9=Y[1]; READ (F,IND=A9)Y[1]
5260 IF Y[0]<Y[3]-1 THEN Y[0]=Y[0]+1,Y[4]=-1 ELSE Y[4]=-1; GOTO 4900
5280 WRITE (F,IND=0)IOL=0290
5281 IF A0=0 THEN A0=A9
5290 RETURN 
5295 IF ERR<>0 THEN GOTO 9000 ELSE RETRY 
5300 REM "REMOVE INDEX Z
5390 RETURN 
5395 ON ERR GOTO 5310,5311,9000
5400 REM " IF CIG PLUS CHECK FOR TRACKING NUMBER SSP# 145492
7090 RETURN 
7100 REM "Add Message if paid by credit card
7102 IF POS("Y"=ARS$(241,1))=0 THEN RETURN 
7205 ! If credit card processing is completed, a processed EDD record for invoice will exist
7210 ENTRY_EXISTS=0
7215 IF A$(420,1)="Y" THEN CALL "UPDEDD;GET_LAST_INVOICE_ENTRY",Z[8],A$(92,2),A$(94,6),A$(7,8),CC$,CC{ALL},ENTRY_EXISTS
7220 IF ENTRY_EXISTS=0 THEN GOTO 7395 ! No processed EDD record for invoice yet
7221 CARD$=PAD(STP(CC$(16,20),2),16) ! 298991 - Last 4 may not be populated, for cc vault users
7225 IF CC$(119,1)<>"A" THEN GOTO 7292
7230 ! Message Line 1 - Optional credit card payment custom message
7235 IF ARS$(136,40)=DIM(40) THEN GOTO 7258
7240 GOSUB 2100
7245 DIM E$(289),E[20]; E$(6,1)="Y",E$(1,1)="M"
7250 IF %ACTION$="C" THEN E$(6,1)="C" ELSE IF %ACTION$="I" THEN E$(6,1)="Y"
7255 E$(7,40)=ARS$(136,40),E$(47,3)="   "
7260 ! Message Line 2 - Approval code (if CC Plus module and card was successfully charged)
7265 GOSUB 2100
7270 DIM E$(289),E[20]; E$(6,1)="Y",E$(1,1)="M"
7275 IF %ACTION$="C" THEN E$(6,1)="C" ELSE IF %ACTION$="I" THEN E$(6,1)="Y"
7280 E$(7,40)=CC$(12,4)+" ********"+CARD$(LEN(CARD$)-3,4)+". Approval code:"+STP(MID(CC$(88,30),1,15),2),E$(47,3)="   "
7285 GOTO 7395
7290 ! Message line when "Card Declined"
7292 GOSUB 2100
7294 DIM E$(289),E[20]; E$(6,1)="Y",E$(1,1)="M"
7296 IF %ACTION$="C" THEN E$(6,1)="C" ELSE IF %ACTION$="I" THEN E$(6,1)="Y"
7298 E$(7,40)="Card "+CC$(12,4)+" ********"+CARD$(LEN(CARD$)-3,4)+" was declined.",E$(47,3)="   "
7395 RETURN 
8800 REM "Position pointer to last link
8805 Z=A[20]
8815 IF Z<=0 THEN GOTO 8840 ELSE READ (F,IND=Z)IOL=0351
8830 IF A9>0 THEN Z=A9; GOTO 8815
8840 A=Z,A9=0
8850 RETURN 
8900 REM "Functions
8910 DEF FNS$(Z9$)=Z9$(1,POS("   "=Z9$+"   ")-1)
8915 DEF FNR$(Z9$)=Z9$(POS(" "<>Z9$)+POS("         "=Z9$))
8950 REM "Program flow logic
8960 DIM U0$(6); U0$(1)=FID(0),U0$=U0$+"PF"; CLOSE (14); OPEN (14)"ZZPARM"
8970 FIND (14,KEY=U0$,DOM=8990)U0$,U1$
8975 IF U1$="" THEN RETURN 
8980 Q1=NUM(U1$(7,2)),Q1$=U1$(9,Q1),U1$=U1$(Q1+9)
8984 IF LEN(Q1$)=20 THEN Q1$=Q1$(1,14)
8990 RETURN 
9000 REM "ERROR PROCESSING
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9050 ON Y7 GOTO 9060,9100,9900,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9190 GOTO 9900
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9700 REM "PROG FLOW
9800 REM "EXIT PROGRAM
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9920 IF L$="Y" THEN SETERR 9921; EXIT 
9999 END 
56000 REM "189822-Credit Card Processing for webec back orders filled
