0010 REM "File Read/Write/Delete for index/direct file conversion <AR2XAB>
0035 REM "5.7 - 02/02/23 - 17.208274 - crg - SSP# 307435
0037 REM "307435-DBD-337: Capture/store notes with Cash Receipts             
0040 REM "Copyright 2023 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 DIM DET[1],Y[4],J[1],B[1],A[14],DET_1$(48)
0100 SETERR 9000; SETESC 9300
0120 ENTER X3$,X4$,FILE_ID,INV$,IND_USED,DETAIL$,DET{ALL},FLAG$,SEQ$,RWD$
0190 REM " FILE_ID=Indexed file,INV$=Invoice record for read on direct file,IND_USED index for next for indexed file, DETAIL$=return string for transaction, DET(ALL)= numerics for transaction,FLAG$=END is last in chain NONE= no detail found,SEQ$=sequence for direct file,RWD$=R read, W write, D delete
0200 X0$="AR2XAB"
0290 IOLIST Y[0],Y[1],Y[2],Y[3],Y[4]
0309 REM "iolist for direct file
0310 IOLIST DETAIL$,DET[0],DET[1]
0319 REM "iolist for indexed file
0320 IOLIST IND_USED,DETAIL$,DET[0],DET[1]
0330 IOLIST B0,B$,B[0],B[1]
0335 IOLIST B$,B(0),B(1)
0339 REM "Iolist for read on AR6 for conversion progS
0340 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14]
0345 REM "Iolist for API for conversion programs
0350 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14],A[15],A[16],A[17],A[18],A[19],A[20],A[21],A[22],A[23],A[24],A[25],A[26],A[27]
0360 IOLIST J0,J$,J[0],J[1]
0400 CALL "ZZINFO",FILE_ID,STATUS,X3$,REC_USED,TOT_REC,KEY_SZ,BYTE,DISC,TYPE,TOT_SEC,FILE_NM$
0505 Z=NUM(X3$(60,3)); DIM Z[Z]
0600 FID$=FN%FID$(FILE_ID),FILE_NAME$=FID$(4,3),INV=18,DIM_1=14 ! [205703]-changed FID() to FN%FID$()
0610 IF FILE_NAME$="APJ" THEN DIM DET_1$(57); INV=20,DIM_1=27
0620 IF HTA(FID$(10,1))="00" THEN KEY_SZ=0 ! SSP#303555
0900 ON KEY_SZ GOTO 4000,1000
1000 REM "Handle Read/Write/Delete of a file that is direct
1010 ON POS(RWD$="RWD",1) GOTO 1020,1020,2000,3000
1020 IF POS(X3$(146,6)="AR2RASARGRAS",6)<>0 AND DETAIL$<>"" THEN F9=1 ELSE F9=0 ! SSP#255115
1025 IF DETAIL$<>"" THEN GOTO 1050
1040 READ (FILE_ID,KEY=INV$(1,INV),DOM=1041)
1050 READ (FILE_ID,END=1190)IOL=0310
1060 IF DETAIL$(1,INV)<>INV$(1,INV) THEN GOTO 1190
1070 IF MID(RWD$,2,1)="H" AND FILE_NAME$="AR7" AND MID(DETAIL$,49,1)<>"H" THEN GOTO 1050 ELSE IF MID(RWD$,2,1)="H" AND FILE_NAME$="APJ" AND MID(DETAIL$,58,1)<>"H" THEN GOTO 1050 ELSE IF MID(RWD$,2,1)<>"H" AND FILE_NAME$="AR7" AND MID(DETAIL$,49,1)="H" THEN GOTO 1050 ELSE IF MID(RWD$,2,1)<>"H" AND FILE_NAME$="APJ" AND MID(DETAIL$,58,1)="H" THEN GOTO 1050; REM "SSP#209664
1090 GOTO 9900
1190 IF F9=1 THEN FLAG$="END" ELSE FLAG$="NONE"
1195 GOTO 9900
2000 REM "Write for direct files
2005 IF FILE_NAME$="APJ" THEN DIM DET_1$(80) ELSE DIM DET_1$(70); REM "SSP#209664
2010 IF FILE_NAME$="APJ" THEN KEY$=DETAIL$(1,20)+DETAIL$(36,1)+DETAIL$(49,6)+STR(NUM(SEQ$):"000"),DET_1$(1)=DETAIL$,DET_1$(55,3)=STR(NUM(SEQ$):"000"),DETAIL$=DET_1$,KEY=30 ELSE KEY$=DETAIL$(1,KEY_SZ-3)+STR(NUM(SEQ$):"000"),DET_1$(1)=DETAIL$,DET_1$(46,3)=STR(NUM(SEQ$):"000"),DETAIL$=DET_1$,KEY=28
2020 IF FLAG$="ADD" THEN GOSUB 5400; IF DET(0)=0 AND DET(1)=0 THEN GOTO 2190
2030 WRITE (FILE_ID,KEY=KEY$,DOM=2100)IOL=0310; IF FILE_NAME$="AR7" THEN CALL "ARGAT8;UPDATE_INVTRANS_INFO",MID(DETAIL$,50,5),DETAIL$ END_IF ; GOTO 2190 ! 307435
2100 REM "Duplicate Key - program IC2LCC is really generic program to find next available seq counter
2120 KEY_1$=KEY$; CALL "IC2LCC",X3$,X4$,FILE_ID,KEY+1-3,3,LAST_ONE$,KEY_1$; KEY$=KEY_1$(1,LEN(KEY$)); IF FILE_NAME$="APJ" THEN DETAIL$(55,3)=KEY$(26,3) ELSE DETAIL$(46,3)=KEY$(26,3) ! SSP#236958
2130 GOTO 2020
2190 GOTO 9900
3000 REM "Remove lines for direct files
3010 READ (FILE_ID,KEY=INV$(1,INV),DOM=3011)
3020 KEY$=KEY(FILE_ID,END=3090); READ (FILE_ID,KEY=KEY$)IOL=0310
3030 IF DETAIL$(1,INV)<>INV$(1,INV) THEN GOTO 3090
3040 IF MID(RWD$,2,1)="H" AND FILE_NAME$="AR7" AND MID(DETAIL$,49,1)<>"H" THEN GOTO 3020 ELSE IF MID(RWD$,2,1)="H" AND FILE_NAME$="APJ" AND MID(DETAIL$,58,1)<>"H" THEN GOTO 3020 ELSE IF MID(RWD$,2,1)<>"H" AND FILE_NAME$="AR7" AND MID(DETAIL$,49,1)="H" THEN GOTO 3020 ELSE IF MID(RWD$,2,1)<>"H" AND FILE_NAME$="APJ" AND MID(DETAIL$,58,1)="H" THEN GOTO 3020; REM "SSP#296515
3045 ! IF MID(RWD$,2,1)="H" AND FILE_NAME$="APJ" AND MID(DETAIL$,58,1)<>"H" THEN GOTO 3020 ELSE IF MID(RWD$,2,1)="H" AND FILE_NAME$="AR7" AND MID(DETAIL$,49,1)<>"H" THEN GOTO 3020 ! SSP#209664!ssp#296515
3050 REMOVE (FILE_ID,KEY=KEY$,DOM=3060)
3060 GOTO 3020
3090 GOTO 9900
4000 REM "Handle Read/Write/Delete of an indexed file
4010 ON POS(RWD$="RWD",1) GOTO 4020,4020,5000,6000
4030 IF IND_USED<=0 THEN FLAG$="NONE"; GOTO 9900
4040 READ (FILE_ID,IND=IND_USED)IOL=0320
4050 IF IND_USED<=0 THEN FLAG$="END"
4090 GOTO 9900
5000 REM "Write lines to the indexed file
5010 GOSUB 5200
5020 IF IND_USED=0 THEN IND_USED=IND_NEXT; GOTO 5100 ELSE J0=IND_USED
5030 J1=J0; READ (FILE_ID,IND=J0)IOL=0360; IF J0>0 THEN GOTO 5030
5040 J0=IND_NEXT; IF J1>0 THEN WRITE (FILE_ID,IND=J1)IOL=0360
5100 DIM J[1]; J$=DETAIL$,J[0]=DET[0],J[1]=DET[1]
5110 J0=0; WRITE (FILE_ID,IND=IND_NEXT)IOL=0360
5120 IF FILE_NAME$="AR7" THEN CALL "ARGAT8;UPDATE_INVTRANS_INFO",MID(J$,50,5),J$; GOTO 2190 ! 307435
5190 GOTO 9900
5200 REM "Get next index to use
5205 IF FLAG$="ADD" THEN GOSUB 5300; IF DET[0]=0 THEN EXITTO 9900
5210 EXTRACT (FILE_ID,IND=0,ERR=5270)IOL=0290
5212 IF Y[4]=-2 THEN READ (FILE_ID); GOTO 5270
5215 IF Y[0]>=Y[3] OR Y[2]>=Y[3] THEN GOTO 5900 ELSE Y[4]=-2
5220 WRITE (FILE_ID,IND=0)IOL=0290
5230 IF Y[1]<1 THEN IND_NEXT=Y[2],Y[2]=Y[2]+1 ELSE IND_NEXT=Y[1]; READ (FILE_ID,IND=IND_NEXT)Y[1]
5240 Y[0]=Y[0]+1,Y[4]=-1
5250 WRITE (FILE_ID,IND=0)IOL=0290
5260 RETURN 
5270 LOCK (FILE_ID,ERR=5210); Y[4]=-1; GOTO 5215
5300 REM "Read for existing transactions and add them up,used during auto gen AR2UTD
5310 TOT=0,B0=IND_USED; DIM B[1],A[DIM_1]
5315 IF FILE_NAME$="APJ" THEN FILE_NAME_2$="API" ELSE FILE_NAME_2$="AR6"
5320 Z$="02O "+FILE_NAME_2$+"...  "; GOSUB 9750
5330 IF FILE_NAME$="AR7" THEN READ (Z[2],KEY=INV$(1,INV))IOL=0340 ELSE IF FILE_NAME$="APJ" THEN READ (Z(2),KEY=INV$(1,INV))IOL=0350
5340 IF B0<=0 THEN GOTO 5385
5345 B1=B0
5350 READ (FILE_ID,IND=B1)IOL=0330
5360 IF LEN(B$)<45 THEN B1=0,TOT=0; GOTO 5385
5370 TOT=TOT+B[0]
5380 GOTO 5340
5385 IF FILE_NAME$="AR7" THEN DET[0]=A[3]-A[6]-TOT ELSE IF FILE_NAME$="APJ" THEN DET(0)=A(13)-A(10)-TOT
5390 RETURN 
5400 REM "utility for direct file
5410 TOT=0; DIM B(1),A(DIM_1)
5415 IF FILE_NAME$="APJ" THEN FILE_NAME_2$="API" ELSE FILE_NAME_2$="AR6"
5420 Z$="02O "+FILE_NAME_2$+"...  "; GOSUB 9750
5430 IF FILE_NAME$="AR7" THEN READ (Z[2],KEY=INV$(1,INV))IOL=0340 ELSE IF FILE_NAME$="APJ" THEN READ (Z(2),KEY=INV$(1,INV))IOL=0350
5440 READ (FILE_ID,KEY=INV$(1,INV),DOM=5450)
5450 READ (FILE_ID,END=5485)IOL=0335
5460 IF B$(1,INV)<>INV$(1,INV) THEN GOTO 5485
5465 TOT=TOT+B[0]
5470 GOTO 5450
5485 IF FILE_NAME$="AR7" THEN DET[0]=A[3]-A[6]-TOT ELSE IF FILE_NAME$="APJ" THEN DET(0)=A(13)-A(10)-TOT
5490 RETURN 
5910 CALL "ZZEXPF",X3$,X4$,"X"+STR(FILE_ID),"",G9; IF G9>0 THEN GOTO 9800
5920 CALL "ZZINFO",FILE_ID,X0,X3$,0,Z,0,0,0,0,0,""; Y[3]=Z-1
5930 GOTO 5215
6000 REM "Remove lines for indexed files
6010 IF IND_USED=0 THEN GOTO 6090 ELSE Y5$=""
6020 EXTRACT (FILE_ID,IND=0,ERR=6060)IOL=0290
6030 A1=Y[1],Y[1]=IND_USED,Y[0]=Y[0]-1
6035 READ (FILE_ID,IND=IND_USED)A; IF A>0 THEN Y[0]=Y[0]-1,IND_USED=A; IF POS(BIN(A,3)=Y5$,3)=0 THEN Y5$=Y5$+BIN(A,3); GOTO 6035
6040 WRITE (FILE_ID,IND=IND_USED)A1
6050 Y[4]=-1; WRITE (FILE_ID,IND=0)IOL=0290
6055 GOTO 6090
6060 IF ERR=0 THEN RETRY ELSE GOTO 9000
6090 GOTO 9900
9000 REM "ERROR PROCESSING
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9050 ON Y7 GOTO 9060,9100,9900,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9110 GOTO 7000
9180 GOTO 1000
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9505 GOTO 6500
9510 SETERR 9000; GOSUB 6500
9520 ON C9 GOTO 1140,2040
9750 REM 
9760 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0
9770 RETURN 
9900 REM "END PROGRAM
9910 IF FLAG$="ADD" AND KEY_SZ=0 THEN CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9920 SETERR 9940
9930 EXIT 
9940 BEGIN ; SETESC 9350
9950 RUN "ZMENU"
9999 END 
56000 REM + Modification History
56002 REM "205703-Oracle - FID and FIB calls, replace with FN%FID$ and FN%FIB$
56003 REM "REM "209664-Cust# 03-BRINK showing inv #'s from C/R 2002 are pulling in
56004 REM "303555-Exception in AR2XAB during AP Period end processing         
56005 REM "307435-DBD-337: Capture/store notes with Cash Receipts             
