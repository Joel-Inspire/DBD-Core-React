0010 REM "Alternate Sales Tax Update <AR2XBC>
0035 REM "5.2 - 03/02/04 - 10.792222 - lms - SSP# 167214
0040 REM "Copyright 2004 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 REM "Extensive program changes on ssp#90808 for multiple tax codes per invoice, see 3000's routine for further info
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,Q0$,Q1$
0100 SETERR 9000
0110 X0$="AR2XBC"
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7],A[8],A[9],A[10],A[11],A[12],A[13],A[14],A[15],A[16],A[17],A[18],A[19],A[20],A[21],A[22],A[23],A[24],A[25],A[26],A[27],A[28],A[29],A[30]
0320 IOLIST B0,B$,B[0],B[1],B[2],B[3],B[4],B[5],B[6],B[7],B[8],B[9],B[10],B[11],B[12],B[13],B[14],B[15],B[16],B[17],B[18],B[19],B[20]
0330 IOLIST C$,C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8],C[9],C[10],C[11],C[12],C[13],C[14],C[15],C[16],C[17],C[18],C[19],C[20],C[21],C[22],C[23],C[24],C[25]
0340 IOLIST D$
0350 IOLIST ASD$,ASD[0],ASD[1],ASD[2],ASD[3],ASD[4],ASD[5],ASD[6],ASD[7],ASD[8],ASD[9],ASD[10],ASD[11],ASD[12]
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01L ARB...  02O ART...  03O AS3...  04O AR5...  05O AR1...  06O ASD...  13O ZZPARM"
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0900 DIM A[30],B[20],C[25],ASD[12]
0920 PRINT @(0,14),'CL',"Updating Alternate Sales Tax File:",
1000 REM "READ NEXT RECORD
1020 READ (Z[1],KEY="",DOM=1021)
1100 READ (Z[1],END=5000)IOL=0310; B0=A[20]
1120 PRINT @(45,14),A$(7,8),"   ",A$(92,8),
1220 GOSUB 3000
1240 IF B0=0 AND A[1]<>0 THEN GOSUB 4000
1300 IF B0>0 THEN READ (Z[2],IND=B0)IOL=0320 ELSE GOTO 1600
1400 GOSUB 2000
1500 GOTO 1300
1600 REM "EOL
1700 GOSUB 3200
1990 GOTO 1100
2000 REM "NEW LINE
2020 IF B[4]=0 THEN GOTO 2990
2100 IF B$(54,1)="C" THEN I0=1; GOTO 2800
2120 IF B$(54,1)="Y" AND B$(2,1)="Y" THEN I0=7; GOTO 2800
2140 IF B$(54,1)="Y" THEN I0=4; GOTO 2800
2200 REM "NON TAXABLE
2220 IF B$(2,1)="Y" THEN I0=10; GOTO 2800
2240 I0=13
2800 REM 
2810 GOSUB 7500
2990 RETURN 
3000 REM "NEW INVOICE
3005 REM "This routine used to set up the AS3 record from the ARB info and write out one record per invoice, changed this on ssp#90808 to read the ASD file for all the different tax codes for this invoice and call ZZRCAP to keep all the AS3 records until we are done reading all the ART lines and then retrieve the AS3 records and write them out. If we don't have any ASD records (not sure if this can happen) we will do it the old way.
3010 COMMAND_LIST$="I",KEY_SIZE=26,NUM_BUCKETS=25,AS3_KEY$="",AS3$="",TMP$="",RETURN_CODE=0,F1$="N"; DIM AS3[25],TMP2$[1],TMP[1],TMP3$[1],C$(53),C[25]
3015 CALL "ZZRCAP",X3$,X4$,COMMAND_LIST$,KEY_SIZE,NUM_BUCKETS,AS3_KEY$,AS3$,AS3{ALL},TMP$,TMP2${ALL},TMP{ALL},TMP3${ALL},RETURN_CODE
3030 READ (Z[6],KEY=A$(1,14),DOM=3031)
3035 READ (Z[6],END=3150)IOL=0350
3040 IF ASD$(1,14)<>A$(1,14) THEN GOTO 3150
3050 DIM AS3$(53),AS3[25]; F1$="Y"
3060 IF F1$="Y" THEN AS3$(1,6)=A$(1,6),AS3$(17,8)=A$(7,8),AS3$(27,10)=A$(15,10),AS3$(37,6)=A$(86,6) ELSE C$(1,6)=A$(1,6),C$(17,8)=A$(7,8),C$(27,10)=A$(15,10),C$(37,6)=A$(86,6)
3065 FIND (Z[5],KEY=A$(15,10),DOM=3070)J$
3066 IF POS(" "<>J$(46,10))<>0 THEN IF F1$="Y" THEN AS3$(27,10)=J$(46,10) ELSE C$(27,10)=J$(46,10)
3070 IF F1$="Y" THEN AS3[0]=A[1],AS3[16]=ASD[4],AS3[17]=ASD[6],AS3[18]=ASD[8],AS3[19]=ASD[3],AS3[20]=ASD[5],AS3[21]=ASD[7] ELSE C[0]=A[1],C[16]=A[4],C[17]=A[6],C[18]=A[8],C[19]=A[3],C[20]=A[5],C[21]=A[7]
3080 IF F1$="Y" THEN AS3$(7,10)=ASD$(15,10) ELSE C$(7,10)=A$(67,10)
3085 IF F1$="N" THEN GOTO 3190
3090 AS3_KEY$=AS3$(1,26)
3100 COMMAND_LIST$="A"
3110 CALL "ZZRCAP",X3$,X4$,COMMAND_LIST$,KEY_SIZE,NUM_BUCKETS,AS3_KEY$,AS3$,AS3{ALL},TMP$,TMP2${ALL},TMP{ALL},TMP3${ALL},RETURN_CODE
3130 GOTO 3035
3150 IF F1$="Y" THEN GOTO 3190 ELSE GOTO 3060
3190 RETURN 
3200 REM "END OF INVOICE
3220 IF A[2]=0 THEN GOTO 3300
3230 IF A$(115,1)="Y" THEN I0=10; GOTO 3280 ELSE DIM D$(36); D$(36,1)="Y"
3240 FIND (Z[4],KEY=A$(67,10),DOM=3241)IOL=0340
3260 IF D$(36,1)="Y" THEN I0=7 ELSE I0=10
3280 IF F1$="Y" THEN B$(125,10)=A$(67,10)
3290 B[4]=A[2]; GOSUB 7500
3300 REM "Update File
3320 GOSUB 3400
3340 RETURN 
3400 REM "Retrieve AS3 records using ZZRCAP for this invoice if F1$="Y"
3410 IF F1$="N" THEN GOTO 3500
3420 C=0
3425 DIM AS3_KEY$(26),AS3$(53),AS3[25]
3430 COMMAND_LIST$="R,"+STR(C),RETURN_CODE=0
3435 CALL "ZZRCAP",X3$,X4$,COMMAND_LIST$,KEY_SIZE,NUM_BUCKETS,AS3_KEY$,AS3$,AS3{ALL},TMP$,TMP2${ALL},TMP{ALL},TMP3${ALL},RETURN_CODE
3440 IF RETURN_CODE=1 THEN GOTO 3590; REM "We've got all the records for this invoice
3450 DIM C$(53),C[25]
3455 C$=AS3$
3460 FOR X=0 TO 25; C[X]=AS3[X]; NEXT X
3500 REM "Update Alternate Sales Tax File
3520 WRITE (Z[3],DOM=3521,KEY=C$(1,26))IOL=0330; GOTO 3585
3530 IF NUM(C$(25,2))<99 THEN C$(25,2)=STR(NUM(C$(25,2))+1:"00"); GOTO 3520
3540 DIM L[25]; FOR I=0 TO 25; L[I]=C[I]; NEXT I; L$=C$
3550 EXTRACT (Z[3],KEY=C$(1,26))IOL=0330
3560 FOR I=0 TO 25; C[I]=C[I]+L[I]; NEXT I
3570 C$=L$
3580 WRITE (Z[3])IOL=0330
3585 IF F1$="Y" THEN C=C+1; GOTO 3425
3590 RETURN 
4000 REM "No lines on invoice
4020 IF F1$="Y" THEN DIM AS3[25]; AS3[4]=A[3],AS3[5]=A[5],AS3[6]=A[7],AS3[13]=A[1]-A[3],AS3[14]=A[1]-A[5],AS3[15]=A[1]-A[7] ELSE C[4]=C[19],C[5]=C[20],C[6]=C[21],C[13]=C[0]-C[19],C[14]=C[0]-C[20],C[15]=C[0]-C[21]
4030 IF F1$="Y" THEN AS3_KEY$(7,10)=A$(67,10),COMMAND_LIST$="A",RETURN_CODE=0; CALL "ZZRCAP",X3$,X4$,COMMAND_LIST$,KEY_SIZE,NUM_BUCKETS,AS3_KEY$,AS3$,AS3{ALL},TMP$,TMP2${ALL},TMP{ALL},TMP3${ALL},RETURN_CODE
4040 RETURN 
5000 REM "EOJ
5020 READ (Z[1],KEY="",DOM=5021)
5040 GOTO 9900
7500 REM "Accumulate to Bucket set
7510 DIM AS3[25]
7520 IF F1$="Y" THEN IF POS(" "<>B$(125,2))>0 THEN AS3[I0]=B[4] END_IF ELSE IF POS(" "<>C$(7,2))>0 THEN C[I0]=C[I0]+B[4]
7530 IF F1$="Y" THEN IF POS(" "<>B$(127,4))>0 THEN AS3[I0+1]=B[4] END_IF ELSE IF POS(" "<>C$(9,4))>0 THEN C[I0+1]=C[I0+1]+B[4]
7540 IF F1$="Y" THEN IF POS(" "<>B$(131,4))>0 THEN AS3[I0+2]=B[4] END_IF ELSE IF POS(" "<>C$(13,4))>0 THEN C[I0+2]=C[I0+2]+B[4]
7560 IF F1$="Y" THEN AS3_KEY$(7,10)=B$(125,10),COMMAND_LIST$="A",RETURN_CODE=0; CALL "ZZRCAP",X3$,X4$,COMMAND_LIST$,KEY_SIZE,NUM_BUCKETS,AS3_KEY$,AS3$,AS3{ALL},TMP$,TMP2${ALL},TMP{ALL},TMP3${ALL},RETURN_CODE
7590 RETURN 
9000 REM "ERROR PROCESSING
9010 Y5=ERR,Y6=TCB(5)
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,1
9045 REM 
9050 ON Y7 GOTO 9060,9100,9190,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9190 GOSUB 6600; GOTO 9900
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9700 REM "FILES
9740 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 0521,9900
9790 RETURN 
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9920 PRINT @(0,14),'CL',
9940 EXIT 
9999 END 
