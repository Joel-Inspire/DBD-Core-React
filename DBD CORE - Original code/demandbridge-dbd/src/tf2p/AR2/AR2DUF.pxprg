0010 REM "A/R Order Update Update <AR2DUF>
0020 SETESC 9300; SETERR 9000
0035 REM "5.7 - 09/15/15 - 9.104722 - jvv - SSP# 276772
0037 REM "276772-Multiple Finder's Fees per Customer/Item/Order Line.        
0040 REM "Copyright 2015 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 REM "Finders Fees & Work/Production Orders"
0060 REM "This overlay is only run if AR2DUE detects at least one work order or one order line with a finders fee
0090 IF %GUI THEN CLEAR ELSE BEGIN 
0100 SETERR 9000
0110 X0$="AR2DUF",X1$="Order Update - Phase III"
0120 DIM A[7],B[21],C[5],F[48],I[20],G[1],D[30] ! SSP 249775
0130 DIM FV5[4] ! SSP 276772
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=MNM('GS')+Z0$+MNM('GE')
0300 REM "IOLISTS
0310 IOLIST A$,A[0],A[1],A[2],A[3],A[4],A[5],A[6],A[7]
0320 IOLIST B$,B[0],B[1],B[2],B[3],B[4],B[5],B[6],B[7],B[8],B[9],B[10],B[11],B[12],B[13],B[14],B[15],B[16],B[17],B[18],B[19],B[20],B[21]
0330 IOLIST C$,C[0],C[1],C[2],C[3],C[4],C[5]
0340 IOLIST D$,D[0],D[1],D[2],D[3],D[4],D[5],D[6],D[7],D[8],D[9],D[10],D[11],D[12],D[13],D[14],D[15],D[16],D[17],D[18],D[19],D[20],D[21],D[22],D[23],D[24],D[25],D[26],D[27],D[28],D[29],D[30]
0360 IOLIST A0,F$,F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8],F[9],F[10],F[11],F[12],F[13],F[14],F[15],F[16],F[17],F[18],F[19],F[20],F[21],F[22],F[23],F[24],F[25],F[26],F[27],F[28],F[29],F[30],F[31],F[32],F[33],F[34],F[35],F[36],F[37],F[38],F[39],F[40],F[41],F[42],F[43],F[44],F[45],F[46],F[47],F[48] ! SSP 249775
0380 IOLIST G$,G[0],G[1]
0390 IOLIST I$,I[0],I[1],I[2],I[3],I[4],I[5],I[6],I[7],I[8],I[9],I[10],I[11],I[12],I[13],I[14],I[15],I[16],I[17],I[18],I[19],I[20]
0420 IOLIST L$,L[0],L[1],L[2],L[3],L[4],L[5],L[6],L[7],L[8],L[9],L[10],L[11],L[12],L[13],L[14],L[15],L[16],L[17],L[18],L[19]
0430 IOLIST S$,S[0],S[1]
0450 IOLIST M$,M[0],M[1],M[2],M[3],M[4]
0460 IOLIST FV5$,FV5[0],FV5[1],FV5[2],FV5[2] ! SSP 276772
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01O FS1...  02O FS2...  03L FS3...  04O ARB...  05O IC1...  06O ART...  07O FSK...  08O FW0...  09O FW1...  10O FSG...  11O AR2...  12O FV5...  14O FV7...  " ! SSP 276722
0515 Z$=Z$+"13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0; ON Z0 GOTO 0521,8810
0540 FIND (Z[13],KEY=X3$(9,3)+"F/M")P0$
0545 MFF_PARM=0; IF MID(P0$,337,1)="Y" THEN MFF_PARM=1 ! SSP 276772
0585 RT$=""; CALL "RT2PRM",ERR=0586,X3$,X4$,RT$
0695 PRINT @(29,9),"Invoice      Order    Line"
1000 REM "READ NEXT RECORD
1020 DIM A$(168)
1050 READ (Z[3],KEY="",DOM=1051)
1100 READ (Z[3],END=4000)IOL=0330
1105 IF C$(20,1)<>" " THEN GOTO 1100
1110 PRINT @(29,10),C$(1,8),"   ",C$(9,8),"    ",C$(17,3),
1120 IF C$(9,8)<>A$(118,8) THEN EXTRACT (Z[1],KEY=C$(9,8),DOM=1990)IOL=0310
1140 EXTRACT (Z[2],KEY=C$(9,11),DOM=1990)IOL=0320
1150 IF MFF_PARM THEN GOSUB READ_MFEE; GOTO 1400 ! SSP 276772
1300 IF B$(135,1)<>" " THEN GOSUB 2600
1400 IF A$(43,1)="Y" AND POS(B$(155,1)="ICN")>0 THEN GOSUB 2000
1990 GOTO 1100
2000 REM "Work Order/Production Orders
2010 DIM I$(10); IF B$(155,1)="C" THEN I$=B$(161,10)
2020 EXTRACT (Z[8],DOM=2100,KEY=A$(6,10)+I$+B$(19,10)+C$(9,8))IOL=0380
2040 G[0]=C[0],G[1]=C[1],G$(267,4)=B$(124,4)
2060 IF POS(" "<>B$(189,9))>0 THEN G$(135,9)=B$(189,9); GOSUB 7800
2070 IF C[3]=0 THEN G$(96,3)=""
2080 WRITE (Z[8])IOL=0380
2100 IF C[3]=0 THEN REMOVE (Z[9],DOM=2101,KEY=C$(9,8)+I$+B$(19,10))
2130 IF POS(B$(155,1)="IC")>0 THEN GOSUB 3200; GOSUB 3300
2190 RETURN 
2600 REM "Finders Fee
2610 FIND (Z[4],DOM=2790,KEY=C$(31,6)+C$(1,8))IOL=0340 ! SSP 276772
2612 DIM M$(66),M[4] ! SSP 276772
2618 FTYPE$=B$(135,1),FVEND$=B$(137,10),FRATE=B[11] ! SSP 276772
2620 FEE_UPD:! SSP 276772
2625 DIM M$(66),M[4] ! SSP 276772
2627 IF C(2)=0 AND FTYPE$="A" THEN IF POS(X3$(9,3)="522500",3)=0 THEN GOTO 2790 ELSE M$(66,1)="Y"; REM "Zero balance A types to show up on finders fee report
2630 IF C[2]=0 AND FTYPE$="S" THEN IF POS(X3$(9,3)="125")=0 THEN GOTO 2790 ELSE M$(66,1)="Y"; REM "They want zero S type finder's on report
2635 IF C[2]=0 AND FTYPE$="F" AND POS(X3$(9,3)="531500",3)<>0 THEN M$(66,1)="Y"; REM "147117 they want 0 Fixed types to show up on the report
2640 FIND (Z(11),KEY=D$(65,2),DOM=*NEXT)TERM$; IF MID(TERM$,57,1)="Y" THEN M$(66,1)="Y"; REM "Credit card invoices are paid
2650 EXTRACT (Z[7],KEY=D$(1,6)+FVEND$+D$(133,4)+D$(7,8)+FTYPE$,DOM=2651)IOL=0450
2660 M$(1,45)=D$(1,6)+FVEND$+D$(133,4)+D$(7,8)+FTYPE$+D$(15,10)+D$(86,6),M$(58,8)=B$(147,8)
2665 M[3]=FRATE
2670 IF FTYPE$="A" THEN M[1]=D[11] ELSE M[1]=M[1]+C[4]; REM "SSP# 132459
2671 IF FTYPE$="A" THEN M[0]=D[1] ELSE M[0]=M[0]+C[2]; REM " SSP# 132459
2672 IF FTYPE$="A" THEN M[2]=D[1]-D[11] ELSE M[2]=M[2]+(C[2]-C[4]); REM " SSP 132459
2700 ON POS(FTYPE$="SCGFA") GOTO 2790,2720,2740,2760,2710,2750; REM " SSP# 132459
2710 M[4]=M[4]+FRATE; GOTO 2780
2720 M[4]=M[4]+C[2]*FRATE*.01; GOTO 2780
2740 M[4]=M[4]+C[4]*FRATE*.01; GOTO 2780
2750 M[4]=(D[1]-D[11])*FRATE*.01; REM " SSP# 132459
2755 GOTO 2780; REM " SSP 132459
2760 M[4]=M[4]+(C[2]-C[4])*FRATE*.01
2780 WRITE (Z[7],KEY=M$(1,29))IOL=0450
2785 IF P0$(183,1)="Y" THEN WRITE (Z[10],KEY=M$(30,10)+M$(21,8)+M$(1,20)+M$(29,1))
2790 RETURN 
3000 REM "Update BOM Inventory
3020 REM "I9$ SET IN 3200'S
3040 EXTRACT (Z[5],KEY=I9$+B$(10,4),DOM=3095)IOL=0390
3060 I[7]=I[7]-B[0]+C[3],I[11]=I[11]-B[8]+C[3]
3070 I[6]=I[6]-INT(C[0]*.05); REM "Waste
3075 I[5]=I[5]+C[0]
3080 WRITE (Z[5])IOL=0390
3085 IF RT$>"" THEN IF RT$(7,1)="H" THEN CUST$=I9$(1,10); CALL "RT2WOC",ERR=3086,X3$,X4$,CUST$,"IC1...","U",I9$+B$(10,4)
3095 RETURN 
3200 REM "Take care of bill of materials items from work order
3201 REM "Decommit off of inv if not blank
3210 FOR I=0 TO 60 STEP 20
3215 IF POS(" "<>G$(317+I,20))<>0 THEN I9$=G$(317+I,20); GOSUB 3000
3220 NEXT I
3245 RETURN 
3300 REM "If item on order line has a bill of materials then the waste backed out in AR2DUD needs to be put back"
3303 IF POS(" "<>G$(317,80))=0 THEN GOTO 3345
3305 I9$=B$(161,10)+B$(19,10)
3310 EXTRACT (Z[5],KEY=I9$+B$(10,4),DOM=3345)IOL=0390
3320 I[6]=I[6]+INT(C[0]*.05); REM "Replace waste"
3325 I[4]=I[4]+C[0]; REM "Receives the quantity into Item
3330 WRITE (Z[5])IOL=0390
3345 RETURN 
4000 REM "Bundled price update
4005 IF POS(P0$(191,1)="FY")=0 THEN GOTO 4300
4008 PRINT 'CF',@(12,10),"Now processing orders for Bundled Price..."
4010 DIM F[48] ! SSP 249885
4030 Z$="12O AS7... "
4034 REM "WHAT TO DO IF ERROR IN FILES...???
4035 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,0
4040 READ (Z[4],KEY="",KNO=0,DOM=4041)
4050 READ (Z[4],END=4300)IOL=0340
4054 REM "NEED TO SKIP REQUISITIONS
4055 IF POS(D$(343,1)="I")=0 THEN GOTO 4050
4060 A0=D[20],A1=0; DIM X[20],F0[300],F0$(0)
4065 PRINT @(12,12),"Processing: ",D$(1,14),
4088 REM "X(0) IS FOR SELL, X(1)=SPECIAL CHGS, X(2)=FRT, X(3)=TAX, X(4)=OTHER
4089 REM "X(5)N/A, X(6)=COST - GOODS, X(7)=COST - SPECIALS, X(8)=COSTED FREIGHT
4090 IF A0<=0 THEN GOTO 4200 ELSE A2=A0; READ (Z[6],IND=A0)IOL=0360
4100 IF F$(2,1)="Y" THEN X[8]=X[8]+F[5]; GOTO 4090 ELSE IF F$(1,1)="M" THEN GOTO 4090
4110 IF F$(1,1)="S" THEN X[1]=X[1]+F[4],X[7]=X[7]+F[5]; GOTO 4090
4115 REM "?? WHAT OTHER LINE TYPES??
4120 F0$=F0$+F$(55,20)+F$(50,4)+STR(A2:"000000")
4122 F0=POS(F$(55,20)=F0$,30); IF F0=0 THEN ESCAPE ELSE F0=INT(F0/30); F0[F0]=F0[F0]+F[4]
4125 X[0]=X[0]+F[4]
4130 X[6]=X[6]+F[5]
4190 GOTO 4090
4200 REM "Done processing lines
4201 P1=X[0],X[2]=D[2],X[3]=D[4]+D[6]+D[8]
4202 X[4]=D[9]-X[3]-X[2]-X[1]-X[0]
4205 IF F0$="" THEN GOTO 4050
4210 IF X[0]=0 THEN F0$=""; GOTO 4050
4220 DIM L[20],L$(80)
4222 READ (Z[6],IND=NUM(F0$(25,6)))IOL=0360
4223 P0=100*F[4]/P1,X[0]=X[0]-F[4]
4225 L$(1,10)=D$(15,10),L$(11,10)=F$(65,10),L$(21,9)=D$(92,8)
4230 EXTRACT (Z[12],KEY=L$(1,29),DOM=4231)IOL=0420
4235 L[19]=P0
4240 L[0]=F[6],L$(36,4)=F$(50,4),L$(76,4)=L$(36,4),L[17]=L[0]
4245 L[1]=L[1]+F[0],L[2]=L[2]+F[1]
4250 L[3]=L[3]+F[4],Q=X[1]*P0/100,X[1]=X[1]-Q,L[4]=L[4]+Q,Q=X[2]*P0/100,L[5]=L[5]+Q,X[2]=X[2]-Q,Q=X[3]*P0/100,L[6]=L[6]+Q,X[3]=X[3]-Q
4259 REM "UNAPPLIED BILLED AMOUNTS GO ON LAST INVOICE IF APPLICABLE
4260 IF LEN(F0$)=30 THEN L[8]=L[8]+X[4],L[4]=L[4]+X[1],L[5]=L[5]+X[2],L[6]=L[6]+X[3]
4265 L$(40,9)=D$(7,8)
4270 L[10]=L[10]+F[5],Q=X[7]*P0/100,L[11]=L[11]+Q,X[7]=X[7]-Q,Q=X[8]*P0/100,X[8]=X[8]-Q,L[12]=L[12]+Q
4275 IF LEN(F0$)=30 THEN L[11]=L[11]+X[7],L[12]=L[12]+X[8]
4278 REM "Total Sell and Cost
4279 L[9]=0,L[16]=0
4280 FOR X=3 TO 8; L[9]=L[9]+L[X],L[16]=L[16]+L[7+X]; NEXT X
4284 REM "Refigure the value
4285 L[18]=0; IF L[2]<>0 THEN L[18]=L[9]*L[17]/L[2]
4290 WRITE (Z[12],KEY=L$(1,29))IOL=0420
4295 F0$=F0$(31); GOTO 4205
4300 REM "End of bundled pricing update
4390 GOTO 9900
7000 READ_MFEE:! SSP 276772
7008 FIND (Z[4],DOM=7090,KEY=C$(31,6)+C$(1,8))IOL=0340 ! SSP 276772
7010 READ (Z[12],KEY=C$(9,11),DOM=*NEXT)
7015 READ_NEXT_FV5:
7020 FF_KEY$=KEY(Z[12],END=7090); READ (Z[12],KEY=FF_KEY$)IOL=0460
7030 IF FF_KEY$(1,11)<>C$(9,11) THEN GOTO 7090
7040 FTYPE$=FV5$(15,1),FVEND$=FV5$(16,10),FRATE=FV5[0]
7050 GOSUB MFEE_UPD
7060 GOTO READ_NEXT_FV5
7090 RETURN 
7099 ! 
7100 MFEE_UPD:! SSP 276772
7110 DIM M$(178),M[4]; FF_SEQ=0 ! SSP 276772
7120 IF C(2)=0 AND FTYPE$="A" THEN IF POS(X3$(9,3)="522500",3)=0 THEN GOTO MFEE_UPD_END ELSE M$(75,1)="Y"; REM "Zero balance A types to show up on finders fee report
7130 IF C[2]=0 AND FTYPE$="S" THEN IF POS(X3$(9,3)="125")=0 THEN GOTO MFEE_UPD_END ELSE M$(75,1)="Y"; REM "They want zero S type finder's on report
7135 IF C[2]=0 AND FTYPE$="F" AND POS(X3$(9,3)="531500",3)<>0 THEN M$(75,1)="Y"; REM "147117 they want 0 Fixed types to show up on the report
7140 FIND (Z(11),KEY=D$(65,2),DOM=*NEXT)TERM$; IF MID(TERM$,57,1)="Y" THEN M$(75,1)="Y"; REM "Credit card invoices are paid
7145 FV7_ORD_KEY$=D$(1,6)+D$(7,8)+C$(17,3)+MID(FV5$,12,3)
7150 ! XTRACT (Z[14],KEY=FV7_KEY$,DOM=*NEXT)IOL=0450
7155 ! IM M[3] ! Do not duplicate Invoice totals
7160 M$(1,20)=FV7_ORD_KEY$,M$(24,31)=FVEND$+D$(133,4)+FTYPE$+D$(15,10)+D$(86,6),M$(67,8)=B$(147,8)
7165 M$(55,6)=X3$(178,6)
7170 ! $(67,3)=C$(17,3)
7175 M[3]=FRATE
7180 IF FTYPE$="A" THEN M[1]=D[11] ELSE M[1]=C[4]; REM "SSP# 132459
7185 IF FTYPE$="A" THEN M[0]=D[1] ELSE M[0]=C[2]; REM " SSP# 132459
7190 IF FTYPE$="A" THEN M[2]=D[1]-D[11] ELSE M[2]=(C[2]-C[4]); REM " SSP 132459
7200 ON POS(FTYPE$="SCGFA") GOTO MFEE_UPD_END,7220,7240,7260,7210,7250; REM " SSP# 132459
7210 M[4]=M[4]+FRATE; GOTO WRITE_MFEE
7220 M[4]=M[4]+C[2]*FRATE*.01; GOTO WRITE_MFEE
7240 M[4]=M[4]+C[4]*FRATE*.01; GOTO WRITE_MFEE
7250 M[4]=(D[1]-D[11])*FRATE*.01; REM " SSP# 132459
7255 GOTO WRITE_MFEE; REM " SSP 132459
7260 M[4]=M[4]+(C[2]-C[4])*FRATE*.01
7300 WRITE_MFEE:
7310 FF_SEQ=FF_SEQ+1; FF_SEQ$=STR(FF_SEQ:"000")
7320 FV7_KEY$=FV7_ORD_KEY$+FF_SEQ$
7330 M$(21,3)=FF_SEQ$
7340 WRITE (Z[14],KEY=FV7_KEY$,DOM=WRITE_MFEE)IOL=0450
7380 MFEE_UPD_END:
7390 RETURN 
7399 ! 
7800 REM "ADD 1 TO STARTING# - RIGHT JUSTIFIED
7810 Z8=POS(" "<>G$(135,9)); IF Z8=0 THEN GOTO 7840
7815 DIM Z9$(10-Z8,"0")
7820 G$(135,9)=STR(NUM(G$(135,9),ERR=7822)+1:Z9$); GOTO 7830
7822 SETERR 9000
7830 IF G$(143,1)=" " THEN G$(135,9)=" "+G$(135,8); GOTO 7830
7840 RETURN 
8800 REM "Problem in ZZFILES
8810 GOSUB 8850; GOTO 0520
8850 REM 
8860 X$="Update "+PGN+" in progress, you may not exit. Contact SW Support for assistance"
8870 CALL "ZZPROM",".4",X3$,0,X$,"","",0
8890 RETURN 
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,1
9050 ON Y7 GOTO 9060,9100,9190,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9190 GOSUB 6600; GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9800 REM 
9830 Y4$="ZMENU"
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9950 IF NOT(NUL(Y4$)) THEN IF %GUI THEN IF STP(Y4$)<>"ZMENU" THEN RUN Y4$ ELSE EXIT 
9960 RUN "AR2DUG"
9999 END 
56000 REM "212450-Issue directly related to WO 200893                         
56001 REM "249775-Changes to sales tax parameters and tax calculations to     
56002 REM "276772-Multiple Finder's Fees per Customer/Item/Order Line.        
