0010 REM "<DR2LMS> UPDATE PVX FILE WITH FMP RECORDS
0020 SETESC 9300; SETERR 9000
0035 REM "5.4 - 06/29/05 - 13.816111 - lms - SSP# 185523
0040 REM "Copyright 2005 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,Q0$,Q1$
0100 IF %GUI=0 THEN SETERR 9000
0110 X0$="DR2LMS",X1$="Update PVX file with FMP Records"
0120 DIM Z0$(80,"-"),FILE$[150]
0125 DIM BLANK$(200," ")
0126 DIM QUOTE$(2,QUO+QUO+QUO)
0130 K0=20,K1=1
0135 C9=-1
0140 ACC$=""
0170 IF POS("MS"=UCS(SYS)) THEN ISWIN=1 ELSE ISWIN=0
0200 REM "
0240 IF %GUI=0 THEN CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=MNM('GS')+Z0$+MNM('GE')
0300 REM "IOLISTS
0310 IOLIST A$; REM "EM1
0320 IOLIST B$
0330 IOLIST C$
0340 IOLIST FS1$,FS1[0],FS1[1],FS1[2],FS1[3],FS1[4],FS1[5],FS1[6],FS1[7],FS1[8],FS1[9],FS1[10],FS1[11],FS1[12],FS1[13]
0350 IOLIST FS2$,FS2[0],FS2[1],FS2[2],FS2[3],FS2[4],FS2[5],FS2[6],FS2[7],FS2[8],FS2[9],FS2[10],FS2[11],FS2[12],FS2[13],FS2[14],FS2[15],FS2[16],FS2[17],FS2[18],FS2[19],FS2[20],FS2[21],FS2[22],FS2[23],FS2[24],FS2[25],FS2[26],FS2[27],FS2[28],FS2[29]
0420 IOLIST I$
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0509 REM "Slot 1 used for ED0 file opened in 1000's, slot 2 used for text file created in 700's to write to
0510 Z$="13O ZZPARM  20O PFX...  12O "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0600 REM "
0610 IF %GUI=0 THEN GOSUB 6000
0640 IF Q1$="" AND %GUI=0 THEN CALL "ZZPROM",".Y",X3$,Z,"PROCEED?","","",0; ON Z GOTO 0641,9900
0800 REM "Set Prefix
0900 REM "Read ZZPARM file for DIRectory and hex codes
0910 DIM I$(512); READ (Z[13],KEY=PARM$,DOM=0911)IOL=0420
0915 ELEMENT_SEPARATOR$=ATH("2A"),SEGMENT_TERMINATOR$=ATH("5E"); REM "Setup for original values:  * and ^ respectively
0920 REM "IF I$(309,2)<>"  " THEN ELEMENT_SEPARATOR$=ATH(I$(309,2))
0925 REM "IF I$(311,2)<>"  " THEN SEGMENT_TERMINATOR$=ATH(I$(311,2))
1000 REM "Get list of .exp files to process
1005 I=-1,J=0
1010 IMPORT_PATH$="/usr/lib/pvx/nomads/"
1036 SLOT=UNT
1060 CLOSE (SLOT); OPEN LOCK (SLOT,OPT="TEXT",ERR=5000)IMPORT_PATH$+"FMPLMS.TXT"
1065 CLOSE (13); OPEN (13)"ZZPARM"; REM "Re-open ZZPARM closed in ZZ2BLS
1080 REM "GOSUB 8100; GOSUB 8150
1099 REC$=""
1100 READ (SLOT,END=5000)A$
1101 IF A$(1,2)="DUP" THEN GOTO 1100
1103 IF A$(1,1)=";" OR ACC$="YES" THEN GOTO 3000
1106 COUNT=COUNT+1
1108 IF COUNT<31 THEN GOTO 1100
1109 IF LEN(A$)=1 THEN GOTO 2000
1149 IF KEY$<>"" THEN GOTO 1210
1150 A$=STP(A$,3,"[")
1155 A$=STP(A$,3,"]")
1200 KEY$="[wdx][odb]PVXTF;"+A$; X$="DR_"+A$(1,4)+"500"
1205 GOTO 1100
1215 COMMA=POS(","=A$)
1216 LONE=POS("="=A$)
1218 L=POS("="=A$,1,2)
1219 COMMA2=POS(","=A$,1,2)
1222 DIFF=COMMA2-L
1223 DIFF=DIFF-1
1224 IF DIFF<0 THEN DIFF=1
1225 REC$=REC$+A$(1,LONE-1)+":"+A$(L+1,DIFF)+"+"
1250 GOTO 1100
2000 REM "WRITE THE RECORD
2010 ESCAPE 
2020 REC$="REC="+REC$(1,LEN(REC$)-1)
2024 ESCAPE ; REM KEC$="KEY="+KEC$(1,LEN(KEC$)-1)
2025 WRITE (Z[20],KEY=X$)KEY$,KEC$+";"+REC$
2026 PRINT KEY$,"    ",LEN(REC$)
2050 REC$=""; KEY$="",X$="",KEC$=""
2099 GOTO 1100
3000 REM " ACCUMULATE THE KEY =
3001 IF ACC$="NO" THEN GOTO 1100
3010 IF A$(1,6)=";start" THEN ACC$="YES"; GOTO 1100
3011 IF A$(1,16)=";end of external" THEN ACC$="NO"; GOTO 1100
3016 AONE=POS("="=A$)
3025 KEC$=KEC$+A$(1,AONE-1)+","
3090 GOTO 1102
5000 REM "EOJ
5001 REM "XFD$=FN%XFD$(Z[2],0),TOT_REC=DEC(XFD$(38,4))
5002 ESCAPE 
5003 CLOSE (Z[2],ERR=5004)
5004 REM IF TOT_REC=0 THEN ERASE TEXT$; GOTO 5012
5005 NAME_2$="FO1.",EXT_2=1
5007 REM "GOR$=NAME_2$+STR(EXT_2:"000")
5010 REM RENAME TEXT$,GOR$,ERR=5011; GOTO 5012; REM "Rename the ED1 file we wrote to, to an FO1 file to be used in the Order Requisition Gateway
5011 REM EXT_2=EXT_2+1; GOTO 5007
5015 C=T; GOSUB 8150
5020 REM "IF Q1$="" THEN CALL "ZZPROM",".4",X3$,Z,"PROCESS COMPLETE!!","","",0
5040 GOTO 9900
6000 REM "BACKGROUND
6005 PRINT (0,ERR=6016)'SB',
6020 PRINT @(10,4),"Updating PFX file with FMP Records"
6165 PRINT (0,ERR=6166)'SF',
6190 RETURN 
6390 PARM$=X3$(9,3)+"O/F"
6400 REM "WHOLE SCREEN                                                       
6405 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,X5$,X0,X1,0
6420 GOSUB 6000
6430 IF C9>0 THEN GOSUB 6200 ELSE GOSUB 6450
6440 IF ABS(C0)>4 THEN C0=ABS(C0)-5
6445 RETURN 
6450 REM "DISPLAY KEYS                                     
6451 CALL "ZZDISP","A",A$(1,10),"A/R",X3$,"","",28,10,X4$
6490 RETURN 
8100 REM "GOSUB here, once, at the beginning, after the background is set and before the Proceed? question. Set T to total # to do (by calling ZZINFO) and T0 to the reporting interval (report every T0 number of records) this is typically 2% of total; This also prints a message (@8115),so adjust accordingly
8110 T=0; CALL "ZZ2FNC;SERIALRECCNT",SLOT,T
8115 IF %GUI=0 THEN PRINT @(0,7),"There are "+STR(T)+" records to process"
8129 REM "Set T0, we make sure T0 is > 1, because later on we MOD and look for avalue of 1. IF T0 is 1, then nothing would get reported. We look for a result of 1 because this causes the first record to automatically start the reporting instead of waiting until the T0'th record to get the first report
8130 T0=INT(T*.02); IF T0<=1 THEN T0=2
8145 RETURN 
8150 REM "Call this each time to update the bar graph. Display horiz. bar graph given total #, T and current #, C, and time counter T1 (T1 is init'ed here and used here, just don't use it somewhere else)
8155 CALL "ZZBARG",X3$,"HG",19,10,50,T1,T,C
8195 RETURN 
8950 DEF FNS$(Z9$)=Z9$(1,POS("     "=Z9$+"     ")-1)
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
