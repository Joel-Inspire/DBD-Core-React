0100 REM 0100"UT0100: KEYED/INDEXED FILE UTILITY       *** SAVED 10/16/84 @ 10:40 AM
0110 REM "CHOICE    UT0100 A0.00 0000 0000 MM-DD-YY
0120 REM IF POS("UT0101"=C$)=0 THEN GOTO 00150
0130 REM LET C$(1,2)=""
0140 REM ON NUM(C$(16,1)) GOTO 00250
0150 BEGIN 
0160 DIM B$(80)
0170 PRINT 'CS','SB',"CHOICE    UT0100 A0.00",@(25),"KEYED/INDEXED FILE UTILITY",@(70),DAY,'SF',
0171 S0$=$8A0022$
0172 OPEN (1,ERR=0180)"$PGSYS"
0173 READ RECORD (1,KEY="S ",DOM=0174)S0$
0174 S0$=S0$(1,3)
0175 CLOSE (1)
0180 INPUT 'SB',@(0,2),"FILE NAME: ",'SF',"--------",'CL',@(11),F$
0190 ON CTL-1 GOTO 0200,0180,0180,8800
0200 IF LEN(F$)>8 OR LEN(F$)<1 THEN GOTO 0180
0210 F$=F$+B$(1,8-LEN(F$))
0220 PRINT @(11,2),F$,'CL',
0230 C$="UT0101UT01000400"+F$(1,6)
0240 GOSUB 6500
0250 IF C$(15,1)<>"0" THEN GOTO 0180
0260 IF POS(C$(23,1)="IK")>0 THEN GOTO 0290
0270 INPUT @(25,2),"NOT A KEYED OR INDEXED FILE.  (CR) ",'CL','RB',*
0280 GOTO 0180
0290 K=NUM(C$(24,2)),B=NUM(C$(26,6))
0300 OPEN (2)F$
0310 DIM X$(80,"-")
0320 PRINT 'SB',@(0,3),X$,'CL',
0330 PRINT @(25,2),'SB',"Key:",'CL','SB',@(30,3),"1---^----10---^----20---^----30---^----40---^",'SF'
0340 X$=""
0350 PRINT 'SB',"FILE TYPE",@(15),'SF',
0360 IF C$(23,1)="K" THEN PRINT "KEYED"
0370 IF C$(23,1)="I" THEN PRINT "INDEXED"
0380 IF C$(23,1)="K" THEN PRINT 'SB',"KEY SIZE",@(15),'SF',NUM(C$(24,2)):"#0"
0390 PRINT 'SB',"BYTES/RECORD",@(15),'SF',NUM(C$(26,6)):"###,##0"
0400 PRINT 'SB',"NUMBER RECORDS",@(15),'SF',NUM(C$(32,6)):"###,##0"
0410 PRINT 'SB',"START SECTOR",@(15),'SF',NUM(C$(38,5)):"##,##0"
0420 PRINT 'SB',"END SECTOR",@(15),'SF',NUM(C$(43,5)):"##,##0"
0430 PRINT 'SB',"DISC NUMBER",@(15),'SF',NUM(C$(48,1)):"0"
0440 IF C$(23,1)="K" THEN PRINT 'SB',"RECORDS USED",@(15),'SF',NUM(C$(49,6)):"###,##0"
0450 PRINT 'SB',"DESCRIPTION",@(15),'SF',C$(55,24)
1000 REM 1000
1010 DIM Z$(K,"-")
1020 PRINT @(0,23),"(CR=NEXT, S=SECOND SCREEN, F=FILE, M=MODIFY, E=END, P=PRINT, D=DELETE, A=ADD)",@(0,22),'SB',"ENTER KEY/INDEX: ",'SF',Z$,'CL',@(17),
1030 INPUT (0,ERR=1000,LEN=K)A$
1040 ON CTL-1 GOTO 1050,1000,1000,8800
1050 IF A$>"" THEN GOTO 1090
1060 GOSUB 2000
1070 GOSUB 2500
1080 GOTO 1000
1090 IF LEN(A$)>1 THEN GOTO 1500
1100 ON POS(A$="SFMEPDA") GOTO 1000,1110,0100,3000,8800,4000,5000,6000
1110 IF K$="" THEN GOTO 1000
1120 IF I>L[0] THEN I=1
1130 GOTO 1070
1500 REM 1500"FILE POSITION
1510 IF K=0 THEN GOTO 1540
1520 EXTRACT (2,KEY=A$,DOM=1530,ERR=1900)
1530 GOTO 1060
1540 A$=STR(NUM(A$,ERR=1000))
1550 EXTRACT (2,IND=NUM(A$),ERR=1900)
1560 GOTO 1060
1900 REM 1900
1910 E$="ERROR: "+STR(ERR)+" EXTRACTING RECORD"
1920 IF ERR=0 THEN E$="RECORD BUSY"
1930 IF ERR=2 THEN E$="END OF FILE"
1940 PRINT @(0,23),'CL',@(0,22),E$,".  (CR) ",'CL','RB',
1950 INPUT *
1960 GOTO 1000
2000 REM 2000"READ NEXT RECORD
2010 IF K>0 THEN K$=KEY(2,END=2400)
2020 IF K=0 THEN K$=STR(IND(2))
2030 PRINT @(30,2),'CL',K$,"!",
2040 IF B>0 THEN GOTO 2080
2041 READ (2)
2045 S=4
2050 GOSUB 8000
2060 PRINT @(0,4),"NO DATA IN SORT FILE. ",'CL',
2070 EXITTO 1000
2080 READ RECORD (2,END=2400)R$
2090 I=1
2100 GOSUB 7000
2110 RETURN 
2400 REM 2400
2410 INPUT @(0,23),'CL',@(0,22),"END OF FILE.  (CR) ",'CL','RB',*
2420 S=4
2430 GOSUB 8000
2440 EXITTO 1000
2500 REM 2500"DISPLAY
2510 S=4,V=4
2520 GOSUB 8000
2530 FOR I=I TO L[0]
2540 IF L[I]>0 THEN GOTO 2570
2550 D$="null"
2560 GOTO 2580
2570 D$=R$(P[I],L[I])
2580 IF V+LEN(Z$)/75<21 THEN GOTO 2600
2590 GOTO 2680
2600 PRINT @(0,V),STR(I:"##.B"),
2610 FOR Z=1 TO LEN(D$) STEP 75
2620 PRINT @(5,V),
2630 IF LEN(D$(Z))<=75 THEN PRINT D$(Z),
2640 IF LEN(D$(Z))>75 THEN PRINT (0,ERR=2641)D$(Z,75),
2650 V=V+1
2660 NEXT Z
2670 IF V<21 THEN GOTO 2710
2680 PRINT @(0,V),"***",@(5),"FIELDS: ",L[0]:"#0",
2690 V=V-1,I=I+1
2700 EXITTO 2730
2710 NEXT I
2720 I=I+1
2730 RETURN 
3000 REM 3000"MODIFY RECORD
3010 IF K$="" THEN GOTO 1000
3020 INPUT @(0,23),'CL',@(0,22),'SB',"ENTER FIELD NUMBER: ",'SF',"--",'CL',@(20),A$
3030 ON CTL-1 GOTO 3040,3020,3020,1000
3040 IF LEN(A$)>2 THEN GOTO 3020
3045 IF A$="" THEN GOTO 1000
3050 A$=STR(NUM(A$,ERR=3020)),F=NUM(A$)
3060 REM "IF FPT(F)>0 OR F<1 OR F>40 THEN GOTO 03020
3061 IF FPT(F)>0 OR F<1 OR F>L[0] THEN GOTO 3020
3070 PRINT @(0,22),"FIELD # ",F:"#0"," DATA: ",'CL',
3080 INPUT D$
3090 ON CTL-1 GOTO 3100,3500,3070,3020
3100 IF D$="" THEN GOTO 3020
3110 IF F<=L[0] THEN GOTO 3150
3120 R$=R$(1,P[L[0]+1]-1)+S0$(1,1)+R$(P[L[0]+1])
3130 GOSUB 7000
3140 GOTO 3110
3150 R$=R$(1,P[F]-1)+D$+R$(P[F]+L[F])
3160 R$=R$(1,POS(S0$(2,1)=R$+S0$(2,1)))
3170 IF K=0 THEN WRITE RECORD (2,IND=NUM(K$))R$
3180 IF K>0 THEN WRITE RECORD (2,KEY=K$)R$
3190 GOSUB 7000
3200 I=1
3210 GOSUB 2500
3220 GOTO 3000
3500 REM 3500
3510 IF L[F]>0 THEN GOTO 3540
3520 INPUT @(0,22),"NULL FIELD.  (CR) ",'CL','RB',*
3530 GOTO 3000
3540 INPUT @(0,22),'SB',"POS: ",'SF',"---",'CL',@(5),A$
3550 ON CTL-1 GOTO 3560,3540,3540,3000
3560 IF LEN(A$)>3 THEN GOTO 3540
3570 A$=STR(NUM(A$,ERR=3540):"000"),P=NUM(A$)
3580 IF P>L[F] OR P<1 THEN GOTO 3540
3590 PRINT @(5,22),A$,'CL',
3600 INPUT @(10,22),'SB',"LENGTH: ",'SF',"---",'CL',@(18),A$
3610 ON CTL-1 GOTO 3620,3600,3600,3540
3620 IF LEN(A$)>3 THEN GOTO 3600
3630 A$=STR(NUM(A$,ERR=3600):"000"),L=NUM(A$)
3640 IF L<1 THEN GOTO 3600
3650 IF P+L-1>L[F] THEN GOTO 3600
3660 PRINT @(18,22),A$,'CL',
3670 DIM X$(L,"-")
3680 PRINT @(25,22),'SB',"DATA: ",'SF',X$,'CL',@(31),
3690 INPUT D$
3700 ON CTL-1 GOTO 3710,3680,3680,3600
3710 IF D$="" THEN GOTO 3680
3720 IF LEN(D$)>L THEN GOTO 3680
3730 R$(P[F]+P-1,L)=D$
3740 GOTO 3160
4000 REM 4000"PRINT KEYS
4010 DIM X$(K,"-")
4020 IF K=0 THEN DIM X$(4,"-")
4030 PRINT @(0,23),'CL',@(0,22),'SB',"ENTER START KEY/INDEX: ",'SF',X$,'CL',@(23),
4040 INPUT A$
4050 IF LEN(X$)>K AND K>0 THEN GOTO 4030
4060 IF K>0 THEN EXTRACT (2,KEY=A$,DOM=4070,ERR=4030)
4070 IF K=0 THEN EXTRACT (2,IND=NUM(A$,ERR=4030))
4080 S=4
4090 GOSUB 8000
4100 V=4,H=0
4110 IF K>0 THEN R0$=KEY(2,END=4900)
4120 IF K>0 THEN READ (2)
4130 IF K=0 THEN READ RECORD (2,END=4900)R0$
4140 R0$=R0$(1,POS(S0$(2,1)=R0$+S0$(2,1))-1)
4150 PRINT @(H,V),R0$,
4160 V=V+1
4170 IF V<21 THEN GOTO 4110
4180 H=H+K+1,V=4
4190 IF K=0 THEN H=H+80
4200 IF H+K+1<79 THEN GOTO 4110
4210 INPUT @(0,22),"CR FOR NEXT PAGE.  (CR) ",'CL','RB',*
4220 IF CTL>1 THEN GOTO 1000
4230 GOTO 4080
4900 REM 4900
4910 INPUT @(0,22),"END OF FILE.  (CR) ",'CL','RB',*
4920 GOTO 1000
5000 REM 5000"DELETE RECORDS
5010 IF K<1 THEN GOTO 1000
5020 DIM X$(K,"-")
5030 PRINT @(0,23),'CL',@(0,22),'SB',"START KEY: ",'SF',X$,'CL',@(11),
5040 INPUT A1$
5050 ON CTL-1 GOTO 5060,5030,5030,1000
5060 IF LEN(A1$)>K THEN GOTO 5030
5070 EXTRACT (2,KEY=A1$,DOM=5080)
5080 A1$=KEY(2,END=5030)
5090 PRINT @(11,22),A1$,'CL',
5100 PRINT @(11+K+1,22),'SB',"END KEY: ",'SF',X$,'CL',@(11+K+10),
5110 INPUT A2$
5120 ON CTL-1 GOTO 5130,5100,5100,5030
5130 IF LEN(A2$)>K THEN GOTO 5100
5140 IF A2$="" THEN A2$=A1$
5150 PRINT @(11+K+10,22),A2$,'CL',
5160 INPUT @(23+K*2,22),'SB',"OK? ",'SF',"-",'CL',@(23+K*2+4),A$
5170 ON CTL-1 GOTO 5180,5160,5160,5100
5180 IF LEN(A$)<>1 THEN GOTO 5160
5190 ON POS(A$="YN") GOTO 5160,5200,5100
5200 S=4
5210 GOSUB 8000
5220 H=0,V=4,D$=""
5230 EXTRACT (2,KEY=A1$,DOM=5240)
5240 R0$=KEY(2,END=5900)
5250 IF R0$>A2$ THEN GOTO 5900
5260 PRINT @(H,V),R0$,
5270 IF D$="" THEN INPUT @(0,22),"(CR) TO REMOVE, (F4) TO ABORT, C TO CANCEL PROMPT: ",'CL',D$
5280 IF D$="" THEN ON CTL-1 GOTO 5290,5270,5270,1000
5290 REMOVE (2,KEY=R0$)
5300 PRINT @(H+K,V),"*",
5310 V=V+1
5320 IF V<21 THEN GOTO 5240
5330 H=H+K+2,V=4
5340 IF H+K+1<80 THEN GOTO 5240
5350 INPUT @(0,22),"CR TO CONTINUE.  (CR) ",'CL','RB',*
5360 S=4,H=0,V=4
5370 GOSUB 8000
5380 GOTO 5240
5900 REM 5900
5910 GOTO 1000
6000 REM 6000"ADD A RECORD
6010 IF K<1 THEN GOTO 1000
6020 DIM X$(K,"-")
6030 PRINT @(0,23),"(F2=SPACE FILL TO KEY SIZE)",'CL',@(0,22),'SB',"ENTER KEY: ",'SF',X$,'CL',
6040 INPUT @(11,22),A$
6050 ON CTL-1 GOTO 6060,6060,6030,1000
6060 IF LEN(A$)>K OR LEN(A$)<1 THEN GOTO 6030
6070 IF CTL=2 THEN A$=A$+B$(1,K-LEN(A$))
6080 PRINT @(11,22),A$,'CL',
6090 R$=A$+S0$(1,2)
6100 WRITE RECORD (2,KEY=A$,DOM=6120)R$
6110 GOTO 1520
6120 INPUT @(0,23),'CL',@(0,22),"KEY ALREADY ON FILE.  (CR) ",'CL','RB',*
6130 GOTO 1520
6500 REM GET FILE PARAMETERS
6510 CLOSE (9)
6515 C$=C$+" "
6520 OPEN (9,ISZ=256,ERR=6525)F$; GOTO 6530
6525 C$(15,1)="1"; RETURN 
6530 Z$=FID(9)
6535 CLOSE (9)
6540 IF Z$(10,1)=$00$ THEN C$(23,1)="I"
6550 IF Z$(10,1)=$01$ THEN C$(23,1)="S"
6560 IF Z$(10,1)=$02$ THEN C$(23,1)="K"
6570 IF Z$(10,1)=$04$ THEN C$(23,1)="P"
6580 C$=C$+STR(ASC(Z$(11))-4:"00")+STR(DEC(Z$(15,2)):"000000")+STR(DEC(Z$(12,3)):"000000")+STR(DEC(Z$(1,3)):"00000")+STR(DEC(Z$(17,3)):"00000")+STR(DEC(Z$(20,1)):"0")+"000000"+"                        "
6590 IF NUM(C$(32,6))>32768 THEN C$(24,2)=STR(NUM(C$(24,2))-2:"00")
6600 ON POS(C$(23,1)="I") GOTO 6630,6610
6610 C$(49,6)=C$(32,6),C$(24,2)="00"
6620 GOTO 6750
6630 C$(55,24)="FILE CANNOT BE LOCKED"
6640 OPEN (9,ISZ=256)F$
6650 READ RECORD (9)Z$
6660 CLOSE (9)
6670 ON POS(C$(23,2)="P") GOTO 6740,6680
6680 C$(49,6)=STR(DEC(Z$(1,3)):"000000"),Z=13+DEC(Z$(12,1))*3,Z1=ASC(Z$(Z))-1,Z=Z+1,Z$=LST(Z$(Z,Z1)),Z$=Z$(7),C$(24,2)="00"
6690 IF POS(":"=Z$)>0 THEN Z$=Z$(POS(":"=Z$)+2)
6700 IF Z$(LEN(Z$),1)=$22$ THEN Z$=Z$(1,LEN(Z$)-1)
6710 IF LEN(Z$)>24 THEN Z$=Z$(1,24)
6720 C$(55,24)=Z$
6730 RETURN 
6740 C$(49,6)=STR(DEC(Z$(37,4)):"000000")
6750 C$(55,24)="NOT AVAILABLE"
6760 CLOSE (9)
6770 RETURN 
7000 REM 7000"7000 ROUTINES
7010 REM " K$ = KEY CONTENTS OR STR(IND)
7020 REM " R$ = DATA RECORD CONTENTS
7030 REM " F$ = FIELD CONTENTS
7040 REM " F0$ = FIELD SEPERATION CHARACTER
7050 REM " E0$ = END OF RECORD SEPERATION CHARACTER
7060 REM " L(0) = NUMBER OF DATA FIELDS IN RECORD
7070 REM " P(0) = RECORD LENGTH
7080 REM " P(L(0)+1) = LAST BYTE USED IN RECORD
7100 REM 7100"DATA RECORD POINTER SET
7110 REM " RECORD IS PASSED IN R$
7120 DIM P[200],L[200]
7130 Z=1,P[Z]=1
7140 A=POS(S0$(1,1)=R$(P[Z]))
7150 IF A=0 THEN GOTO 7180
7160 L[Z]=A-1,P[Z+1]=A+P[Z],Z=Z+1
7170 GOTO 7140
7180 A=POS(S0$(2,1)=R$)
7190 IF A=0 THEN A=LEN(R$)
7200 L[Z]=P[Z]-1,P[Z+1]=A,Z=Z-1,L[0]=Z,P[0]=LEN(R$)
7210 RETURN 
8000 REM 8000
8010 PRINT @(0,S),'CE'
8040 RETURN 
8800 REM 8800
8810 PRINT @(0,23),'CL',@(0,22),"->END OF PGM: UT0100  ",'CL',
8811 RUN "**"
8812 RUN "ZMENU",ERR=8813
8815 RUN "OP",ERR=8816
8820 RUN "MASTER"
