0010 REM "Data Transfer - Email/Ftp <ZZ2TXF>
0020 SETESC 9300; SETERR 9000
0035 REM "5.6 - 04/04/08 - 17.4375 - lms - SSP# 191992
0037 REM "191992-Generate welcome email during order entry and flag items    
0040 REM "Copyright 2008 DemandBridge, Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$
0095 REM COMMAND$,ARG$,OPTION$ NOT USED AS OF 06/15/05
0100 SETERR 9000
0110 X0$="ZZ2TXF",X1$="Data Transfer - Email/Ftp"
0120 ALLOWED_TIME=15 ! # seconds to allow command to run before leaving
0150 RETURN_CODE=0,RETURN$=""
0160 X3_NO_TIME$=X3$; X3_NO_TIME$(78,1)="0"
0170 EOL$=""
0180 DIM W[4]
0310 IOLIST AR$
0490 IOLIST R0$,W$,W[0],W[1],W[2],W[3],W[4]
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="01O EML...  02O ZZS...  13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0600 REM "Set BASE_TYPE$ to "MS-WINDOWS","UNIX","OTHER" to use for lookups, set FULL_TYPE$ to SYS, and SYS_TYPE$ to "WINDOWS","UNIX",or "OTHER" for deciding how to do commands
0610 FULL_TYPE$=SYS
0620 IF MID(FULL_TYPE$,1,4)="UNIX" THEN BASE_TYPE$="UNIX",SYS_TYPE$="UNIX" ELSE IF FULL_TYPE$="MS-WINDOWS" THEN BASE_TYPE$="MS-WINDOWS",SYS_TYPE$="WINDOWS" ELSE BASE_TYPE$="OTHER",SYS_TYPE$="OTHER"
0700 DIM EML_P$(512); READ (Z[13],KEY=X3$(9,3)+"EML",DOM=*NEXT)EML_P$(1)
0900 INITIALZATION:
0980 CALL "UPDEML;READNEXT",Z[1],A$,A{ALL},FOUND
1000 WHILE FOUND ! 7980 wend
1020 FROM_DIR$=STP(A$(137,60),2); IF FROM_DIR$<>"" THEN IF FROM_DIR$(LEN(FROM_DIR$),1)<>"/" THEN FROM_DIR$=FROM_DIR$+"/"
1032 TO_DIR$=STP(A$(197,60),3," "); IF TO_DIR$<>"" AND TO_DIR$(LEN(TO_DIR$),1)<>"/" THEN TO_DIR$=TO_DIR$+"/"
1035 FIND_DIR$="< ls "+FROM_DIR$
1050 PRINT @(0,20),"Now Transferring data "
1060 CHKDATE$=A$(383,6)
1070 CALL "UPDEML;EXTRACTBYKEY",Z[1],0,A$(1,5),SEG2$,SEG3$,SEG4$,SEG5$,A$,A{ALL},FOUNDEML,BUSYEML; IF FOUNDEML AND NOT(BUSYEML) THEN A$(383,6)=X3$(21,6); CALL "UPDEML;UPDATE",Z[1],A$,A{ALL},BUSYEML2
1100 IF NOT(BUSYEML) AND FOUNDEML THEN {! 7900
1110 SWITCH A$(6,2) ! 7850
1150 CASE "BE" ! buyer shipment conf email ! 1290 BREAK
1155 OVER$="N"
1160 READ (Z[2],KEY=A$(31,6)+A$(371,12),DOM=*BREAK)IOL=0310,IOL=0490
1170 SWITCH A$(31,6) ! PARAMETER OVERRIDE ! 1195 END SWITCH
1175 CASE "SMGPAA"
1177 W$(1,6)=X3$(21,6),W$(7,6)=X3$(21,6),W$(14,1)="Y",W$(15,15)=A$(8,15),OVER$="Y",T0=1,L0$="SMD   ",W$(30,10)=DIM(10),W$(40,10)="~~~~~~~~~~",W$(50,4)=DIM(4)
1179 BREAK
1195 END SWITCH ! 1170
1205 IF OVER$="Y" THEN {! 1250 }
1210 T1$=L0$((T0-1)*6+1,6),K$=X3$(1,8)
1215 ZZP=UNT; OPEN (ZZP)"ZZP"
1217 WRITE (ZZP,KEY=K$)X3$,X4$,T1$,R0$,W$,IOL=0310
1220 CLOSE (ZZP)
1222 IF POS("\"=A$(137,60))<>0 THEN SEP$="\" ELSE SEP$="/"
1225 %EML_PDF_PATH$=STP(A$(137,60),3," "); IF %EML_PDF_PATH$(LEN(%EML_PDF_PATH$),1)<>SEP$ THEN %EML_PDF_PATH$=%EML_PDF_PATH$+SEP$
1227 CALL A$(31,6),ERR=*NEXT
1250  }
1270 FILE_SIZE=570
1280 GOSUB EMAIL_REPORT
1290 BREAK ! 1150
1298 ! 
1299 ! 
1300 CASE "CE" ! customer shipment conf email ! 1390 break
1305 OVER$="N"
1310 READ (Z[2],KEY=A$(31,6)+A$(371,12),DOM=*BREAK)IOL=0310,IOL=0490
1312 SWITCH A$(31,6) ! PARAMETER OVERRIDE ! 1330 END SWITCH
1315 CASE "SMGPAA"
1317 W$(1,6)=X3$(21,6),W$(7,6)=X3$(21,6),W$(14,1)="Y",W$(15,15)=DIM(15),OVER$="Y",T0=1,L0$="SMD   ",W$(30,10)=A$(8,10),W$(40,10)=A$(8,10),W$(50,4)=A$(18,4)
1319 BREAK
1330 END SWITCH 
1340 IF OVER$="Y" THEN {
1342 T1$=L0$((T0-1)*6+1,6),K$=X3$(1,8)
1345 ZZP=UNT; OPEN (ZZP)"ZZP"; WRITE (ZZP,KEY=K$)X3$,X4$,T1$,R0$,W$,IOL=0310; CLOSE (ZZP)
1350 IF POS("\"=A$(137,60))<>0 THEN SEP$="\" ELSE SEP$="/"
1352 %EML_PDF_PATH$=STP(A$(137,60),3," "); IF %EML_PDF_PATH$(LEN(%EML_PDF_PATH$),1)<>SEP$ THEN %EML_PDF_PATH$=%EML_PDF_PATH$+SEP$
1380 CALL A$(31,6),ERR=*NEXT
1382 FILE_SIZE=570
1385 GOSUB EMAIL_REPORT
1387  }
1390 BREAK
1400 CASE "SH" ! 
1402 CMD_CHAN=UNT; OPEN (CMD_CHAN,ERR=*BREAK)FIND_DIR$
1405 NEXT_FTP:
1407 READ (CMD_CHAN,END=1600)NEXT_FILE$
1410 IF STP(A$(41,60),3," ")<>"" AND STP(A$(102,15),3," ")<>"" AND STP(A$(117,20),3," ")<>"" THEN {! 1550
1420 INVOKE "rm -f $HOME/.netrc"
1425 TMP_RC$="netrc"+FID(0),TMP_SCR$="ftpscript"+FID(0)
1427 ERASE TMP_RC$,ERR=*NEXT
1430 SERIAL TMP_RC$
1432 ERASE TMP_SCR$,ERR=*NEXT
1435 SERIAL TMP_SCR$
1440 TMP_CH=UNT; OPEN LOCK (TMP_CH,OPT="TEXT")TMP_RC$
1445 TMP_CH_PTH$=PTH(TMP_CH)
1450 PRINT (TMP_CH)"machine "+STP(A$(41,60),3," ")+EOL$
1455 PRINT (TMP_CH)"login "+STP(A$(102,15),3," ")+EOL$
1460 PRINT (TMP_CH)"password "+STP(A$(117,20),3," ")+EOL$
1470 CLOSE (TMP_CH); OPEN LOCK (TMP_CH,OPT="TEXT")TMP_SCR$
1480 PRINT (TMP_CH)"mv "+TMP_CH_PTH$+" $HOME/.netrc"+E0L$
1485 PRINT (TMP_CH)"chmod 600 $HOME/.netrc"+EOL$
1490 PRINT (TMP_CH)"ftp -i "+STP(A$(41,60),3," ")+" << EOF"+EOL$
1492 REM PRINT (TMP_CH)"idle 30"+EOL$
1495 PRINT (TMP_CH)"binary"+EOL$
1500 PRINT (TMP_CH)"put "+FROM_DIR$+NEXT_FILE$+" "+TO_DIR$+NEXT_FILE$+EOL$
1510 PRINT (TMP_CH)"get "+TO_DIR$+NEXT_FILE$+" "+FROM_DIR$+NEXT_FILE$+".FTPRCV"+EOL$
1520 PRINT (TMP_CH)"EOF"+EOL$
1522 PRINT (TMP_CH)"if [ -f "+FROM_DIR$+NEXT_FILE$+".FTPRCV ]"; PRINT (TMP_CH)"then"; PRINT (TMP_CH)"rm -f "+FROM_DIR$+NEXT_FILE$+"*"; PRINT (TMP_CH)"fi"
1524 TMP_CH$=PTH(TMP_CH)
1525 CLOSE (TMP_CH)
1530 INVOKE "chmod 700 "+TMP_CH$
1535 INVOKE TMP_CH$
1550  } ! 1410
1590 GOTO NEXT_FTP
1610 CLOSE (CMD_CHAN)
1650 BREAK
2000 CASE "CR" ! 4100 break ! cust report
2010 IF CHKDATE$<>X3$(21,6) THEN {! 4090
2020 READ (Z[2],KEY=A$(31,6)+A$(371,12),DOM=*BREAK)IOL=0310,IOL=0490
2030 T9$="123456789"
2040 OVER$="N"
2050 SWITCH A$(31,6) ! PARAMETER OVERRIDE ! 2990 END SWITCH
2060 CASE "FM2CEA"
2070 W$(1,10)=A$(8,10),W$(21,10)=A$(8,10),OVER$="Y",L0$="IC1   ",T0=1; T0$=L0$
2080 BREAK
2090 CASE "FM2CIA"
2100 W$(1,10)=A$(8,10),W$(21,10)=A$(8,10),OVER$="Y",L0$="IC1   ",T0=1; T0$=L0$
2110 BREAK
2120 CASE "FM2TBA"
2130 W$(1,10)=A$(8,10),W$(11,10)=A$(8,10),OVER$="Y",L0$="FM1   ",T0=1,T0$=L0$
2140 BREAK
2990 END SWITCH ! 2050
3005 IF OVER$="Y" AND STP(A$(137,60),3," ")<>"" THEN {! 3090 }
3010 T1$=L0$((T0-1)*6+1,6),K$=X3$(1,8)
3020 ZZP=UNT; OPEN (ZZP)"ZZP"
3030 WRITE (ZZP,KEY=K$)X3$,X4$,T1$,R0$,W$,IOL=0310
3040 CLOSE (ZZP)
3050 IF POS("\"=A$(137,60))<>0 THEN SEP$="\" ELSE SEP$="/"
3060 %EML_PDF_PATH$=STP(A$(137,60),3," "); IF %EML_PDF_PATH$(LEN(%EML_PDF_PATH$),1)<>SEP$ THEN %EML_PDF_PATH$=%EML_PDF_PATH$+SEP$
3080 %UNATTEND=1; CALL A$(31,6),ERR=*NEXT
3081 %UNATTEND=0
3090  } ! 3005
4090  } ! 2010
4100 BREAK ! 2000
7850 END SWITCH ! 1110
7900  } ! 1100
7950 CALL "UPDEML;READNEXT",Z[1],A$,A{ALL},FOUND
7980 WEND ! 1000
7985 CALL "ZZ2SEP",ERR=*NEXT,X3$,X4$,"","*" ! Scheduled Email Processing
7990 GOTO 9900
7998 ! 
7999 ! 
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9905 PRINT @(0,20),'CL',
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
10000 EMAIL_REPORT:
10005 CMD_CHAN=UNT; OPEN (CMD_CHAN,ERR=*RETURN)FIND_DIR$
10010 NEXT_EMAIL2:
10015 ERRORMESG$=""
10020 READ (CMD_CHAN,END=END_OF_EMAIL)NEXT_FILE$
10030 NEXT_FILE$=STP(NEXT_FILE$,3," ")
10035 CHK_CHAN=UNT; OPEN (CHK_CHAN,ERR=NEXT_EMAIL2)FROM_DIR$+NEXT_FILE$; CHK_SIZE$=FIN(CHK_CHAN); CLOSE (CHK_CHAN); CHK_SIZE=DEC(CHK_SIZE$(1,4))
10050 IF FILE_SIZE=0 OR CHK_SIZE>FILE_SIZE THEN {! 10105
10065 SUBJECT$=STP(A$(261,50),3," ")
10070 IF STP(A$(41,60),3," ")<>"" AND STP(EML_P$(7,60),3," ")<>"" THEN {
10075 FROMADDRESS$=STP(A$(311,60),2); REPLYADDRESS$=FROMADDRESS$
10080 TOADDRESS$=STP(A$(41,60),3," "),SMTPSERVER$=STP(EML_P$(7,60),3," ")
10085 CCADDRESS$="",BCCADDRESS$="",SUBJECT$=STP(A$(261,50),2),MESSAGE$=""
10087 ERASEIT=1
10090 CALL "*web/email",FROMADDRESS$,REPLYADDRESS$,TOADDRESS$,CCADDRESS$,BCCADDRESS$,SUBJECT$,MESSAGE$,FROM_DIR$+NEXT_FILE$,"N",SMTPSERVER$,SERVERTIMEOUT,LINEWRAPSAT,BODYENCODING$,ERASEIT,ERRORMESG$
10100  }
10105  } ! 10050
10110 IF ERRORMESG$="" THEN INVOKE "rm -f "+FROM_DIR$+NEXT_FILE$
10120 GOTO NEXT_EMAIL2
10150 END_OF_EMAIL:
10160 CLOSE (CMD_CHAN)
10185 FILE_SIZE=0
10190 RETURN 
10198 ! 
10199 ! 
56000 REM "5.4 - 06/15/05 - 14.091666 - jme - SSP# 183203
56001 REM "186852-Email Order Shipping Confirmations                          
56005 REM "192290-Shipping confirmation email was not sent to buyer.          
