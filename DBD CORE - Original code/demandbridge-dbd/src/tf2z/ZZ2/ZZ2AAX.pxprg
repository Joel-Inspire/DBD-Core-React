0010 REM "<ZZ2AAX> Create Program File from Compiled Code
0015 REM "LEVEL: U1-2.5
0030 REM "(C) 1985,1986 Basic Ideas, Inc; Atlanta, Ga.
0035 REM "3.9 - 11/29/95 - 9.73 - kmc
0040 REM "Copyright 1995 Computer Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0042 REM F0$=Program Name
0043 REM A0$ = Compiled statements 1st three bytes = length of line
0044 REM x1 = start of program line
0045 REM x0 = program line number
0046 REM P5$ = PRG HEADER REMARK LINE
0050 ENTER F0$,A0$,X3$,X4$,O9,T0$,D0
0080 PRINT @(0,7),'CE',
0100 ! 
0300 MAKE_REMARK_LINE:
0320 IF T0$="" THEN GOTO MAIN ELSE A$="15REM"+$22$+"Prog Type: "+T0$(1,2)+"-"
0325 F9=NUM(X3$(60,3))
0330 CLOSE (F9); OPEN (F9)"ZZPARM"
0340 FIND (F9,KEY="INSTALL")I0$; A$=A$+I0$(64,8)
0350 CODE$=CPL(A$),A0$=A0$+BIN(LEN(CODE$),3)+CODE$,A$="",T0$=""
0360 ! 
1000 ! check if file exists and merge or create
1010 MAIN:
1020 CLOSE (F9); OPEN (F9,ERR=MAKE_LAST_LINE)F0$
1030 GOSUB READ_FIRST_REMARK
1040 IF POS("A"=X4$)>0 THEN GOTO 1140 ELSE PRINT @(0,21),'CE',@(1,21),"Description: ",P5$,
1050 REM CALL "ZZPROM","Y",X3$,A,"Program already defined.  Replace with new version? ","","",0;      ON A GOTO 1140,9900
1140 PRINT @(0,21),'CE',; GOSUB MERGE_PRG_CODE
1150 F0$=FID(F9); CLOSE (F9)
1160 ERASE F0$(4,6)+F0$(21,2),ERR=*NEXT; GOTO *SAME
1185 F0$=F0$(4,6)+F0$(21,2)
1200 ! 
1201 MAKE_LAST_LINE:
1210 CODE$=CPL("9999END"),A0$=A0$+BIN(LEN(CODE$),3)+CODE$+$FFFFFFFFFF$,P0$=P$,E7$=""
1260 PRINT @(0,7),'CE',@(12,7),"Information being sorted... ",F0$
1275 GOTO 1286
1280 ! 
1281 ERASE "ZZ0S"+FID(0),ERR=*NEXT; GOTO *SAME
1285 DIRECT "ZZ0S"+FID(0),4,200,12
1310 ! 
1311 S0$=""
1320 X=1,A1=0,R9=1
1335 A1=A1+1
1340 IF X+5>LEN(A0$) THEN GOTO 1430
1345 X1=DEC(A0$(X,3))+3,X0=DEC(A0$(X+3,2))
1350 IF A0$(X+5,1)=$44$ THEN T0$=T0$+A0$(X+8,1)+A0$(X+3,2)
1410 GOSUB SORT_PRG_LINES
1415 PRINT ".",
1420 X=X+X1,R9=R9+X1; IF X1<254 THEN R9=R9-2
1425 IF A0$(X,3)<>$FFFFFF$ THEN GOTO 1336
1426 ! 
1430 SETERR 0000
1431 CLOSE (14)
1432 R0=R9+1000,B=1
1433 ERASE F0$,ERR=*NEXT
1435 SERIAL F0$
1440 A2=-1,A5=0
1450 CLOSE (F9); OPEN LOCK (F9)F0$
1460 PRINT @(0,7),'CE',@(12,7),"Writing information to disk: ",F0$
1500 S1$=S0$(1,7),S0$=S0$(8),X=DEC($00$+S1$(1,2)),X0=DEC(S1$(3,3)),X1=DEC(S1$(6,2))
1505 Q$=A0$(X0+3,X1-3) ! LET Q$=PFP(Q$,SYMTAB$); IF O9>0 THEN LET Q$=Q$+$E0$
1506 GOTO 1508
1508 A0=LEN(Q$)+1; IF A0>255 THEN A0=A0+2,Q$=BIN(A0,3)+Q$ ELSE Q$=CHR(A0)+Q$
1510 PRINT ".",
1545 IF A0>255 THEN PLINE$=LST(Q$(4)) ELSE PLINE$=LST(Q$(2))
1550 PRINT (F9)PLINE$; IF LEN(S0$)>=7 THEN GOTO 1500
1600 ! 
1770 A0=0,A0$=""
1775 CLOSE (F9)
1790 GOTO 9900
1800 ! 
1801 MERGE_PRG_CODE:
1805 IF POS("X"=X4$)>0 THEN GOTO 1890
1820 CALL "ZZ2BA8",F0$,7500,8999,14,A0$
1825 SETERR 9000
1890 RETURN 
2001 ! 
2002 READ_FIRST_REMARK:
2010 P5$="",F$=FID(F9)
2030 READ RECORD (F9,IND=0)P5$
2050 SETERR 2100
2070 P=13+ASC(P5$(12,1))*3,P5$=P5$(P)
2075 P=ASC(P5$),P5$=LST(P5$(2,P-1))
2085 IF POS("REM"=P5$)>0 THEN P5$=P5$(11)
2088 P=POS("<"=P5$); IF P>0 THEN P5$=P5$(1,P-1)
2090 SETERR 9000
2095 RETURN 
2100 P5$="** UNABLE TO GET FIRST PROGRAM LINE **"
2110 GOTO 2090
2500 ! 
2501 SORT_PRG_LINES:
2510 IF X0=0 THEN RETURN ELSE S1$=BIN(X0,3)+BIN(X,3)+BIN(X1,2),S1$=S1$(2)
2520 IF S0$="" THEN S0$=S1$; RETURN 
2530 P=POS(S1$(1,2)=S0$,7); IF P>0 THEN S0$(P,7)=S1$; RETURN ELSE P=POS(S1$(1,2)<=S0$,7); IF P=0 THEN S0$=S0$+S1$; RETURN 
2540 S0$=S0$(1,P-1)+S1$+S0$(P); RETURN 
9000 REM "ERROR ROUTINE
9005 E0=ERR,E1=TCB(5)
9010 CALL "ZZPROM","4",X3$,A,"ERROR "+STR(E0)+" IN DEVELOPMENT PROGRAM SORT"+", LINE: "+STR(E1)+". PRESS |RETURN TO EXIT","","",0
9035 EXIT ERR
9510 SETESC 9550
9520 CALL "ZZPROM","5",X3$,A,"ESCAPE DETECTED IN DEVELOPMENT PROGRAM SORT. "+"PRESS |RETURN OR TYPE |END","","",0
9530 ON A GOTO 9540,9550
9540 RETURN 
9550 EXIT 27
9900 REM "
9910 PRINT @(0,7),'CE',
9950 EXIT 
9999 END 
