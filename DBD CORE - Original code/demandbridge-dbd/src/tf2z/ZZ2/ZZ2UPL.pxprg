0010 REM "Update Lock Management <ZZ2UPL>
0020 SETESC 9300; SETERR 9000
0035 REM "5.1 - 05/09/02 - 15.586111 - kmc - SSP# 121993
0040 REM "Copyright 2002 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 ! COMMAND$->A=Add lock, D=Delete lock, C=check lock
0051 ! RET$->Y if ok, otherwise not ok
0060 ! record layout - 1,10="LOCK"+6 char prog name, 11,10=str of PID
0061 ! 21,10=uid, 31,8=fid(0), 39,30=date/time message 69,30=prog description
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,UPDATE_CODE$,COMMAND$,RET$
0100 SETERR 9000
0110 X0$="ZZ2UPL",X1$="Update Lock Management"
0500 REM "FILES                                                            
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0600 ! initialize
0605 RET$=""
0610 GOSUB SET_VALUES ! set all values needed based on UPDATE_CODE$
1000 ! Determine what to do
1010 SWITCH COMMAND$
1020 CASE "A"
1022 GOSUB ADD_LOCK
1024 BREAK
1030 CASE "D"
1032 GOSUB DELETE_LOCK
1034 BREAK
1040 CASE "C"
1042 GOSUB CHECK_LOCK
1044 BREAK
1080 END SWITCH 
1095 GOTO 9900
2000 ! ^100,5 Add a lock
2005 ADD_LOCK:
2010 DIM LOCK$(100)
2015 LOCK$(1,10)="LOCK"+UPDATE_CODE$; LOCK$(11,10)=STR(TCB(89)); LOCK$(21,10)=UID; LOCK$(31,8)=FID(0); LOCK$(39,30)=FN%PRINT_DATETIME$(0,"%Mz-%Dz-%Y at %Hz:%mz:%sz"); LOCK$(69,30)=PROG_DESC$
2030 WRITE (Z[13],KEY=LOCK$(1,10),DOM=*NEXT)LOCK$; RET$="Y"; GOTO ADD_OK
2035 READ (Z[13],KEY=LOCK$(1,10),DOM=2030)LOCK$
2037 GOSUB UPDATE_IN_PROGRESS; RETURN 
2040 ADD_OK:
2095 RETURN 
2099 ! 
2100 ! ^100,5 Delete a lock 
2105 DELETE_LOCK:
2110 DIM LOCK$(100); LOCK$(1,10)="LOCK"+UPDATE_CODE$
2115 REMOVE (Z[13],KEY=LOCK$(1,10),DOM=*NEXT)
2120 RET$="Y"
2195 RETURN 
2199 ! 
2200 ! ^100,5 Check if lock set
2205 CHECK_LOCK:
2210 DIM LOCK$(100); LOCK$(1,10)="LOCK"+UPDATE_CODE$
2215 RET$="Y"
2225 FIND (Z[13],KEY=LOCK$(1,10),DOM=*NEXT); GOSUB UPDATE_IN_PROGRESS
2295 RETURN 
2299 ! 
2400 ! ^100,5 Add program description to LOCK$(69,30)
2405 SET_VALUES:
2410 SWITCH UPDATE_CODE$
2415 CASE "AR2UAA"; PROG_DESC$="A/R Period End Update"; BREAK
2480 END SWITCH 
2495 RETURN 
2499 ! 
2500 ! ^100,5 Give update in progress message and leave - Assumes LOCK$ contains the record
2505 UPDATE_IN_PROGRESS:
2510 PRINT @(0,21),'CE',@(0,21),STP(LOCK$(69,30))," is running",
2520 TMP$="Started "+STP(LOCK$(39,30))+" by "+STP(LOCK$(21,10))+" (PID="+STP(LOCK$(11,10))+")"
2530 CALL "ZZPROM",".4",X3$,Z,TMP$,"","",0
2540 RET$="U"
2595 RETURN 
2599 ! 
9000 REM "ERROR PROCESSING                                                 
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL                                
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC                                       
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM                                      
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
