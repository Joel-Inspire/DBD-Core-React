0010 REM "Expand Files Module <ZZEXPF>
0030 REM "(C) 1985-1989 Basic Ideas, Inc; Atlanta, Ga.
0035 REM "5.5 - 06/09/06 - 16.720833 - tma - SSP# 196868
0037 REM "196868-In Cash Receipts update says a file needs to be expanded.   
0040 REM "Copyright 2006 TopForm Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0050 ! Q0$ = ACTIONCODE + PERCENT, Q2$ & X = DEVICE, Q1$ = FILENAME
0060 ! X0 = RETURN CODE
0260 IOLIST P$,P[0,0],P[0,1],P[1,0],P[1,1],P[2,0],P[2,1],P[3,0],P[3,1],P[4,0],P[4,1],P[5,0],P[5,1]
0290 IOLIST Y[0],Y[1],Y[2],Y[3],Y[4]
1020 SETERR 1040; ENTER X3$,X4$,Q0$,Q2$,X0; F0=NUM(X3$(60,3)); SETERR 9000; GOTO 1050
1040 IF X3$="?" THEN CALL "ZZPDOC","ZZEXPF"; EXIT ELSE EXIT 36
1050 ! ^ 1000
1060 GET_DEVICE_AND_FILENAME:
1110 IF POS("X"=Q0$)=0 AND POS("A"=Q0$)=0 THEN GOTO CHECK_OPEN_DEVICES
1112 IF LEN(Q0$)>2 THEN IF Q0$(1,1)="N" AND Q0$(2,1)="A" AND FN%NMV(Q0$(3))<>0 THEN NO_AUTOEXPAND=1,Q0$=Q0$(2)
1115 IF Q0$(1,1)="X" THEN X=NUM(Q0$(2)) ELSE X=NUM(Q2$,ERR=1200)
1120 Q1$=FID(X,ERR=CHECK_OPEN_DEVICES)
1121 IF LEN(Q1$)=2 THEN GOTO CHECK_OPEN_DEVICES ELSE Q1$=Q1$(4,6)+Q1$(21,2)
1130 GOTO OPEN_FILES
1140 ! 
1150 ! ^ 1200
1210 CHECK_OPEN_DEVICES:
1211 IF POS("?"=Q0$)=0 THEN GOTO OPEN_FILES
1215 X=0
1220 LOOK_AT_NEXT:
1221 X=X+1; IF X>NUM(X3$(60,3)) THEN GOTO 9900
1230 Q1$=FID(X,ERR=LOOK_AT_NEXT); IF LEN(Q1$)=2 THEN GOTO LOOK_AT_NEXT ELSE Q1$=Q1$(4,6)+Q1$(21,2)
1240 CALL "ZZINFO",ERR=LOOK_AT_NEXT,X,Q,X3$,RECS_USED,RECS_MAX,0,0,0,FILETYPE,0,""
1250 IF RECS_MAX=O OR RECS_USED<RECS_MAX OR FILETYPE>3 THEN GOTO LOOK_AT_NEXT ELSE X0=X,Z3=RECS_MAX
1320 IF POS("ZZE"=Q1$)=1 THEN CALL "ZZPROM",".4",X3$,0,"File ZZE must be manually expanded","","",0; GOTO 9900
1500 ! ^ 1500
1501 OPEN_FILES:
1506 F$="01L "+Q1$+"  "+"02OSZZE     "
1510 DIM F[NUM(X3$(60,3))],Z[4]
1520 CALL "ZZFLES",X3$,Y1$,Y0$,F$,F{ALL},Z0,0; ON Z0 GOTO *NEXT,2900
1525 IF Q0$>"" THEN F[1]=X ELSE X=F[1]
1540 CALL "ZZINFO",X,X0,X3$,Z3,Z4,Z1,Z2,Z5,0,0,""; ON X0 GOTO 1545,2900
1545 D1=Z3; IF Z1=0 THEN D1=Z4
1550 READ (F[2],KEY=Q1$,DOM=1560)O$; O$=O$(7,40); GOTO 1590
1560 READ (F[2],ERR=1561,KEY=Q1$(1,3)+"   ")O$; O$=O$(7,40)
1605 M$=STR(Z3)+"/"+STR(Z4)+"%"; IF X0<>0 THEN M$=M$+" >"+STR(X0)
1680 O$=STP(O$,3); IF O$>"" THEN M$=STP(Q1$,3)+", "+O$+", "+M$ ELSE M$=STP(Q1$,3)+", "+M$
1690 M$="+( "+M$+")"
1700 GOSUB 6000
1704 Z9=INT(Z3/30); IF Z9=0 THEN Z9=1
1705 IF Z1>0 AND NO_AUTOEXPAND=0 THEN Z[0]=0; GOTO 2000; REM "If 8 is in the options field then make the file an auto expanding file (leve 8.3.1)
1710 IF POS("A"=Q0$+A0$)>0 THEN GOTO 1800
1735 CALL "ZZPROM","X0ZZEXPF",X3$,S3,M$,"","",0; ON S3 GOTO 1800,2900
1800 ! ^ 1800
1801 Z9=INT(Z3/30); IF Z9=0 THEN Z9=1
1805 P=POS("A"=Q0$); IF P>0 THEN IF LEN(Q0$)>P THEN Z[0]=NUM(Q0$(P+1)); GOTO 2000
1815 IF POS("A"=Q0$+A0$)>0 THEN GOTO 2000
1820 PRINT @(0,22),"Old no. of records: ",Z3:"###,##0","  New no. of records: ",
1830 CALL "ZZENTR","NX",Z{ALL},"","",X3$,49,22,0,0,C0,"#,###,##0","","","","","",""; IF C0<>-1 THEN IF C0<0 THEN GOTO 2900
1840 IF Z[0]<Z3 THEN GOTO 1820
1850 REM IF Z[0]>=50000 THEN CALL "ZZPROM",".Y",X3$,Q,"WHOA! Dat's a whole lotta records.  Are you sure?","","",0; ON Q GOTO 01851,01820
2010 ! 
2011 F0$="EX1"+X3$(1,2),R=0
2015 ERASE F0$,ERR=2016; GOTO 2015
2020 IF Z1=0 THEN INDEXED F0$,Z[0],Z2,ERR=2021 ELSE IF Z2>0 THEN DIRECT F0$,Z1,Z[0],Z2,ERR=2021 ELSE SORT F0$,Z1,Z[0]
2050 F$="02C ZZE...  02X "+F0$+"  "
2060 CALL "ZZFLES",X3$,Y1$,Y0$,F$,F{ALL},Z0,0; ON Z0 GOTO 2061,2900
2100 PRINT @(0,21),M$(2),
2110 IF POS("A"=Q0$+A0$)>0 THEN GOTO 2150
2120 CALL "ZZPROM","X2ZZEXPF",X3$,A,"","","",0; ON A GOTO 2150,2900
2150 CALL "ZZPROM","X3ZZEXPF",X3$,0,X9$,"","",0
2402 IF Z1>0 THEN Z3=Z3+1 ELSE DIM Y[4]
2405 PRINT @(0,22),'CE',X9$," ",O$,@(0,23),"Progress: ",
2410 IF Z1>0 THEN EXTRACT (F[1],KEY="",DOM=2420) ELSE EXTRACT (F[1],IND=0)IOL=0290
2420 IF Z1>0 THEN K$=KEY(F[1],END=2490) ELSE K$="Record# "+STR(R:"###,##0")
2430 READ RECORD (F[1],END=2490)A$
2440 IF Z1>0 AND Z2>0 THEN WRITE RECORD (F[2],KEY=K$)A$ ELSE IF Z1>0 AND Z2=0 THEN WRITE (F[2],KEY=K$) ELSE WRITE RECORD (F[2])A$
2445 R=R+1; REM IF MOD(R,100)=0 THEN PRINT @(0,23),R*100/Z3:"##0.0","%",@(24,23),K$,
2446 REM "IF MOD(r,z9)=0 THEN CALL "ZZBARG",x3$,"HG",23,12,30,d0,d1,r
2450 GOTO 2420
2490 PRINT @(0,22),'CE',; CALL "ZZPROM","X4ZZEXPF",X3$,0,"","","",0
2505 CLOSE (F[1]); CLOSE (F[2]); F2$="EX2"+X3$(1,2)
2509 REM "GET RID OF OLD VERSION OF THIS FILE
2510 ERASE F2$,ERR=2511; GOTO 2510
2515 Q1$=STP(Q1$,1)
2520 RENAME Q1$,F2$
2530 RENAME F0$,Q1$
2540 ERASE F2$
2550 OPEN (F[1])Q1$
2555 X0=0
2560 IF Z1=0 THEN F=F[1]; GOSUB WRITE_INDEX_KEY
2590 PRINT @(0,21),'CE',
2595 GOTO 9900
2910 ! ^ 2900
2920 X0=1
2990 GOTO 9900
4020 ! ^ 4000
4030 FOR X=0 TO Z4-1
5220 ! ^ 5200 SORT FILE KEY REC
5221 WRITE_INDEX_KEY:
5222 Z=NUM(FIN(F,"MAXREC")); Y[3]=Z-1
5230 Y[4]=-1; WRITE (F,IND=0)IOL=0290
5290 RETURN 
6000 ! ^ 6000
6001 REM "GET SUGGESTED NUMBER OF RECORDS
6004 IF Q1$="ZZPARM  " THEN DIM P[5,1]; READ (F[1],KEY="ZZEXPF",DOM=0690)IOL=0260; P$=P$(7); GOTO 6006; REM "Special logic if ZZPARM is the file being expanded
6005 CLOSE (F0); OPEN (F0)"ZZPARM"; DIM P[5,1]; READ (F0,KEY="ZZEXPF",DOM=6090)IOL=0260; P$=P$(7)
6010 IF P$="" THEN Z[0]=INT(Z3*1.2+50); GOTO 6090 ELSE IF Z1>0 THEN Q=Z3,X5=0 ELSE IF Z1<=0 THEN Q=Z4,X5=0
6015 IF Q<P[X5,0] OR X5=5 THEN Q=Q+INT(Q*P[X5,1]/100); GOTO 6050 ELSE X5=X5+1; GOTO 6015
6050 IF MOD(Q,10)<>0 THEN Q=10*INT(1+Q/10)
6052 IF Q<10 THEN Q=10
6055 Z[0]=Q; IF P$(X5+1,1)="1" THEN A0$="A" ELSE A0$=""
6095 RETURN 
9010 ! ^ 9000
9020 E0=ERR,E1=TCB(5)
9040 CALL "ZZERRM",E0$,"ZZEXPF",E1$,X3$,E0,E1,E2,E3,0
9050 ON E2 GOTO 9060,9100,9900,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE E1$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9180 GOTO 9000
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)<>"1" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9920 IF %GUI THEN PRINT (0,ERR=*NEXT)'GOTO'(200),'POP'
9940 EXIT 
9999 END 
