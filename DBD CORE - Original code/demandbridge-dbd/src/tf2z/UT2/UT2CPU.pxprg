0010 REM "Changed Program Utility <UT2CPU>
0020 SETESC 9300; SETERR 9000
0035 REM "3.3 - 10/13/90 - 12.16
0040 REM "Copyright 1990 Computer Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0045 REM "Recommended sizes for PGMCHECK:
0046 REM "  For Unix, DIRECT "PGMCHECK",20,1100,32,8,0
0047 REM "  For Tos,  DIRECT "PGMCHECK",9,1100,32,8,0
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,Q0$,Q1$
0100 SETERR 9000
0110 X0$="UT2CPU",X1$="Changed Program Utility"
0120 DIM Z0$(80,"-")
0135 C9=-1
0140 H=0,L1=7,L=L1,H1=0
0200 REM "
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0249 D9$="../"
0250 DIM V9$(20); V9$(1,10)="tf2p",V9$(11,10)="tf2z"
0251 DIM V9$(20); V9$(1,10)="tf2p"
0295 DIM Z0$(80,X3$(235,1)); Z0$=MNM('GS')+Z0$+MNM('GE')
0300 REM "IOLISTS
0500 REM "FILES
0505 DIM Z[NUM(X3$(60,3))]
0510 Z$="12O PGMCHECK  13O ZZPARM  "
0520 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0521,9900
0600 REM "
0610 CALL "ZZPROM",".Y",X3$,A9,"Do you want to clear Program Check file and rebuild it?","","",0
0615 IF A9=0 THEN PRINT @(5,L1-4),"**** Program check file will be cleared - Date is ",DAY,"  ",TIM,"  ****", ELSE GOSUB 7500
0620 CALL "ZZPROM",".Y",X3$,Z,"Proceed?","","",0; ON Z GOTO 0621,9900
0625 IF A9=0 THEN CALL "ZZINIT",STR(Z[12]:"00"); WRITE (Z[12],KEY="")DAY,TIM
0720 IF X3$(77,1)<>"T" THEN Z$="01O "+D9$+FNS$(V9$(1,10))+"  02O "+D9$+FNS$(V9$(11,10))+"  " ELSE Z$="01O D1   02O D2   11O *VBU   "
0730 IF X3$(77,1)<>"Y" THEN Z$="01O D1  "
0740 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 0741,9900
0750 IF X3$(77,1)<>"T" THEN CLOSE (14); OPEN (14)"D1"; D8$=FID(14),D8$=FNS$(D8$(4,6)+D8$(21))
0760 IF D8$(1,6)="/usr1/" THEN D8$=D8$(1,6)+D8$(7,POS("/"=D8$(7))) ELSE D8$=D8$(1,POS("/"=D8$))
0920 IF A9=1 THEN PRINT 'SB',@(20,L1-2),"Now Processing:",'SF',; IF X3$(77,1)="T" THEN CALL "ZZINIT",STR(Z[11]:"00") ELSE INVOKE "rm "+D8$+"bulist"
0930 PRINT @(0,L1-3),Z0$,
0940 IF A9=1 THEN PRINT @(0,L1-1),Z0$, ELSE PRINT @(0,L1-4),'CL',@(30,L1-4),"Program count:",; L1=L1-2,L=L1
1000 REM "X3$(77,1)=T means TOS, otherwise Unix
1020 IF X3$(77,1)<>"T" THEN GOTO 1200
1040 F=Z[1],V$="1"; GOSUB 2000
1060 F=Z[2],V$="2"; GOSUB 2000
1080 GOTO 5000
1200 REM "Unix system"
1220 F=Z[1],V$=FNS$(V9$(1,10))+"/"; GOSUB 2200
1230 CLOSE (F); CLOSE (9); CLOSE (5); DISABLE (1)
1235 GOTO 1250
1240 F=Z[2],V$=FNS$(V9$(11,10))+"/"; GOSUB 2200
1250 ENABLE (1)
1260 GOTO 5000
2000 REM "TOS System
2010 V1$=V$
2020 K$=KEY(F,END=2080); K$=K$(1,8); READ (F)
2040 GOSUB 2500
2060 GOTO 2020
2080 RETURN 
2200 REM "Unix System"
2220 READ RECORD (F,END=2390)K$
2240 K$=FNZ$(K$)
2260 IF LEN(K$)=3 THEN CLOSE (5); OPEN (5,ERR=2220)"///"+K$ ELSE GOTO 2220
2270 V1$=V$+K$+"/"
2280 READ RECORD (5,END=2220)K$; K$=FNZ$(K$)
2300 GOSUB 2500
2320 GOTO 2280
2390 RETURN 
2500 REM "Process sub-DIRectory"
2520 CLOSE (9); OPEN (9,ERR=2690)K$
2540 F$=FID(9); IF F$(10,1)<>$04$ THEN GOTO 2690
2560 E8$=$00$,E9=0; READ RECORD (9,END=2561)A$; E9=DEC(A$(1,3)); E9$=CRC(A$)
2580 READ RECORD (9,END=2581)A$; E9$=CRC(A$+E9$); GOTO 2580
2590 H1=H1+1; IF A9=1 THEN GOTO 2700
2600 WRITE (Z[12],KEY=V1$+K$)V1$+K$,HTA(E9$),E9
2625 PRINT @(45,L1-2),H1,
2650 PRINT @(H,L),V1$,K$,"  ",E9:"##,##0",
2660 H=H+25; IF H=75 THEN H=0,L=L+1; IF L>20 THEN L=20; PRINT @(0,L1),'LD',
2690 RETURN 
2700 REM "Check for changes mode"
2705 PRINT @(35,L1-2)," ",H1,"  ",V1$+K$,"        ",
2710 V2$=" New"; FIND (Z[12],DOM=2727,KEY=V1$+K$)*,E8$,E8
2720 IF E8$=HTA(E9$) AND E8=E9 THEN GOTO 2790
2725 V2$=" Changed"
2727 IF LEN(K$)>6 THEN IF K$(7,1)="X" THEN GOTO 2740
2728 IF K$(1,1)="*" THEN GOTO 2740
2730 IF X3$(77,1)="T" THEN WRITE (Z[11],KEY=V1$+K$) ELSE INVOKE "ls "+D8$+V1$+K$+" >>"+D8$+"bulist"
2740 PRINT @(H,L),V1$,K$,V2$,
2780 GOTO 2660
2790 RETURN 
5000 REM "EOJ"
5010 IF A9=1 THEN PRINT @(0,L1-2),'CL',
5015 IF A9=0 THEN X$="Program check file PGMCHECK has been created" ELSE X$="Use{      cpio -ovcB <bulist >/dev/rxxx     }to backup changed programs"
5020 CALL "ZZPROM",".4",X3$,0,X$,"","",0
5060 GOTO 9900
7500 REM "Check mode
7510 FIND (Z[12],KEY="",DOM=7540)D$,T$
7520 PRINT @(10,L1-4),"Programs will be checked against those as of ",D$," ",T$,
7530 RETURN 
7540 CALL "ZZPROM",".4",X3$,0,"Error - Program check file is clear!!!","","",0
7550 EXITTO 9900
8950 DEF FNZ$(Z9$)=Z9$(3,POS($0000$=Z9$(3,8)+$0000$)-1)
8960 DEF FNS$(Z9$)=Z9$(1,POS("        "=Z9$+"        ")-1)
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
