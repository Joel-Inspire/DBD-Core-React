0010 REM "Unpack all packed data <UT2CV2>
0030 REM "(C) 1985,1986 Basic Ideas, Inc; Atlanta, Ga.
0035 REM "5.7 - 04/16/12 - 16.662777 - tma - SSP# 254273
0037 REM "254273-UT2CV2 - Unpack stat file utility - Change verbage from     
0040 REM "Copyright 2012 Demand Bridge, LLC.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0090 CLEAR ; SETERR 0100; ENTER X3$,X4$,Q0$,Q1$
0100 SETERR 9000
0110 X0$="UT2CV2",X1$="Convert Packed Data "
0120 DIM Z0$(80,"-")
0130 K0=20,K1=1
0135 C9=-1
0140 PACK$="AP9APSARXASFASTAR9ARAFM3FSWGL3IC9" ! SSP#254109
0150 STAT$="A/PAPSARXASFASTA/RAR3F/MFM1G/LI/C" ! SSP#254109
0160 Z9$=Z9$(1,POS("  "=Z9$+"  ")-1)
0200 REM "
0240 CALL "ZZCOMP",X0$,X1$,X2$,X3$,X4$,M9$,X0,X1,X2; IF X1>0 THEN GOTO 9920
0245 IF X3$(66,1)>"2" THEN PRECISION NUM(X3$(66,1),ERR=0246)
0295 DIM Z0$(80,X3$(235,1)); Z0$=MNM('GS')+Z0$+MNM('GE')
0300 REM "IOLISTS
0310 IOLIST P9$,M[0],M[1],M[2],M[3],M[4],M[5],M[6],M[7],M[8],M[9],M[10],M[11],M[12],M[13],M[14]
0510 DIM Z[NUM(X3$(60,3))]
0530 DIM M[14]
0600 REM 
0610 GOSUB 6000
0640 IF Q1$="" THEN CALL "ZZPROM",".Y",X3$,Z,"Proceed?","","",0; ON Z GOTO 0641,9900
0890 SETERR 9500
0900 REM "X3$=Control, Q$="READ,WRITE", M0$=Mask (default to "")
0901 REM "M1$=Packed array, M0=Array len (default to 13), M1=bytes/entry
0902 REM " M(all) is array, F0 is physical file to read/write
0903 REM "Q0$=stat type, Q1$=Key, S9$=Params
1000 PRINT @(0,4),'CE'
1010 DIM S$(20)
1013 M1=5
1014 M0$="92"
1015 M0=14
1016 Q$="R"
1017 Q=1
1018 M8=NUM(M0$(1,1)),M9=NUM(M0$(2,1)); PRECISION M9; M9=10^M9
1100 REM "BEGIN PROCESS
1110 FOR X1=1 TO LEN(PACK$)/3
1200 REM "PROCESS DATA
1210 NAME$=PACK$(X1*3-2,3),STATNAME$=STAT$(X1*3-2,3)
1212 Z$="01C  01O "+NAME$+"...  04O ZA0...  02C  "
1215 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 1216,9900
1220 LOCK (Z[1],ERR=1400)
1225 GOSUB 8100
1230 GOSUB 3000; REM CREATE TEMPORARY UNPACKED FILE & OPEN ON CHANNEL 2
1235 IF F9$(34,1)="U" THEN GOTO 1380; REM "SKIP IF ALREADY UNPACKED
1240 P9$=KEY(Z[1],END=1340)
1250 DIM M[14]
1255 READ RECORD (Z[1],KEY=P9$)M1$
1256 IF M1$(1,7)="0023200" THEN ESCAPE 
1260 C=C+1; IF MOD(C,T0)=1 THEN GOSUB 8150
1265 IF LEN(M1$)=0 THEN GOTO 1240
1270 GOSUB 4000
1275 M1$=M1$(LEN(P9$)+1)
1280 FOR X=0 TO M0
1285 SETERR 1290; M[X]=0; M[X]=DEC(M1$(X*M1+1,M1)); M[X]=M[X]*M9
1290 SETERR 0000; NEXT X
1300 WRITE (Z[2],KEY=P9$)IOL=0310
1320 SETERR 9000
1330 GOTO 1240
1340 C=T; GOSUB 8150
1350 C=0
1360 GOSUB 4100; REM "RENAME FILE
1370 GOSUB 4200; REM "CHANGE ZZPARM TO SHOW DATA AS UNPACKED
1380 NEXT X1
1385 GOSUB 4300
1390 GOTO 5000
1400 REM "CANNOT LOCK FILE
1420 PRINT @(0,18),"Cannot lock file ",NAME$," (LOG ALL PEOPLE OFF SYSTEM AND PRESS RETURN",; INPUT *
1430 RETRY ; REM "SHOULD GO BACK TO 1208
3000 REM "Create a temporary file to write unpacked data to
3010 CALL "ZZINFO",Z[1],X0,X3$,R0,R1,K,B,D,T0,S0,F$
3020 FILE$=F$(1,6)+".s"
3030 DIRECT FILE$,K,0,256,ERR=3100
3040 Z$="02C  02O "+FILE$+"  "
3050 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 3051,9900
3060 READ (Z[13],KEY="STAT"+STATNAME$)F9$,F0
3065 Q9$=F9$(8,20)
3070 PRINT @(30,10),"Updating ",F$,"  ",Q9$,
3090 RETURN 
3100 REM "ERASE FILE
3120 ERASE FILE$
3140 GOTO 3030
4000 REM "SET M9
4010 M9=.01
4020 IF PACK$(X1*3-2,3)="AR9" AND P9$(LEN(P9$),1)="N" THEN M9=1
4030 IF PACK$(X1*3-2,3)="ARA" AND P9$(LEN(P9$),1)="N" THEN M9=1
4040 IF PACK$(X1*3-2,3)="ARX" AND P9$(LEN(P9$),1)="N" THEN M9=1
4050 IF PACK$(X1*3-2,3)="ASF" AND P9$(LEN(P9$),1)="N" THEN M9=1
4060 IF PACK$(X1*3-2,3)="TP9" AND P9$(LEN(P9$),1)="I" THEN M9=1
4090 RETURN 
4100 REM "RENAME FILE
4110 Z$="01C  02C  "
4120 CALL "ZZFLES",X3$,Y1$,Y0$,Z$,Z{ALL},Z0,Z1; ON Z0 GOTO 4121,9900
4140 ERASE F$(1,6)
4150 RENAME FILE$,F$(1,6)
4190 RETURN 
4200 REM "CHANGE RECORD IN ZZPARM TO SHOW THAT FILE IS NOW UNPACKED
4220 READ (Z[13],KEY="STAT"+STATNAME$)F9$,F0
4230 F9$(34,1)="U"
4240 WRITE (Z[13],KEY="STAT"+STATNAME$)F9$,F0
4290 RETURN 
4300 REM "Change BERT Fields to show unpacked records
4310 K$=KEY(Z[4],END=4390)
4320 READ RECORD (Z[4],KEY=K$)A$
4330 IF POS(A$(61,3)=PACK$,3)>0 AND A$(81,1)="9" THEN A$(81,1)="2" ELSE GOTO 4310
4340 WRITE RECORD (Z[4],KEY=K$)A$
4380 GOTO 4310
4390 RETURN 
5000 REM "EOJ
5020 IF Q1$="" THEN CALL "ZZPROM",".4",X3$,Z,"Process complete!!","","",0
5040 GOTO 9900
6000 REM "BACKGROUND
6005 PRINT (0,ERR=6016)'SB',
6020 PRINT @(15,4),"This utility program will unpack statistical files"
6165 PRINT (0,ERR=6166)'SF',
6190 RETURN 
8100 REM "GOSUB here, once, at the beginning, after the background is set and before the Proceed? question. Set T to total # to do (by calling ZZINFO) and T0 to the reporting interval (report every T0 number of records) this is typically 2% of total; This also prints a message (@8115),so adjust accordingly
8110 CALL "ZZINFO",Z[1],T9,X3$,T,T0,K,B,D,S0,S1,F$
8115 PRINT @(0,17),"There are "+STR(T)+" records to process"
8129 REM "Set T0, we make sure T0 is > 1, because later on we MOD and lookfor avalue of 1. IF T0 is 1, then nothing would get reported. We lookfor a result of 1 because this causes the first record to automatically start the reporting instead of waiting until the T0'th record to get the first report
8130 T0=INT(T*.02); IF T0<=1 THEN T0=2
8145 RETURN 
8150 REM "Call this each time to update the bar graph. Display horiz. bar graph given total #, T and current #, C, and time counter T1 (T1 is init'ed here and used here, just don't use it somewhere else)
8155 CALL "ZZBARG",X3$,"HG",19,10,50,T1,T,C
8195 RETURN 
8950 DEF FNS$(Z9$)=Z9$(1,POS("     "=Z9$+"     ")-1)
9000 REM "ERROR PROCESSING
9005 IF ERR=69 THEN GOTO 9500
9010 Y5=ERR,Y6=TCB(5)
9015 SETERR 9016; Y8$=LST(PGM(Y6))
9016 SETERR 9000
9040 CALL "ZZERRM",Y8$,X0$,Y7$,X3$,Y5,Y6,Y7,Y8,0
9045 REM 
9050 ON Y7 GOTO 9060,9100,9800,9070,9090
9055 REM 
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE Y7$
9080 SETERR 9000; RETRY 
9090 SETERR 0000; RETRY 
9100 REM " TRANSFER CONTROL
9180 GOTO 0990
9190 GOTO 9800
9300 SETESC 9350
9310 SETERR 9350
9315 IF X3$(47,1)="N" THEN RETURN ELSE SETESC 0000; RETURN 
9350 SETERR 9000; RETURN 
9500 REM "CTRL LOGIC
9510 SETERR 9000; GOSUB 6400
9520 ON C9 GOTO 1140,2040
9900 REM "END PROGRAM
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9930 SETERR 9940; Q1$=A1$; EXIT 
9940 SETESC 9350
9950 RUN "ZMENU"
9999 END 
