0010 REM "Process installation file <ZZINST>
0035 REM "4.1 - 03/02/98 - 18.68 - kmc - SSP# 095630
0040 REM "Copyright 1997 Computer Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0998 REM "I$=CLIENT NAME, S0=SERIAL NUMBER, U0=# USERS, I1$=CLIENT CODE,I2$=APPLICATIONS
0999 REM "APPLICATIONS= AABBBCCCCCC   AA=CLDE, BBB=VERSION, CCCCCC=DATE
1010 REM "L0=LENGTH OF EACH APPLICATIONS DATA IN STRING
1015 K$="lightyears",L0=17; DIM Z$(10,$00$)
1020 ENTER CLIENT_NAME$,S0,U0,CLIENT_CODE$,VALIDAPPS$,I3$
1022 IF CLIENT_NAME$="?" OR CLIENT_NAME$="@"+STR(%SSN) THEN GOTO GET_EXISTING_APPS_RECORD
1023 REM "UNUSED IF CLIENT_NAME$="DONE!" THEN LET M9$=CLIENT_NAME$
1025 CLIENT_NAME$="",S0=0,U0=0,CLIENT_CODE$="",VALIDAPPS$=""
1030 SETERR 9000
1100 REM Get Serial numbers & Apps Authorization file
1101 REM TFINSTALL is on remotes only.
1110 AUTH_FILE$="TF.INST"
1120 IF POS("MS"=SYS)>0 THEN {
1130 AUTH_FILE$="TFINSTAL"
1140  } ELSE {
1150 CALL "ZZTFNM",AUTH_FILE$
1160  }
1200 REM Load A$ with parameter records
1210 CLOSE (14); OPEN (14,ERR=NO_INSTALL_FILE)AUTH_FILE$
1220 READ RECORD (14,END=*NEXT)X$; A$=A$+X$+$0A$; GOTO *SAME
1230 CLOSE (14)
1240 DIM Z$(10,$00$); A$=A$(1,POS(Z$=A$+Z$)-1)
1400 REM "UNENCRYPT A$ TO AUTH_REC-STR$
1410 K$="lightyears"
1420 CALL "ZZCRYP",X3$,K$,"","U",AUTH_REC_STR$,I{ALL},A$,X9
1430 AUTH_REC_STR$(37,10)=STR(%SSN)
1440 REM unused LET ORIGSSN$=Auth_Rec_str$(37,10); LET ORIGCODE$=Auth_Rec_str$(50,8),ORIGUSER$=Auth_Rec_str$(47,3); REM "SAVE OFF ORIGINAL ACCESS CODE AND SSN FOR NT SYSTEMS
1450 REM "STRIP OFF CLIENT (REMOTE) SERIAL NUMBERS
1460 P0=POS("[CLIENT]"=AUTH_REC_STR$)
1470 I9$=""
1480 I0SAVE$=AUTH_REC_STR$
1490 IF P0>0 THEN {
1500 I9$=MID(AUTH_REC_STR$,P0+8)
1510 AUTH_REC_STR$=MID(AUTH_REC_STR$,1,P0-1)
1520  }
1530 VALIDAPPS$=MID(AUTH_REC_STR$,1,6)
1540 CLIENT_NAME$=MID(AUTH_REC_STR$,7,30)
1550 AUTH_REC_STR$=MID(AUTH_REC_STR$,37)
1560 S0=NUM(MID(AUTH_REC_STR$,1,10))
1570 U0=NUM(MID(AUTH_REC_STR$,11,3))
1580 S8=S0
1590 IF POS("MS-DOS"=SYS)=1 THEN S0=500105,A$(37,10)=STR(S0:"0000000000")
1600 I3$=AUTH_REC_STR$(14,8),CLIENT_CODE$=AUTH_REC_STR$(22)
1610 IF S0<>%SSN THEN {
1620 IF POS("MS"=SYS)<>1 THEN {
1630 EXIT 89
1640  } ELSE {
1650 CALL "ZZNTSN",X3$,%SSN,FLAG$,MASTER_SSN
1660 IF FLAG$<>"Y" OR S0<>MASTER_SSN THEN {
1670 EXIT 89
1680  } ELSE {
1690 REM RT2BEG EXPECTS THE CLIENT SERIAL NUMBER NOT THE MASTER NUMBER
1691 S0=%SSN
1700  } } }
1710 REM 
2000 REM "ADD THESE TO THE INSTALLATION
2019 REM "ZZPARM is not installed on Remotes. If error on open then leave, this is needed for Remote T/M
2020 CLOSE (14); OPEN (14,ERR=9900)"ZZPARM"
2025 DIM A$(50),A[2]; A$(1,6)=VALIDAPPS$,A$(7,30)=CLIENT_NAME$,A$(37,13)=STR(S0:"0000000000")+STR(U0:"000"),A0$=""
2029 GOTO 2040; REM "Always install full set of applications
2030 READ RECORD (14,KEY="APPS",DOM=2040)Q$
2035 DIM Z9$(10,$00$); Q$=Q$(1,POS(Z9$=Q$+Z9$)-1)
2036 IF NTFLAG$="Y" THEN IF A[0]>0 THEN IF A[0]<>%SSN THEN CALL "ZZNTSN",X3$,SERIN$,FLAG$,SEROUT$; GOTO 2045
2040 IF A[0]>0 THEN IF A[0]<>%SSN THEN Q$="Application record SSN does not match"; GOTO 9800
2045 A[0]=S0,A[1]=U0
2050 A0$=A$(1,50),A$=A$(51)
2100 REM "PROCESS EACH APPLICATION
2120 FOR X=1 TO LEN(CLIENT_CODE$) STEP L0; A$=A$+CLIENT_CODE$(X,L0); NEXT X
2140 REM LET P0=POS(CLIENT_CODE$(X,2)=A$,L0); IF P0=0 THEN LET A$=A$+CLIENT_CODE$(X,L0); GOTO 02190
2145 REM LET A$(P0,L0)=CLIENT_CODE$(X,L0)
2190 REM NEXT X
2195 A$=A0$+A$
2200 REM 
2210 CALL "ZZCRYP",X3$,K$,"","E",A$,A{ALL},Q$,X9
2220 WRITE RECORD (14,KEY="APPS")Q$
2230 DIM AUTH_REC_STR$(120); AUTH_REC_STR$(1)="INSTALL"; EXTRACT (14,KEY="INSTALL",DOM=2231)AUTH_REC_STR$
2232 AUTH_REC_STR$(47,9)=A$(38,9),AUTH_REC_STR$(67,3)=STR(U0:"000")
2235 P=POS("ZZ"=A$(51),L0); IF P>0 THEN AUTH_REC_STR$(64,3)=MID(A$,51+P+1,3)
2240 WRITE (14,KEY="INSTALL")AUTH_REC_STR$,A$,A[0],A[1]
2445 REM IF POS("MS-DOS"=SYS)=1 THEN LET S0=S8
2500 REM "Update Client (Remote) Serial Numbers  - Always remove previous ones in case they no longer have license.
2510 K9$="APPS"
2520 READ (14,KEY=K9$)
2530 K8$=KEY(14,END=2550)
2540 IF MID(K8$,1,LEN(K9$))=K9$ THEN REMOVE (14,KEY=K8$); GOTO 2530
2550 IF I9$="" THEN GOTO 2900
2560 K9$=K9$+"0000"; DIM A[2]
2570 IF I9$="" THEN GOTO 2900 ELSE P0=POS("[CLIENT]"=I9$); IF P0=0 THEN J9$=I9$,I9$="" ELSE J9$=I9$(1,P0-1),I9$=I9$(P0+8)
2580 CALL "ZZCRYP",X3$,K$,"","E",J9$,A{ALL},Q$,X9
2590 K9$(5,4)=STR(NUM(K9$(5,4))+1:"0000")
2600 WRITE RECORD (14,KEY=K9$)Q$
2690 GOTO 2570
2900 REM 
2910 IF F9$>"Y" THEN GOTO 4000
2990 GOTO 9900
4000 GET_EXISTING_APPS_RECORD:
4020 CLOSE (14); OPEN (14)"ZZPARM"
4030 READ RECORD (14,KEY="APPS")Q$
4035 Q$=Q$(1,POS(Z$=Q$+Z$)-1)
4040 CALL "ZZCRYP",X3$,K$,"","U",A$,A{ALL},Q$,0
4045 IF CLIENT_NAME$="@"+STR(%SSN) THEN CLIENT_NAME$=A$; GOTO 4090
4050 CLIENT_CODE$=A$(51)
4055 VALIDAPPS$=A$(1,6),CLIENT_NAME$=A$(7,30)
4060 S0=NUM(A$(37,10)),U0=NUM(A$(47,3))
4090 GOTO 9900
8000 NO_INSTALL_FILE:
8020 EXIT 12
9040 EXIT ERR
9800 REM 
9850 EXIT 89
9900 REM "END
9920 CLOSE (14)
9940 EXIT 
9999 END 
