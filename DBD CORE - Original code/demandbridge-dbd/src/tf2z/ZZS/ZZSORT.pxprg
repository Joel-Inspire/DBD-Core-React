0010 REM "File Sort Routine <ZZSORT>
0030 REM "(C) 1985,1986,1987 Basic Ideas, Inc; Atlanta, Ga.
0035 REM "3.7 - 04/18/94 - .67 - kmc
0040 REM "Copyright 1994 Computer Software Inc.; Norcross, Georgia
0041 REM "        Licensed Software - All Rights Reserved.
0510 X0$="ZZSORT",X$=$8A$
1010 DIM S$(10),Z0$(20,"0"),Z1$(20,"9")
1090 SETESC 9300
1100 ENTER X3$,X4$,F0$,F2$,F3$,F4$,F0,F1,F2,X0,X1,X9
1105 Q=POS("\"=F0$); IF Q>0 THEN S8$=F0$(Q+1),F0$=F0$(1,Q-1)
1110 SETERR 9000
1115 DIM Z[NUM(X3$(60,3))]
1120 F0$=F0$+S$(1,6),F0$=F0$(1,6)
1125 IF F0$(4,3)="..." THEN F0$(4,3)=""
1140 IF POS("G"=FID(0))=1 THEN G$="G"
1200 REM "Get sort file information "
1210 GOSUB 7000
1220 IF F3$>"" THEN ADDR "ZZFLTR"
1230 IF F9$(47,1)="P" THEN GOSUB 8500
1325 IF G$="G" OR POS("R"=F2$)<=0 THEN GOTO 1400
1330 REM "Resort, Skip, Abort
1350 CALL "ZZPROM","S1",X3$,S0,"","","",0; ON S0 GOTO 1400,8000,9800
1400 REM "Clear and set up dest file"
1405 F0$=F0$+S$(1,6-LEN(F0$)); IF F0$(4,3)="   " THEN F0$(4,3)="..."
1410 F$=STR(X1:"00")+"L "+F0$+"  "
1450 CALL "ZZFLES",X3$,Y1$,Y0$,F$,Z{ALL},Z0,0; ON Z0 GOTO 1451,9800
1460 CALL "ZZINIT",STR(Z[X1]:"00")
1700 REM "
1820 Q0$="+ ("+F0$+")"; IF G$<>"G" THEN CALL "ZZPROM","S2",X3$,0,Q0$,"","",0
2000 REM "RECORD SORT
2005 IF G$<>"G" THEN GOSUB 8100
2010 EXTRACT RECORD (X0,KEY="",DOM=2020)A0$
2020 A3=IND(X0,ERR=2400)
2023 C=C+1; IF MOD(C,T0)=1 THEN IF G$<>"G" THEN GOSUB 8150
2025 K$=KEY(X0,END=2400); READ RECORD (X0)A0$; IF S8$>"" THEN IF K$(LEN(K$),1)<>S8$ THEN GOTO 2020
2040 IF F3$>"" THEN CALL "ZZFLTR",ERR=2041,X3$,F3$,"",K$,K0,0; ON K0 GOTO 2020,2041
2100 REM "
2120 IF S9$>"" THEN CALL "ZZPACK",X3$,"U","",A0$(LEN(K$)+1),P8,0,N{ALL},-1,S8$,"",S9$
2140 GOSUB 4000
2160 REM " IF G$<>"G" THEN PRINT @(0,23),B$,
2200 REM "
2209 F$=FID(Z[X1])
2220 WRITE (Z[X1],KEY=B$)
2290 GOTO 2020
2410 IF X2>0 THEN EXTRACT (X2,KEY="",DOM=2411)
2420 EXTRACT (X1,KEY="",DOM=2421)
2490 IF G$<>"G" THEN PRINT @(0,23),'CL',
2500 REM "
2950 GOTO 9900
4000 REM "CREATE SORT KEY OUT OF DATA RECORD
4030 B$=""; FOR X=0 TO A
4035 ON A[X,0]+1 GOTO 4050,4036,4040
4036 B$=B$+STR(A3:Z0$(1,A[X,1])); GOTO 4150
4040 B$=B$+A0$(A[X,0],A[X,1]); GOTO 4150
4050 REM "NUMERIC ELEMENT
4052 IF S9$>"" THEN B=N[-A[X,0]]; GOTO 4080
4055 A0=POS(X$=A0$)+1,B=0,A1=1,A9=-A[X,0]; IF A0=1 THEN GOTO 4090
4060 FOR Y=1 TO A9
4062 A0=A0+A1-1
4065 A1=POS(X$=A0$(A0))+1; IF A1=1 THEN EXITTO 4090
4070 NEXT Y
4075 B=NUM(A0$(A0,A1-2))
4080 IF Z2$(X+1,1)="-" THEN B=-B
4085 B=INT(B*A[X,2])
4088 N=NUM(Z1$(1,A[X,1]-1))
4090 B=B+N,B$=B$+STR(B:Z0$(1,A[X,1]))
4150 NEXT X
4190 RETURN 
7000 REM "LOAD SORT VALUES IN A ARRAY
7005 GOSUB 7100
7010 DIM A[7,2]
7020 FOR I0=1 TO LEN(A$) STEP 7
7022 IF A$(I0,1)=" " THEN EXITTO 7041 ELSE I1=INT(I0/7)
7025 ON POS(A$(I0+1,1)="A+-I") GOTO 7040,7026,7027,7027,7028
7026 A[I1,0]=NUM(A$(I0+2,3)),Z2$=Z2$+" "; GOTO 7030
7027 A[I1,0]=(-NUM(A$(I0+2,3)))-1,Z2$=Z2$+A$(I0+1,1),A[I1,1]=NUM(A$(I0+5,1))+NUM(A$(I0+6,1))+1,A[I1,2]=10^NUM(A$(I0+6,1)); GOTO 7031
7028 A[I1,0]=0,Z2$=Z2$+" "; GOTO 7030
7030 A[I1,1]=NUM(A$(I0+5,2))
7035 A2=A2+A[I1,1]
7040 NEXT I0
7045 A=INT(I0/7)-1
7050 F$=STR(E:"00")+"C ZZE...  "
7060 CALL "ZZFLES",X3$,Y1$,Y0$,F$,Z{ALL},Z0,S0; ON Z0 GOTO 7061,9800
7099 RETURN 
7100 REM "Read file info in from ZZE into A$
7120 FOR I0=1 TO NUM(X3$(60,3))
7125 IF Z[I0]=0 THEN E=I0; EXITTO 7131
7130 NEXT I0; E=14
7140 F$=STR(E:"00")+"O ZZE...  "
7150 CALL "ZZFLES",X3$,Y1$,Y0$,F$,Z{ALL},Z0,S0; ON Z0 GOTO 7151,9800
7160 READ (Z[E],KEY=F0$,DOM=9900)A$
7170 READ (Z[E],KEY=A$(50,6))F9$
7171 X2=X1
7172 GOTO 7190
7175 X3=INT(POS(A$(56,6)=Y0$(11),9)/9)+1
7180 F$="01S "+A$(50,6); FOR X=1 TO LEN(F$); IF F$(X,1)=" " THEN F$(X,1)="."
7181 NEXT X; F$=F$+"  "
7185 CALL "ZZFLES",X3$,Y1$,Y0$,F$,Z{ALL},Z0,Z1
7195 A$=A$(63,56)
7199 RETURN 
8000 REM "END OF SORT
8100 REM "setup for Bargraph
8110 CALL "ZZINFO",X0,T9,X3$,T,T0,0,0,0,0,0,""
8129 REM "Set T0, we make sure T0 is > 1, because later on we MOD and look for avalue of 1. IF T0 is 1, then nothing would get reported. We look fora result of 1 because this causes the first record to automatically start the reporting instead of waiting until the T0'th record to get the first report
8130 T0=INT(T*.02); IF T0<=1 THEN T0=2
8145 RETURN 
8150 REM "Call this each time to update the bar graph. Display horiz. bar graph given total #, T and current #, C, and time counter T1 (T1 is init'ed here and used here, just don't use it somewhere else)
8155 CALL "ZZBARG",X3$,"HG",19,10,50,T1,T,C
8195 RETURN 
8290 GOTO 9900
8500 REM "GET STATS
8510 F9=NUM(X3$(60,3)); CLOSE (F9); OPEN (F9)"ZZPARM"
8520 READ (F9,KEY="STAT"+F9$(58,3))S9$
8525 P8=NUM(F9$(67,3)); DIM N[P8]
8540 RETURN 
9000 REM "ERROR PROCESSING
9010 E0=ERR,E1=TCB(5)
9015 SETERR 9016; E0$=LST(PGM(E1))
9016 SETERR 9000
9040 CALL "ZZERRM",E0$,X0$,E1$,X3$,E0,E1,E2,E3,0
9050 ON E2 GOTO 9060,9100,9900,9070,9090
9060 RETRY 
9070 SETERR 9080
9075 EXECUTE E1$
9080 SETERR 9000; RETRY 
9100 REM " TRANSFER CONTROL
9190 GOTO 9800
9300 REM "ESCAPE
9301 ESCAPE 
9311 EXIT ERR
9390 RETURN 
9800 REM "ERROR DURING EXIT
9820 X9=1; GOTO 9900
9900 REM "END PROGRAM
9905 IF F3$>"" THEN DROP "ZZFLTR",ERR=9906
9910 CALL "ZZFLES",X3$,Y1$,Y0$,"END",Z{ALL},0,0
9940 EXIT 
9999 END 
